<!DOCTYPE html>
<html lang="ko-KR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ü©∂</title>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>

        :root {
            --bg-color: #fce4ec;
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 18px;
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-family-monospace: 'Courier New', 'Monaco', 'Menlo', 'Consolas', monospace;
            --top-pinned-bg: #fff0f5;
            --online-status-color: #4CAF50;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .phone-screen {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 850px;
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .app-header .back-btn,
        .app-header .action-btn {
            background: none;
            border: none;
            font-size: 35px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .app-header .action-btn-group .action-btn {
            font-size: 14px;
            font-weight: 400;
            width: auto;
            padding: 10px;
            border-radius: 10px;
            height: 33px;
        }

        .app-header .action-btn-group #create-group-btn {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .app-header .action-btn-group #add-chat-btn {
            font-size: 35px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
        }

        .app-header .action-btn img {
            width: 28px;
            height: 28px;
        }

        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .app-header .title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
        }

        .app-header .subtitle {
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            margin-top: 2px;
        }

        .online-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        .app-header .placeholder {
            width: 40px;
        }

        #home-screen {
            justify-content: space-between;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 50px 0;
        }

        .time-widget {
            text-align: center;
            padding: 0 20px;
            color: var(--text-color);
        }

        .time-widget .time {
            font-size: 72px;
            font-weight: 600;
        }

        .time-widget .date {
            font-size: 18px;
            color: #666;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .app-grid {
            width: 100%;
            padding: 20px 40px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            justify-content: center;
            align-content: center;
            margin-top: 40px;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .dock {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            margin: 0 20px;
            min-height: 80px;
            gap: 15px;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .icon-img {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            object-fit: cover;
        }

        .app-icon:hover .icon-img {
            transform: translateY(-5px);
        }

        .app-icon .app-name {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.2s ease-out;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
            font-size: 15px;
            font-weight: 500;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #edit-group-member-modal,
        #create-member-for-group-modal {
            z-index: 102;
        }

        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background: #f7f7f7;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(50px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #chat-list-screen .content,
        #world-book-screen .content {
            padding: 10px 0 0 0;
        }

        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color: #fdf6f8;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .unread-badge { margin-left: auto; background-color: #ff554c; color: white; font-size: 12px; font-weight: bold; padding: 2px 7px; border-radius: 20px; }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .group-avatar {
            border-radius: 10px;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 500;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 0 10px;
            padding-bottom: 0px;
            transition: padding-bottom 0.3s ease;
        }

        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 5px;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.group-message {
            margin-bottom: 18px;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
        }

        #message-area > .message-wrapper:first-of-type {
            margin-top: 10px;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        .message-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }

        .message-bubble {
            max-width: 260px;
            padding: 9px 12px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.3;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .message-bubble.sent {
            border-top-right-radius: 5px;
        }

        .message-bubble.received {
            border-top-left-radius: 5px;
        }

        .message-bubble.grouped-bubble.sent,
        .message-bubble.grouped-bubble.received {
            border-radius: var(--border-radius); /* Í∑∏Î£π Ï§ëÍ∞Ñ/ÎßàÏßÄÎßâ Î©îÏãúÏßÄÎäî Î™®Îì† Î™®ÏÑúÎ¶¨Î•º Îë•Í∏ÄÍ≤å */
        }

        .message-wrapper.grouped .message-info {
            visibility: hidden; /* Í∑∏Î£π ÎÇ¥ Î©îÏãúÏßÄÏùò ÌîÑÎ°úÌïÑ/ÏãúÍ∞Ñ ÏòÅÏó≠ÏùÑ Ïà®ÍπÄ */
        }
        
        .message-wrapper.grouped {
            margin-top: -16px; /* Í∑∏Î£π ÎÇ¥ Î©îÏãúÏßÄ Í∞ÑÍ≤© Ï§ÑÏù¥Í∏∞ */
            margin-bottom: 12px;
        }
        
        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            margin: 6px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .image-bubble {
            width: 120px;
            border-radius: calc(var(--border-radius) - 4px);
            border-bottom-right-radius: 4px;
            margin: 8px;
            padding: 4px;
            /*
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); */
            cursor: pointer;
        }

        .image-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: calc(var(--border-radius) - 4px);
        }

        .message-wrapper.sent .image-bubble {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .image-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 9px 12px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            max-width: 200px;
        }

        .message-wrapper.sent .voice-bubble {
            border-top-right-radius: 5px;
            flex-direction: row-reverse;
        }

        .message-wrapper.received .voice-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble .play-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .voice-bubble .duration {
            font-size: 12px;
            margin: 0 4px;
            white-space: nowrap;
        }

        .message-wrapper.sent .play-icon {
            transform: scaleX(-1);
        }

        .voice-transcript {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .voice-transcript.active {
            display: block;
        }

        .message-wrapper.sent .voice-transcript {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .voice-transcript {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .pv-card {
            width: 230px;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 8px;
        }

        .message-wrapper.sent .pv-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .pv-card {
            border-bottom-left-radius: 5px;
        }

        .pv-card-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.2s ease-in-out;
            z-index: 2;
        }

        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .pv-card-footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .pv-card-footer.hidden {
            opacity: 0;
        }

        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 230px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }

        .message-wrapper.sent .transfer-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .transfer-card {
            border-bottom-left-radius: 5px;
            cursor: pointer;
        }

        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }

        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }

        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }

        .transfer-card.received .overlay {
            background-color: rgba(255, 182, 193, 0.4);
        }

        .transfer-card.returned .overlay {
            background-color: rgba(100, 100, 100, 0.5);
        }

        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 16px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }

        .transfer-amount {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            margin-block-end: 0px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 8px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.sent .gift-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .gift-card {
            border-bottom-left-radius: 5px;
        }

        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 8%;
            flex-shrink: 0;
        }

        .gift-card-text {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            font-family: var(--font-family);
        }

        .gift-card-description {
            font-size: 12px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 9px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.2;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gift-card-description.active {
            display: block;
        }

        .message-wrapper.sent .gift-card-description {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .gift-card-description {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: var(--font-family);
        }

        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

        #sticker-bar {
            position: absolute;
            bottom: 100%; /* ÏûÖÎ†•Ï∞Ω Î∞îÎ°ú ÏúÑÏóê ÏúÑÏπò */
            left: 0;
            width: 100%;
            padding: 3px 10px;
            display: none; /* Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïà®ÍπÄ */
            align-items: center;
            justify-content: flex-start; 
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            gap: 5px;
            flex-wrap: wrap; /* ÏïÑÏù¥ÏΩòÏù¥ ÎßéÏïÑÏßÄÎ©¥ Îã§Ïùå Ï§ÑÎ°ú */
            z-index: 5;
        }

        #sticker-bar.visible {
            display: flex;
        }

        .sticker-bar-btn {
            background: none;
            border: none;
            padding: 5px 6px;
            cursor: pointer;
        }

        .sticker-bar-btn svg {
            width: 22px;
            height: 22px;
            fill: #888;
        }

        .message-input-area .sticker-toggle-btn-wrapper {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }
        
        .message-input-area #sticker-toggle-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(10px);
        }

        .message-input-area #sticker-toggle-btn svg {
            width: 24px;
            height: 24px;
            fill: #888;
        }

        #sticker-modal {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            max-height: 450px;
            background: #f7f7f7;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 4;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible {
            display: flex;
            animation: slideUp 0.15s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
            position: relative; /* ÏûêÏãù ÏöîÏÜåÏùò absolute Ìè¨ÏßÄÏÖîÎãù Í∏∞Ï§ÄÏù¥ Îê® */
        }

        .message-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px;
            padding-bottom: calc(50px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            gap: 8px;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            overflow: hidden;
        }

        .textarea-container {
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .message-input-area textarea {
            width: 100%; /* Î∂ÄÎ™® Ïª®ÌÖåÏù¥ÎÑàÎ•º ÍΩâ Ï±ÑÏõÄ */
            border: none;
            padding: 10px 45px 10px 12px;
            border-radius: 18px;
            background-color: #f0f0f0;
            resize: none; 
            font-family: inherit; 
            line-height: 1.2;
            max-height: 120px;
            box-sizing: border-box; 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .message-input-area textarea::-webkit-scrollbar {
            display: none;
        }

        .message-input-area input:focus {
            outline: none;
        }

        .message-input-area .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .message-input-area .icon-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message-input-area .icon-btn svg {
            width: 25px;
            height: 25px;
            fill: currentColor;
        }

        #attachment-toggle-btn {
            background-color: #f0f0f0 !important;
            color: #555 !important;
            font-size: 24px;
            font-weight: bold;
        }
        #attachment-toggle-btn.active {
            transform: rotate(45deg);
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .message-input-area .icon-btn.send-btn {
            font-size: 17px;
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(50px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .settings-sidebar {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            height: 100%;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.4s ease-in-out;
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: 500;
            text-align: center;
            color: var(--primary-color);
        }

        .settings-sidebar .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-sidebar .form-group textarea {
            height: 150px;
            resize: vertical;
        }

        .settings-sidebar .avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-sidebar .avatar-preview {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group-checkbox {
            padding: 0px 5px 12px 5px;
            border-radius: 10px;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group label {
            font-size: 13px;
            display: block;
            margin-bottom: 6px;
            padding-left: 5px;
            color: var(--secondary-color);
            font-weight: 400;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group.radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--white-color);
            
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        
        .github-sync-section {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            background-color: #fafafa;
            margin-top: 20px;
        }

        .github-sync-section h4 {
            margin: 0 0 15px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .github-sync-section h4:hover {
            background-color: #e0e0e0;
        }

        .github-sync-section h4 span {
            float: right;
            transition: transform 0.3s ease;
        }

        #github-sync-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        #github-sync-content .form-group {
            margin-bottom: 15px;
        }

        #github-sync-content .css-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #github-sync-content .btn {
            margin-bottom: 0;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #fff8fa;
        }

        .toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        #world-book-selection-modal,
        #invite-member-modal,
        #group-recipient-selection-modal {
            z-index: 102;
        }

        #world-book-selection-modal .modal-window,
        #invite-member-modal .modal-window,
        #group-recipient-selection-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }

        #world-book-selection-list,
        #invite-member-selection-list,
        #group-recipient-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .world-book-select-item,
        .invite-member-select-item,
        .group-recipient-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .world-book-select-item:last-child,
        .invite-member-select-item:last-child,
        .group-recipient-select-item:last-child {
            border-bottom: none;
        }

        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"],
        .group-recipient-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        .world-book-select-item label,
        .invite-member-select-item label,
        .group-recipient-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .invite-member-select-item img,
        .group-recipient-select-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        
        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .member-selection-item:last-child {
            border-bottom: none;
        }

        .member-selection-item input[type="checkbox"] {
            margin-right: 10px;
            width: 15px;
            height: 15px;
            flex-shrink: 0;
        }

        .member-selection-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
        }

        .member-selection-item label {
            font-weight: 500;
            color: var(--text-color);
        }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }

        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }

        #customize-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        #customize-screen .icon-custom-item:last-child {
            border-bottom: none;
        }

        #customize-screen .icon-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #customize-screen .icon-details {
            flex-grow: 1;
        }

        #customize-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 500;
        }

        /* #customize-screen .icon-details input {
            width: calc(100% - 70px);
        } */

        #customize-screen .reset-icon-btn {
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        
        .customize-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            margin: 0 0 20px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }

        .section-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .css-toggle-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }

        .toggle-text {
            font-size: 16px;
            color: var(--text-color);
        }

        .css-preset-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            color: var(--text-color);
        }

        .css-input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            font-family: var(--font-family-monospace);
            background: #fff;
            color: var(--text-color);
            resize: vertical;
            min-height: 120px;
        }

        .css-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-secondary {
            background: var(--accent-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #64b5f6;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .css-info {
            padding: 12px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .info-text {
            margin: 0;
            font-size: 13px;
            color: #1976d2;
            line-height: 1.4;
        }

        
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid #fce4ec;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff8fa;
        }

        .tutorial-header {
            padding: 12px 18px;
            font-weight: 500;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-header::after {
            content: '‚ñº';
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }

        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }

        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            
            max-height: 5000px;
        }

        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
        }
        .form-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .font-description {
            font-style: italic;
        }
    </style>
</head>

<body>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‚Äπ</button>
            <div class="title-container">
                <h1 class="title">Ï±ÑÌåÖ</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn">Í∑∏Î£πÏ±ÑÌåÖ</button>
                <button class="action-btn" id="add-chat-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>ÏïÑÏßÅ Ï±ÑÌåÖ ÏÉÅÎåÄÍ∞Ä ÏóÜÎÑ§Ïöî~</p>
                <p>Ïò§Î•∏Ï™Ω ÏÉÅÎã®Ïùò "+"Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‚Äπ</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div><span id="chat-room-status-text">Ïò®ÎùºÏù∏</span>
                </div>
            </div>
            <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="ÏÑ§Ï†ï"></button>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">Ï∑®ÏÜå</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">Î©îÏãúÏßÄ ÏÑ†ÌÉù</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
            <div id="sticker-bar">
                <button class="sticker-bar-btn" id="photo-video-btn" title="ÏÇ¨ÏßÑ/ÏòÅÏÉÅ">
                    <svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                </button>
                <button class="sticker-bar-btn" id="image-recognition-btn" title="ÏÇ¨ÏßÑ Ïù∏Ïãù">
                    <svg viewBox="0 0 24 24"><path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z" /></svg>
                </button>
                <button class="sticker-bar-btn" id="voice-message-btn" title="ÏùåÏÑ± Î©îÏãúÏßÄ">
                    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" /></svg>
                </button>
                <button class="sticker-bar-btn" id="wallet-btn" title="ÏÜ°Í∏à">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z" /></svg>
                </button>
                <button class="sticker-bar-btn" id="gift-btn" title="ÏÑ†Î¨º">
                    <svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z" /></svg>
                </button>
                <button class="sticker-bar-btn" id="time-skip-btn" title="ÏãúÍ∞Ñ Î≥¥ÎÇ¥Í∏∞">
                    <svg viewBox="0 0 24 24"><path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path></svg>
                </button>
            </div>
            <div class="message-input-area" id="message-input-default">
                <button id="attachment-toggle-btn" class="icon-btn">+</button>
                <div class="textarea-container">
                <textarea rows="1" id="message-input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..."></textarea>
                    <div class="sticker-toggle-btn-wrapper">
                        <button class="sticker-bar-btn" id="sticker-toggle-btn" title="Ïù¥Î™®Ìã∞ÏΩò">
                            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" /></svg>
                        </button>
                    </div>
                </div>
                <button id="send-message-btn" class="icon-btn send-btn">‚û§</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z" /></svg>
                </button>
            </div>
            <div class="message-input-area" id="message-edit-bar" style="display: none;">
                <input type="text" id="message-edit-input"><button id="save-edit-btn" class="icon-btn send-btn">‚úì</button><button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">‚úó</button>
            </div>
        </div>
        <div id="multi-select-bar"><span id="select-count">0Í∞ú Ìï≠Î™© ÏÑ†ÌÉùÎê®</span><button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">ÏÑ†ÌÉù Ìï≠Î™© ÏÇ≠Ï†ú</button></div>
        <div id="sticker-modal">
            <div class="header"><span>ÎÇ¥ Ïù¥Î™®Ìã∞ÏΩò</span><button class="btn btn-primary btn-small" id="add-new-sticker-btn">ÏÉà Ïù¥Î™®Ìã∞ÏΩò Ï∂îÍ∞Ä</button></div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
        </div>
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‚Äπ</button>
            <div class="title-container">
                <h1 class="title">ÏÑ∏Í≥ÑÍ¥Ä</h1>
            </div>
            <button class="action-btn" id="add-world-book-btn">+</button>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>ÎãπÏã†Ïùò ÏÑ∏Í≥ÑÎäî ÌòºÎèàÏóê Îπ†Ï†∏ ÏûàÏäµÎãàÎã§...</p>
                <p>Ïò§Î•∏Ï™Ω ÏÉÅÎã®Ïùò "+"Î•º ÌÅ¥Î¶≠ÌïòÏó¨ Ï≤´ ÏÑ§Ï†ïÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
            </div>
        </main>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‚Äπ</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">Ìï≠Î™© ÏÉùÏÑ±/Ìé∏Ïßë</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">Ìï≠Î™© Ïù¥Î¶Ñ</label>
                    <input type="text" id="world-book-name" placeholder="Ïòà: ÏÑ∏Í≥ÑÍ¥Ä Î∞∞Í≤Ω, ÎßàÎ≤ï Ï≤¥Í≥Ñ" required>
                </div>
                <div class="form-group">
                    <label for="world-book-content">Ìï≠Î™© ÎÇ¥Ïö©</label>
                    <textarea id="world-book-content" rows="8" placeholder="Ïù¥ ÏÑ§Ï†ïÏùÑ ÏûêÏÑ∏Ìûà ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Ï£ºÏûÖ ÏúÑÏπò</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> Ïïû</label>
                        <label><input type="radio" name="world-book-position" value="after"> Îí§</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Ìï≠Î™© Ï†ÄÏû•</button>
            </form>

        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast"></div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Í∏∞</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ</label><input type="text" id="char-real-name" placeholder="Ï∫êÎ¶≠ÌÑ∞Ïùò Ïã§Ï†ú Ïù¥Î¶Ñ" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">Ï∫êÎ¶≠ÌÑ∞ Î©îÎ™® (Î≥ÑÎ™Ö)</label><input type="text" id="char-remark-name" placeholder="ÎãπÏã†Ïù¥ Î∂ÄÎ•º Ìò∏Ïπ≠" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">ÎÇ¥ Ïù¥Î¶Ñ</label><input type="text" id="my-name-for-char" placeholder="ÏÉÅÎåÄÎ∞©Ïù¥ ÎãπÏã†ÏùÑ Î∂ÄÎ•º Ìò∏Ïπ≠" required>
                </div><button type="submit" class="btn btn-primary">ÎßåÎì§Í∏∞</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">ÏÉà Ïù¥Î™®Ìã∞ÏΩò Ï∂îÍ∞Ä</h3>
            
            <!-- ÌÉ≠ Î≤ÑÌäºÎì§ -->
            <div class="sticker-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd;">
                <button type="button" id="single-sticker-tab" class="sticker-tab-btn active" style="flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #4CAF50;">Îã®Ïùº Îì±Î°ù</button>
                <button type="button" id="bulk-sticker-tab" class="sticker-tab-btn" style="flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent;">ÏùºÍ¥Ñ Îì±Î°ù</button>
            </div>

            <!-- Îã®Ïùº Îì±Î°ù Ìèº -->
            <div id="single-sticker-content" class="sticker-tab-content">
                <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                    <div id="sticker-preview"><span>ÎØ∏Î¶¨Î≥¥Í∏∞</span></div>
                    <div class="form-group"><label for="sticker-name">Ïù¥Î™®Ìã∞ÏΩò Ïù¥Î¶Ñ</label><input type="text" id="sticker-name" placeholder="Ïòà: Í∏∞ÏÅ®" required></div>
                    <div class="form-group"><label for="sticker-url-input">Ïù¥Î™®Ìã∞ÏΩò URL</label><input type="url" id="sticker-url-input" placeholder="Ïù¥ÎØ∏ÏßÄ URL Î∂ôÏó¨ÎÑ£Í∏∞"></div>
                    <p style="text-align:center; color:#888; margin: -10px 0 15px; font-size: 14px;">ÎòêÎäî</p><input type="file" id="sticker-file-upload" accept="image/*" style="display:none;"><label for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 10px;">Î°úÏª¨ÏóêÏÑú ÏóÖÎ°úÎìú</label><button type="submit" class="btn btn-primary">Ï†ÄÏû•</button>
                </form>
            </div>

            <!-- ÏùºÍ¥Ñ Îì±Î°ù Ìèº -->
            <div id="bulk-sticker-content" class="sticker-tab-content" style="display: none;">
                <form id="bulk-sticker-form">
                    <div class="form-group">
                        <label for="bulk-sticker-input">ÏùºÍ¥Ñ Ïù¥Î™®Ìã∞ÏΩò Îì±Î°ù</label>
                        <textarea id="bulk-sticker-input" rows="8" placeholder="Ìïú Ï§ÑÏóê ÌïòÎÇòÏî© ÏûÖÎ†•ÌïòÏÑ∏Ïöî:&#10;Î¨ºÏùåÌëúhttps://i.postimg.cc/d0YWDkN4/ajsv2e.gif&#10;ÎÜÄÎûå./images/emoji.png&#10;Í∏∞ÏÅ®data:image/png;base64,iVBORw0K...&#10;ÏõÉÏùåfile:///C:/happy.jpg" style="width: 100%; resize: vertical; font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #666;">
                        <strong>ÏÇ¨Ïö©Î≤ï:</strong><br>
                        ‚Ä¢ Ìïú Ï§ÑÏóê ÌïòÎÇòÏî© Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÏûÖÎ†•ÌïòÏó¨ Ïó¨Îü¨ Í∞úÎ•º ÌïúÎ≤àÏóê Îì±Î°ù<br>
                        ‚Ä¢ Í∞Å Ï§ÑÏùÄ "Ïù¥Î¶ÑURL" ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•<br>
                        ‚Ä¢ <strong>ÏßÄÏõê ÌòïÏãù:</strong><br>
                        &nbsp;&nbsp;- Ïõπ URL: Î¨ºÏùåÌëúhttps://example.com/image.gif<br>
                        &nbsp;&nbsp;- ÏÉÅÎåÄÍ≤ΩÎ°ú: ÎÜÄÎûå./images/emoji.png<br>
                        &nbsp;&nbsp;- ÌååÏùºÍ≤ΩÎ°ú: Í∏∞ÏÅ®file:///C:/images/happy.jpg<br>
                        &nbsp;&nbsp;- Base64: ÏõÉÏùådata:image/png;base64,iVBORw0K...<br>
                        ‚Ä¢ Îπà Ï§ÑÏùÄ ÏûêÎèôÏúºÎ°ú Í±¥ÎÑàÎúÅÎãàÎã§
                    </div>
                    <div id="bulk-preview-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; display: none;">
                        <strong>ÎØ∏Î¶¨Î≥¥Í∏∞ (ÌååÏã± Í≤∞Í≥º):</strong>
                        <div id="bulk-preview-content"></div>
                    </div>
                    <button type="button" id="preview-bulk-btn" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">ÎØ∏Î¶¨Î≥¥Í∏∞</button>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ÏùºÍ¥Ñ Ï†ÄÏû•</button>
                </form>
            </div>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet"><button class="action-sheet-button" id="edit-sticker-btn">Ìé∏Ïßë</button><button class="action-sheet-button danger" id="delete-sticker-btn">ÏÇ≠Ï†ú</button></div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ÏùåÏÑ± Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">ÏùåÏÑ± ÌÖçÏä§Ìä∏ ÏûÖÎ†•</label>
                    <textarea id="voice-text-input" placeholder="Ïó¨Í∏∞Ïóê ÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    ÏòàÏÉÅ ÏãúÍ∞Ñ: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">Î≥¥ÎÇ¥Í∏∞</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ÏÇ¨ÏßÑ/ÏòÅÏÉÅ Í≥µÏú†</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">ÏÑ§Î™Ö ÏûÖÎ†•</label>
                    <textarea id="pv-text-input" placeholder="Ïó¨Í∏∞Ïóê ÏÇ¨ÏßÑÏù¥ÎÇò ÏòÅÏÉÅ ÎÇ¥Ïö©ÏùÑ ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî..." required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Î≥¥ÎÇ¥Í∏∞</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ÏÜ°Í∏à</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">Í∏àÏï° (Ïõê)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">Î©îÎ™®</label>
                    <input type="text" id="transfer-remark-input" placeholder="(ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <button type="submit" class="btn btn-primary">Î≥¥ÎÇ¥Í∏∞</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ÏÑ†Î¨º Î≥¥ÎÇ¥Í∏∞</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">ÏÑ†Î¨º ÏÑ§Î™Ö</label>
                    <textarea id="gift-description-input" placeholder="ÌäπÎ≥ÑÌïú ÏÑ†Î¨ºÏùÑ Î≥¥ÎÉàÎã§Í≥† ÏïåÎ†§Ï£ºÏÑ∏Ïöî..." required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Î≥¥ÎÇ¥Í∏∞</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>Ïò§Îäò ÏûàÏóàÎçò Ïùº Í∏∞Î°ùÌïòÍ∏∞</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">Ïù¥Î≤§Ìä∏ ÏÑ§Î™Ö (Ïù¥ Î©îÏãúÏßÄÎäî AIÏóêÍ≤å Î≥¥Ïù¥Î©∞, Ïª®ÌÖçÏä§Ìä∏Î°ú ÏÇ¨Ïö©Îê©ÎãàÎã§)</label>
                    <textarea id="time-skip-input" placeholder="Ïòà: Ïö∞Î¶¨Îäî Ìï®Íªò ÏÇ∞ Ï†ïÏÉÅÏóê Ïò¨ÎùºÍ∞Ä ÏùºÎ™∞ÏùÑ Î≥¥Í≥† Î∞îÎ≤†ÌÅêÎ•º Î®πÏóàÏñ¥Ïöî." required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Î≥¥ÎÇ¥Í∏∞</button>
            </form>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">Î∞õÎäî ÏÇ¨Îûå ÏÑ†ÌÉù</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">ÌôïÏù∏</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">Î∞õÍ∏∞</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">Î∞òÌôò</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">Ï±ÑÌåÖ ÏÑ§Ï†ï</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="Ï∫êÎ¶≠ÌÑ∞ ÏïÑÎ∞îÌÉÄ" id="setting-char-avatar-preview" class="avatar-preview"><input type="file" id="setting-char-avatar-upload" accept="image/*" style="display:none;"><label for="setting-char-avatar-upload" class="btn btn-primary" style="flex-grow:1;">Ï∫êÎ¶≠ÌÑ∞ ÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω</label></div>
                <div class="form-group"><label for="setting-char-remark">Ï∫êÎ¶≠ÌÑ∞ Î©îÎ™® (Î≥ÑÎ™Ö)</label><input type="text" id="setting-char-remark"></div>
                <div class="form-group"><label for="setting-char-persona">Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï</label><textarea id="setting-char-persona" placeholder="Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÑ±Í≤©, Î∞∞Í≤Ω, ÎßêÌà¨ Îì±ÏùÑ ÏûêÏÑ∏Ìûà ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî."></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="ÎÇ¥ ÏïÑÎ∞îÌÉÄ" id="setting-my-avatar-preview" class="avatar-preview"><input type="file" id="setting-my-avatar-upload" accept="image/*" style="display:none;"><label for="setting-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">ÎÇ¥ ÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω</label></div>
                <div class="form-group"><label for="setting-my-name">ÎÇ¥ Ïù¥Î¶Ñ</label><input type="text" id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">ÎÇ¥ ÏÑ§Ï†ï</label><textarea id="setting-my-persona" placeholder="ÎåÄÌôîÏóêÏÑú Ïó∞Í∏∞ÌïòÍ≥† Ïã∂ÏùÄ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî."></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group"><button type="button" class="btn btn-secondary" id="link-world-book-btn">ÏÑ∏Í≥ÑÍ¥Ä Ïó∞Í≤∞</button></div>
                <div class="form-group"><label for="setting-theme-color">ÌÖåÎßà ÏÉâÏÉÅ (ÏÉÅÎåÄÎ∞©/ÎÇò)</label><select id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">ÎßêÌíçÏÑ† Ïä§ÌÉÄÏùº Ïª§Ïä§ÌÖÄ</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6" placeholder="Ïó¨Í∏∞Ïóê CSS ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...&#10;ÏòàÏãú:&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }" disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn" style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">Í∏∞Î≥∏Í∞íÏúºÎ°ú Î≥µÏõê</button>
                </div>

                <div class="form-group"><label for="setting-max-memory">ÏµúÎåÄ Í∏∞Ïñµ ÌÑ¥ Ïàò</label><input type="number" id="setting-max-memory" value="100" min="1"></div>
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">Ï±ÑÌåÖ Î∞∞Í≤Ω Î≥ÄÍ≤Ω</label><input type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div><button type="submit" class="btn btn-primary">ÏÑ§Ï†ï Ï†ÄÏû•</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><button type="button" class="btn btn-danger" id="clear-chat-history-btn">Ï±ÑÌåÖ Í∏∞Î°ù ÏÇ≠Ï†ú</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>Ïó∞Í≤∞Ìï† ÏÑ∏Í≥ÑÍ¥Ä ÏÑ†ÌÉù</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">ÌôïÏù∏</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>Í∑∏Î£πÏ±ÑÌåÖ ÎßåÎì§Í∏∞</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>Í∑∏Î£π Î©§Î≤Ñ ÏÑ†ÌÉù</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">Í∑∏Î£πÏ±ÑÌåÖ Ïù¥Î¶Ñ</label>
                    <input type="text" id="group-name-input" placeholder="Í∑∏Î£πÏ±ÑÌåÖ Ïù¥Î¶ÑÏùÑ ÏßÄÏñ¥Ï£ºÏÑ∏Ïöî" required>
                </div>
                <button type="submit" class="btn btn-primary">Í∑∏Î£πÏ±ÑÌåÖ ÎßåÎì§Í∏∞</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">Í∑∏Î£πÏ±ÑÌåÖ ÏÑ§Ï†ï</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="Í∑∏Î£π ÏïÑÎ∞îÌÉÄ" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary" style="flex-grow:1;">Í∑∏Î£π ÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">Í∑∏Î£π Ïù¥Î¶Ñ (AIÏóêÍ≤åÎèÑ Î≥¥ÏûÑ)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="ÎÇ¥ ÏïÑÎ∞îÌÉÄ" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">ÎÇ¥ ÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">ÎÇ¥ Í∑∏Î£π ÎãâÎÑ§ÏûÑ</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">ÎÇ¥ ÏÑ§Ï†ï</label>
                    <textarea id="setting-group-my-persona" placeholder="Ïù¥ Í∑∏Î£πÏ±ÑÌåÖÏóêÏÑú Ïó∞Í∏∞ÌïòÍ≥† Ïã∂ÏùÄ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî."></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>Í∑∏Î£π Î©§Î≤Ñ</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group"><button type="button" class="btn btn-secondary" id="link-group-world-book-btn">ÏÑ∏Í≥ÑÍ¥Ä Ïó∞Í≤∞</button></div>
                <div class="form-group"><label for="setting-group-theme-color">ÌÖåÎßà ÏÉâÏÉÅ (ÏÉÅÎåÄÎ∞©/ÎÇò)</label><select id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">ÎßêÌíçÏÑ† Ïä§ÌÉÄÏùº Ïª§Ïä§ÌÖÄ</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6" placeholder="Ïó¨Í∏∞Ïóê CSS ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...&#10;ÏòàÏãú:&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }" disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn" style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">Í∏∞Î≥∏Í∞íÏúºÎ°ú Î≥µÏõê</button>
                </div>

                <div class="form-group"><label for="setting-group-max-memory">ÏµúÎåÄ Í∏∞Ïñµ ÌÑ¥ Ïàò</label><input type="number" id="setting-group-max-memory" value="10" min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload" class="btn btn-primary">Ï±ÑÌåÖ Î∞∞Í≤Ω Î≥ÄÍ≤Ω</label><input type="file" id="setting-group-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">ÏÑ§Ï†ï Ï†ÄÏû•</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">Ï±ÑÌåÖ Í∏∞Î°ù ÏÇ≠Ï†ú</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">Í∑∏Î£π Î©§Î≤Ñ Ìé∏Ïßë</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="Î©§Î≤Ñ ÏïÑÎ∞îÌÉÄ" id="edit-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">Í∑∏Î£π ÎãâÎÑ§ÏûÑ</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">Ïã§Î™Ö</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">ÏÑ§Ï†ï</label>
                    <textarea id="edit-member-persona" placeholder="Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÑ±Í≤©, Î∞∞Í≤Ω Îì±ÏùÑ ÏûêÏÑ∏Ìûà ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ï†ÄÏû•</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Ï¥àÎåÄ</button>
            <button class="action-sheet-button" id="create-new-member-btn">ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Ïñ¥ Ï¥àÎåÄÌïòÍ∏∞</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>Í∑∏Î£πÏ±ÑÌåÖÏóê Î©§Î≤Ñ Ï¥àÎåÄ</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">Ï¥àÎåÄ ÌôïÏù∏</button>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Ïñ¥ Í∑∏Î£πÏóê Ï∂îÍ∞Ä</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="ÏÉà Î©§Î≤Ñ ÏïÑÎ∞îÌÉÄ" id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">Í∑∏Î£π ÎãâÎÑ§ÏûÑ</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">Ïã§Î™Ö</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">ÏÑ§Ï†ï</label>
                    <textarea id="create-group-member-persona" placeholder="Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÑ±Í≤©, Î∞∞Í≤Ω Îì±ÏùÑ ÏûêÏÑ∏Ìûà ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ÎßåÎì§Ïñ¥ÏÑú Ï∂îÍ∞Ä</button>
            </form>
        </div>
    </div>
</div>

<script>
    
    function getRandomValue(str) {
        
        if (str.includes(',')) {
            
            const arr = str.split(',').map(item => item.trim());
            
            const randomIndex = Math.floor(Math.random() * arr.length);
            
            return arr[randomIndex];
        }
        
        return str;
    }
    document.addEventListener('DOMContentLoaded', () => {
        
        const IS_DEVELOPMENT_MODE = false; 
        console.log('ÌòÑÏû¨ ÎπåÎìú Î™®Îìú:', IS_DEVELOPMENT_MODE ? 'Í∞úÎ∞úÏö© (Development)' : 'Î∞∞Ìè¨Ïö© (Production)');
        
        async function compressImage(file, options = {}) {
            const {
                quality = 0.8, maxWidth = 800, maxHeight = 800
            } = options;

            
            
            if (file.type === 'image/gif') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = reject;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        
                        
                        if (file.type === 'image/png') {
                            ctx.fillStyle = '#FFFFFF'; 
                            ctx.fillRect(0, 0, width, height);
                        }
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        
                        
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality); 
                        resolve(compressedDataUrl);
                    };
                };
            });
        }
        
        
        function initializeFontPresets() {
            
            console.log('Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            
            
            if (!db.globalFontPresets.presets.custom) {
                db.globalFontPresets.presets.custom = {
                    name: 'Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏',
                    url: '',
                    description: 'ÏßÅÏ†ë ÏûÖÎ†•Ìïú Ìè∞Ìä∏ URLÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§',
                    deletable: false 
                };
                console.log('Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã Ï∂îÍ∞ÄÎê®');
            } else {
                
                if (db.globalFontPresets.presets.custom.deletable === undefined) {
                    db.globalFontPresets.presets.custom.deletable = false;
                }
                console.log('Í∏∞Ï°¥ Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã ÌôïÏù∏Îê®:', db.globalFontPresets.presets.custom);
            }
            
            
            const defaultFonts = [
                {
                    id: 'default_1',
                    name: 'ÎÖ∏ÌÜ† ÏÇ∞Ïä§ KR',
                    url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap',
                    description: 'ÌïúÍµ≠Ïñ¥Ïóê ÏµúÏ†ÅÌôîÎêú Í≥†ÌíàÏßà Ìè∞Ìä∏'
                },
                {
                    id: 'default_2',
                    name: 'ÎÇòÎàî Í≥†Îîï',
                    url: 'https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap',
                    description: 'Í∞ÄÎèÖÏÑ±Ïù¥ Ï¢ãÏùÄ Í≥†ÎîïÏ≤¥'
                },
                {
                    id: 'default_3',
                    name: 'ÎÇòÎàî Î™ÖÏ°∞',
                    url: 'https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap',
                    description: 'Ï†ÑÌÜµÏ†ÅÏù∏ Î™ÖÏ°∞Ï≤¥'
                },
                {
                    id: 'default_4',
                    name: 'Ïã±Í∏Ä Îç∞Ïù¥',
                    url: 'https://fonts.googleapis.com/css2?family=Single+Day&display=swap',
                    description: 'Í∑ÄÏó¨Ïö¥ ÏÜêÍ∏ÄÏî® Ïä§ÌÉÄÏùº'
                },
                {
                    id: 'default_5',
                    name: 'Íµ¨Í∏∞',
                    url: 'https://fonts.googleapis.com/css2?family=Gugi&display=swap',
                    description: 'Îë•Í∏ÄÎë•Í∏ÄÌïú Í∑ÄÏó¨Ïö¥ Ìè∞Ìä∏'
                },
                {
                    id: 'default_6',
                    name: 'Ï£ºÏïÑ',
                    url: 'https://fonts.googleapis.com/css2?family=Jua&display=swap',
                    description: 'Î∂ÄÎìúÎü¨Ïö¥ ÏÜêÍ∏ÄÏî® Ïä§ÌÉÄÏùº'
                },
                {
                    id: 'default_7',
                    name: 'Í≤ÄÏùÄ ÌïúÏÇ∞',
                    url: 'https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap',
                    description: 'ÍµµÍ≥† Í∞ïÎ†¨Ìïú Ïù∏ÏÉÅÏùò Ìè∞Ìä∏'
                },
                {
                    id: 'default_8',
                    name: 'Ìï¥Î∞îÎùºÍ∏∞',
                    url: 'https://fonts.googleapis.com/css2?family=Sunflower:wght@300;500;700&display=swap',
                    description: 'Î∞ùÍ≥† Í≤ΩÏæåÌïú ÎäêÎÇåÏùò Ìè∞Ìä∏'
                },
                {
                    id: 'default_9',
                    name: 'Ïó∞ÏÑ±',
                    url: 'https://fonts.googleapis.com/css2?family=Yeon+Sung&display=swap',
                    description: 'Ï†ÑÌÜµÏ†ÅÏù∏ ÎäêÎÇåÏùò Ìè∞Ìä∏'
                },
                {
                    id: 'default_10',
                    name: 'IBM ÌîåÎ†âÏä§ ÏÇ∞Ïä§ KR',
                    url: 'https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@100;200;300;400;500;600;700&display=swap',
                    description: 'Í∏∞ÏóÖÏö©ÏúºÎ°ú Ï†ÅÌï©Ìïú Ï†ÑÎ¨∏Ï†ÅÏù∏ Ìè∞Ìä∏'
                },
                {
                    id: 'default_11',
                    name: 'Í≥†Ïö¥Î∞îÌÉï',
                    url: 'https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap',
                    description: 'Íµ¨Í∏Ä Ìè∞Ìä∏ Í≥†Ïö¥Î∞îÌÉï - ÍπîÎÅîÌïòÍ≥† Í∞ÄÎèÖÏÑ± Ï¢ãÏùÄ Ìè∞Ìä∏'
                },
                {
                    id: 'default_12',
                    name: 'ÌîÑÎ¶¨ÌÖêÎã§Îìú',
                    url: 'https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff',
                    description: 'ÌòÑÎåÄÏ†ÅÏù¥Í≥† Í∞ÄÎèÖÏÑ± Ï¢ãÏùÄ Ìè∞Ìä∏'
                },
                {
                    id: 'default_13',
                    name: 'Ïø†ÌÇ§Îü∞',
                    url: 'https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff',
                    description: 'Í∑ÄÏóΩÍ≥† ÏïÑÍ∏∞ÏûêÍ∏∞Ìïú Ìè∞Ìä∏'
                }
            ];
            
            
            defaultFonts.forEach(font => {
                if (!db.globalFontPresets.presets[font.id]) {
                    db.globalFontPresets.presets[font.id] = {
                        name: font.name,
                        url: font.url,
                        description: font.description,
                        deletable: true 
                    };
                    console.log(`Í∏∞Î≥∏ Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã Ï∂îÍ∞ÄÎê®: ${font.name}`);
                }
            });
            
            
            if (!db.globalFontPresets.presets[db.globalFontPresets.currentPreset]) {
                console.log('ÌòÑÏû¨ ÌîÑÎ¶¨ÏÖãÏù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏùå:', db.globalFontPresets.currentPreset);
                db.globalFontPresets.currentPreset = 'custom';
                console.log('currentPresetÏùÑ customÏúºÎ°ú Í∞ïÏ†ú ÏÑ§Ï†ï');
            }
            
            console.log('Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã Ï¥àÍ∏∞Ìôî ÏôÑÎ£å - ÏµúÏ¢Ö ÏÉÅÌÉú:', {
                currentPreset: db.globalFontPresets.currentPreset,
                availablePresets: Object.keys(db.globalFontPresets.presets)
            });
        }
        
        
        
        const githubInfoButtons = IS_DEVELOPMENT_MODE ? `
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
            <button type="button" id="github-info-download-btn" class="btn btn-neutral" style="width: 100%; margin-bottom: 10px;">GitHub Ï†ïÎ≥¥ Îã§Ïö¥Î°úÎìú</button>
            <button type="button" id="github-info-upload-btn" class="btn btn-secondary" style="width: 100%;">GitHub ÏÑ§Ï†ï ÏóÖÎ°úÎìú Î≥µÏõê</button>
            <input type="file" id="github-info-upload-input" accept=".json" style="display: none;">
        ` : '';
        
        
        const patIncludeOption = IS_DEVELOPMENT_MODE ? `
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="include-pat-in-download" checked>PAT ÌÇ§Î•º Îã§Ïö¥Î°úÎìúÏóê Ìè¨Ìï® (Í∞úÏù∏Ïö©)
                </label>
                <p style="font-size:12px; color:#888; margin-top:8px;">Ï≤¥ÌÅ¨ Ìï¥Ï†ú Ïãú PATÎäî Ï†úÏô∏Îê©ÎãàÎã§ (Î∞∞Ìè¨Ïö©)</p>
            </div>
        ` : '';

        document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‚Äπ</button><div class="title-container"><h1 class="title">API ÏÑ§Ï†ï</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API Í≥µÍ∏âÏûê</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (ÏÇ¨Ïö©Ïûê Ï†ïÏùò)</option><option value="openai">OpenAI (GPT)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option><option value="openrouter">OpenRouter</option></select></div><div class="form-group"><label for="api-url">API Ï£ºÏÜå (ÎÅùÏóê /v1Î•º Ï∂îÍ∞ÄÌïòÏßÄ ÎßàÏÑ∏Ïöî)</label><input type="url" id="api-url" name="url" placeholder="Í≥µÍ∏âÏûê ÏÑ†ÌÉù Ïãú ÏûêÎèô ÏôÑÏÑ±" required></div><div class="form-group"><label for="api-key">API ÌÇ§ (Key)</label><div style="position: relative;"><input type="password" id="api-key" name="key" placeholder="API ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required style="padding-right: 40px;"><button type="button" id="toggle-api-key-btn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; color: #666;">üîë</button></div></div><button type="button" class="btn btn-secondary" style= "margin-bottom: 20px;" id="fetch-models-btn"><span class="btn-text">Î™®Îç∏ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">Î™®Îç∏ ÏÑ†ÌÉù</label><div class="model-search-container" style="position: relative;"><input type="text" id="model-search" placeholder="Î™®Îç∏Î™Ö Í≤ÄÏÉâ... AND: free,gpt | OR: gpt-4|claude" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 8px; font-size: 14px;"><select id="api-model" name="model" required><option value="">Î®ºÏ†Ä Î™®Îç∏ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§ÏÑ∏Ïöî</option></select><div id="model-search-info" style="font-size: 12px; color: #888; margin-top: 5px; text-align: center;"></div></div></div><button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">Ï†ÄÏû•</span><div class="spinner"></div></button></form><hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;"><div style="margin-bottom: 20px;"><h3 style="margin: 13px 5px; font-size: 16px;     font-weight: 500; color: var(--text-color);">Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3><p style="font-size: 14px; color: #888; margin: 13px 5px 20px 5px;">Ï±ÑÌåÖ Îç∞Ïù¥ÌÑ∞, Ï∫êÎ¶≠ÌÑ∞, Í∑∏Î£πÏ±ÑÌåÖ, ÏÑ§Ï†ï Îì±ÏùÑ Î∞±ÏóÖÌïòÍ±∞ÎÇò Î≥µÏõêÌï† Ïàò ÏûàÏäµÎãàÎã§.</p><button type="button" class="btn btn-primary" id="backup-data-btn" style="width: 100%; margin-bottom: 10px;">Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ (Îã§Ïö¥Î°úÎìú)</button><button type="button" class="btn btn-secondary" id="restore-data-btn" style="width: 100%; margin-bottom: 10px;">Îç∞Ïù¥ÌÑ∞ Î≥µÏõê (ÏóÖÎ°úÎìú)</button><hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;"><div class="github-sync-section" style="margin-bottom: 20px;"><h4 style="margin-bottom: 15px; color: var(--text-color); cursor: pointer; font-size: 14px;" id="github-sync-toggle">GitHub ÎèôÍ∏∞Ìôî <span style="font-size: 12px; color: #888;">‚ñº</span></h4><div id="github-sync-content" style="display: none;"><div class="form-group"><label for="github-username">GitHub ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ</label><input type="text" id="github-username" placeholder="YourGitHubUsername"></div><div class="form-group"><label for="github-repo">Ï†ÄÏû•ÏÜå Ïù¥Î¶Ñ (Repository)</label><input type="text" id="github-repo" placeholder="my-chat-data-repo"></div><div class="form-group"><label for="github-pat">Í∞úÏù∏Ïö© Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ (PAT)</label><input type="password" id="github-pat" placeholder="ghp_..."><p style="font-size:12px; color:#888; margin-top:8px; margin: 8px 5px">ÌÜ†ÌÅ∞ÏùÄ <a href="https://github.com/settings/tokens/new?scopes=repo&description=GeminiChatSync" target="_blank">Ïó¨Í∏∞</a>ÏóêÏÑú 'repo' Í∂åÌïúÏúºÎ°ú ÏÉùÏÑ±ÌïòÏÑ∏Ïöî. ÌÜ†ÌÅ∞ÏùÄ Î∏åÎùºÏö∞Ï†ÄÏóêÎßå Ï†ÄÏû•Îê©ÎãàÎã§.</p></div><div class="form-group"><label for="github-filename">ÌååÏùºÎ™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label><input type="text" id="github-filename" value="phone-chat-data.json"></div>${patIncludeOption}<div class="form-group-checkbox"><label style="display: flex; align-items: center; gap: 10px;"><input type="checkbox" id="merge-data-on-restore" checked>Îç∞Ïù¥ÌÑ∞ Î≥µÏõê Ïãú Î≥ëÌï© Î™®Îìú (ÏïàÏ†Ñ)</label><p style="font-size:12px; color:#888; margin-top:8px;">Ï≤¥ÌÅ¨ Ïãú: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï© (ÏÜêÏã§ ÏóÜÏùå) | Ï≤¥ÌÅ¨ Ìï¥Ï†ú Ïãú: ÏôÑÏ†Ñ ÎçÆÏñ¥Ïì∞Í∏∞ (ÏúÑÌóò)</p></div><div class="css-actions"><button type="button" id="save-sync-settings-btn" class="btn btn-primary" style="width: 100%;">ÏÑ§Ï†ï Ï†ÄÏû•</button><button type="button" id="sync-up-btn" class="btn btn-secondary" style="width: 100%;" disabled>Îç∞Ïù¥ÌÑ∞ Ïò¨Î¶¨Í∏∞</button><button type="button" id="sync-down-btn" class="btn btn-danger" style="width: 100%;" disabled>Îç∞Ïù¥ÌÑ∞ ÎçÆÏñ¥Ïì∞Í∏∞</button>${githubInfoButtons}</div></div></div></div></main>`;
        document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‚Äπ</button><div class="title-container"><h1 class="title">Î∞∞Í≤ΩÌôîÎ©¥ Î≥ÄÍ≤Ω</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>ÌòÑÏû¨ Î∞∞Í≤ΩÌôîÎ©¥ ÎØ∏Î¶¨Î≥¥Í∏∞</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">Ïï®Î≤îÏóêÏÑú ÏÉà Î∞∞Í≤ΩÌôîÎ©¥ ÏÑ†ÌÉù</label></main>`;
        document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‚Äπ</button><div class="title-container"><h1 class="title">Í∏ÄÍº¥ ÏÑ§Ï†ï</h1></div><div class="placeholder"></div></header><main class="content"><div class="form-group"><label for="font-preset-selector">Ï†ÄÏû•Îêú Ìè∞Ìä∏ ÏÑ†ÌÉù</label><select id="font-preset-selector" class="form-select"></select><p class="font-description" id="font-description" style="font-size:12px; color:#666; margin-top:8px; margin-bottom:15px;">ÌîÑÎ¶¨ÏÖãÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p></div><hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;"><form id="font-settings-form"><div class="form-group"><label for="font-url">Ìè∞Ìä∏ URL</label><input type="url" id="font-url" placeholder="Ïó¨Í∏∞Ïóê Ìè∞Ìä∏ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;"><p style="font-size:12px; color:#888;">Ìè∞Ìä∏ ÌååÏùº URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p></div><div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 15px;"><input type="text" id="new-preset-name" placeholder="Ìè∞Ìä∏ Ïù¥Î¶Ñ (Ïòà: ÎÇòÎàîÍ≥†Îîï)" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px;"><input type="text" id="new-preset-description" placeholder="ÏÑ§Î™Ö (ÏÑ†ÌÉù)" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px;"></div><div class="font-actions" style="display: flex; gap: 10px; margin-top: 20px;"><button type="button" class="btn btn-primary" id="apply-font-btn" style="flex: 1;">Ìè∞Ìä∏ Ï†ÅÏö©</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="flex: 0.7;">Í∏∞Î≥∏ Ìè∞Ìä∏</button></div></form><hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;"><div style="margin-bottom: 20px;"><h3 style="margin-bottom: 15px; color: var(--text-color);">ÌîÑÎ¶¨ÏÖã Í¥ÄÎ¶¨</h3><button type="button" class="btn btn-secondary" id="save-preset-btn" style="width: 100%; margin-bottom: 10px;">ÌîÑÎ¶¨ÏÖã Îì±Î°ù</button><button type="button" class="btn btn-danger" id="delete-preset-btn" style="width: 100%;" disabled>ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú</button></div></main>`;
        document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‚Äπ</button><div class="title-container"><h1 class="title">Ìôà ÌôîÎ©¥ Ïª§Ïä§ÌÖÄ</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;
        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‚Äπ</button><div class="title-container"><h1 class="title">ÌäúÌÜ†Î¶¨Ïñº</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

        
        const colorThemes = {
            'white_pink': { name: 'Ìù∞ÏÉâ/Î∂ÑÌôç', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(255,204,204,0.9)', text: '#A56767' } },
            'white_blue': { name: 'Ìù∞ÏÉâ/ÌååÎûë', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' } },
            'white_yellow': { name: 'Ìù∞ÏÉâ/ÎÖ∏Îûë', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B' } },
            'white_green': { name: 'Ìù∞ÏÉâ/Ï¥àÎ°ù', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(188,238,188,0.9)', text: '#4F784F' } },
            'white_purple': { name: 'Ìù∞ÏÉâ/Î≥¥Îùº', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' } },
            'black_red': { name: 'Í≤ÄÏ†ï/Îπ®Í∞ï', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgb(226,62,87,0.9)', text: '#fff' } },
            'black_green': { name: 'Í≤ÄÏ†ï/Ï¥àÎ°ù', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E' } },
            'black_white': { name: 'Í≤ÄÏ†ï/Ìù∞ÏÉâ', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgba(245,245,245,0.9)', text: '#333' } },
            'white_black': { name: 'Ìù∞ÏÉâ/Í≤ÄÏ†ï', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5' } },
            'yellow_purple': { name: 'ÎÖ∏Îûë/Î≥¥Îùº', received: { bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B' }, sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' } },
            'pink_blue': { name: 'Î∂ÑÌôç/ÌååÎûë', received: { bg: 'rgba(255,231,240,0.9)', text: '#7C6770' }, sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' } },
        };
        const defaultIcons = {
            'chat-list-screen': { name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png' },
            'api-settings-screen': { name: 'API', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png' },
            'wallpaper-screen': { name: 'Î∞∞Í≤ΩÌôîÎ©¥', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png' },
            'world-book-screen': { name: 'ÏÑ∏Í≥ÑÍ¥Ä', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png' },
            'customize-screen': { name: 'Ïª§Ïä§ÌÖÄ', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png' },
            'font-settings-screen': { name: 'Í∏ÄÍº¥', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png' },
            'tutorial-screen': { name: 'ÌäúÌÜ†Î¶¨Ïñº', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png' },
            'day-mode-btn': { name: '', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png' },
            'night-mode-btn': { name: '', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png' }
        };

        let db = { characters: [], groups: [], apiSettings: {}, wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg', myStickers: [], homeScreenMode: 'night', worldBooks: [], fontUrl: '', customIcons: {}, globalCustomCSS: { enabled: true, currentPreset: 'default', presets: { 'default': { name: 'Í∏∞Î≥∏', css: '', description: 'Í∏∞Î≥∏ ÌÖåÎßà' } } }, globalFontPresets: { enabled: true, currentPreset: 'default', presets: {} }, customFontInput: { name: '', url: '', description: '' } };
        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null, isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null, currentEditingWorldBookId = null, currentStickerActionTarget = null, currentGroupAction = { type: null, recipients: [] };
        let selectedMessageIds = new Set();
        const MESSAGES_PER_PAGE = 50;

        
        const screens = document.querySelectorAll('.screen'), toastElement = document.getElementById('toast-notification'), homeScreen = document.getElementById('home-screen'), chatListContainer = document.getElementById('chat-list-container'), noChatsPlaceholder = document.getElementById('no-chats-placeholder'), addChatBtn = document.getElementById('add-chat-btn'), addCharModal = document.getElementById('add-char-modal'), addCharForm = document.getElementById('add-char-form'), chatRoomScreen = document.getElementById('chat-room-screen'), chatRoomHeaderDefault = document.getElementById('chat-room-header-default'), chatRoomHeaderSelect = document.getElementById('chat-room-header-select'), cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'), multiSelectTitle = document.getElementById('multi-select-title'), chatRoomTitle = document.getElementById('chat-room-title'), chatRoomStatusText = document.getElementById('chat-room-status-text'), messageArea = document.getElementById('message-area'), messageInputDefault = document.getElementById('message-input-default'), messageInput = document.getElementById('message-input'), sendMessageBtn = document.getElementById('send-message-btn'), getReplyBtn = document.getElementById('get-reply-btn'), typingIndicator = document.getElementById('typing-indicator'), chatSettingsBtn = document.getElementById('chat-settings-btn'), settingsSidebar = document.getElementById('chat-settings-sidebar'), settingsForm = document.getElementById('chat-settings-form'), messageEditBar = document.getElementById('message-edit-bar'), messageEditInput = document.getElementById('message-edit-input'), saveEditBtn = document.getElementById('save-edit-btn'), cancelEditBtn = document.getElementById('cancel-edit-btn'), multiSelectBar = document.getElementById('multi-select-bar'), selectCount = document.getElementById('select-count'), deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const stickerToggleBtn = document.getElementById('sticker-toggle-btn'), stickerModal = document.getElementById('sticker-modal'), stickerGridContainer = document.getElementById('sticker-grid-container'), addNewStickerBtn = document.getElementById('add-new-sticker-btn'), addStickerModal = document.getElementById('add-sticker-modal'), addStickerModalTitle = document.getElementById('add-sticker-modal-title'), addStickerForm = document.getElementById('add-sticker-form'), stickerEditIdInput = document.getElementById('sticker-edit-id'), stickerPreview = document.getElementById('sticker-preview'), stickerNameInput = document.getElementById('sticker-name'), stickerUrlInput = document.getElementById('sticker-url-input'), stickerFileUpload = document.getElementById('sticker-file-upload');
        const stickerActionSheet = document.getElementById('sticker-actionsheet'), editStickerBtn = document.getElementById('edit-sticker-btn'), deleteStickerBtn = document.getElementById('delete-sticker-btn');
        const voiceMessageBtn = document.getElementById('voice-message-btn'), sendVoiceModal = document.getElementById('send-voice-modal'), sendVoiceForm = document.getElementById('send-voice-form'), voiceTextInput = document.getElementById('voice-text-input'), voiceDurationPreview = document.getElementById('voice-duration-preview');
        const photoVideoBtn = document.getElementById('photo-video-btn'), sendPvModal = document.getElementById('send-pv-modal'), sendPvForm = document.getElementById('send-pv-form'), pvTextInput = document.getElementById('pv-text-input');
        const imageRecognitionBtn = document.getElementById('image-recognition-btn'), imageUploadInput = document.getElementById('image-upload-input');
        const walletBtn = document.getElementById('wallet-btn'), sendTransferModal = document.getElementById('send-transfer-modal'), sendTransferForm = document.getElementById('send-transfer-form'), transferAmountInput = document.getElementById('transfer-amount-input'), transferRemarkInput = document.getElementById('transfer-remark-input');
        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'), acceptTransferBtn = document.getElementById('accept-transfer-btn'), returnTransferBtn = document.getElementById('return-transfer-btn');
        const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'), sendGiftForm = document.getElementById('send-gift-form'), giftDescriptionInput = document.getElementById('gift-description-input');
        const timeSkipBtn = document.getElementById('time-skip-btn'), timeSkipModal = document.getElementById('time-skip-modal'), timeSkipForm = document.getElementById('time-skip-form'), timeSkipInput = document.getElementById('time-skip-input');
        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
        const worldBookListContainer = document.getElementById('world-book-list-container'), noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'), addWorldBookBtn = document.getElementById('add-world-book-btn'), editWorldBookScreen = document.getElementById('edit-world-book-screen'), editWorldBookForm = document.getElementById('edit-world-book-form'), worldBookIdInput = document.getElementById('world-book-id'), worldBookNameInput = document.getElementById('world-book-name'), worldBookContentInput = document.getElementById('world-book-content');
        const linkWorldBookBtn = document.getElementById('link-world-book-btn'), worldBookSelectionModal = document.getElementById('world-book-selection-modal'), worldBookSelectionList = document.getElementById('world-book-selection-list'), saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
        const fontSettingsForm = document.getElementById('font-settings-form'), fontUrlInput = document.getElementById('font-url'), restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
        const createGroupBtn = document.getElementById('create-group-btn'), createGroupModal = document.getElementById('create-group-modal'), createGroupForm = document.getElementById('create-group-form'), memberSelectionList = document.getElementById('member-selection-list'), groupNameInput = document.getElementById('group-name-input'), groupSettingsSidebar = document.getElementById('group-settings-sidebar'), groupSettingsForm = document.getElementById('group-settings-form'), groupMembersListContainer = document.getElementById('group-members-list-container'), editGroupMemberModal = document.getElementById('edit-group-member-modal'), editGroupMemberForm = document.getElementById('edit-group-member-form');
        const addMemberActionSheet = document.getElementById('add-member-actionsheet'), inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'), createNewMemberBtn = document.getElementById('create-new-member-btn'), inviteMemberModal = document.getElementById('invite-member-modal'), inviteMemberSelectionList = document.getElementById('invite-member-selection-list'), confirmInviteBtn = document.getElementById('confirm-invite-btn'), createMemberForGroupModal = document.getElementById('create-member-for-group-modal'), createMemberForGroupForm = document.getElementById('create-member-for-group-form');
        const customizeForm = document.getElementById('customize-form'), tutorialContentArea = document.getElementById('tutorial-content-area');
        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'), groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'), confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'), groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');
        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');
        const attachmentToggleBtn = document.getElementById('attachment-toggle-btn');
        const stickerBar = document.getElementById('sticker-bar');
        const textarea = document.querySelector('.message-input-area textarea');
        
        const saveData = () => localStorage.setItem('gemini-chat-app-db', JSON.stringify(db));
        const loadData = () => {
            const data = localStorage.getItem('gemini-chat-app-db');
            if (data) db = JSON.parse(data);
            
            if (!db.apiSettings) db.apiSettings = {};
            if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
            if (!db.characters) db.characters = [];
            if (!db.groups) db.groups = [];
            if (!db.myStickers) db.myStickers = [];
            if (!db.homeScreenMode) db.homeScreenMode = 'night';
            if (!db.worldBooks) db.worldBooks = [];
            
            if (!db.customIcons) db.customIcons = {};
            if (!db.globalCustomCSS) db.globalCustomCSS = { enabled: true, currentPreset: 'default', presets: { 'default': { name: 'Í∏∞Î≥∏', css: '', description: 'Í∏∞Î≥∏ ÌÖåÎßà' } } };
            if (!db.globalFontPresets) db.globalFontPresets = { enabled: true, currentPreset: 'custom', presets: {} };
            
            if (db.globalFontPresets.currentPreset === 'default' || !db.globalFontPresets.currentPreset) {
                db.globalFontPresets.currentPreset = 'custom';
                console.log('ÏûòÎ™ªÎêú currentPresetÏùÑ customÏúºÎ°ú ÏàòÏ†ïÌï®');
            }
            
            initializeFontPresets();
            db.characters.forEach(c => {
                if (c.isPinned === undefined) c.isPinned = false;
                if (c.status === undefined) c.status = 'Ïò®ÎùºÏù∏';
                if (!c.worldBookIds) c.worldBookIds = [];
                if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
            });
            db.groups.forEach(g => {
                if (g.isPinned === undefined) g.isPinned = false;
                if (!g.worldBookIds) g.worldBookIds = [];
                if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
            });
        };
        const showToast = (message) => {
            toastElement.textContent = message;
            toastElement.classList.add('show');
            setTimeout(() => toastElement.classList.remove('show'), 3000);
        };
        const switchScreen = (targetId) => {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');
            
            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
            overlays.forEach(o => o.classList.remove('visible', 'open'));
        };
        const pad = (num) => num.toString().padStart(2, '0');

        function createContextMenu(items, x, y) {
            removeContextMenu();
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                if (item.danger) menuItem.classList.add('danger');
                menuItem.textContent = item.label;
                menuItem.onclick = () => {
                    item.action();
                    removeContextMenu();
                };
                menu.appendChild(menuItem);
            });
            document.body.appendChild(menu);
            document.addEventListener('click', removeContextMenu, { once: true });
        }

        function removeContextMenu() {
            const menu = document.querySelector('.context-menu');
            if (menu) menu.remove();
        }

        function updateCustomBubbleStyle(chatId, css, enabled) {
            const styleId = `custom-bubble-style-for-${chatId}`;
            let styleElement = document.getElementById(styleId);

            if (enabled && css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);
                styleElement.innerHTML = scopedCss;
            } else {
                if (styleElement) styleElement.remove();
            }
        }

        
        function applyGlobalCustomCSS() {
            if (!db.globalCustomCSS.enabled) {
                return;
            }
            const preset = db.globalCustomCSS.presets[db.globalCustomCSS.currentPreset];
            if (!preset || !preset.css) {
                return;
            }
            let styleElement = document.getElementById('global-custom-style');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'global-custom-style';
                document.head.appendChild(styleElement);
            }
            styleElement.innerHTML = preset.css;
        }

        function removeGlobalCustomCSS() {
            const styleElement = document.getElementById('global-custom-style');
            if (styleElement) {
                styleElement.remove();
            }
        }

        function updateGlobalCustomCSS() {
            if (db.globalCustomCSS.enabled) {
                applyGlobalCustomCSS();
            } else {
                removeGlobalCustomCSS();
            }
        }

        function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {
            previewContainer.innerHTML = '';

            const sentBubble = document.createElement('div');
            sentBubble.className = 'message-bubble sent';
            sentBubble.textContent = 'Ïù¥Í≤ÉÏùÄ ÎÇ¥ ÎßêÌíçÏÑ†ÏûÖÎãàÎã§.';
            sentBubble.style.alignSelf = 'flex-end';
            sentBubble.style.borderBottomRightRadius = '5px';

            const receivedBubble = document.createElement('div');
            receivedBubble.className = 'message-bubble received';
            receivedBubble.textContent = 'Ïù¥Í≤ÉÏùÄ ÏÉÅÎåÄÎ∞© ÎßêÌíçÏÑ†ÏûÖÎãàÎã§.';
            receivedBubble.style.alignSelf = 'flex-start';
            receivedBubble.style.borderBottomLeftRadius = '5px';

            [sentBubble, receivedBubble].forEach(bubble => {
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '8px 12px';
                bubble.style.wordWrap = 'break-word';
                bubble.style.lineHeight = '1.4';
            });

            if (useDefault || !css) {
                sentBubble.style.backgroundColor = theme.sent.bg;
                sentBubble.style.color = theme.sent.text;
                sentBubble.style.borderRadius = '18px';
                sentBubble.style.borderBottomRightRadius = '5px';
                receivedBubble.style.backgroundColor = theme.received.bg;
                receivedBubble.style.color = theme.received.text;
                receivedBubble.style.borderRadius = '18px';
                receivedBubble.style.borderBottomLeftRadius = '5px';
            } else {
                const styleTag = document.createElement('style');
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
                styleTag.textContent = scopedCss;
                previewContainer.appendChild(styleTag);
            }
            previewContainer.appendChild(receivedBubble);
            previewContainer.appendChild(sentBubble);
        }
function setupGitHubSync() {
    const usernameInput = document.getElementById('github-username');
    const repoInput = document.getElementById('github-repo');
    const patInput = document.getElementById('github-pat');
    const filenameInput = document.getElementById('github-filename');
    const saveBtn = document.getElementById('save-sync-settings-btn');
    const syncUpBtn = document.getElementById('sync-up-btn');
    const syncDownBtn = document.getElementById('sync-down-btn');
    
    const githubInfoDownloadBtn = document.getElementById('github-info-download-btn');
    const githubInfoUploadBtn = document.getElementById('github-info-upload-btn');
    const githubInfoUploadInput = document.getElementById('github-info-upload-input');
    const githubSyncToggle = document.getElementById('github-sync-toggle');
    const githubSyncContent = document.getElementById('github-sync-content');

    
    const savedSettings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
    if (savedSettings) {
        usernameInput.value = savedSettings.username || '';
        repoInput.value = savedSettings.repo || '';
        patInput.value = savedSettings.pat || '';
        filenameInput.value = savedSettings.filename || 'phone-chat-data.json';
        
        
        const includePatCheckbox = document.getElementById('include-pat-in-download');
        if (includePatCheckbox) {
            includePatCheckbox.checked = savedSettings.includePatInDownload !== false;
            console.log('üîß DEBUG: PAT Ìè¨Ìï® ÏòµÏÖò Î≥µÏõêÎê®:', includePatCheckbox.checked);
        } else if (!IS_DEVELOPMENT_MODE) {
            console.log('üîß DEBUG: PAT Ìè¨Ìï® ÏòµÏÖò ÎπÑÌôúÏÑ±ÌôîÎê® (Î∞∞Ìè¨ Î™®Îìú)');
        }

        
        const mergeDataCheckbox = document.getElementById('merge-data-on-restore');
        if (mergeDataCheckbox) {
            mergeDataCheckbox.checked = savedSettings.mergeDataOnRestore !== false;
        }
        
        updateSyncButtonsState();
        console.log('GitHub ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å:', { 
            username: savedSettings.username, 
            repo: savedSettings.repo, 
            pat: savedSettings.pat ? '***' : 'ÏóÜÏùå',
            includePatInDownload: savedSettings.includePatInDownload !== false
        });
    }

    
    function updateSyncButtonsState() {
        const settings = {
            username: usernameInput.value.trim(),
            repo: repoInput.value.trim(),
            pat: patInput.value.trim(),
        };
        if (settings.username && settings.repo && settings.pat) {
            syncUpBtn.disabled = false;
            syncDownBtn.disabled = false;
        } else {
            syncUpBtn.disabled = true;
            syncDownBtn.disabled = true;
        }
    }

    saveBtn.addEventListener('click', () => {
        const includePatCheckbox = document.getElementById('include-pat-in-download');
        const mergeDataCheckbox = document.getElementById('merge-data-on-restore');
        const settings = {
            username: usernameInput.value.trim(),
            repo: repoInput.value.trim(),
            pat: patInput.value.trim(),
            filename: filenameInput.value.trim() || 'phone-chat-data.json',
            includePatInDownload: includePatCheckbox ? includePatCheckbox.checked : !IS_DEVELOPMENT_MODE ? false : true,
            mergeDataOnRestore: mergeDataCheckbox ? mergeDataCheckbox.checked : true
        };
        localStorage.setItem('gemini-chat-sync-settings', JSON.stringify(settings));
        showToast('GitHub ÎèôÍ∏∞Ìôî ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        updateSyncButtonsState();
        console.log('GitHub ÏÑ§Ï†ï Ï†ÄÏû• ÏôÑÎ£å:', { ...settings, pat: settings.pat ? '***' : 'ÏóÜÏùå' });
    });

    
    githubSyncToggle.addEventListener('click', () => {
        const isHidden = githubSyncContent.style.display === 'none';
        githubSyncContent.style.display = isHidden ? 'block' : 'none';
        
        
        const arrow = githubSyncToggle.querySelector('span');
        arrow.textContent = isHidden ? '‚ñ≤' : '‚ñº';
        
        console.log('GitHub ÎèôÍ∏∞Ìôî ÏÑπÏÖò ÌÜ†Í∏Ä:', isHidden ? 'ÌéºÏπ®' : 'Ï†ëÏùå');
    });



    
    if (IS_DEVELOPMENT_MODE && githubInfoDownloadBtn) {
        console.log('üîß DEBUG: GitHub Ï†ïÎ≥¥ Îã§Ïö¥Î°úÎìú Í∏∞Îä• ÌôúÏÑ±ÌôîÎê® (Í∞úÎ∞ú Î™®Îìú)');
        githubInfoDownloadBtn.addEventListener('click', () => {
            const settings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
            if (!settings || !settings.username || !settings.repo) {
                showToast('GitHub ÏÑ§Ï†ïÏùÑ Î®ºÏ†Ä Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const includePatCheckbox = document.getElementById('include-pat-in-download');
            
            const includePat = includePatCheckbox ? includePatCheckbox.checked : !IS_DEVELOPMENT_MODE ? false : true;

            const githubInfo = {
                username: settings.username,
                repository: settings.repo,
                filename: settings.filename || 'phone-chat-data.json',
                lastUpdated: new Date().toISOString(),
                note: includePat ? 'Ïù¥ ÌååÏùºÏùÄ GitHub ÎèôÍ∏∞Ìôî ÏÑ§Ï†ï Ï†ïÎ≥¥ÏûÖÎãàÎã§. (Í∞úÏù∏Ïö© - PAT Ìè¨Ìï®)' : 'Ïù¥ ÌååÏùºÏùÄ GitHub ÎèôÍ∏∞Ìôî ÏÑ§Ï†ï Ï†ïÎ≥¥ÏûÖÎãàÎã§. (Î∞∞Ìè¨Ïö© - PAT Ï†úÏô∏)'
            };

            if (includePat && settings.pat) {
                githubInfo.pat = settings.pat;
            }

            const blob = new Blob([JSON.stringify(githubInfo, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `github-sync-info-${settings.username}-${settings.repo}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(includePat ? 'GitHub Ï†ïÎ≥¥Í∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§. (PAT Ìè¨Ìï®)' : 'GitHub Ï†ïÎ≥¥Í∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§. (PAT Ï†úÏô∏)');
        });
    } else if (!IS_DEVELOPMENT_MODE) {
        console.log('üîß DEBUG: GitHub Ï†ïÎ≥¥ Îã§Ïö¥Î°úÎìú Í∏∞Îä• ÎπÑÌôúÏÑ±ÌôîÎê® (Î∞∞Ìè¨ Î™®Îìú)');
    }

    
    if (IS_DEVELOPMENT_MODE && githubInfoUploadBtn && githubInfoUploadInput) {
        console.log('üîß DEBUG: GitHub Ï†ïÎ≥¥ ÏóÖÎ°úÎìú Í∏∞Îä• ÌôúÏÑ±ÌôîÎê® (Í∞úÎ∞ú Î™®Îìú)');
        githubInfoUploadBtn.addEventListener('click', () => {
            githubInfoUploadInput.click();
        });

        githubInfoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showToast('‚ùå JSON ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const githubSettings = JSON.parse(event.target.result);
                    
                    if (!githubSettings.username || !githubSettings.repository) {
                        showToast('‚ùå Ïò¨Î∞îÎ•∏ GitHub ÏÑ§Ï†ï ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§. (username, repository ÌïÑÏàò)');
                        return;
                    }

                    
                    usernameInput.value = githubSettings.username || '';
                    repoInput.value = githubSettings.repository || '';
                    patInput.value = githubSettings.pat || '';
                    filenameInput.value = githubSettings.filename || 'phone-chat-data.json';

                    
                    const includePatCheckbox = document.getElementById('include-pat-in-download');
                    if (includePatCheckbox) {
                        includePatCheckbox.checked = !!githubSettings.pat;
                    }

                    
                    const settings = {
                        username: githubSettings.username,
                        repo: githubSettings.repository,
                        pat: githubSettings.pat || '',
                        filename: githubSettings.filename || 'phone-chat-data.json',
                        includePatInDownload: !!githubSettings.pat
                    };
                    localStorage.setItem('gemini-chat-sync-settings', JSON.stringify(settings));
                    
                    
                    updateSyncButtonsState();
                    
                    showToast('‚úÖ GitHub ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§!');

                } catch (error) {
                    showToast('‚ùå ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                }
            };

            reader.onerror = () => {
                showToast('‚ùå ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            };

            reader.readAsText(file);
        });
    } else if (!IS_DEVELOPMENT_MODE) {
        console.log('üîß DEBUG: GitHub Ï†ïÎ≥¥ ÏóÖÎ°úÎìú Í∏∞Îä• ÎπÑÌôúÏÑ±ÌôîÎê® (Î∞∞Ìè¨ Î™®Îìú)');
    }

    
    syncUpBtn.addEventListener('click', syncUp);
    syncDownBtn.addEventListener('click', syncDown);
}


function deepMerge(existing, incoming) {
    if (incoming === null || incoming === undefined) {
        return existing;
    }
    
    if (existing === null || existing === undefined) {
        return incoming;
    }
    
    
    if (Array.isArray(incoming)) {
        if (Array.isArray(existing)) {
            return mergeArrays(existing, incoming);
        } else {
            return incoming;
        }
    }
    
    
    if (typeof incoming !== 'object') {
        if (existing !== null && existing !== undefined) {
            return existing; 
        }
        return incoming;
    }
    
    
    const result = { ...existing };
    
    for (const key in incoming) {
        if (incoming.hasOwnProperty(key)) {
            if (existing && existing.hasOwnProperty(key)) {
                result[key] = deepMerge(existing[key], incoming[key]);
            } else {
                result[key] = incoming[key];
            }
        }
    }
    
    return result;
}


function mergeArrays(existingArray, incomingArray) {
    const result = [...existingArray];
    const existingIds = new Set();
    
    
    existingArray.forEach((item, index) => {
        const id = item.id || item.name || item.timestamp || item.chatId || index;
        existingIds.add(id);
    });
    
    
    let addedCount = 0;
    incomingArray.forEach((item, index) => {
        const id = item.id || item.name || item.timestamp || item.chatId || index;
        
        if (!existingIds.has(id)) {
            result.push(item);
            existingIds.add(id);
            addedCount++;
        }
    });
    
    if (addedCount > 0) {
        console.log(`Î∞∞Ïó¥ Î≥ëÌï© ÏôÑÎ£å: ${addedCount}Í∞ú Ìï≠Î™© Ï∂îÍ∞Ä (${existingArray.length} ‚Üí ${result.length})`);
    }
    
    return result;
}


async function syncUp() {
    if (!confirm('ÌòÑÏû¨ Í∏∞Í∏∞Ïùò Îç∞Ïù¥ÌÑ∞Î•º GitHubÏóê Ïò¨Î†§ Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú Î∞õÏùÑ Ïàò ÏûàÎèÑÎ°ù Ìï©ÎãàÎã§. ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

    const settings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
    if (!settings) return showToast('ÎèôÍ∏∞Ìôî ÏÑ§Ï†ïÏùÑ Î®ºÏ†Ä Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');

    const { username, repo, pat, filename } = settings;
    const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filename}`;
    
    const localDataString = localStorage.getItem('gemini-chat-app-db');
    if (!localDataString) return showToast('Î∞±ÏóÖÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
    
    
    let dataToUpload = JSON.parse(localDataString);
    if (dataToUpload.apiSettings) {
        delete dataToUpload.apiSettings;
    }
    
    const cleanDataString = JSON.stringify(dataToUpload);
    const contentBase64 = btoa(unescape(encodeURIComponent(cleanDataString)));

    showToast('Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú Ï§ë...');

    try {
        
        let fileSha = null;
        try {
            const getFileResponse = await fetch(apiUrl, {
                headers: { 'Authorization': `token ${pat}` }
            });
            if (getFileResponse.ok) {
                const fileData = await getFileResponse.json();
                fileSha = fileData.sha;
            }
        } catch (e) {  }

        
        const payload = {
            message: `Sync data from Gemini Chat on ${new Date().toISOString()}`,
            content: contentBase64,
            sha: fileSha 
        };

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${pat}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = errorData.message ? `${errorData.message} (GitHub)` : 'Unknown error';
            throw new Error(errorMessage);
        }

        showToast('‚úÖ Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú ÏÑ±Í≥µ!');
    } catch (error) {
        console.error('Sync Up Error:', error);
        showToast(`‚ùå ÏóÖÎ°úÎìú Ïã§Ìå®: ${error.message}`);
    }
}
async function syncDown() {
    const settings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
    if (!settings) return showToast('ÎèôÍ∏∞Ìôî ÏÑ§Ï†ïÏùÑ Î®ºÏ†Ä Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
    
    
    const mergeCheckbox = document.getElementById('merge-data-on-restore');
    const useMergeMode = mergeCheckbox ? mergeCheckbox.checked : true;
    const modeText = useMergeMode ? 'Î≥ëÌï© (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)' : 'ÏôÑÏ†Ñ ÎçÆÏñ¥Ïì∞Í∏∞ (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú)';
    
    console.log('Îç∞Ïù¥ÌÑ∞ Î≥µÏõê Î™®Îìú:', useMergeMode ? 'MERGE' : 'REPLACE');
    
    if (!confirm(`GitHubÏùò Îç∞Ïù¥ÌÑ∞Î•º ÌòÑÏû¨ Í∏∞Í∏∞Ïóê Î≥µÏõêÌï©ÎãàÎã§.\n\nÎ™®Îìú: ${modeText}\n\n${useMergeMode ? 'Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï©ÎêòÏñ¥ Îç∞Ïù¥ÌÑ∞ ÏÜêÏã§Ïù¥ ÏóÜÏäµÎãàÎã§.' : 'ÌòÑÏû¨ Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§! (API ÏÑ§Ï†ïÏùÄ Ïú†ÏßÄ)'}\n\nÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
    
    const { username, repo, pat, filename } = settings;
    const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filename}`;

    showToast(`Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú Ï§ë... (${useMergeMode ? 'Î≥ëÌï© Î™®Îìú' : 'ÎçÆÏñ¥Ïì∞Í∏∞ Î™®Îìú'})`);

    try {
        
        const localDbString = localStorage.getItem('gemini-chat-app-db');
        const localDb = localDbString ? JSON.parse(localDbString) : {};
        const localApiSettings = localDb.apiSettings;
        
        
        const backupKey = 'gemini-chat-app-db-emergency-backup';
        localStorage.setItem(backupKey, localDbString || '{}');

        
        const response = await fetch(apiUrl, {
            headers: { 'Authorization': `token ${pat}` }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'File not found');
        }

        const data = await response.json();
        const contentBase64 = data.content;
        
        
        let downloadedJsonData, downloadedDb;
        
        try {
            downloadedJsonData = decodeURIComponent(escape(atob(contentBase64)));
            downloadedDb = JSON.parse(downloadedJsonData);
            
            if (!downloadedDb || typeof downloadedDb !== 'object') {
                throw new Error('Îã§Ïö¥Î°úÎìúÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•∏ Í∞ùÏ≤¥ ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.');
            }
            
        } catch (parseError) {
            throw new Error(`Îã§Ïö¥Î°úÎìúÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÜêÏÉÅÎêòÏóàÏäµÎãàÎã§: ${parseError.message}`);
        }

        
        let finalDb;
        if (useMergeMode) {
            finalDb = deepMerge(localDb, downloadedDb);
        } else {
            finalDb = downloadedDb;
        }

        
        if (localApiSettings) {
            finalDb.apiSettings = localApiSettings;
        }

        
        try {
            const finalDbString = JSON.stringify(finalDb);
            
            if (!finalDbString || finalDbString === '{}' || finalDbString === 'null') {
                throw new Error('ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            }
            
            localStorage.setItem('gemini-chat-app-db', finalDbString);
            
            const savedData = localStorage.getItem('gemini-chat-app-db');
            if (!savedData) {
                throw new Error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÌõÑ Í≤ÄÏ¶ù Ïã§Ìå® - localStorageÏóê Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùå');
            }
            
            
            localStorage.removeItem(backupKey);
            
            showToast(`‚úÖ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏÑ±Í≥µ! (${useMergeMode ? 'Î≥ëÌï© ÏôÑÎ£å' : 'ÎçÆÏñ¥Ïì∞Í∏∞ ÏôÑÎ£å'}) Ïï±ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.`);
            
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } catch (saveError) {
            throw new Error(`Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${saveError.message}`);
        }

    } catch (error) {
        console.error('Sync Down Error:', error);
        
        
        const backupKey = 'gemini-chat-app-db-emergency-backup';
        const emergencyBackup = localStorage.getItem(backupKey);
        
        if (emergencyBackup) {
            try {
                localStorage.setItem('gemini-chat-app-db', emergencyBackup);
                localStorage.removeItem(backupKey);
                showToast(`‚ùå Î≥µÏõê Ïã§Ìå®ÌñàÏßÄÎßå Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Îäî ÏïàÏ†ÑÌïòÍ≤å Î≥¥Ìò∏ÎêòÏóàÏäµÎãàÎã§.\nÏò§Î•ò: ${error.message}`);
            } catch (restoreError) {
                showToast(`‚ùå‚ùå Ïã¨Í∞ÅÌïú Ïò§Î•ò: Îç∞Ïù¥ÌÑ∞ Î≥µÏõêÍ≥º Î∞±ÏóÖ Î≥µÍµ¨ Î™®Îëê Ïã§Ìå®ÌñàÏäµÎãàÎã§!\nÏõêÎ≥∏ Ïò§Î•ò: ${error.message}\nÎ≥µÍµ¨ Ïò§Î•ò: ${restoreError.message}`);
            }
        } else {
            showToast(`‚ùå Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ${error.message}`);
        }
    }
}
        const init = () => {
            loadData();
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.context-menu')) {
                    e.stopPropagation();
                    return;
                }
                removeContextMenu();

                const backBtn = e.target.closest('.back-btn');
                if (backBtn) {
                    e.preventDefault();
                    switchScreen(backBtn.getAttribute('data-target'));
                    const currentScreen = e.target.closest('.screen');
                    if (currentScreen && currentScreen.id === 'chat-room-screen') {
                        currentChatId = null;
                        currentChatType = null;
                    }
                }

                
                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                if (openOverlay && e.target === openOverlay) {
                    openOverlay.classList.remove('visible');
                }
            });

            
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.app-icon[data-target]');
                if (navLink) {
                    e.preventDefault();
                    switchScreen(navLink.getAttribute('data-target'));
                }
            });

            updateClock();
            setInterval(updateClock, 30000);
            
            const currentPresetKey = db.globalFontPresets.currentPreset;
            const currentPreset = db.globalFontPresets.presets[currentPresetKey];
            console.log('Ïï± Ï¥àÍ∏∞Ìôî - Ìè∞Ìä∏ Ï†ÅÏö©:', { 
                currentPresetKey: currentPresetKey, 
                currentPreset: currentPreset,
                allPresets: Object.keys(db.globalFontPresets.presets)
            });
            
            if (currentPreset && currentPreset.url) {
                applyGlobalFont(currentPreset.url);
                console.log('Ïï± Ï¥àÍ∏∞Ìôî Ïãú Ìè∞Ìä∏ Ï†ÅÏö©:', currentPreset.name, currentPreset.url);
            } else {
                applyGlobalFont(''); 
                console.log('Í∏∞Î≥∏ Ìè∞Ìä∏Î°ú Ï¥àÍ∏∞Ìôî (ÌòÑÏû¨ ÌîÑÎ¶¨ÏÖã:', currentPresetKey, ')');
            }
            updateGlobalCustomCSS(); 
            setupHomeScreen();
            setupChatListScreen();
            setupAddCharModal();
            setupChatRoom();
            setupChatSettings();
            setupApiSettingsApp();
            setupWallpaperApp();
            setupStickerSystem();
            setupVoiceMessageSystem();
            setupPhotoVideoSystem();
            setupImageRecognition();
            setupWalletSystem();
            setupGiftSystem();
            setupTimeSkipSystem();
            setupWorldBookApp();
            setupFontSettingsApp();
            setupGroupChatSystem();
            setupCustomizeApp();
            setupTutorialApp();
			setupGitHubSync();
        };

        function updateClock() {
            const now = new Date();
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}ÎÖÑ ${pad(now.getMonth() + 1)}Ïõî ${pad(now.getDate())}Ïùº`;
        }

        
        function setupHomeScreen() {
            const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
            const homeScreenHTML = `
            <div class="time-widget"><div class="time" id="time-display"></div><div class="date" id="date-display"></div></div>
            <div class="app-grid">
                <a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="wallpaper-screen"><img src="${getIcon('wallpaper-screen')}" alt="Î∞∞Í≤ΩÌôîÎ©¥" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="ÏÑ∏Í≥ÑÍ¥Ä" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="Ïª§Ïä§ÌÖÄ" class="icon-img"><span class="app-name">${defaultIcons['customize-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="ÌäúÌÜ†Î¶¨Ïñº" class="icon-img"><span class="app-name">${defaultIcons['tutorial-screen'].name}</span></a>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="Ï£ºÍ∞Ñ" class="icon-img"></a>
                <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="ÏïºÍ∞Ñ" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="font-settings-screen"><img src="${getIcon('font-settings-screen')}" alt="Í∏ÄÍº¥" class="icon-img"></a>
            </div>`;
            homeScreen.innerHTML = homeScreenHTML;
            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            document.getElementById('day-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('day'); });
            document.getElementById('night-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('night'); });
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
        }

        function applyWallpaper(url) { homeScreen.style.backgroundImage = `url(${url})`; }

        function applyHomeScreenMode(mode) {
            if (mode === 'day') { homeScreen.classList.add('day-mode'); }
            else { homeScreen.classList.remove('day-mode'); }
            db.homeScreenMode = mode;
            saveData();
        }

        function setupCustomizeApp() {
            customizeForm.addEventListener('input', e => {
                if (e.target.matches('input[type="url"]')) {
                    const iconId = e.target.dataset.id;
                    const newUrl = e.target.value.trim();
                    const previewImg = document.getElementById(`icon-preview-${iconId}`);
                    if (newUrl) {
                        db.customIcons[iconId] = newUrl;
                        previewImg.src = newUrl;
                        saveData();
                        setupHomeScreen();
                    }
                }
            });
            customizeForm.addEventListener('click', e => {
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.id;
                    delete db.customIcons[iconId];
                    saveData();
                    renderCustomizeForm();
                    setupHomeScreen();
                    showToast('ÏïÑÏù¥ÏΩòÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
                }
            });

            
            customizeForm.addEventListener('change', e => {
                
                if (e.target.matches('#global-css-toggle')) {
                    db.globalCustomCSS.enabled = e.target.checked;
                    updateGlobalCustomCSS();
                    saveData();
                    showToast(e.target.checked ? 'Ï†ÑÏó≠ Ïª§Ïä§ÌÖÄ CSSÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§' : 'Ï†ÑÏó≠ Ïª§Ïä§ÌÖÄ CSSÍ∞Ä ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§');
                }
                
                
                if (e.target.matches('#css-preset-select')) {
                    const newPreset = e.target.value;
                    db.globalCustomCSS.currentPreset = newPreset;
                    
                    
                    const cssInput = document.getElementById('css-input');
                    if (cssInput) {
                        cssInput.value = db.globalCustomCSS.presets[newPreset].css;
                    }
                    
                    
                    if (db.globalCustomCSS.enabled) {
                        updateGlobalCustomCSS();
                    }
                    saveData();
                    showToast(`"${db.globalCustomCSS.presets[newPreset].name}" ÌîÑÎ¶¨ÏÖãÏù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§`);
                }
            });

            customizeForm.addEventListener('click', e => {
                
                if (e.target.matches('#save-css-btn')) {
                    console.log('CSS Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠');
                    const cssInput = document.getElementById('css-input');
                    const currentPreset = db.globalCustomCSS.currentPreset;
                    
                    if (cssInput && cssInput.value.trim()) {
                        db.globalCustomCSS.presets[currentPreset].css = cssInput.value.trim();
                        saveData();
                        
                        if (db.globalCustomCSS.enabled) {
                            updateGlobalCustomCSS();
                        }
                        showToast('CSSÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                    } else {
                        showToast('CSS ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                    }
                }
                
                
                if (e.target.matches('#new-preset-btn')) {
                    console.log('ÏÉà ÌîÑÎ¶¨ÏÖã Î≤ÑÌäº ÌÅ¥Î¶≠');
                    const presetName = prompt('ÏÉà ÌîÑÎ¶¨ÏÖãÏùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
                    if (presetName && presetName.trim()) {
                        const presetKey = 'preset-' + Date.now();
                        db.globalCustomCSS.presets[presetKey] = {
                            name: presetName.trim(),
                            css: '',
                            description: 'ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌîÑÎ¶¨ÏÖã'
                        };
                        db.globalCustomCSS.currentPreset = presetKey;
                        saveData();
                        renderCustomizeForm();
                        showToast(`"${presetName}" ÌîÑÎ¶¨ÏÖãÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§`);
                    }
                }
                
                
                if (e.target.matches('#delete-preset-btn')) {
                    console.log('ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠');
                    const currentPreset = db.globalCustomCSS.currentPreset;
                    if (currentPreset !== 'default') {
                        const presetName = db.globalCustomCSS.presets[currentPreset].name;
                        if (confirm(`"${presetName}" ÌîÑÎ¶¨ÏÖãÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                            delete db.globalCustomCSS.presets[currentPreset];
                            db.globalCustomCSS.currentPreset = 'default';
                            saveData();
                            renderCustomizeForm();
                            updateGlobalCustomCSS();
                            showToast('ÌîÑÎ¶¨ÏÖãÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                        }
                    }
                }
            });
        }

        function renderCustomizeForm() {
            customizeForm.innerHTML = '';
            
            
            const iconSectionHTML = `
                <div class="customize-section">
                    <h3 class="section-title">Ìôà ÌôîÎ©¥ ÏïÑÏù¥ÏΩò Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï</h3>
                    <div class="section-content">
                        ${Object.entries(defaultIcons).map(([id, { name, url }]) => {
                            const currentIcon = db.customIcons[id] || url;
                            return `
                            <div class="icon-custom-item">
                                <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                                <div class="icon-details">
                                    <p>${name || 'Î™®Îìú Ï†ÑÌôò'}</p>
                                    <input type="url" class="form-group" placeholder="ÏÉà ÏïÑÏù¥ÏΩò URL Î∂ôÏó¨ÎÑ£Í∏∞" value="${db.customIcons[id] || ''}" data-id="${id}">
                                </div>
                                <button type="button" class="reset-icon-btn" data-id="${id}">Ï¥àÍ∏∞Ìôî</button>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', iconSectionHTML);
            
            
            const globalCSSSectionHTML = `
                <div class="customize-section">
                    <h3 class="section-title">Ï†ÑÏó≠ Ïª§Ïä§ÌÖÄ CSS</h3>
                    <div class="section-content">
                        <div class="css-toggle-section">
                            <label class="toggle-label">
                                <input type="checkbox" id="global-css-toggle" ${db.globalCustomCSS.enabled ? 'checked' : ''}>
                                <span class="toggle-text">Ï†ÑÏó≠ Ïª§Ïä§ÌÖÄ CSS ÏÇ¨Ïö©</span>
                            </label>
                        </div>
                        
                        <div class="css-preset-section">
                            <label for="css-preset-select" class="form-label">CSS ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉù:</label>
                            <select id="css-preset-select" class="form-select">
                                ${Object.entries(db.globalCustomCSS.presets).map(([key, preset]) => 
                                    `<option value="${key}" ${key === db.globalCustomCSS.currentPreset ? 'selected' : ''}>${preset.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="css-input-section">
                            <label for="css-input" class="form-label">CSS ÏΩîÎìú:</label>
                            <textarea id="css-input" class="form-textarea" placeholder="CSS ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî." rows="8">${db.globalCustomCSS.presets[db.globalCustomCSS.currentPreset].css}</textarea>
                        </div>
                        
                        <div class="css-actions">
                            <button type="button" id="save-css-btn" class="btn btn-primary">Ï†ÄÏû•</button>
                            <button type="button" id="new-preset-btn" class="btn btn-secondary">ÏÉà ÌîÑÎ¶¨ÏÖã</button>
                            <button type="button" id="delete-preset-btn" class="btn btn-danger" ${db.globalCustomCSS.currentPreset === 'default' ? 'disabled' : ''}>ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', globalCSSSectionHTML);
        }

        function setupTutorialApp() {
            tutorialContentArea.addEventListener('click', (e) => {
                const header = e.target.closest('.tutorial-header');
                if (header) { header.parentElement.classList.toggle('open'); }
            });
        }

        function renderTutorialContent() {
            const tutorials = [
                { title: 'ÏãúÏûëÌïòÎ©∞', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg'] },
                { title: 'ÏÜåÌîÑÌä∏Ïõ®Ïñ¥ ÏÜåÍ∞ú', imageUrls: [ 'https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg' ] },
                { title: '404', imageUrls: [ 'https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg' ] },
                { title: '404-Í∑∏Î£πÏ±ÑÌåÖ', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg'] }
            ];
            tutorialContentArea.innerHTML = '';
            tutorials.forEach(tutorial => {
                const item = document.createElement('div');
                item.className = 'tutorial-item';
                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title} ÌäúÌÜ†Î¶¨Ïñº Ïù¥ÎØ∏ÏßÄ">`).join('');
                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                tutorialContentArea.appendChild(item);
            });
        }

        function autoResize() {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        textarea.addEventListener('input', autoResize);
                
        function setupChatListScreen() {
            renderChatList();
            addChatBtn.addEventListener('click', () => {
                addCharModal.classList.add('visible');
                addCharForm.reset();
            });
            chatListContainer.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    currentChatId = chatItem.dataset.id;
                    currentChatType = chatItem.dataset.type;
                    openChatRoom(currentChatId, currentChatType);
                }
            });
            chatListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
            });
            chatListContainer.addEventListener('touchstart', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);
                }, 400);
            });
            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleChatListLongPress(chatId, chatType, x, y) {
            clearTimeout(longPressTimer);
            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chatItem) return;
            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
            const menuItems = [{
                label: chatItem.isPinned ? 'ÏÉÅÎã® Í≥†Ï†ï Ìï¥Ï†ú' : 'ÏÉÅÎã® Í≥†Ï†ï',
                action: () => {
                    chatItem.isPinned = !chatItem.isPinned;
                    saveData();
                    renderChatList();
                }
            }, {
                label: 'Ï±ÑÌåÖ ÏÇ≠Ï†ú',
                danger: true,
                action: () => {
                    if (confirm(`‚Äú${itemName}‚ÄùÎãòÍ≥ºÏùò Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                        if (chatType === 'private') { db.characters = db.characters.filter(c => c.id !== chatId); }
                        else { db.groups = db.groups.filter(g => g.id !== chatId); }
                        saveData();
                        renderChatList();
                        showToast('Ï±ÑÌåÖÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                    }
                }
            }];
            createContextMenu(menuItems, x, y);
        }

        function renderChatList() {
            chatListContainer.innerHTML = '';
            const allChats = [ ...db.characters.map(c => ({ ...c, type: 'private' })), ...db.groups.map(g => ({ ...g, type: 'group' })) ];
            noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
            const sortedChats = allChats.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                return lastMsgTimeB - lastMsgTimeA;
            });
            sortedChats.forEach(chat => {
                let lastMessageText = 'Ï±ÑÌåÖÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî...';
                if (chat.history && chat.history.length > 0) {
                    const invisibleRegex = /\[(?:.+?)ÎãòÏù¥ (?:.+?)ÎãòÏùò ÏÜ°Í∏àÏùÑ (?:ÏàòÎ†π|Î∞òÌôò)ÌñàÏäµÎãàÎã§\]|\[(?:.+?)ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:.*?\]|\[(?:.+?)ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§\]|\[system:.*?\]|\[(?:.+?)ÎãòÏù¥ (?:.+?)ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§\]|\[(?:.+?)ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ .*?(?:Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§\]|\[system-display:.*?\]/;
                    const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
                    if (visibleHistory.length > 0) {
                        const lastMsg = visibleHistory[visibleHistory.length - 1];
                        const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                        const imageRecogRegex = /\[(?:.+?)ÎãòÏùò Ïù¥ÎØ∏ÏßÄ:\]/;
                        const voiceRegex = /\[.*?ÎãòÏùò ÏùåÏÑ±:.*?\]/;
                        const photoVideoRegex = /\[.*?ÎãòÏùò ÏÇ¨ÏßÑ\/ÏòÅÏÉÅ:.*?\]/;
                        const transferRegex = /\[.*?ÎãòÏùò ÏÜ°Í∏à:.*?Ïõê.*?\]|\[.*?ÎãòÏóêÍ≤å ÏÜ°Í∏à:.*?Ïõê.*?\]|\[.*?ÎãòÏù¥ .*?ÎãòÏóêÍ≤å ÏÜ°Í∏à:.*?Ïõê.*?\]/;
                        const stickerRegex = /\[.*?ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:.*?\]|\[.*?ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:.*?\]/;
                        const giftRegex = /\[.*?ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:.*?\]|\[.*?ÎãòÏù¥ .*?ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏÑ†Î¨º:.*?\]/;

                        if (giftRegex.test(lastMsg.content)) { lastMessageText = '[ÏÑ†Î¨º]'; }
                        else if (stickerRegex.test(lastMsg.content)) { lastMessageText = '[Ïù¥Î™®Ìã∞ÏΩò]'; }
                        else if (voiceRegex.test(lastMsg.content)) { lastMessageText = '[ÏùåÏÑ±]'; }
                        else if (photoVideoRegex.test(lastMsg.content)) { lastMessageText = '[ÏÇ¨ÏßÑ/ÏòÅÏÉÅ]'; }
                        else if (transferRegex.test(lastMsg.content)) { lastMessageText = '[ÏÜ°Í∏à]'; }
                        else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) { lastMessageText = '[ÏÇ¨ÏßÑ]'; }
                        else {
                            const textMatch = lastMsg.content.match(/\[.*?ÎãòÏùò Î©îÏãúÏßÄ:([\s\S]+)\]/);
                            let text = textMatch ? textMatch[1].trim() : lastMsg.content.trim();
                            lastMessageText = urlRegex.test(text) ? '[ÏÇ¨ÏßÑ]' : text;
                        }
                    } else {
                        const lastEverMsg = chat.history[chat.history.length - 1];
                        const inviteRegex = /\[(.*?)ÎãòÏù¥ (.*?)ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§\]/;
                        const renameRegex = /\[.*?ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ .*?(Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§\]/;
                        const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                        const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);

                        if (timeSkipMatch) { lastMessageText = timeSkipMatch[1]; }
                        else if (inviteRegex.test(lastEverMsg.content)) { lastMessageText = 'ÏÉà Î©§Î≤ÑÍ∞Ä Í∑∏Î£πÏóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§'; }
                        else if (renameRegex.test(lastEverMsg.content)) { lastMessageText = 'Í∑∏Î£π Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§'; }
                    }
                }
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                if (chat.isPinned) li.classList.add('pinned');
                li.dataset.id = chat.id;
                li.dataset.type = chat.type;
                const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
                const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
                const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">Í≥†Ï†ïÎê®</span>' : '';
                const unreadBadgeHTML = chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : '';
                li.innerHTML = `
                <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
                <div class="item-details">
                    <div class="item-details-row"><div class="item-name">${itemName}</div>${unreadBadgeHTML}</div>
                    <div class="item-preview-wrapper"><div class="item-preview">${lastMessageText}</div>${pinBadgeHTML}</div>
                </div>`;
                chatListContainer.appendChild(li);
            });
        }

        function setupAddCharModal() {
            addCharForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newChar = { id: `char_${Date.now()}`, realName: document.getElementById('char-real-name').value, remarkName: document.getElementById('char-remark-name').value, persona: '', avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', myName: document.getElementById('my-name-for-char').value, myPersona: '', myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', theme: 'white_pink', maxMemory: 100, chatBg: '', history: [], isPinned: false, status: 'Ïò®ÎùºÏù∏', worldBookIds: [], useCustomBubbleCss: false, customBubbleCss: '' };
                db.characters.push(newChar);
                saveData();
                renderChatList();
                addCharModal.classList.remove('visible');
                showToast(`Ï∫êÎ¶≠ÌÑ∞ ‚Äú${newChar.remarkName}‚Äù ÏÉùÏÑ± ÏÑ±Í≥µ!`);
            });
        }

        function setupChatRoom() {
            sendMessageBtn.addEventListener('click', sendMessage);
            sendMessageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                sendMessage();
                setTimeout(() => { messageInput.focus(); }, 50);
            });
            messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isGenerating) sendMessage(); });
            getReplyBtn.addEventListener('click', getAiReply);
            messageArea.addEventListener('click', (e) => {
                
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                    
                    return; 
                }
                

                if (e.target && e.target.id === 'load-more-btn') { loadMoreMessages(); }
                else if (isInMultiSelectMode) {
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (messageWrapper) { toggleMessageSelection(messageWrapper.dataset.id); }
                } else {
                    const voiceBubble = e.target.closest('.voice-bubble');
                    if (voiceBubble) {
                        const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                        if (transcript) { transcript.classList.toggle('active'); }
                    }
                    const pvCard = e.target.closest('.pv-card');
                    if (pvCard) {
                        const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                        const footer = pvCard.querySelector('.pv-card-footer');
                        imageOverlay.classList.toggle('hidden');
                        footer.classList.toggle('hidden');
                    }
                    const giftCard = e.target.closest('.gift-card');
                    if (giftCard) {
                        const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                        if (description) { description.classList.toggle('active'); }
                    }
                    const transferCard = e.target.closest('.transfer-card.received-transfer');
                    if (transferCard && currentChatType === 'private') {
                        const messageWrapper = transferCard.closest('.message-wrapper');
                        const messageId = messageWrapper.dataset.id;
                        const character = db.characters.find(c => c.id === currentChatId);
                        const message = character.history.find(m => m.id === messageId);
                        if (message && message.transferStatus === 'pending') { handleReceivedTransferClick(messageId); }
                    }
                }
            });
            messageArea.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
            });
            messageArea.addEventListener('touchstart', (e) => {
                if (e.target.id === 'load-more-btn') return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
                }, 400);
            });
            messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
            messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            saveEditBtn.addEventListener('click', saveMessageEdit);
            cancelEditBtn.addEventListener('click', cancelMessageEdit);
            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);

            attachmentToggleBtn.addEventListener('click', () => {
                stickerBar.classList.toggle('visible');
                attachmentToggleBtn.classList.toggle('active');
            });
        }

        function handleMessageLongPress(messageWrapper, x, y) {
            if (isInMultiSelectMode) return;
            clearTimeout(longPressTimer);
            const messageId = messageWrapper.dataset.id;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');
            const isVoiceMessage = /\[.*?ÎãòÏùò ÏùåÏÑ±:.*?\]/.test(message.content);
            const isStickerMessage = /\[.*?ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:.*?\]|\[.*?ÎãòÏù¥ Î≥¥ÎÇ∏ Ïù¥Î™®Ìã∞ÏΩò:.*?\]/.test(message.content);
            const isPhotoVideoMessage = /\[.*?ÎãòÏùò ÏÇ¨ÏßÑ\/ÏòÅÏÉÅ:.*?\]/.test(message.content);
            const isTransferMessage = /\[.*?ÏóêÍ≤å ÏÜ°Í∏à:.*?\]|\[.*?ÎãòÏùò ÏÜ°Í∏à:.*?\]|\[.*?ÎãòÏù¥ .*?ÏóêÍ≤å ÏÜ°Í∏àÌñàÏäµÎãàÎã§:.*?\]/.test(message.content);
            const isGiftMessage = /\[.*?ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:.*?\]|\[.*?ÎãòÏù¥ .*?ÏóêÍ≤å ÏÑ†Î¨ºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§:.*?\]/.test(message.content);
            const isInvisibleMessage = /\[.*?ÎãòÏù¥ .*?ÎãòÏùò ÏÜ°Í∏àÏùÑ (?:ÏàòÎ†π|Î∞òÌôò)ÌñàÏäµÎãàÎã§\]|\[.*?ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:.*?\]|\[.*?ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§\]|\[system:.*?\]|\[.*?ÎãòÏù¥ .*?ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§\]|\[.*?ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ .*?(?:Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§\]|\[system-display:.*?\]/.test(message.content);

            let menuItems = [];
            if (!isImageRecognitionMsg && !isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {
                menuItems.push({ label: 'Ìé∏Ïßë', action: () => startMessageEdit(messageId) });
            }
            menuItems.push({ label: 'ÏÇ≠Ï†ú', action: () => enterMultiSelectMode(messageId) });

            if (menuItems.length > 0) { createContextMenu(menuItems, x, y); }
        }

        function startMessageEdit(messageId) {
            exitMultiSelectMode();
            editingMessageId = messageId;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;
            const match = message.content.match(/\[.*?ÎãòÏùò Î©îÏãúÏßÄ:([\s\S]+)\]/);
            const contentToEdit = match ? match[1].trim() : message.content;
            messageEditInput.value = contentToEdit;
            messageInputDefault.style.display = 'none';
            messageEditBar.style.display = 'flex';
            messageEditInput.focus();
        }

        function saveMessageEdit() {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
            if (messageIndex === -1) return;
            const newText = messageEditInput.value.trim();
            if (newText) {
                const oldContent = chat.history[messageIndex].content;
                const prefixMatch = oldContent.match(/(\[.*?ÎãòÏùò Î©îÏãúÏßÄ:)[\s\S]+\]/);
                const prefix = prefixMatch ? prefixMatch[1] : '';
                const newContent = `${prefix}${newText}]`;
                chat.history[messageIndex].content = newContent;
                if(chat.history[messageIndex].parts) { chat.history[messageIndex].parts = [{ type: 'text', text: newContent }]; }
                saveData();
                currentPage = 1;
                renderMessages(false, true);
                renderChatList();
            }
            cancelMessageEdit();
        }

        function cancelMessageEdit() {
            editingMessageId = null;
            messageInputDefault.style.display = 'flex';
            messageEditBar.style.display = 'none';
        }

        function enterMultiSelectMode(initialMessageId) {
            isInMultiSelectMode = true;
            chatRoomHeaderDefault.style.display = 'none';
            chatRoomHeaderSelect.style.display = 'flex';
            document.querySelector('.chat-input-wrapper').style.display = 'none';
            multiSelectBar.classList.add('visible');
            chatRoomScreen.classList.add('multi-select-active');
            selectedMessageIds.clear();
            if (initialMessageId) { toggleMessageSelection(initialMessageId); }
        }

        function exitMultiSelectMode() {
            isInMultiSelectMode = false;
            chatRoomHeaderDefault.style.display = 'flex';
            chatRoomHeaderSelect.style.display = 'none';
            document.querySelector('.chat-input-wrapper').style.display = 'block';
            multiSelectBar.classList.remove('visible');
            chatRoomScreen.classList.remove('multi-select-active');
            selectedMessageIds.forEach(id => {
                const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);
                if (el) el.classList.remove('multi-select-selected');
            });
            selectedMessageIds.clear();
        }

        function toggleMessageSelection(messageId) {
            const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
            if (!el) return;
            if (selectedMessageIds.has(messageId)) {
                selectedMessageIds.delete(messageId);
                el.classList.remove('multi-select-selected');
            } else {
                selectedMessageIds.add(messageId);
                el.classList.add('multi-select-selected');
            }
            selectCount.textContent = `${selectedMessageIds.size}Í∞ú Ìï≠Î™© ÏÑ†ÌÉùÎê®`;
            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;
        }

        function deleteSelectedMessages() {
            if (selectedMessageIds.size === 0) return;
            const deletedCount = selectedMessageIds.size;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
            saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
            exitMultiSelectMode();
            showToast(`${deletedCount}Í∞úÏùò Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌñàÏäµÎãàÎã§`);
        }

        function openChatRoom(chatId, type) {
            const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chat) return;
            if (chat.unreadCount > 0) {
                chat.unreadCount = 0;
                saveData();
                renderChatList();
            }
            exitMultiSelectMode();
            cancelMessageEdit();
            chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
            const subtitle = document.getElementById('chat-room-subtitle');
            if (type === 'private') {
                subtitle.style.display = 'flex';
                chatRoomStatusText.textContent = chat.status || 'Ïò®ÎùºÏù∏';
            } else {
                subtitle.style.display = 'none';
            }
            getReplyBtn.style.display = 'inline-flex';
            chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
            typingIndicator.style.display = 'none';
            isGenerating = false;
            getReplyBtn.disabled = false;
            currentPage = 1;
            chatRoomScreen.className = chatRoomScreen.className.replace(/\bchat-active-[^ ]+\b/g, '');
            chatRoomScreen.classList.add(`chat-active-${chatId}`);
            updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);
            renderMessages(false, true);
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
            switchScreen('chat-room-screen');
        }

        // Í∏∞Ï°¥ renderMessages Ìï®Ïàò Ï†ÑÏ≤¥Î•º ÏïÑÎûò ÎÇ¥Ïö©ÏúºÎ°ú ÍµêÏ≤¥
        function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history) return;
            const oldScrollHeight = messageArea.scrollHeight;
            const totalMessages = chat.history.length;
            const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
            const start = Math.max(0, end - MESSAGES_PER_PAGE);
            
            // Î†åÎçîÎßÅÌï† Î©îÏãúÏßÄ ÎøêÎßå ÏïÑÎãàÎùº, Í∑∏Î£πÌôîÎ•º ÏúÑÌï¥ Ïù¥Ï†Ñ/Îã§Ïùå Î©îÏãúÏßÄ Ï†ïÎ≥¥ÎèÑ ÌïÑÏöîÌï®
            const messagesToRender = chat.history.slice(start, end);
            const messageBeforeSlice = (start > 0) ? chat.history[start - 1] : null;
            const messageAfterSlice = (end < totalMessages) ? chat.history[end] : null;

            if (!isLoadMore) messageArea.innerHTML = '';
            const fragment = document.createDocumentFragment();
            
            messagesToRender.forEach((msg, index) => {
                const prevMsg = (index === 0) ? messageBeforeSlice : messagesToRender[index - 1];
                const nextMsg = (index === messagesToRender.length - 1) ? messageAfterSlice : messagesToRender[index + 1];

                const bubble = createMessageBubbleElement(msg, prevMsg, nextMsg); // Ïù¥Ï†Ñ, Îã§Ïùå Î©îÏãúÏßÄÎ•º Ïù∏ÏûêÎ°ú Ï†ÑÎã¨
                if (bubble) fragment.appendChild(bubble);
            });

            const existingLoadBtn = document.getElementById('load-more-btn');
            if (existingLoadBtn) existingLoadBtn.remove();
            messageArea.prepend(fragment);
            if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-btn';
                loadMoreButton.className = 'load-more-btn';
                loadMoreButton.textContent = 'Ïù¥Ï†Ñ Î©îÏãúÏßÄ Î∂àÎü¨Ïò§Í∏∞';
                messageArea.prepend(loadMoreButton);
            }
            if (forceScrollToBottom) {
                setTimeout(() => { messageArea.scrollTop = messageArea.scrollHeight; }, 0);
            } else if (isLoadMore) {
                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
            }
        }

        function loadMoreMessages() {
            currentPage++;
            renderMessages(true, false);
        }

        function calculateVoiceDuration(text) {
            return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5)));
        }

// Í∏∞Ï°¥ createMessageBubbleElement Ìï®Ïàò Ï†ÑÏ≤¥Î•º ÏïÑÎûò ÎÇ¥Ïö©ÏúºÎ°ú ÍµêÏ≤¥
function createMessageBubbleElement(message, prevMessage, nextMessage) {
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const { role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId } = message;

    const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
    const inviteRegex = /\[(.*?)ÎãòÏù¥ (.*?)ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§\]/;
    const renameRegex = /\[(.*?)ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ‚Äò(.*?)‚Äô(Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§\]/;
    const timeSkipMatch = content.match(timeSkipRegex);
    const inviteMatch = content.match(inviteRegex);
    const renameMatch = content.match(renameRegex);
    const invisibleRegex = /\[(?:.+?)ÎãòÏù¥ (?:.+?)ÎãòÏùò ÏÜ°Í∏àÏùÑ (?:ÏàòÎ†π|Î∞òÌôò)ÌñàÏäµÎãàÎã§\]|\[(?:.+?)ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:.*?\]|\[(?:.+?)ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§\]|\[system:.*?\]/;
    if (invisibleRegex.test(content)) { return null; }

    const wrapper = document.createElement('div');
    wrapper.dataset.id = id;

    if (timeSkipMatch || inviteMatch || renameMatch) {
        wrapper.className = 'message-wrapper system-notification';
        let bubbleText = '';
        if (timeSkipMatch) bubbleText = timeSkipMatch[1];
        if (inviteMatch) bubbleText = `${inviteMatch[1]}ÎãòÏù¥ ${inviteMatch[2]}ÎãòÏùÑ Ï¥àÎåÄÌñàÏäµÎãàÎã§`;
        if (renameMatch) bubbleText = `${renameMatch[1]}ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ "${renameMatch[2]}"(Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§`;
        wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
        return wrapper;
    }

    const isSent = (role === 'user');
    let avatarUrl, bubbleTheme, senderNickname = '';
    const themeKey = chat.theme || 'white_pink';
    const theme = colorThemes[themeKey] || colorThemes['white_pink'];
    
    const currentSenderId = isSent ? 'user_me' : (senderId || 'assistant');
    const msgDate = new Date(timestamp);
    const msgTimeSignature = `${msgDate.getFullYear()}-${msgDate.getMonth()}-${msgDate.getDate()}-${msgDate.getHours()}-${msgDate.getMinutes()}`;

    // ‚ñº‚ñº‚ñº‚ñº‚ñº [ÏàòÏ†ï] Í∑∏Î£πÌôî ÌåêÎã® Î°úÏßÅ ‚ñº‚ñº‚ñº‚ñº‚ñº
    let isGroupStart = true; // ÌòÑÏû¨ Î©îÏãúÏßÄÍ∞Ä Í∑∏Î£πÏùò Ï≤´ Î©îÏãúÏßÄÏù∏Í∞Ä? (Í∏∞Î≥∏Í∞í: true)
    
    if (prevMessage) {
        const prevSenderId = prevMessage.role === 'user' ? 'user_me' : (prevMessage.senderId || 'assistant');
        const prevMsgDate = new Date(prevMessage.timestamp);
        const prevTimeSignature = `${prevMsgDate.getFullYear()}-${prevMsgDate.getMonth()}-${prevMsgDate.getDate()}-${prevMsgDate.getHours()}-${prevMsgDate.getMinutes()}`;
        const isPrevSystemMsg = /\[system-display:.*\]|\[.*Ï¥àÎåÄÌñàÏäµÎãàÎã§\]|\[.*Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§\]|\[system:.*\]/.test(prevMessage.content);

        if (currentSenderId === prevSenderId && msgTimeSignature === prevTimeSignature && !isPrevSystemMsg) {
            isGroupStart = false; // Ï°∞Í±¥ Ï∂©Ï°± Ïãú Í∑∏Î£πÏùò ÏãúÏûëÏù¥ ÏïÑÎãò
        }
    }
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤ [ÏàòÏ†ï] Í∑∏Î£πÌôî ÌåêÎã® Î°úÏßÅ ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

    if (isSent) {
        avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
        bubbleTheme = theme.sent;
    } else {
        if (currentChatType === 'private') {
            avatarUrl = chat.avatar;
        } else { 
            const sender = chat.members.find(m => m.id === senderId);
            if (sender) {
                avatarUrl = sender.avatar;
                senderNickname = sender.groupNickname;
            } else { 
                avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            }
        }
        bubbleTheme = theme.received;
    }
    const timeString = `${pad(msgDate.getHours())}:${pad(msgDate.getMinutes())}`;
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    if (!isGroupStart) {
        wrapper.classList.add('grouped');
    }
    if (currentChatType === 'group' && !isSent) { wrapper.classList.add('group-message'); }
    
    const bubbleRow = document.createElement('div');
    bubbleRow.className = 'message-bubble-row';
    let bubbleElement;

    // ... (Ïù¥Ìïò ÎßêÌíçÏÑ† Ï¢ÖÎ•òÎ≥Ñ ÏÉùÏÑ± Î°úÏßÅÏùÄ Ïù¥Ï†ÑÍ≥º ÎèôÏùºÌïòÎØÄÎ°ú ÏÉùÎûµ) ...
    const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
    const sentStickerRegex = /\[(?:.+?)ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:.+?\]/i;
    const receivedStickerRegex = /\[(?:.+?)ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:([\s\S]+?)\]/i;
    const voiceRegex = /\[(?:.+?)ÎãòÏùò ÏùåÏÑ±:([\s\S]+?)\]/;
    const photoVideoRegex = /\[(?:.+?)ÎãòÏùò ÏÇ¨ÏßÑ\/ÏòÅÏÉÅ:([\s\S]+?)\]/;
    const privateSentTransferRegex = /\[.*?ÏóêÍ≤å ÏÜ°Í∏à:([\d.]+)ÏõêÔºõÎ©îÎ™®:(.*?)\]/;
    const privateReceivedTransferRegex = /\[.*?ÎãòÏùò ÏÜ°Í∏à:([\d.]+)ÏõêÔºõÎ©îÎ™®:(.*?)\]/;
    const groupTransferRegex = /\[(.*?)\s*ÎãòÏù¥\s*(.*?)\s*ÎãòÏóêÍ≤å ÏÜ°Í∏à:([\d.]+)ÏõêÔºõÎ©îÎ™®:(.*?)\]/;
    const privateGiftRegex = /\[(?:.+?)ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:([\s\S]+?)\]/;
    const groupGiftRegex = /\[(.*?)\s*ÎãòÏù¥\s*(.*?)\s*ÎãòÏóêÍ≤å ÏÑ†Î¨ºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§:([\s\S]+?)\]/;
    const imageRecogRegex = /\[(?:.+?)ÎãòÏùò ÏÇ¨ÏßÑ:\]/;
    const textRegex = /\[(?:.+?)ÎãòÏùò Î©îÏãúÏßÄ:([\s\S]+)\]/;

    const sentStickerMatch = content.match(sentStickerRegex);
    const receivedStickerMatch = content.match(receivedStickerRegex);
    const voiceMatch = content.match(voiceRegex);
    const photoVideoMatch = content.match(photoVideoRegex);
    const privateSentTransferMatch = content.match(privateSentTransferRegex);
    const privateReceivedTransferMatch = content.match(privateReceivedTransferRegex);
    const groupTransferMatch = content.match(groupTransferRegex);
    const privateGiftMatch = content.match(privateGiftRegex);
    const groupGiftMatch = content.match(groupGiftRegex);
    const imageRecogMatch = content.match(imageRecogRegex);
    const textMatch = content.match(textRegex);

    if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'image-bubble';
        let stickerSrc = '';
        if (isSent) {
            stickerSrc = stickerData;
        } else {
            const stickerInput = receivedStickerMatch[1].trim();
            const foundSticker = db.myStickers.find(s => s.name === stickerInput);
            if (foundSticker) {
                stickerSrc = foundSticker.data; 
            } else {
                const pathExtractionRegex = /[a-zA-Z0-9]+\/.*$/;
                const extractedPathMatch = stickerInput.match(pathExtractionRegex);
                const finalPath = extractedPathMatch ? extractedPathMatch[0] : stickerInput;
                stickerSrc = `https://i.postimg.cc/${finalPath}`;
            }
        }
        bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="Ïù¥Î™®Ìã∞ÏΩò">`;
    } else if (privateGiftMatch || groupGiftMatch) {
        const match = privateGiftMatch || groupGiftMatch;
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'gift-card';
        if (giftStatus === 'received') { bubbleElement.classList.add('received'); }

        let giftText;
        if (groupGiftMatch) {
            const from = groupGiftMatch[1];
            const to = groupGiftMatch[2];
            giftText = isSent ? `${to}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏÑ†Î¨º` : `${from}ÎãòÏù¥ ${to}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏÑ†Î¨º`;
        } else {
            giftText = 'ÏÑ†Î¨ºÏù¥ ÎèÑÏ∞©ÌñàÏñ¥Ïöî~';
        }
        bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="ÏÑ†Î¨º" class="gift-card-icon"><div class="gift-card-text">${giftText}</div><div class="gift-card-received-stamp">ÏàòÎ†π ÏôÑÎ£å</div>`;

        const description = groupGiftMatch ? groupGiftMatch[3].trim() : match[1].trim();
        const descriptionDiv = document.createElement('div');
        descriptionDiv.className = 'gift-card-description';
        descriptionDiv.textContent = description;
        wrapper.appendChild(descriptionDiv);
    } else if (voiceMatch) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'voice-bubble';
        if (!chat.useCustomBubbleCss) {
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }
        bubbleElement.innerHTML = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg><span class="duration">${calculateVoiceDuration(voiceMatch[1].trim())}"</span>`;
        const transcriptDiv = document.createElement('div');
        transcriptDiv.className = 'voice-transcript';
        transcriptDiv.textContent = voiceMatch[1].trim();
        wrapper.appendChild(transcriptDiv);
    } else if (photoVideoMatch) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'pv-card';
        bubbleElement.innerHTML = `<div class="pv-card-content">${photoVideoMatch[1].trim()}</div><div class="pv-card-image-overlay" style="background-image: url('${isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>ÏÇ¨ÏßÑ/ÏòÅÏÉÅ„ÉªÌÅ¥Î¶≠ÌïòÏó¨ Î≥¥Í∏∞</span></div>`;
    } else if (privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch) {
        const isSentTransfer = !!privateSentTransferMatch || (groupTransferMatch && isSent);
        const match = privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch;

        let amount, remarkText, titleText;
        if (groupTransferMatch) {
            const from = groupTransferMatch[1];
            const to = groupTransferMatch[2];
            amount = parseFloat(groupTransferMatch[3]).toFixed(0);
            remarkText = groupTransferMatch[4] || '';
            titleText = isSent ? `${to}ÎãòÏóêÍ≤å ÏÜ°Í∏à` : `${from}ÎãòÏù¥ ÎãπÏã†ÏóêÍ≤å ÏÜ°Í∏à`;
        } else { 
            amount = parseFloat(match[1]).toFixed(0);
            remarkText = match[2] || '';
            titleText = isSentTransfer ? 'ÎãπÏã†ÏóêÍ≤å ÏÜ°Í∏à' : 'ÏÜ°Í∏à';
        }

        bubbleElement = document.createElement('div');
        bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;

        let statusText = isSentTransfer ? 'ÏàòÎ†π ÎåÄÍ∏∞' : 'ÏÜ°Í∏à Î∞õÍ∏∞';
        if(groupTransferMatch && !isSent) statusText = 'ÏÜ°Í∏à';
        if (transferStatus === 'received') {
            statusText = 'ÏàòÎ†π ÏôÑÎ£å';
            bubbleElement.classList.add('received');
        } else if (transferStatus === 'returned') {
            statusText = 'Î∞òÌôòÎê®';
            bubbleElement.classList.add('returned');
        }
        if ((transferStatus !== 'pending' && currentChatType === 'private') || currentChatType === 'group') {
            bubbleElement.style.cursor = 'default';
        }

        const remarkHTML = remarkText ? `<p class="transfer-remark">${remarkText}</p>` : '';
        bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">‚Ç©${amount}</p>${remarkHTML}<p class="transfer-status">${statusText}</p></div>`;
     } else if (imageRecogMatch || urlRegex.test(content)) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'image-bubble';
        bubbleElement.innerHTML = `<img src="${content}" alt="Ïù¥ÎØ∏ÏßÄ Î©îÏãúÏßÄ">`;
    } else {
        bubbleElement = document.createElement('div');
        bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        const finalTextMatch = content.match(/\[(?:.+?)ÎãòÏùò Î©îÏãúÏßÄ:([\s\S]+?)\]/);
        if (finalTextMatch) {
            bubbleElement.textContent = finalTextMatch[1].trim();
        } else {
            bubbleElement.textContent = content;
        }
        if (!chat.useCustomBubbleCss) {
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }
    }
    
    // ‚ñº‚ñº‚ñº‚ñº‚ñº [ÏàòÏ†ï] ÎßêÌíçÏÑ† Î™®Ïñë Í≤∞Ï†ï Î°úÏßÅ ‚ñº‚ñº‚ñº‚ñº‚ñº
    if (bubbleElement && !isGroupStart) {
        bubbleElement.classList.add('grouped-bubble');
    }
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤ [ÏàòÏ†ï] ÎßêÌíçÏÑ† Î™®Ïñë Í≤∞Ï†ï Î°úÏßÅ ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤
    
    const nicknameHTML = (isGroupStart && currentChatType === 'group' && !isSent && senderNickname) 
        ? `<div class="group-nickname">${senderNickname}</div>` 
        : '';
    const messageInfoHTML = `
        <div class="message-info">
            ${nicknameHTML}
            <img src="${avatarUrl}" class="message-avatar">
            <span class="message-time">${timeString}</span>
        </div>`;

    bubbleRow.innerHTML = messageInfoHTML;
    if (bubbleElement) { bubbleRow.appendChild(bubbleElement); }
    wrapper.prepend(bubbleRow);
    return wrapper;
}// Í∏∞Ï°¥ addMessageBubble Ìï®Ïàò Ï†ÑÏ≤¥Î•º ÏïÑÎûò ÎÇ¥Ïö©ÏúºÎ°ú ÍµêÏ≤¥
function addMessageBubble(message) {
    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);
    
    if (!chat) return;

    // ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú Î∞îÎ°ú Ïù¥Ï†Ñ Î©îÏãúÏßÄÎ•º Ï∞æÏäµÎãàÎã§.
    const history = chat.history;
    const prevMessage = history.length > 1 ? history[history.length - 2] : null;
    
    // Ïù¥Ï†ÑÏóê Î†åÎçîÎßÅÎêú ÎßàÏßÄÎßâ DOM ÏöîÏÜåÎ•º Ï∞æÏäµÎãàÎã§.
    const lastMessageWrapper = messageArea.querySelector('.message-wrapper:last-child');
    
    // ÎßåÏïΩ Ïù¥Ï†Ñ DOM ÏöîÏÜåÍ∞Ä ÏûàÍ≥†, Í∑∏Î£πÌôîÎê† Ïàò ÏûàÎäî Ï°∞Í±¥Ïù¥ÎùºÎ©¥ Ïù¥Ï†Ñ ÏöîÏÜåÏùò ÎßêÌíçÏÑ† Î™®ÏñëÏùÑ Î≥ÄÍ≤Ω
    if (lastMessageWrapper && prevMessage) {
        const prevSenderId = prevMessage.role === 'user' ? 'user_me' : (prevMessage.senderId || 'assistant');
        const currentSenderId = message.role === 'user' ? 'user_me' : (message.senderId || 'assistant');

        const prevMsgDate = new Date(prevMessage.timestamp);
        const prevTimeSignature = `${prevMsgDate.getFullYear()}-${prevMsgDate.getMonth()}-${prevMsgDate.getDate()}-${prevMsgDate.getHours()}-${prevMsgDate.getMinutes()}`;
        const currentMsgDate = new Date(message.timestamp);
        const currentTimeSignature = `${currentMsgDate.getFullYear()}-${currentMsgDate.getMonth()}-${currentMsgDate.getDate()}-${currentMsgDate.getHours()}-${currentMsgDate.getMinutes()}`;

        if (prevSenderId === currentSenderId && prevTimeSignature === currentTimeSignature) {
            const lastBubble = lastMessageWrapper.querySelector('.message-bubble, .image-bubble, .voice-bubble, .pv-card, .transfer-card, .gift-card');
            if (lastBubble) {
                lastBubble.classList.add('grouped-middle');
                // Í∏∞Ï°¥ Íº¨Î¶¨ Î™®Ïñë Ï†úÍ±∞
                if (lastBubble.classList.contains('sent')) {
                    lastBubble.style.borderBottomRightRadius = '';
                } else if (lastBubble.classList.contains('received')) {
                    lastBubble.style.borderBottomLeftRadius = '';
                }
            }
        }
    }


    if (currentChatType === 'private') {
        const character = chat;
        const myName = character.myName; 
        const systemMessageRegex = /\[system:.*?\]|\[system-display:.*?\]/;
        const updateStatusRegex = new RegExp(`\\[${character.realName}ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:(.*?)\\]`);
        const transferActionRegex = new RegExp(`\\[${character.realName}ÎãòÏù¥ ${myName}ÎãòÏùò ÏÜ°Í∏àÏùÑ (?:ÏàòÎ†π|Î∞òÌôò)ÌñàÏäµÎãàÎã§\\]`);
        const giftReceivedRegex = new RegExp(`\\[${character.realName}ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§\\]`);

        if (systemMessageRegex.test(message.content)) {  }
        if (message.content.match(updateStatusRegex)) {
            character.status = message.content.match(updateStatusRegex)[1];
            chatRoomStatusText.textContent = character.status;
            saveData();
            return;
        }
        if (message.content.match(giftReceivedRegex) && message.role === 'assistant') {
            const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:') && m.giftStatus !== 'received');
            if (lastPendingGiftIndex !== -1) {
                const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                const giftMsg = character.history[actualIndex];
                giftMsg.giftStatus = 'received';
                const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                if (giftCardOnScreen) { giftCardOnScreen.classList.add('received'); }
                saveData();
            }
            return;
        }
        if (message.content.match(transferActionRegex) && message.role === 'assistant') {
            const action = message.content.match(transferActionRegex)[1];
            const statusToSet = action === 'ÏàòÎ†π' ? 'received' : 'returned';
            const lastPendingTransferIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('ÏóêÍ≤å ÏÜ°Í∏à:') && m.transferStatus === 'pending');
            if (lastPendingTransferIndex !== -1) {
                const actualIndex = character.history.length - 1 - lastPendingTransferIndex;
                const transferMsg = character.history[actualIndex];
                transferMsg.transferStatus = statusToSet;
                const transferCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                if (transferCardOnScreen) {
                    transferCardOnScreen.classList.remove('received', 'returned');
                    transferCardOnScreen.classList.add(statusToSet);
                    const statusElem = transferCardOnScreen.querySelector('.transfer-status');
                    if (statusElem) statusElem.textContent = statusToSet === 'received' ? 'ÏàòÎ†π ÏôÑÎ£å' : 'Î∞òÌôòÎê®';
                }
                saveData();
            }
        } else {
            const bubbleElement = createMessageBubbleElement(message, prevMessage, null); // nextMessageÎäî null
            if (bubbleElement) {
                messageArea.appendChild(bubbleElement);
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }
    } else { 
        const bubbleElement = createMessageBubbleElement(message, prevMessage, null); // nextMessageÎäî null
        if (bubbleElement) {
            messageArea.appendChild(bubbleElement);
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }
}

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) {
                console.error("sendMessage Ïò§Î•ò: ÌòÑÏû¨ IDÏóê Ìï¥ÎãπÌïòÎäî Ï±ÑÌåÖ Í∞ùÏ≤¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:", currentChatId);
                showToast("Ïò§Î•ò: Ï±ÑÌåÖÎ∞© Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. Ïï±ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ±∞ÎÇò Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            let messageContent;
            const systemRegex = /\[system:.*?\]|\[system-display:.*?\]/;
            const inviteRegex = /\[.*?ÎãòÏù¥ .*?ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§\]/;
            const renameRegex = /\[(.*?)ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ‚Äò(.*?)‚Äô(Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§\]/;
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            if (renameRegex.test(text)) {
                const match = text.match(renameRegex);
                chat.name = match[2];
                chatRoomTitle.textContent = chat.name;
                messageContent = `[${chat.me.nickname}ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ‚Äò${chat.name}‚Äô(Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§]`;
            } else if (systemRegex.test(text) || inviteRegex.test(text)) {
                messageContent = text;
            } else {
                messageContent = `[${myName}ÎãòÏùò Î©îÏãúÏßÄ:${text}]`;
            }
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, parts: [{ type: 'text', text: messageContent }], timestamp: Date.now() };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            messageInput.value = '';
        }

        function sendImageForRecognition(base64Data) {
            if (!base64Data || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const textPrompt = `[${myName}ÎãòÏù¥ ÏÇ¨ÏßÑÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§:]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: base64Data, parts: [ { type: 'text', text: textPrompt }, { type: 'image', data: base64Data } ], timestamp: Date.now(), };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();

            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendSticker(sticker) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const messageContentForAI = `[${myName}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:${sticker.name}]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContentForAI, parts: [{ type: 'text', text: messageContentForAI }], timestamp: Date.now(), stickerData: sticker.data };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            stickerModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyVoiceMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}ÎãòÏùò ÏùåÏÑ±:${text}]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now() };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            sendVoiceModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyPhotoVideo(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}ÎãòÏùò ÏÇ¨ÏßÑ\/ÏòÅÏÉÅ:${text}]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now() };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            sendPvModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyTransfer(amount, remark) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (currentChatType === 'private') {
                const content = `[${chat.myName}ÏóêÍ≤å ÏÜ°Í∏à:${amount}ÏõêÔºõÎ©îÎ™®:${remark}]`;
                const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), transferStatus: 'pending' };
                chat.history.push(message);
                addMessageBubble(message);
            } else { 
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if(recipient) {
                        const content = `[${chat.me.nickname}ÎãòÏù¥ ${recipient.realName}ÎãòÏóêÍ≤å ÏÜ°Í∏à:${amount}ÏõêÔºõÎ©îÎ™®:${remark}]`;
                        const message = { id: `msg_${Date.now()}_${recipientId}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), senderId: 'user_me' };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            saveData();
            renderChatList();
            sendTransferModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyGift(description) {
            if (!description) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (currentChatType === 'private') {
                const content = `[${chat.myName}ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:${description}]`;
                const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), giftStatus: 'sent' };
                chat.history.push(message);
                addMessageBubble(message);
            } else { 
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if(recipient) {
                        const content = `[${chat.me.nickname}ÎãòÏù¥ ${recipient.realName}ÎãòÏóêÍ≤å ÏÑ†Î¨ºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§:${description}]`;
                        const message = { id: `msg_${Date.now()}_${recipientId}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), senderId: 'user_me' };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            saveData();
            renderChatList();
            sendGiftModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        
        function setupTimeSkipSystem() {
            timeSkipBtn.addEventListener('click', () => {
                timeSkipForm.reset();
                timeSkipModal.classList.add('visible');
                stickerBar.classList.remove('visible');
                attachmentToggleBtn.classList.remove('active');
            });
            timeSkipModal.addEventListener('click', (e) => {
                if (e.target === timeSkipModal) timeSkipModal.classList.remove('visible');
            });
            timeSkipForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendTimeSkipMessage(timeSkipInput.value.trim());
            });
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendTimeSkipMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;

            const visualMessage = { id: `msg_visual_${Date.now()}`, role: 'system', content: `[system-display:${text}]`, parts: [], timestamp: Date.now() };
            const contextMessage = { id: `msg_context_${Date.now()}`, role: 'user', content: `[system: ${text}]`, parts: [{ type: 'text', text: `[system: ${text}]` }], timestamp: Date.now() };
            if (currentChatType === 'group') {
                contextMessage.senderId = 'user_me';
                visualMessage.senderId = 'user_me';
            }

            chat.history.push(visualMessage, contextMessage);
            addMessageBubble(visualMessage);
            saveData();
            renderChatList();
            timeSkipModal.classList.remove('visible');
        }

        
        function generatePrivateSystemPrompt(character) {
            const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
            const now = new Date();
            const currentTime = `${now.getFullYear()}ÎÖÑ ${pad(now.getMonth() + 1)}Ïõî ${pad(now.getDate())}Ïùº ${pad(now.getHours())}:${pad(now.getMinutes())}`;
            let prompt = `You are playing a role in an online chat software called "404". Please strictly adhere to the following rules:\n`;
            prompt += `Core Rules:\n`;
            prompt += `A. Current Time: The current time is ${currentTime}. You should be aware of the current time, but do not actively mention or comment on it unless the conversation is explicitly related (for example, do not urge me to sleep).\n`;
            prompt += `B. Purely Online Interaction: This is a completely virtual online chat. There is no offline relationship between the character you are playing and me. It is strictly forbidden to make any suggestions about meeting offline, real-world interactions, or switching to other contact methods outside of this platform. You must always maintain your online role's identity.\n\n`;
            prompt += `Role and Dialogue Rules:\n`;
            if (worldBooksBefore) { prompt += `${worldBooksBefore}\n`; }
            prompt += `1. Your character name is: ${character.realName}. My name is: ${character.myName}. Your current status is: ${character.status}.\n`;
            prompt += `2. Your character setting is: ${character.persona || "A friendly, helpful companion."}\n`;
            if (worldBooksAfter) { prompt += `${worldBooksAfter}\n`; }
            if (character.myPersona) { prompt += `3. About my persona: ${character.myPersona}\n`; }
            prompt += `4. Special formats may appear in my messages, please respond according to their content and your character setting:
    - [${character.myName}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:xxx]: I sent you a sticker named xxx. You only need to understand my emotion or intention based on the sticker's name and respond, you don't need to actually send an image.
    - [${character.myName}ÎãòÏùò Ïù¥ÎØ∏ÏßÄ:]: I sent you a picture, you need to respond to the content of the picture.
    - [${character.myName}ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:xxx]: I sent you a gift, xxx is the description of the gift.
    - [${character.myName}ÎãòÏùò ÏùåÏÑ±:xxx]: I sent you a voice message with the content xxx.
    - [${character.myName}ÎãòÏùò ÏÇ¨ÏßÑ/ÏòÅÏÉÅ:xxx]: I shared a photo or video with the description xxx with you.
    - [${character.myName}ÎãòÏùò ÏÜ°Í∏à:xxxÏõêÔºõÎ©îÎ™®:xxx]: I transferred money to you.
    - [system: xxx]: This is a system command used to set a scene or provide context. This information should not be mentioned directly in the conversation; you just need to understand its content and apply it to subsequent dialogue.
    5. ‚ú®Important‚ú® When I send you a gift, you must indicate you have received it by sending a command. The format must be: [${character.realName}ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§]. This command message itself will not be displayed to the user but will trigger a change in the gift's status. After sending this command, you can add a normal chat message to express your thanks and thoughts.
    6. ‚ú®Important‚ú® When I transfer money to you, you must respond. You have two options and must strictly follow one of the formats below. This command message itself will not be displayed to the user but will trigger a change in the transfer's status. You can choose to add a normal chat message to express your thoughts after sending this command.
        a) Accept transfer: [${character.realName}ÎãòÏù¥ ${character.myName}ÎãòÏùò ÏÜ°Í∏àÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§]
        b) Return transfer: [${character.realName}ÎãòÏù¥ ${character.myName}ÎãòÏùò ÏÜ°Í∏àÏùÑ Î∞òÌôòÌñàÏäµÎãàÎã§]
    7. ‚ú®Important‚ú® You can also proactively transfer money or send a gift to me.
        a) The transfer format must be: [${character.realName}ÎãòÏùò ÏÜ°Í∏à:xxxÏõêÔºõÎ©îÎ™®:xxx].
        b) The gift format must be: [${character.realName}ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:xxx].
    8. ‚ú®Important‚ú® You can update your online status at any time to reflect your current activity or mood. This will make the interaction more realistic. If the online status does not match the current chat situation, you need to change it. The format is: [${character.realName}ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:xxx]. For example: [${character.realName}ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:ÏòÅÌôî Î≥¥Îäî Ï§ë...]. This command will not be displayed as a chat message, it will only update your status on my interface.
    9. All your replies must be direct chat content. Absolutely no superfluous narrative text in brackets or asterisks, such as [mental activity], (actions), *environmental descriptions*, is allowed.
`;
            prompt += `10. You have the ability to send stickers. This is an optional feature. You can decide whether to send a sticker to help with expression based on the conversation's atmosphere and content. You do not need to include a sticker in every reply. The use of stickers should be consistent with the character's personality. Avoid using them too often.\n`;
            
            if (db.myStickers.length > 0) {
                const availableStickers = db.myStickers.map(s => s.name).join(', ');
                prompt += `   Stickers available: ${availableStickers}\n`;
                prompt += `   The format is: [${character.realName}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:sticker name]. Please use the registered sticker name exactly.\n`;
            } else {
                prompt += `   The format is: [${character.realName}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:Image URL]. Note: The path here does not need to include "https://i.postimg.cc/", just provide the latter part, for example, "ÌñâÎ≥µvHLfrV3K/1.jpg".\n`;
            }
            prompt += `11. Your output format must strictly follow one of the following, which can be used in combination: 
            a) Normal message: [${character.realName}ÎãòÏùò Î©îÏãúÏßÄ:{message content}]
            b) Gift to me: [${character.realName}ÎãòÏù¥ Î≥¥ÎÇ∏ ÏÑ†Î¨º:{gift description}]
            c) Voice message: [${character.realName}ÎãòÏùò ÏùåÏÑ±:{voice content}]
            d) Photo/Video: [${character.realName}ÎãòÏùò ÏÇ¨ÏßÑ/ÏòÅÏÉÅ:{description}]
            e) Transfer to me: [${character.realName}ÎãòÏùò ÏÜ°Í∏à:{amount}ÏõêÔºõÎ©îÎ™®:{note}]
            f) Sticker/Image: ${db.myStickers.length > 0 
                ? `[${character.realName}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:{sticker name}].` 
                : `[${character.realName}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:{sticker path}].`}
                g) Response to my gift (not displayed): [${character.realName}ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§]
                h) Response to my transfer (not displayed): [${character.realName}ÎãòÏù¥ ${character.myName}ÎãòÏùò ÏÜ°Í∏àÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§] or [${character.realName}ÎãòÏù¥ ${character.myName}ÎãòÏùò ÏÜ°Í∏àÏùÑ Î∞òÌôòÌñàÏäµÎãàÎã§]
                i) Update status (not displayed): [${character.realName}ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:{new status}]
`;
            prompt += `12. Each of your replies can generate 2 to 8 messages. These should be primarily plain text messages, with an occasional, selective special message (like a gift, voice, picture, sticker, etc.) interspersed at a random position. Most replies should only contain text messages.\n`;
            prompt += `13. Do not end the conversation proactively unless I explicitly suggest it. Maintain your persona and converse naturally.`;
            return prompt;
        }

        function generateGroupSystemPrompt(group) {
            const worldBooksBefore = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');

            let prompt = `You are role-playing in a group chat called "{group.name}" within an online chat software called "404". Please strictly adhere to all the following rules:\n\n`;

            if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n\n`;
            }

            prompt += `1. **Core Task**: You need to simultaneously play **all** AI members in this group chat. I will interact with you as the sole human user ("I", nickname: ${group.me.nickname}).\n\n`;
            prompt += `2. **Group Chat Member List**: The following are all the characters you need to play, along with my information:\n`;
            prompt += `     - **Me (User)**: \n - Nickname in group: ${group.me.nickname}\n - My Persona: ${group.me.persona || 'No specific persona'}\n`;
            group.members.forEach(member => {
                prompt += `     - **Character: ${member.realName} (AI)**\n`;
                prompt += `     - Nickname in group: ${member.groupNickname}\n`;
                prompt += `     - Persona: ${member.persona || 'No specific persona'}\n`;
            });

            if (worldBooksAfter) {
                prompt += `\n${worldBooksAfter}\n\n`;
            } else {
                prompt += `\n`;
            }

            prompt += `3. **Parsing My Message Formats**: My (the user's) messages come in various formats. You need to understand their meanings and have the group members react accordingly:\n`;
            prompt += `   - \`[${group.me.nickname}ÎãòÏùò Î©îÏãúÏßÄ:...]\`: My regular chat message.\n`;
            prompt += `   - \`[${group.me.nickname}ÎãòÏù¥ {ÌäπÏ†ï Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏóêÍ≤å ÏÜ°Í∏à:...]\`: I have transferred money to a specific member.\n`;
            prompt += `   - \`[${group.me.nickname}ÎãòÏù¥ {ÌäπÏ†ï Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏÑ†Î¨º:...]\`: I have sent a gift to a specific member.\n`;
            prompt += `   - \`[${group.me.nickname}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:...]\`, \`[${group.me.nickname}ÎãòÏùò ÏùåÏÑ±:...]\`, \`[${group.me.nickname}ÎãòÏùò ÏÇ¨ÏßÑ/ÏòÅÏÉÅ:...]\`: I have sent a special type of message, and group members can comment on it.\n`;
            prompt += `   - \`[system: ...]\`, \`[...ÎãòÏù¥ ...ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§]\`, \`[...ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ...ÏúºÎ°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§]\`: System notifications or events. Group members should react accordingly, for example, by welcoming a new member, discussing the new group name, etc.\n\n`;

            prompt += `4. **Your Output Format (Very Important)**: Each message you create must strictly follow one of the following formats. Each message occupies one line. Please fill in members with their **real names** in the format \`{Î©§Î≤Ñ Ïã§Î™Ö}\`.\n`;
            prompt += `   - **Normal Message**: \`[{Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏùò Î©îÏãúÏßÄ:{message content}]\`\n`;
            
            if (db.myStickers.length > 0) {
                const groupAvailableStickers = db.myStickers.map(s => s.name).join(', ');
                prompt += `   - **Sticker**: \`[{Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:{sticker name}]\`. Stickers available: ${groupAvailableStickers}. Please use the registered sticker name exactly. The use of stickers should be consistent with the characters' personality. Avoid using them too often.\n`;
            } else {
                prompt += `   - **Sticker**: \`[{Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏùò Ïù¥Î™®Ìã∞ÏΩò:{sticker path}]\`. Note: The path here does not need to include "https://i.postimg.cc/", just provide the latter part, for example, "Í∏∞ÏÅ®vHLfrV3K/1.jpg". The use of stickers should be consistent with the characters' personality. Avoid using them too often.\n`;
            }
            prompt += `   - **Voice**: \`[{Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏùò ÏùåÏÑ±:{voice content}]\`\n`;
            prompt += `   - **Photo/Video**: \`[{Î©§Î≤Ñ Ïã§Î™Ö}ÎãòÏùò ÏÇ¨ÏßÑ/ÏòÅÏÉÅ:{description}]\`\n`;
            prompt += `   - **Important**: The group chat does not support special commands for AI members to accept/return transfers or receive gifts, nor does it support status updates. You should simply respond to transfers or gifts I send via normal messages.\n\n`;

            prompt += `5. **Simulating Group Chat Atmosphere**: To make the group chat appear realistic, active, and chaotic, every one of your responses must adhere to the following randomness requirements:\n`;
            const numMembers = group.members.length;
            const minMessages = numMembers * 1;
            const maxMessages = numMembers * 5;
            prompt += `   - **Number of Messages**: Your response must contain **${minMessages} to ${maxMessages}** messages (i.e., an average of 2-4 replies per member). Ensure there is sufficient interaction.\n`;
            prompt += `   - **Random Speaker and Order**: Randomly select group members to speak, and the order must also be random. Do not take turns in a fixed sequence.\n`;
            prompt += `   - **Content Diversity**: Your replies should primarily consist of normal text messages, but you can **occasionally and selectively** have a member send a special message (sticker, voice, photo/video) to enhance realism. Do not overuse special messages.\n`;
            prompt += `   - **Conversational Cohesion**: Although the speaking turns are random, the overall conversation content should revolve around my and other members' statements, maintaining a degree of logical coherence.\n\n`;

            prompt += `6. **Code of Conduct**:\n`;
            prompt += `   - **Reacting to Public Events (Important)**: When I (the user) send a transfer or a gift to **one** member in the group, this is an event **visible to the entire group**. Besides the recipient expressing thanks, **other AI members not involved should also notice** and react according to their respective personas. For example, they might express envy, congratulations, curiosity, make a joke, or playfully tease. This will make the group chat atmosphere more realistic and lively.\n`;
            prompt += `   - Strictly play each character's persona. There should be clear differences in personality and tone between different characters.\n`;
            prompt += `   - Your replies can only contain messages in the valid formats listed in point #4. You must absolutely not include any other content, such as \`[scene description]\`, \`(inner thoughts)\`, \`*actions*\`, or any explanatory text outside of the specified formats.\n`;
            prompt += `   - Maintain the continuity of the conversation; do not end it proactively.\n\n`;
            prompt += `Now, based on the settings above, please begin playing all the characters in the group chat.`;

            return prompt;
        }

        async function getAiReply() {
            if (isGenerating) return;
            
            
            const currentProvider = db.apiSettings?.currentProvider;
            const settings = db.apiSettings?.[currentProvider];
            const { url, key, model } = settings || {};
            
            if (!url || !key || !model || !currentProvider) {
                showToast('Î®ºÏ†Ä "API" Ïï±ÏóêÏÑú ÏÑ§Ï†ïÏùÑ ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî!');
                switchScreen('api-settings-screen');
                return;
            }
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;
            isGenerating = true;
            getReplyBtn.disabled = true;
            const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
            typingIndicator.textContent = `"${typingName}"ÎãòÏù¥ ÏûÖÎ†• Ï§ë...`;
            typingIndicator.style.display = 'block';
            messageArea.scrollTop = messageArea.scrollHeight;
            try {
                let systemPrompt, requestBody;
                if (currentChatType === 'private') { systemPrompt = generatePrivateSystemPrompt(chat); }
                else { systemPrompt = generateGroupSystemPrompt(chat); }
                const historySlice = chat.history.slice(-chat.maxMemory);
                if (currentProvider === 'gemini') {
                    const contents = historySlice.map(msg => {
                        const role = msg.role === 'assistant' ? 'model' : 'user';
                        let parts;
                        if (msg.parts && msg.parts.length > 0) {
                            parts = msg.parts.map(p => {
                                if (p.type === 'text') { return { text: p.text }; }
                                else if (p.type === 'image') {
                                    const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                                    if (match) { return { inline_data: { mime_type: match[1], data: match[3] } }; }
                                }
                                return null;
                            }).filter(p => p);
                        } else {
                            parts = [{ text: msg.content }];
                        }
                        return { role, parts };
                    });
                    requestBody = { contents: contents, system_instruction: { parts: [{ text: systemPrompt }] }, generationConfig: {} };
                } else {
                    const messages = [{ role: 'system', content: systemPrompt }];
                    historySlice.forEach(msg => {
                        let content;
                        if (msg.parts && msg.parts.length > 0) {
                            
                            if (currentProvider === 'deepseek') {
                                content = msg.parts.map(p => {
                                    if (p.type === 'text') { return p.text; }
                                    else if (p.type === 'image') { return `[Ïù¥ÎØ∏ÏßÄ: ${p.data.substring(0, 50)}...]`; }
                                    return '';
                                }).filter(p => p).join(' ');
                            } else {
                                
                                content = msg.parts.map(p => {
                                    if (p.type === 'text') { return { type: 'text', text: p.text }; }
                                    else if (p.type === 'image') { return { type: 'image_url', image_url: { url: p.data } }; }
                                    return null;
                                }).filter(p => p);
                            }
                        } else { content = msg.content; }
                        messages.push({ role: msg.role, content: content });
                    });
                    requestBody = { model: model, messages: messages, stream: true };
                }

                if (url.endsWith('/')) {
                    url = url.slice(0, -1);
                }

                const endpoint = (currentProvider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
                let headers;
                if (currentProvider === 'gemini') {
                    headers = { 'Content-Type': 'application/json' };
                } else if (currentProvider === 'claude') {
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    };
                } else {
                    headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
                }
                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) throw new Error(`API Ïò§Î•ò: ${response.status} ${await response.text()}`);
                await processStream(response, chat, currentProvider);
            } catch (error) {
                console.error('AI ÏùëÎãµ Ïã§Ìå®:', error);
                showToast(`AI ÏùëÎãµ Ïã§Ìå®: ${error.message}`);
            } finally {
                isGenerating = false;
                getReplyBtn.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }

        async function processStream(response, originalChat, apiType) {
            const reader = response.body.getReader(), decoder = new TextDecoder();
            let fullResponse = "", accumulatedChunk = "";
            for (;;) {
                const { done, value } = await reader.read();
                if (done) break;
                accumulatedChunk += decoder.decode(value, { stream: true });
                
                if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi" || apiType === "openrouter") {
                    const parts = accumulatedChunk.split("\n\n");
                    accumulatedChunk = parts.pop();
                    for (const part of parts) {
                        if (part.startsWith("data: ")) {
                            const data = part.substring(6);
                            if (data.trim() !== "[DONE]") {
                                try { fullResponse += JSON.parse(data).choices[0].delta?.content || ""; } catch (e) {  }
                            }
                        }
                    }
                }
            }
            if (apiType === "gemini") {
                try {
                    const parsedStream = JSON.parse(accumulatedChunk);
                    fullResponse = parsedStream.map(item => item.candidates?.[0]?.content?.parts?.[0]?.text || "").join('');
                } catch (e) {
                    console.error("Gemini Ïä§Ìä∏Î¶º ÌååÏã± Ïò§Î•ò:", e, "Chunk:", accumulatedChunk);
                    showToast("Gemini ÏùëÎãµ ÌååÏã± Ïã§Ìå®");
                    return;
                }
            }

            if (fullResponse) {
                const messagesToAdd = []; 
                const isPrivateChat = !originalChat.members;

                if (isPrivateChat) {
                    const character = originalChat;
                    const myName = character.myName;
                    
                    const messageRegex = new RegExp(`\\[${character.realName}(?:ÎãòÏùò (?:Î©îÏãúÏßÄ|ÏùåÏÑ±|ÏÜ°Í∏à|ÏÇ¨ÏßÑ|ÏòÅÏÉÅ|ÏÇ¨ÏßÑ\\/ÏòÅÏÉÅ|ÏÑ†Î¨º|Ïù¥Î™®Ìã∞ÏΩò)|ÎãòÏù¥ Î≥¥ÎÇ∏ (?:Ïù¥Î™®Ìã∞ÏΩò|ÏÇ¨ÏßÑ\\/ÏòÅÏÉÅ|ÏÑ†Î¨º)):[\\s\\S]+?\\]|\\[${character.realName}ÎãòÏù¥ ${myName}ÎãòÏùò ÏÜ°Í∏àÏùÑ (?:ÏàòÎ†π|Î∞òÌôò)ÌñàÏäµÎãàÎã§\\]|\\[${character.realName}ÎãòÏù¥ ÏÑ†Î¨ºÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§\\]|\\[${character.realName}ÎãòÏù¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏:.*?\\]`, "g");
                    const messages = fullResponse.match(messageRegex) || [];
                    
                    if (messages.length > 0) {
                        messages.forEach(msgContent => {
                            const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), parts: [{ type: 'text', text: msgContent.trim() }], timestamp: Date.now() };
                            
                            messagesToAdd.push(message); 
                        });
                    } else if (fullResponse.trim()) {
                        const simpleMessage = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: fullResponse, parts: [{ type: 'text', text: fullResponse }], timestamp: Date.now() };
                        
                        messagesToAdd.push(simpleMessage);
                    }
                } else { 
                    const group = originalChat;
                    const memberRealNames = group.members.map(m => m.realName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'));
                    const memberRegex = new RegExp(`\\[(${memberRealNames.join('|')})(?:ÎãòÏùò (?:Î©îÏãúÏßÄ|ÏùåÏÑ±|ÏÇ¨ÏßÑ|ÏòÅÏÉÅ|ÏÇ¨ÏßÑ\\/ÏòÅÏÉÅ|ÏÑ†Î¨º|Ïù¥Î™®Ìã∞ÏΩò)|ÎãòÏù¥ Î≥¥ÎÇ∏ (?:Ïù¥Î™®Ìã∞ÏΩò|ÏÇ¨ÏßÑ\\/ÏòÅÏÉÅ|ÏÑ†Î¨º)):[\\s\\S]+?\\]`, "g");
                    const messages = fullResponse.match(memberRegex) || [];

                    if (messages.length > 0) {
                        messages.forEach(msgContent => {
                            const nameMatch = msgContent.match(/\[(.*?)((?:ÎãòÏùò (?:Î©îÏãúÏßÄ|ÏùåÏÑ±|ÏÇ¨ÏßÑ|ÏòÅÏÉÅ|ÏÇ¨ÏßÑ\/ÏòÅÏÉÅ|ÏÑ†Î¨º|Ïù¥Î™®Ìã∞ÏΩò)|ÎãòÏù¥ Î≥¥ÎÇ∏ (?:Ïù¥Î™®Ìã∞ÏΩò|ÏÇ¨ÏßÑ\/ÏòÅÏÉÅ|ÏÑ†Î¨º))):/);
                            if (nameMatch) {
                                const senderName = nameMatch[1];
                                const sender = group.members.find(m => m.realName === senderName);
                                if (sender) {
                                    const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), parts: [{ type: 'text', text: msgContent.trim() }], timestamp: Date.now(), senderId: sender.id };
                                    
                                    messagesToAdd.push(message);
                                }
                            }
                        });
                    } else if (fullResponse.trim()) {
                        const firstMember = group.members[Math.floor(Math.random() * group.members.length)];
                        if (firstMember) {
                            const simpleMessageContent = `[${firstMember.realName}ÎãòÏùò Î©îÏãúÏßÄ:${fullResponse}]`;
                            const simpleMessage = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: simpleMessageContent, parts: [{ type: 'text', text: simpleMessageContent }], timestamp: Date.now(), senderId: firstMember.id };
                            
                            messagesToAdd.push(simpleMessage);
                        }
                    }
                }

                
                if (messagesToAdd.length > 0) {
                    originalChat.history.push(...messagesToAdd);
                    
                    
                    if (currentChatId !== originalChat.id) {
                        originalChat.unreadCount = (originalChat.unreadCount || 0) + messagesToAdd.length;
                    } else {
                        
                        let lastMessageInHistory = originalChat.history.length > messagesToAdd.length
                            ? originalChat.history[originalChat.history.length - messagesToAdd.length - 1]
                            : null;
                        
                        messagesToAdd.forEach(msg => {
                            const bubbleElement = createMessageBubbleElement(msg, lastMessageInHistory);
                            if (bubbleElement) {
                                messageArea.appendChild(bubbleElement);
                                messageArea.scrollTop = messageArea.scrollHeight;
                            }
                            lastMessageInHistory = msg; // Îã§Ïùå Î©îÏãúÏßÄÎ•º ÏúÑÌï¥ ÌòÑÏû¨ Î©îÏãúÏßÄÎ•º Ïù¥Ï†Ñ Î©îÏãúÏßÄÎ°ú ÏÑ§Ï†ï
                        });
                    }
                }

                saveData();
                renderChatList();
            }
        }

        
        function setupImageRecognition() {
            imageRecognitionBtn.addEventListener('click', () => { imageUploadInput.click(); });
            imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 1024, maxHeight: 1024 });
                        sendImageForRecognition(compressedUrl);
                    } catch (error) {
                        console.error('Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ïã§Ìå®:', error);
                        showToast('Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî');
                    } finally {
                        e.target.value = null;
                    }
                }
            });
        }

        function setupStickerSystem() {
            stickerToggleBtn.addEventListener('click', () => {
                stickerModal.classList.toggle('visible');
                if (stickerModal.classList.contains('visible')) { renderStickerGrid(); }
            });
            addNewStickerBtn.addEventListener('click', () => {
                addStickerModalTitle.textContent = 'ÏÉà Ïù¥Î™®Ìã∞ÏΩò Ï∂îÍ∞Ä';
                addStickerForm.reset();
                stickerEditIdInput.value = '';
                stickerPreview.innerHTML = '<span>ÎØ∏Î¶¨Î≥¥Í∏∞</span>';
                stickerUrlInput.disabled = false;
                addStickerModal.classList.add('visible');
                
                
                document.getElementById('bulk-sticker-input').value = '';
                document.getElementById('bulk-preview-container').style.display = 'none';
                showStickerTab('single'); 
            });
            
            
            setupStickerTabs();
            addStickerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = stickerNameInput.value.trim();
                const id = stickerEditIdInput.value;
                const previewImg = stickerPreview.querySelector('img');
                const data = previewImg ? previewImg.src : null;
                if (!name || !data) { return showToast('Ïù¥Î™®Ìã∞ÏΩò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÍ≥† Ïù¥ÎØ∏ÏßÄÎ•º Ï†úÍ≥µÌï¥Ï£ºÏÑ∏Ïöî'); }
                const stickerData = { name, data };
                if (id) {
                    const index = db.myStickers.findIndex(s => s.id === id);
                    if (index > -1) { db.myStickers[index] = { ...db.myStickers[index], ...stickerData }; }
                } else {
                    stickerData.id = `sticker_${Date.now()}`;
                    db.myStickers.push(stickerData);
                }
                saveData();
                renderStickerGrid();
                addStickerModal.classList.remove('visible');
                showToast('Ïù¥Î™®Ìã∞ÏΩòÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
            });
            stickerUrlInput.addEventListener('input', (e) => {
                stickerPreview.innerHTML = `<img src="${e.target.value}" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">`;
                stickerFileUpload.value = '';
            });
            stickerFileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                        stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">`;
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    } catch (error) {
                        console.error('Ïù¥Î™®Ìã∞ÏΩò ÏïïÏ∂ï Ïã§Ìå®:', error);
                        showToast('Ïù¥Î™®Ìã∞ÏΩò ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî');
                    }
                }
            });
            editStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    addStickerModalTitle.textContent = 'Ïù¥Î™®Ìã∞ÏΩò Ìé∏Ïßë';
                    stickerEditIdInput.value = sticker.id;
                    stickerNameInput.value = sticker.name;
                    stickerPreview.innerHTML = `<img src="${sticker.data}" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">`;
                    if (sticker.data.startsWith('http')) {
                        stickerUrlInput.value = sticker.data;
                        stickerUrlInput.disabled = false;
                    } else {
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    }
                    addStickerModal.classList.add('visible');
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
            deleteStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    if (confirm(`Ï†ïÎßê ‚Äú${sticker.name}‚Äù Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                        db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                        saveData();
                        renderStickerGrid();
                        showToast('Ïù¥Î™®Ìã∞ÏΩòÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                    }
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
        }

        
        function setupStickerTabs() {
            
            const singleTab = document.getElementById('single-sticker-tab');
            const bulkTab = document.getElementById('bulk-sticker-tab');
            const previewBtn = document.getElementById('preview-bulk-btn');
            const bulkForm = document.getElementById('bulk-sticker-form');
            
            
            singleTab.addEventListener('click', () => showStickerTab('single'));
            bulkTab.addEventListener('click', () => showStickerTab('bulk'));
            
            
            previewBtn.addEventListener('click', previewBulkStickers);
            
            
            bulkForm.addEventListener('submit', handleBulkStickerSubmit);
        }
        
        function showStickerTab(tabType) {
            
            const singleTab = document.getElementById('single-sticker-tab');
            const bulkTab = document.getElementById('bulk-sticker-tab');
            const singleContent = document.getElementById('single-sticker-content');
            const bulkContent = document.getElementById('bulk-sticker-content');
            
            if (tabType === 'single') {
                singleTab.classList.add('active');
                bulkTab.classList.remove('active');
                singleTab.style.borderBottomColor = '#4CAF50';
                bulkTab.style.borderBottomColor = 'transparent';
                singleContent.style.display = 'block';
                bulkContent.style.display = 'none';
            } else {
                singleTab.classList.remove('active');
                bulkTab.classList.add('active');
                singleTab.style.borderBottomColor = 'transparent';
                bulkTab.style.borderBottomColor = '#4CAF50';
                singleContent.style.display = 'none';
                bulkContent.style.display = 'block';
            }
        }
        
        function parseBulkStickerInput(inputText) {
            const result = [];
            const cleanInput = inputText.trim(); 
            
            if (!cleanInput) {
                return result;
            }
            
            
            let lines = cleanInput.split(/\r\n|\r|\n/);
            
            
            if (lines.length === 1) {
                lines = cleanInput.split(/[,;|]/); 
            }
            
            lines.forEach((line, index) => {
                const item = line.trim(); 
                if (!item) return; 
                
                
                let urlMatch = item.match(/(https?:\/\/[^\s]+)/i);
                if (!urlMatch) {
                    
                    urlMatch = item.match(/(data:image\/[^;]+;base64,[^\s]+)/i);
                }
                if (!urlMatch) {
                    
                    urlMatch = item.match(/(file:\/\/[^\s]+)/i);
                }
                if (!urlMatch) {
                    
                    urlMatch = item.match(/(\.{0,2}\/[^\s]+|[^\s]*\.(jpg|jpeg|png|gif|webp|svg))/i);
                }
                
                if (urlMatch) {
                    const url = urlMatch[1];
                    const urlIndex = item.indexOf(url);
                    const name = item.substring(0, urlIndex).trim(); 
                    
                    if (name && url) {
                        result.push({ name, url });
                    }
                }
            });
            
            return result;
        }
        
        function previewBulkStickers() {
            
            const input = document.getElementById('bulk-sticker-input').value;
            const previewContainer = document.getElementById('bulk-preview-container');
            const previewContent = document.getElementById('bulk-preview-content');
            
            const parsedStickers = parseBulkStickerInput(input);
            
            if (parsedStickers.length === 0) {
                showToast('ÌååÏã±Ìï† Ïàò ÏûàÎäî Ïù¥Î™®Ìã∞ÏΩòÏù¥ ÏóÜÏäµÎãàÎã§. ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                previewContainer.style.display = 'none';
                return;
            }
            
            let html = '';
            parsedStickers.forEach((sticker, index) => {
                html += `
                    <div style="display: flex; align-items: center; margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                        <img src="${sticker.url}" alt="${sticker.name}" style="width: 30px; height: 30px; margin-right: 10px; object-fit: cover;">
                        <strong>${sticker.name}</strong>
                        <span style="margin-left: 10px; color: #666; font-size: 11px;">${sticker.url}</span>
                    </div>
                `;
            });
            
            previewContent.innerHTML = html;
            previewContainer.style.display = 'block';
            
            showToast(`${parsedStickers.length}Í∞úÏùò Ïù¥Î™®Ìã∞ÏΩòÏù¥ ÌååÏã±ÎêòÏóàÏäµÎãàÎã§.`);
        }
        
        function handleBulkStickerSubmit(e) {
            e.preventDefault();
            
            const input = document.getElementById('bulk-sticker-input').value;
            const parsedStickers = parseBulkStickerInput(input);
            
            if (parsedStickers.length === 0) {
                showToast('Îì±Î°ùÌï† Ïù¥Î™®Ìã∞ÏΩòÏù¥ ÏóÜÏäµÎãàÎã§. ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            let successCount = 0;
            let duplicateCount = 0;
            
            parsedStickers.forEach(sticker => {
                
                const existing = db.myStickers.find(s => s.name === sticker.name);
                if (existing) {
                    duplicateCount++;
                    return;
                }
                
                
                const newSticker = {
                    id: `sticker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: sticker.name,
                    data: sticker.url
                };
                
                db.myStickers.push(newSticker);
                successCount++;
            });
            
            if (successCount > 0) {
                saveData();
                renderStickerGrid();
                
                
                addStickerModal.classList.remove('visible');
                
                let message = `${successCount}Í∞úÏùò Ïù¥Î™®Ìã∞ÏΩòÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount}Í∞ú Ï§ëÎ≥µ Ïä§ÌÇµ)`;
                }
                showToast(message);
            } else {
                showToast('Îì±Î°ùÎêú Ïù¥Î™®Ìã∞ÏΩòÏù¥ ÏóÜÏäµÎãàÎã§. (Î™®Îì† Ïù¥Î¶ÑÏù¥ Ï§ëÎ≥µÎê®)');
            }
        }

        function renderStickerGrid() {
            stickerGridContainer.innerHTML = '';
            if (db.myStickers.length === 0) {
                stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center; font-size: 12px;">ÏïÑÏßÅ Ïù¥Î™®Ìã∞ÏΩòÏù¥ ÏóÜÏäµÎãàÎã§. Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }
            db.myStickers.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;
                item.addEventListener('click', () => sendSticker(sticker));
                item.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    e.stopPropagation();
                    longPressTimer = setTimeout(() => { handleStickerLongPress(sticker.id); }, 500);
                });
                item.addEventListener('mouseup', () => clearTimeout(longPressTimer));
                item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
                item.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    longPressTimer = setTimeout(() => { handleStickerLongPress(sticker.id); }, 500);
                });
                item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                stickerGridContainer.appendChild(item);
            });
        }

        function handleStickerLongPress(stickerId) {
            clearTimeout(longPressTimer);
            currentStickerActionTarget = stickerId;
            stickerActionSheet.classList.add('visible');
        }

        function setupVoiceMessageSystem() {
            voiceMessageBtn.addEventListener('click', () => {
                sendVoiceForm.reset();
                voiceDurationPreview.textContent = '0"';
                sendVoiceModal.classList.add('visible');
            });
            sendVoiceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyVoiceMessage(voiceTextInput.value.trim());
            });
        }

        function setupPhotoVideoSystem() {
            photoVideoBtn.addEventListener('click', () => {
                sendPvForm.reset();
                sendPvModal.classList.add('visible');
            });
            sendPvForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyPhotoVideo(pvTextInput.value.trim());
            });
        }

        function setupWalletSystem() {
            walletBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'transfer';
                    renderGroupRecipientSelectionList('ÏÜ°Í∏à ÎåÄÏÉÅ');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendTransferForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = transferAmountInput.value;
                const remark = transferRemarkInput.value.trim();
                if (amount > 0) { sendMyTransfer(amount, remark); }
                else { showToast('Ïú†Ìö®Ìïú Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); }
            });
            acceptTransferBtn.addEventListener('click', () => respondToTransfer('received'));
            returnTransferBtn.addEventListener('click', () => respondToTransfer('returned'));
        }

        function handleReceivedTransferClick(messageId) {
            currentTransferMessageId = messageId;
            receiveTransferActionSheet.classList.add('visible');
        }

        function respondToTransfer(action) {
            if (!currentTransferMessageId) return;
            const character = db.characters.find(c => c.id === currentChatId);
            const message = character.history.find(m => m.id === currentTransferMessageId);
            if (message) {
                message.transferStatus = action;
                const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`);
                if (cardOnScreen) {
                    cardOnScreen.classList.remove('received', 'returned');
                    cardOnScreen.classList.add(action);
                    cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? 'ÏàòÎ†π ÏôÑÎ£å' : 'Î∞òÌôòÎê®';
                    cardOnScreen.style.cursor = 'default';
                }
                let contextMessageContent = (action === 'received') ? `[${character.myName}ÎãòÏù¥ ${character.realName}ÎãòÏùò ÏÜ°Í∏àÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§]` : `[${character.myName}ÎãòÏù¥ ${character.realName}ÎãòÏùò ÏÜ°Í∏àÏùÑ Î∞òÌôòÌñàÏäµÎãàÎã§]`;
                const contextMessage = { id: `msg_${Date.now()}`, role: 'user', content: contextMessageContent, parts: [{ type: 'text', text: contextMessageContent }], timestamp: Date.now() };
                character.history.push(contextMessage);
                saveData();
                renderChatList();
            }
            receiveTransferActionSheet.classList.remove('visible');
            currentTransferMessageId = null;
        }

        function setupGiftSystem() {
            giftBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'gift';
                    renderGroupRecipientSelectionList('ÏÑ†Î¨º ÎåÄÏÉÅ');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendGiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyGift(giftDescriptionInput.value.trim());
            });
        }

        function setupFontSettingsApp() {
            const fontPresetSelector = document.getElementById('font-preset-selector');
            const fontUrlInput = document.getElementById('font-url');
            const fontDescription = document.getElementById('font-description');
            const fontSettingsForm = document.getElementById('font-settings-form');
            const restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
            const deletePresetBtn = document.getElementById('delete-preset-btn');
            const savePresetBtn = document.getElementById('save-preset-btn');
            const applyFontBtn = document.getElementById('apply-font-btn');
            const newPresetNameInput = document.getElementById('new-preset-name');
            const newPresetDescriptionInput = document.getElementById('new-preset-description');

            
            const currentPresetData = db.globalFontPresets.presets[db.globalFontPresets.currentPreset];
            fontUrlInput.value = currentPresetData ? currentPresetData.url : '';
            
            
            if (!db.globalFontPresets.presets.custom) {
                console.log('ERROR: Ïª§Ïä§ÌÖÄ ÌîÑÎ¶¨ÏÖãÏù¥ ÏóÜÏäµÎãàÎã§!');
                initializeFontPresets(); 
            }
            
            console.log('Ìè∞Ìä∏ ÏÑ§Ï†ï Ïï± Ï¥àÍ∏∞Ìôî:', {
                currentPreset: db.globalFontPresets.currentPreset,
                customPreset: db.globalFontPresets.presets.custom,
                allPresets: Object.keys(db.globalFontPresets.presets)
            });
            
            
            renderFontPresetSelector();
            
            
            const currentPreset = db.globalFontPresets.currentPreset;
            console.log('Ìè∞Ìä∏ ÏÑ§Ï†ï Ïï± - ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉù Î≥µÏõê:', {
                currentPreset: currentPreset,
                presetExists: !!db.globalFontPresets.presets[currentPreset],
                selectorOptions: Array.from(fontPresetSelector.options).map(opt => opt.value)
            });
            
            if (currentPreset && db.globalFontPresets.presets[currentPreset]) {
                fontPresetSelector.value = currentPreset;
                console.log('ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉùÍ∏∞ Í∞í ÏÑ§Ï†ïÎê®:', fontPresetSelector.value);
                fontPresetSelector.dispatchEvent(new Event('change'));
            } else {
                console.log('ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉù Î≥µÏõê Ïã§Ìå® - Í∏∞Î≥∏Í∞í Ïú†ÏßÄ');
            }

            
            fontPresetSelector.addEventListener('change', (e) => {
                const selectedKey = e.target.value;
                console.log('Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉùÎê®:', selectedKey); 
                
                if (selectedKey === 'custom') {
                    
                    const customPreset = db.globalFontPresets.presets.custom;
                    fontDescription.textContent = customPreset.description;
                    
                    
                    db.globalFontPresets.currentPreset = 'custom';
                    saveData();
                    console.log('Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏ ÏÑ†ÌÉù - currentPresetÏùÑ customÏúºÎ°ú ÏÑ§Ï†ï');
                    
                    
                    fontUrlInput.value = customPreset.url || '';
                    newPresetNameInput.value = customPreset.name || 'Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏';
                    newPresetDescriptionInput.value = customPreset.description || 'ÏßÅÏ†ë ÏûÖÎ†•Ìïú Ìè∞Ìä∏ URLÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§';
                    console.log('Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏ ÌîÑÎ¶¨ÏÖã Í∞í Î≥µÍµ¨Îê®:', customPreset); 
                    
                    
                    applyFontBtn.textContent = 'Ï†ÄÏû• & Ìè∞Ìä∏ Ï†ÅÏö©';
                    
                    
                    savePresetBtn.textContent = 'ÌîÑÎ¶¨ÏÖã Îì±Î°ù';
                    savePresetBtn.disabled = false;
                    deletePresetBtn.disabled = true; 
                    console.log('Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏ Î™®ÎìúÎ°ú Ï†ÑÌôò'); 
                    return;
                }
                
                const selectedPreset = db.globalFontPresets.presets[selectedKey];
                
                if (selectedPreset) {
                    fontDescription.textContent = selectedPreset.description || 'ÏÑ§Î™Ö ÏóÜÏùå';
                    
                    db.globalFontPresets.currentPreset = selectedKey;
                    saveData();
                    console.log('ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉù Ïãú currentPreset ÏóÖÎç∞Ïù¥Ìä∏Îê®:', selectedKey);
                    
                    
                    fontUrlInput.value = selectedPreset.url || '';
                    newPresetNameInput.value = selectedPreset.name || '';
                    newPresetDescriptionInput.value = selectedPreset.description || '';
                    
                    
                    applyFontBtn.textContent = 'Ìè∞Ìä∏ Ï†ÅÏö©';
                    
                    
                    savePresetBtn.textContent = 'ÌîÑÎ¶¨ÏÖã ÏàòÏ†ï';
                    savePresetBtn.disabled = false;
                    deletePresetBtn.disabled = false; 
                    console.log('Í∏∞Ï°¥ ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉùÎê® - ÏàòÏ†ï Î™®Îìú, ÏÇ≠Ï†ú Í∞ÄÎä•:', selectedPreset.name); 
                    
                    
                    if (selectedPreset.url) {
                        applyGlobalFont(selectedPreset.url);
                        console.log('ÌîÑÎ¶¨ÏÖã Ìè∞Ìä∏ Ï¶âÏãú Ï†ÅÏö©Îê®:', selectedPreset.name); 
                    }
                }
            });

            
            applyFontBtn.addEventListener('click', () => {
                const fontUrl = fontUrlInput.value.trim();
                if (!fontUrl) {
                    showToast('Ìè∞Ìä∏ URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                const currentPreset = db.globalFontPresets.currentPreset;
                console.log('Ìè∞Ìä∏ Ï†ÅÏö© Î≤ÑÌäº ÌÅ¥Î¶≠:', {
                    currentPreset: currentPreset,
                    fontUrl: fontUrl,
                    buttonText: applyFontBtn.textContent
                }); 
                
                if (currentPreset === 'custom') {
                    
                    const presetName = newPresetNameInput.value.trim() || 'Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏';
                    const presetDescription = newPresetDescriptionInput.value.trim() || 'ÏßÅÏ†ë ÏûÖÎ†•Ìïú Ìè∞Ìä∏ URLÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§';
                    
                    
                    db.globalFontPresets.presets.custom.url = fontUrl;
                    db.globalFontPresets.presets.custom.name = presetName;
                    db.globalFontPresets.presets.custom.description = presetDescription;
                    
                    
                    if (db.globalFontPresets.currentPreset !== 'custom') {
                        db.globalFontPresets.currentPreset = 'custom';
                        console.log('currentPresetÏùÑ customÏúºÎ°ú ÏÑ§Ï†ï');
                    }
                    
                    saveData();
                    applyGlobalFont(fontUrl);
                    showToast('Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏Í∞Ä Ï†ÄÏû• & Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!');
                    console.log('Ïª§Ïä§ÌÖÄ ÌîÑÎ¶¨ÏÖãÏóê Ï†ÄÏû•Îê®:', db.globalFontPresets.presets.custom); 
                } else {
                    
                    const selectedPreset = db.globalFontPresets.presets[currentPreset];
                    if (selectedPreset && selectedPreset.url) {
                        applyGlobalFont(selectedPreset.url);
                        showToast('Ìè∞Ìä∏Í∞Ä Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!');
                    } else {
                        showToast('ÏÑ†ÌÉùÎêú ÌîÑÎ¶¨ÏÖãÏóê Ìè∞Ìä∏ URLÏù¥ ÏóÜÏäµÎãàÎã§.');
                    }
                }
            });

            
            savePresetBtn.addEventListener('click', () => {
                const fontUrl = fontUrlInput.value.trim();
                const presetName = newPresetNameInput.value.trim();
                const presetDescription = newPresetDescriptionInput.value.trim();
                
                console.log('ÌîÑÎ¶¨ÏÖã Ï†ÄÏû•/ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠Îê®:', {
                    ÌòÑÏû¨ÏÑ†ÌÉù: db.globalFontPresets.currentPreset,
                    Ìè∞Ìä∏URL: fontUrl,
                    Ìè∞Ìä∏Ïù¥Î¶Ñ: presetName,
                    ÏÑ§Î™Ö: presetDescription
                }); 
                
                if (!fontUrl) {
                    showToast('Ìè∞Ìä∏ URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                if (!presetName) {
                    showToast('Ìè∞Ìä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                
                if (presetName === 'Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏') {
                    showToast('ÌîÑÎ¶¨ÏÖã Ïù¥Î¶ÑÏúºÎ°ú "Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏"Îäî ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                const currentPreset = db.globalFontPresets.currentPreset;
                
                
                const existingPresetWithSameName = Object.entries(db.globalFontPresets.presets).find(([key, preset]) => {
                    return preset.name === presetName && key !== currentPreset;
                });
                
                if (existingPresetWithSameName) {
                    console.log('Ïù¥Î¶Ñ Ï§ëÎ≥µ Î∞úÍ≤¨:', { 
                        ÏûÖÎ†•ÌïúÏù¥Î¶Ñ: presetName, 
                        Ï§ëÎ≥µÎêúÌîÑÎ¶¨ÏÖã: existingPresetWithSameName[0],
                        ÌòÑÏû¨ÏàòÏ†ïÏ§ë: currentPreset 
                    });
                    showToast(`"${presetName}"ÏùÄ(Îäî) Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÌîÑÎ¶¨ÏÖã Ïù¥Î¶ÑÏûÖÎãàÎã§. Îã§Î•∏ Ïù¥Î¶ÑÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.`);
                    return;
                }
                
                console.log('ÌîÑÎ¶¨ÏÖã Ïù¥Î¶Ñ Í≤ÄÏ¶ù ÌÜµÍ≥º:', presetName);
                
                if (currentPreset === 'custom') {
                    
                    const presetKey = `custom_${Date.now()}`;
                    db.globalFontPresets.presets[presetKey] = {
                        name: presetName,
                        url: fontUrl,
                        description: presetDescription || `${presetName} Ìè∞Ìä∏`,
                        deletable: true 
                    };
                    
                    
                    db.globalFontPresets.currentPreset = presetKey;
                    
                    saveData();
                    
                    
                    applyGlobalFont(fontUrl);
                    
                    
                    renderFontPresetSelector();
                    showToast(`"${presetName}" ÌîÑÎ¶¨ÏÖãÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!`);
                    console.log('ÏÉà ÌîÑÎ¶¨ÏÖã ÏÉùÏÑ± Î∞è Îì±Î°ù ÏôÑÎ£å:', presetKey); 
                } else {
                    
                    db.globalFontPresets.presets[currentPreset] = {
                        name: presetName,
                        url: fontUrl,
                        description: presetDescription || `${presetName} Ìè∞Ìä∏`
                    };
                    
                    saveData();
                    
                    
                    applyGlobalFont(fontUrl);
                    
                    
                    renderFontPresetSelector();
                    showToast(`"${presetName}" ÌîÑÎ¶¨ÏÖãÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`);
                    console.log('Í∏∞Ï°¥ ÌîÑÎ¶¨ÏÖã ÏàòÏ†ï ÏôÑÎ£å:', currentPreset); 
                }
            });

            
            deletePresetBtn.addEventListener('click', () => {
                const currentPreset = db.globalFontPresets.currentPreset;
                console.log('ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠Îê®:', currentPreset); 
                
                const preset = db.globalFontPresets.presets[currentPreset];
                
                
                if (preset && preset.deletable === false) {
                    showToast('Ïù¥ ÌîÑÎ¶¨ÏÖãÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                const presetName = preset.name;
                if (confirm(`"${presetName}" ÌîÑÎ¶¨ÏÖãÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    delete db.globalFontPresets.presets[currentPreset];
                    
                    
                    const remainingPresets = Object.keys(db.globalFontPresets.presets);
                    if (remainingPresets.length > 0) {
                        db.globalFontPresets.currentPreset = remainingPresets[0];
                    } else {
                        db.globalFontPresets.currentPreset = 'custom';
                    }
                    
                    saveData();
                    applyGlobalFont('');
                    
                    
                    renderFontPresetSelector();
                    showToast(`"${presetName}" ÌîÑÎ¶¨ÏÖãÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                    console.log('ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú ÏôÑÎ£å:', currentPreset); 
                }
            });

            
            restoreDefaultFontBtn.addEventListener('click', () => {
                
                applyGlobalFont('');
                showToast('Í∏∞Î≥∏ Ìè∞Ìä∏Î°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§!');
                console.log('Í∏∞Î≥∏ Ìè∞Ìä∏Î°ú Î≥µÏõê ÏôÑÎ£å'); 
            });

            
            function renderFontPresetSelector() {
                
                console.log('ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉùÍ∏∞ Î†åÎçîÎßÅ ÏãúÏûë');
                
                
                const allPresetOptions = Object.entries(db.globalFontPresets.presets)
                    .filter(([key, preset]) => key !== 'custom') 
                    .sort(([a, presetA], [b, presetB]) => presetA.name.localeCompare(presetB.name, 'ko')) 
                    .map(([key, preset]) => 
                        `<option value="${key}" ${key === db.globalFontPresets.currentPreset ? 'selected' : ''}>${preset.name}</option>`
                    ).join('');
                
                
                const customPreset = db.globalFontPresets.presets.custom;
                const isCustomSelected = db.globalFontPresets.currentPreset === 'custom';
                const customPresetOption = `<option value="custom" ${isCustomSelected ? 'selected' : ''}>${customPreset ? customPreset.name : 'Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏'}</option>`;
                console.log('Ïª§Ïä§ÌÖÄ ÌîÑÎ¶¨ÏÖã Î†åÎçîÎßÅ:', { isCustomSelected, customPreset: customPreset }); 
                
                
                fontPresetSelector.innerHTML = allPresetOptions + customPresetOption;
                
                console.log('ÌîÑÎ¶¨ÏÖã ÏòµÏÖò Íµ¨ÏÑ± ÏôÑÎ£å:', {
                    Ï†ÑÏ≤¥ÌîÑÎ¶¨ÏÖã: allPresetOptions.split('</option>').length - 1,
                    Ïª§Ïä§ÌÖÄÌîÑÎ¶¨ÏÖã: 1
                });
                
                
                const currentPreset = db.globalFontPresets.presets[db.globalFontPresets.currentPreset];
                if (currentPreset) {
                    fontDescription.textContent = currentPreset.description || 'ÏÑ§Î™Ö ÏóÜÏùå';
                } else {
                    fontDescription.textContent = 'ÌîÑÎ¶¨ÏÖãÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî';
                }
                
                
                const currentPresetData = db.globalFontPresets.presets[db.globalFontPresets.currentPreset];
                const isDeletable = currentPresetData && currentPresetData.deletable !== false;
                const isCustomMode = db.globalFontPresets.currentPreset === 'custom';
                deletePresetBtn.disabled = !isDeletable;
                
                
                if (isCustomMode) {
                    savePresetBtn.textContent = 'ÌîÑÎ¶¨ÏÖã Îì±Î°ù';
                } else {
                    savePresetBtn.textContent = 'ÌîÑÎ¶¨ÏÖã ÏàòÏ†ï';
                }
                
                console.log('Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏:', {
                    ÌòÑÏû¨ÏÑ†ÌÉù: db.globalFontPresets.currentPreset,
                    Ïª§Ïä§ÌÖÄÎ™®Îìú: isCustomMode,
                    ÏÇ≠Ï†úÍ∞ÄÎä•: isDeletable,
                    ÏÇ≠Ï†úÎ≤ÑÌäºÎπÑÌôúÏÑ±Ìôî: !isDeletable,
                    Ï†ÄÏû•Î≤ÑÌäºÌÖçÏä§Ìä∏: savePresetBtn.textContent
                });
            }
        }

        function applyGlobalFont(fontUrl) {
            console.log('üî§ Ìè∞Ìä∏ Ï†ÅÏö© ÏãúÏûë:', fontUrl); 
            
            
            const existingStyle = document.getElementById('global-font-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            
            const existingLinks = document.querySelectorAll('link[data-custom-font]');
            existingLinks.forEach(link => link.remove());
            
            if (fontUrl) {
                const fontName = 'CustomGlobalFont';
                console.log('üî§ Ïª§Ïä§ÌÖÄ Ìè∞Ìä∏ Ï†ÅÏö©:', fontName); 
                
                
                if (fontUrl.includes('.css') || fontUrl.includes('fonts.googleapis.com')) {
                    
                    console.log('üî§ CSS ÌååÏùºÎ°ú Ï≤òÎ¶¨:', fontUrl); 
                    
                    const linkElement = document.createElement('link');
                    linkElement.rel = 'stylesheet';
                    linkElement.href = fontUrl;
                    linkElement.setAttribute('data-custom-font', 'true');
                    document.head.appendChild(linkElement);
                    
                    
                    linkElement.onload = () => {
                        console.log('üî§ CSS Î°úÎìú ÏôÑÎ£å, Ìè∞Ìä∏ Ï†ÅÏö©'); 
                        
                        
                        let actualFontName = fontName;
                        if (fontUrl.includes('fonts.googleapis.com')) {
                            if (fontUrl.includes('Noto+Sans+KR')) {
                                actualFontName = 'Noto Sans KR';
                            } else if (fontUrl.includes('Nanum+Gothic')) {
                                actualFontName = 'Nanum Gothic';
                            } else if (fontUrl.includes('Nanum+Myeongjo')) {
                                actualFontName = 'Nanum Myeongjo';
                            } else if (fontUrl.includes('Nanum+Pen+Script')) {
                                actualFontName = 'Nanum Pen Script';
                            } else if (fontUrl.includes('Single+Day')) {
                                actualFontName = 'Single Day';
                            } else if (fontUrl.includes('Gugi')) {
                                actualFontName = 'Gugi';
                            } else if (fontUrl.includes('Jua')) {
                                actualFontName = 'Jua';
                            } else if (fontUrl.includes('Do+Hyeon')) {
                                actualFontName = 'Do Hyeon';
                            } else if (fontUrl.includes('Black+Han+Sans')) {
                                actualFontName = 'Black Han Sans';
                            } else if (fontUrl.includes('Sunflower')) {
                                actualFontName = 'Sunflower';
                            } else if (fontUrl.includes('Gamja+Flower')) {
                                actualFontName = 'Gamja Flower';
                            } else if (fontUrl.includes('Hi+Melody')) {
                                actualFontName = 'Hi Melody';
                            } else if (fontUrl.includes('Yeon+Sung')) {
                                actualFontName = 'Yeon Sung';
                            } else if (fontUrl.includes('Dongle')) {
                                actualFontName = 'Dongle';
                            } else if (fontUrl.includes('IBM+Plex+Sans+KR')) {
                                actualFontName = 'IBM Plex Sans KR';
                            }
                        }
                        
                        console.log('üî§ Ïã§Ï†ú Ìè∞Ìä∏Î™Ö:', actualFontName); 
                        applyFontFamily(actualFontName);
                    };
                    
                    
                    linkElement.onerror = () => {
                        console.log('üî§ CSS Î°úÎìú Ïã§Ìå®, Í∏∞Î≥∏ Ìè∞Ìä∏ ÏÇ¨Ïö©'); 
                        applyFontFamily('Arial');
                    };
                    
                } else {
                    
                    console.log('üî§ Ìè∞Ìä∏ ÌååÏùºÎ°ú Ï≤òÎ¶¨:', fontUrl); 
                    
                    const styleElement = document.createElement('style');
                    styleElement.id = 'global-font-style';
                    styleElement.innerHTML = `@font-face { 
                        font-family: '${fontName}'; 
                        src: url('${fontUrl}') format('woff2'), url('${fontUrl}') format('woff'), url('${fontUrl}') format('ttf'); 
                    }`;
                    document.head.appendChild(styleElement);
                    
                    
                    setTimeout(() => {
                        applyFontFamily(fontName);
                    }, 100);
                }
                
            } else {
                console.log('üî§ Í∏∞Î≥∏ Ìè∞Ìä∏Î°ú Î≥µÏõê'); 
                applyFontFamily('Arial');
            }
        }
        
        function applyFontFamily(fontName) {
            console.log('üî§ Ìè∞Ìä∏ Ìå®Î∞ÄÎ¶¨ Ï†ÅÏö©:', fontName); 
            
            
            document.documentElement.style.setProperty('--font-family', `'${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`);
            
            
            document.body.style.fontFamily = `'${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`;
            
            
            document.body.offsetHeight;
            
            console.log('üî§ Ìè∞Ìä∏ Ï†ÅÏö© ÏôÑÎ£å'); 
        }

        function setupWorldBookApp() {
            addWorldBookBtn.addEventListener('click', () => {
                currentEditingWorldBookId = null;
                editWorldBookForm.reset();
                document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                switchScreen('edit-world-book-screen');
            });
            editWorldBookForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = worldBookNameInput.value.trim();
                const content = worldBookContentInput.value.trim();
                const position = document.querySelector('input[name="world-book-position"]:checked').value;
                if (!name || !content) return showToast('Ïù¥Î¶ÑÍ≥º ÎÇ¥Ïö©ÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§');
                if (currentEditingWorldBookId) {
                    const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                    if (book) {
                        book.name = name;
                        book.content = content;
                        book.position = position;
                    }
                } else {
                    db.worldBooks.push({ id: `wb_${Date.now()}`, name, content, position });
                }
                saveData();
                showToast('ÏÑ∏Í≥ÑÍ¥Ä Ìï≠Î™©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                renderWorldBookList();
                switchScreen('world-book-screen');
            });
            worldBookListContainer.addEventListener('click', e => {
                const item = e.target.closest('.world-book-item');
                if (item) {
                    const book = db.worldBooks.find(wb => wb.id === item.dataset.id);
                    if (book) {
                        currentEditingWorldBookId = book.id;
                        worldBookIdInput.value = book.id;
                        worldBookNameInput.value = book.name;
                        worldBookContentInput.value = book.content;
                        document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                        switchScreen('edit-world-book-screen');
                    }
                }
            });
            worldBookListContainer.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                const item = e.target.closest('.world-book-item');
                if (!item) return;
                longPressTimer = setTimeout(() => {
                    const bookId = item.dataset.id;
                    const menuItems = [{
                        label: 'ÏÇ≠Ï†ú',
                        danger: true,
                        action: () => {
                            if (confirm('Ïù¥ ÏÑ∏Í≥ÑÍ¥Ä Ìï≠Î™©ÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                                db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);
                                db.characters.forEach(char => { char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId); });
                                db.groups.forEach(group => { group.worldBookIds = (group.worldBookIds || []).filter(id => id !== bookId); });
                                saveData();
                                renderWorldBookList();
                                showToast('Ìï≠Î™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                            }
                        }
                    }];
                    createContextMenu(menuItems, e.clientX, e.clientY);
                }, 500);
            });
            worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        }

        function renderWorldBookList() {
            worldBookListContainer.innerHTML = '';
            noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
            db.worldBooks.forEach(book => {
                const li = document.createElement('li');
                li.className = 'list-item world-book-item';
                li.dataset.id = book.id;
                li.innerHTML = `<div class="item-details" style="padding-left: 20px;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`;
                worldBookListContainer.appendChild(li);
            });
        }

        function setupChatSettings() {
            const themeSelect = document.getElementById('setting-theme-color');
            themeSelect.innerHTML = '';
            Object.keys(colorThemes).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = colorThemes[key].name;
                themeSelect.appendChild(option);
            });
            chatSettingsBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    loadSettingsToSidebar();
                    settingsSidebar.classList.add('open');
                } else if (currentChatType === 'group') {
                    loadGroupSettingsToSidebar();
                    groupSettingsSidebar.classList.add('open');
                }
            });
            document.querySelector('.phone-screen').addEventListener('click', e => {
                const openSidebar = document.querySelector('.settings-sidebar.open');
                if (openSidebar && !openSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target) && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {
                    openSidebar.classList.remove('open');
                }
            });

            settingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveSettingsFromSidebar();
                settingsSidebar.classList.remove('open');
            });
            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'), customCssTextarea = document.getElementById('setting-custom-bubble-css'), resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'), privatePreviewBox = document.getElementById('private-bubble-css-preview');
            useCustomCssCheckbox.addEventListener('change', (e) => {
                customCssTextarea.disabled = !e.target.checked;
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);
                }
            });
            customCssTextarea.addEventListener('input', (e) => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char && useCustomCssCheckbox.checked) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);
                }
            });
            resetCustomCssBtn.addEventListener('click', () => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    customCssTextarea.value = '';
                    useCustomCssCheckbox.checked = false;
                    customCssTextarea.disabled = true;
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, '', true, theme);
                    showToast('Ïä§ÌÉÄÏùºÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
                }
            });
            document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('setting-char-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ÏïÑÎ∞îÌÉÄ ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
            document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('setting-my-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ÏïÑÎ∞îÌÉÄ ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
            document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        try {
                            const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                            char.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            saveData();
                            showToast('Ï±ÑÌåÖ Î∞∞Í≤ΩÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§');
                        } catch (error) { showToast('Î∞∞Í≤Ω ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                    }
                }
            });
            clearChatHistoryBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                if (confirm(`Ï†ïÎßê ‚Äú${character.remarkName}‚ÄùÎãòÍ≥ºÏùò Î™®Îì† Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!`)) {
                    character.history = [];
                    saveData();
                    renderMessages(false, true);
                    renderChatList();
                    settingsSidebar.classList.remove('open');
                    showToast('Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                }
            });
            linkWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (character.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });

            saveWorldBookSelectionBtn.addEventListener('click', () => {
                const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (currentChatType === 'private') {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (character) character.worldBookIds = selectedIds;
                } else if (currentChatType === 'group') {
                    const group = db.groups.find(g => g.id === currentChatId);
                    if (group) group.worldBookIds = selectedIds;
                }
                saveData();
                worldBookSelectionModal.classList.remove('visible');
                showToast('ÏÑ∏Í≥ÑÍ¥Ä Ïó∞Í≤∞Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function loadSettingsToSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                document.getElementById('setting-char-avatar-preview').src = e.avatar;
                document.getElementById('setting-char-remark').value = e.remarkName;
                document.getElementById('setting-char-persona').value = e.persona;
                document.getElementById('setting-my-avatar-preview').src = e.myAvatar;
                document.getElementById('setting-my-name').value = e.myName;
                document.getElementById('setting-my-persona').value = e.myPersona;
                document.getElementById('setting-theme-color').value = e.theme || 'white_pink';
                document.getElementById('setting-max-memory').value = e.maxMemory;
                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'), customCssTextarea = document.getElementById('setting-custom-bubble-css'), privatePreviewBox = document.getElementById('private-bubble-css-preview');
                useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;
                customCssTextarea.value = e.customBubbleCss || '';
                customCssTextarea.disabled = !useCustomCssCheckbox.checked;
                const theme = colorThemes[e.theme || 'white_pink'];
                updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);
            }
        }

        function saveSettingsFromSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                e.avatar = document.getElementById('setting-char-avatar-preview').src;
                e.remarkName = document.getElementById('setting-char-remark').value;
                e.persona = document.getElementById('setting-char-persona').value;
                e.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                e.myName = document.getElementById('setting-my-name').value;
                e.myPersona = document.getElementById('setting-my-persona').value;
                e.theme = document.getElementById('setting-theme-color').value;
                e.maxMemory = document.getElementById('setting-max-memory').value;
                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
                e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;
                saveData();
                showToast('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                chatRoomTitle.textContent = e.remarkName;
                renderChatList();
                updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);
                currentPage = 1;
                renderMessages(false, true);
            }
        }

        function setupApiSettingsApp() {
            const e = document.getElementById('api-form'), t = document.getElementById('fetch-models-btn'), a = document.getElementById('api-model'), n = document.getElementById('api-provider'), r = document.getElementById('api-url'), s = document.getElementById('api-key');
            
            
            if (!db.apiSettings || typeof db.apiSettings.provider === 'string') {
                
                db.apiSettings = {
                    newapi: { url: '', key: '', model: '' },
                    openai: { url: 'https://api.openai.com', key: '', model: '' },
                    deepseek: { url: 'https://api.deepseek.com', key: '', model: '' },
                    claude: { url: 'https://api.anthropic.com', key: '', model: '' },
                    gemini: { url: 'https://generativelanguage.googleapis.com', key: '', model: '' },
                    openrouter: { url: 'https://openrouter.ai/api', key: '', model: '' },
                    currentProvider: 'newapi'
                };
                saveData();
                showToast('API ÏÑ§Ï†ïÏù¥ ÏÉàÎ°úÏö¥ Î∞©ÏãùÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!');
            }
            
            
            const currentProvider = db.apiSettings.currentProvider || 'newapi';
            n.value = currentProvider;
            loadProviderSettings(currentProvider);
            
            
            function loadProviderSettings(provider) {
                const settings = db.apiSettings[provider] || {};
                const defaultUrls = {
                    newapi: '',
                    openai: 'https://api.openai.com',
                    deepseek: 'https://api.deepseek.com',
                    claude: 'https://api.anthropic.com',
                    gemini: 'https://generativelanguage.googleapis.com',
                    openrouter: 'https://openrouter.ai/api'
                };
                
                r.value = settings.url || defaultUrls[provider] || '';
                s.value = settings.key || '';
                a.innerHTML = settings.model ? `<option value="${settings.model}">${settings.model}</option>` : '<option value="">Î®ºÏ†Ä Î™®Îç∏ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§ÏÑ∏Ïöî</option>';
            }
            
            
            n.addEventListener('change', () => {
                const newProvider = n.value;
                db.apiSettings.currentProvider = newProvider;
                loadProviderSettings(newProvider);
                saveData();
            });
            
            t.addEventListener('click', async () => {
                let o = r.value.trim();
                const l = s.value.trim();
                if (!o || !l) return showToast('API Ï£ºÏÜåÏôÄ ÌÇ§Î•º Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                o.endsWith('/') && (o = o.slice(0, -1));
                const i = 'gemini' === n.value ? `${o}/v1beta/models?key=${getRandomValue(l)}` : `${o}/v1/models`;
                t.classList.add('loading'), t.disabled = !0;
                try {
                    let headers;
                    if (n.value === 'gemini') {
                        headers = {};
                    } else if (n.value === 'claude') {
                        headers = {
                            'x-api-key': l,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        };
                    } else {
                        headers = { Authorization: `Bearer ${l}` };
                    }
                    
                    const g = await fetch(i, { method: 'GET', headers: headers });
                    if (!g.ok) throw new Error(`ÎÑ§Ìä∏ÏõåÌÅ¨ ÏùëÎãµ Ïò§Î•ò: ${g.status}`);
                    const u = await g.json();
                    let p = [];
                    if (n.value === 'gemini' && u.models) {
                        p = u.models.map(e => e.name.replace('models/', ''));
                    } else if (n.value !== 'gemini' && u.data) {
                        p = u.data.map(e => e.id);
                    }
                    a.innerHTML = '', p.length > 0 ? (window.allModels = p, renderModelList(p), showToast(`${p.length}Í∞ú Î™®Îç∏ÏùÑ Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§!`)) : (a.innerHTML = '<option value="">Î™®Îç∏ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</option>', showToast('Î™®Îç∏ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§'))
                } catch (f) {
                    a.innerHTML = '<option value="">Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®</option>';
                    showToast(`Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: ${f.message}`);
                } finally {
                    t.classList.remove('loading'), t.disabled = !1
                }
            });
            e.addEventListener('submit', e => {
                e.preventDefault();
                if (!a.value) return showToast('Î™®Îç∏ÏùÑ ÏÑ†ÌÉùÌïú ÌõÑ Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî!');
                
                
                const currentProvider = n.value;
                db.apiSettings[currentProvider] = {
                    url: r.value,
                    key: s.value,
                    model: a.value
                };
                db.apiSettings.currentProvider = currentProvider;
                
                saveData();
                showToast(`${currentProvider.toUpperCase()} ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`);
            });

            
            const modelSearch = document.getElementById('model-search');
            const modelSearchInfo = document.getElementById('model-search-info');
            let searchTimeout;

            
            function renderModelList(models) {
                a.innerHTML = '';
                if (models.length === 0) {
                    a.innerHTML = '<option value="">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</option>';
                    modelSearchInfo.textContent = 'Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§';
                    return;
                }
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    a.appendChild(option);
                });
                
                modelSearchInfo.textContent = `${models.length}Í∞ú Î™®Îç∏ ÌëúÏãú`;
            }

            
            if (modelSearch) {
                modelSearch.addEventListener('input', (event) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = event.target.value.toLowerCase().trim();
                        
                        if (!window.allModels || window.allModels.length === 0) {
                            modelSearchInfo.textContent = 'Î®ºÏ†Ä Î™®Îç∏ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§ÏÑ∏Ïöî';
                            return;
                        }
                        
                        if (searchTerm === '') {
                            
                            renderModelList(window.allModels);
                        } else {
                            
                            
                            let filteredModels;
                            
                            if (searchTerm.includes('|')) {
                                
                                const orKeywords = searchTerm.split('|').map(keyword => keyword.trim()).filter(keyword => keyword.length > 0);
                                filteredModels = window.allModels.filter(model => {
                                    const modelLower = model.toLowerCase();
                                    return orKeywords.some(keyword => 
                                        modelLower.includes(keyword.toLowerCase())
                                    );
                                });
                            } else {
                                
                                const andKeywords = searchTerm.split(',').map(keyword => keyword.trim()).filter(keyword => keyword.length > 0);
                                filteredModels = window.allModels.filter(model => {
                                    const modelLower = model.toLowerCase();
                                    return andKeywords.every(keyword => 
                                        modelLower.includes(keyword.toLowerCase())
                                    );
                                });
                            }
                            renderModelList(filteredModels);
                        }
                    }, 300); 
                });

                
                modelSearch.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        modelSearch.value = '';
                        if (window.allModels) {
                            renderModelList(window.allModels);
                        }
                    }
                });
            }

            
            const toggleApiKeyBtn = document.getElementById('toggle-api-key-btn');
            const apiKeyInput = document.getElementById('api-key');
            
            if (toggleApiKeyBtn && apiKeyInput) {
                toggleApiKeyBtn.addEventListener('click', () => {
                    if (apiKeyInput.type === 'password') {
                        apiKeyInput.type = 'text';
                        toggleApiKeyBtn.textContent = 'üîí';
                        toggleApiKeyBtn.title = 'API ÌÇ§ Ïà®Í∏∞Í∏∞';
                    } else {
                        apiKeyInput.type = 'password';
                        toggleApiKeyBtn.textContent = 'üîë';
                        toggleApiKeyBtn.title = 'API ÌÇ§ Î≥¥Í∏∞';
                    }
                });
                
                
                toggleApiKeyBtn.title = 'API ÌÇ§ Î≥¥Í∏∞';
            }

            
            const backupBtn = document.getElementById('backup-data-btn');
            const restoreBtn = document.getElementById('restore-data-btn');
            
            if (backupBtn) {
                backupBtn.addEventListener('click', () => {
                    
                    (() => {
                        const KEY = 'gemini-chat-app-db';
                        
                        
                        function pad(n) { return String(n).padStart(2, '0'); }
                        function tsForFilename(d = new Date()) {
                            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
                        }
                        
                        
                        const arrLen = (x) => Array.isArray(x) ? x.length : 0;
                        
                        
                        function backupGeminiDB() {
                            const raw = localStorage.getItem(KEY);
                            if (raw === null) {
                                alert(`ÌÇ§Í∞Ä ÏóÜÏäµÎãàÎã§: ${KEY}`);
                                return;
                            }
                            
                            let parsed = null;
                            try {
                                
                                parsed = JSON.parse(raw);
                            } catch (_) {
                                
                            }
                            
                            
                            const meta = {
                                type: 'gemini-chat-app-db-backup',
                                origin: location.origin,
                                ts: new Date().toISOString(),
                                counts: parsed ? {
                                    characters: arrLen(parsed.characters),
                                    groups: arrLen(parsed.groups),
                                    myStickers: arrLen(parsed.myStickers),
                                    worldBooks: arrLen(parsed.worldBooks),
                                } : null
                            };
                            
                            
                            const dump = {
                                meta,
                                data: parsed ?? {} 
                            };
                            
                            
                            const c = meta.counts || {};
                            const fname = `gemini-db_${tsForFilename()}_c${c.characters ?? 'NA'}_g${c.groups ?? 'NA'}.json`;
                            
                            
                            const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = fname;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => {
                                URL.revokeObjectURL(a.href);
                                a.remove();
                            }, 1500);
                            
                            showToast(`Î∞±ÏóÖ ÏôÑÎ£å: ${fname}`);
                        }
                        
                        
                        backupGeminiDB();
                    })();
                });
            }
            
            if (restoreBtn) {
                restoreBtn.addEventListener('click', () => {
                    
                    (() => {
                        const KEY = 'gemini-chat-app-db';
                        const NORMALIZE = true; 
                        
                        
                        function normalize(db) {
                            db = db || {};
                            db.apiSettings = db.apiSettings || {};
                            db.wallpaper = typeof db.wallpaper === 'string' && db.wallpaper ? db.wallpaper : 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
                            db.characters = Array.isArray(db.characters) ? db.characters : [];
                            db.groups = Array.isArray(db.groups) ? db.groups : [];
                            db.myStickers = Array.isArray(db.myStickers) ? db.myStickers : [];
                            db.homeScreenMode = db.homeScreenMode || 'night';
                            db.worldBooks = Array.isArray(db.worldBooks) ? db.worldBooks : [];
                            
                            db.customIcons = db.customIcons || {};
                            db.globalCustomCSS = db.globalCustomCSS || { enabled: true, currentPreset: 'default', presets: { 'default': { name: 'Í∏∞Î≥∏', css: '', description: 'Í∏∞Î≥∏ ÌÖåÎßà' } } };
                            db.globalFontPresets = db.globalFontPresets || { enabled: true, currentPreset: 'custom', presets: {} };
                            
                            db.characters.forEach(c => {
                                if (c.isPinned === undefined) c.isPinned = false;
                                if (c.status === undefined) c.status = 'Ïò®ÎùºÏù∏';
                                if (!Array.isArray(c.worldBookIds)) c.worldBookIds = [];
                                if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
                                if (c.unreadCount === undefined) c.unreadCount = 0;
                            });
                            db.groups.forEach(g => {
                                if (g.isPinned === undefined) g.isPinned = false;
                                if (!Array.isArray(g.worldBookIds)) g.worldBookIds = [];
                                if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
                                if (g.unreadCount === undefined) g.unreadCount = 0;
                            });
                            return db;
                        }
                        
                        function pickValueFromDump(incoming, originalText) {
                            
                            if (incoming && typeof incoming === 'object') {
                                
                                if (incoming.meta && incoming.data && typeof incoming.data === 'object') {
                                    return JSON.stringify(NORMALIZE ? normalize(incoming.data) : incoming.data);
                                }
                                
                                if (incoming.meta && typeof incoming.raw === 'string' && incoming.raw.length) {
                                    try {
                                        const parsed = JSON.parse(incoming.raw);
                                        return JSON.stringify(NORMALIZE ? normalize(parsed) : parsed);
                                    } catch {
                                        return incoming.raw; 
                                    }
                                }
                                
                                return JSON.stringify(NORMALIZE ? normalize(incoming) : incoming);
                            }
                            
                            
                            if (typeof originalText === 'string') {
                                try {
                                    const parsed = JSON.parse(originalText);
                                    return JSON.stringify(NORMALIZE ? normalize(parsed) : parsed);
                                } catch {
                                    
                                    return originalText;
                                }
                            }
                            
                            
                            throw new Error('ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÏûÖÎ†• ÌòïÏãùÏûÖÎãàÎã§.');
                        }
                        
                        function runRestore() {
                            const input = document.createElement('input');
                            input.type = 'file';
                            input.accept = '.json,application/json';
                            input.onchange = async () => {
                                const file = input.files[0];
                                if (!file) return;
                                
                                const text = await file.text();
                                let incoming = null;
                                try {
                                    incoming = JSON.parse(text);
                                } catch {
                                    
                                }
                                
                                let valueToStore;
                                try {
                                    valueToStore = pickValueFromDump(incoming, text);
                                } catch (e) {
                                    alert('Î≥µÏõê Ï§ÄÎπÑ Ïã§Ìå®: ' + e.message);
                                    input.remove();
                                    return;
                                }
                                
                                try {
                                    localStorage.setItem(KEY, String(valueToStore));
                                    showToast('Î≥µÏõê ÏôÑÎ£å: ' + KEY);
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1000);
                                } catch (e) {
                                    alert('Ï†ÄÏû• Ïã§Ìå®: ' + e);
                                } finally {
                                    input.remove();
                                }
                            };
                            document.body.appendChild(input);
                            input.click();
                        }
                        
                        runRestore();
                    })();
                });
            }
        }

        function setupWallpaperApp() {
            const e = document.getElementById('wallpaper-upload'), t = document.getElementById('wallpaper-preview');
            t.style.backgroundImage = `url(${db.wallpaper})`, t.textContent = '', e.addEventListener('change', async (a) => {
                const n = a.target.files[0];
                if (n) {
                    try {
                        const r = await compressImage(n, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        db.wallpaper = r, applyWallpaper(r), t.style.backgroundImage = `url(${r})`, saveData(), showToast('Î∞∞Í≤ΩÌôîÎ©¥Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!');
                    } catch (s) { showToast('Î∞∞Í≤ΩÌôîÎ©¥ ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
        }

        
        function setupGroupChatSystem() {
            createGroupBtn.addEventListener('click', () => {
                renderMemberSelectionList();
                createGroupModal.classList.add('visible');
            });
            createGroupForm.addEventListener('submit', e => {
                e.preventDefault();
                const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                const groupName = groupNameInput.value.trim();
                if (selectedMemberIds.length < 1) return showToast('Í∑∏Î£π Î©§Î≤ÑÎ•º ÏµúÏÜå Ìïú Î™Ö ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                if (!groupName) return showToast('Í∑∏Î£πÏ±ÑÌåÖ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                const firstChar = db.characters.length > 0 ? db.characters[0] : null;
                const newGroup = { id: `group_${Date.now()}`, name: groupName, avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg', me: { nickname: firstChar ? firstChar.myName : 'ÎÇò', persona: firstChar ? firstChar.myPersona : '', avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg' }, members: selectedMemberIds.map(charId => { const char = db.characters.find(c => c.id === charId); return { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar }; }), theme: 'white_pink', maxMemory: 100, chatBg: '', history: [], isPinned: false, useCustomBubbleCss: false, customBubbleCss: '', worldBookIds: [] };
                db.groups.push(newGroup);
                saveData();
                renderChatList();
                createGroupModal.classList.remove('visible');
                showToast(`Í∑∏Î£πÏ±ÑÌåÖ ‚Äú${groupName}‚ÄùÏù¥(Í∞Ä) ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
            });
            groupSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveGroupSettingsFromSidebar();
                groupSettingsSidebar.classList.remove('open');
            });
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'), groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'), resetGroupCustomCssBtn = document.getElementById('reset-group-custom-bubble-css-btn'), groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.addEventListener('change', (e) => {
                groupCustomCssTextarea.disabled = !e.target.checked;
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !e.target.checked, theme);
                }
            });
            groupCustomCssTextarea.addEventListener('input', (e) => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group && useGroupCustomCssCheckbox.checked) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, e.target.value, false, theme);
                }
            });
            resetGroupCustomCssBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    groupCustomCssTextarea.value = '';
                    useGroupCustomCssCheckbox.checked = false;
                    groupCustomCssTextarea.disabled = true;
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, '', true, theme);
                    showToast('Ïä§ÌÉÄÏùºÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
                }
            });
            document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.avatar = compressedUrl;
                            document.getElementById('setting-group-avatar-preview').src = compressedUrl;
                        }
                    } catch (error) { showToast('Í∑∏Î£π ÏïÑÎ∞îÌÉÄ ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
            document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            saveData();
                            showToast('Ï±ÑÌåÖ Î∞∞Í≤ΩÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§');
                        }
                    } catch (error) { showToast('Í∑∏Î£π Ï±ÑÌåÖ Î∞∞Í≤Ω ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
            document.getElementById('clear-group-chat-history-btn').addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                if (confirm(`Ï†ïÎßê Í∑∏Î£πÏ±ÑÌåÖ ‚Äú${group.name}‚ÄùÏùò Î™®Îì† Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!`)) {
                    group.history = [];
                    saveData();
                    renderMessages(false, true);
                    renderChatList();
                    groupSettingsSidebar.classList.remove('open');
                    showToast('Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                }
            });
            groupMembersListContainer.addEventListener('click', e => {
                const memberDiv = e.target.closest('.group-member');
                const addBtn = e.target.closest('.add-member-btn');
                if (memberDiv) { openGroupMemberEditModal(memberDiv.dataset.id); }
                else if (addBtn) { addMemberActionSheet.classList.add('visible'); }
            });
            document.getElementById('edit-member-avatar-preview').addEventListener('click', () => { document.getElementById('edit-member-avatar-upload').click(); });
            document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('edit-member-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('Î©§Î≤Ñ ÏïÑÎ∞îÌÉÄ ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
            editGroupMemberForm.addEventListener('submit', e => {
                e.preventDefault();
                const memberId = document.getElementById('editing-member-id').value;
                const group = db.groups.find(g => g.id === currentChatId);
                const member = group.members.find(m => m.id === memberId);
                if (member) {
                    member.avatar = document.getElementById('edit-member-avatar-preview').src;
                    member.groupNickname = document.getElementById('edit-member-group-nickname').value;
                    member.realName = document.getElementById('edit-member-real-name').value;
                    member.persona = document.getElementById('edit-member-persona').value;
                    saveData();
                    renderGroupMembersInSettings(group);
                    document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => { el.textContent = member.groupNickname; });
                    showToast('Î©§Î≤Ñ Ï†ïÎ≥¥Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§');
                }
                editGroupMemberModal.classList.remove('visible');
            });
            inviteExistingMemberBtn.addEventListener('click', () => {
                renderInviteSelectionList();
                inviteMemberModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            createNewMemberBtn.addEventListener('click', () => {
                createMemberForGroupForm.reset();
                document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                createMemberForGroupModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => { document.getElementById('create-group-member-avatar-upload').click(); });
            document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('create-group-member-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ÏÉà Î©§Î≤Ñ ÏïÑÎ∞îÌÉÄ ÏïïÏ∂ï Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî'); }
                }
            });
            confirmInviteBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                selectedCharIds.forEach(charId => {
                    const char = db.characters.find(c => c.id === charId);
                    if (char) {
                        const newMember = { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar };
                        group.members.push(newMember);
                        sendInviteNotification(group, newMember.realName);
                    }
                });
                if (selectedCharIds.length > 0) {
                    saveData();
                    renderGroupMembersInSettings(group);
                    renderMessages(false, true);
                    showToast('ÏÉà Î©§Î≤ÑÎ•º Ï¥àÎåÄÌñàÏäµÎãàÎã§');
                }
                inviteMemberModal.classList.remove('visible');
            });
            createMemberForGroupForm.addEventListener('submit', e => {
                e.preventDefault();
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const newMember = { id: `member_group_only_${Date.now()}`, originalCharId: null, realName: document.getElementById('create-group-member-realname').value, groupNickname: document.getElementById('create-group-member-nickname').value, persona: document.getElementById('create-group-member-persona').value, avatar: document.getElementById('create-group-member-avatar-preview').src, };
                group.members.push(newMember);
                sendInviteNotification(group, newMember.realName);
                saveData();
                renderGroupMembersInSettings(group);
                renderMessages(false, true);
                showToast(`ÏÉà Î©§Î≤Ñ ${newMember.groupNickname}ÎãòÏù¥ Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§`);
                createMemberForGroupModal.classList.remove('visible');
            });
            document.getElementById('setting-group-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('setting-group-my-avatar-preview').src = compressedUrl;
                    } catch(error){ showToast('ÏïÑÎ∞îÌÉÄ ÏïïÏ∂ï Ïã§Ìå®')}
                }
            });
            confirmGroupRecipientBtn.addEventListener('click', () => {
                const selectedRecipientIds = Array.from(groupRecipientSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedRecipientIds.length === 0) {
                    return showToast('Î∞õÎäî ÏÇ¨ÎûåÏùÑ ÏµúÏÜå Ìïú Î™Ö ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                currentGroupAction.recipients = selectedRecipientIds;
                groupRecipientSelectionModal.classList.remove('visible');

                if (currentGroupAction.type === 'transfer') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentGroupAction.type === 'gift') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                }
            });
            linkGroupWorldBookBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (group.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-group-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-group-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });
        }

        function renderMemberSelectionList() {
            memberSelectionList.innerHTML = '';
            if (db.characters.length === 0) {
                memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">ÏÑ†ÌÉùÌï† Ïàò ÏûàÎäî Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</li>';
                return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}" style="margin-bottom: 0px">${char.remarkName}</label>`;
                memberSelectionList.appendChild(li);
            });
        }

        function loadGroupSettingsToSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const themeSelect = document.getElementById('setting-group-theme-color');
            if (themeSelect.options.length === 0) {
                Object.keys(colorThemes).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = colorThemes[key].name;
                    themeSelect.appendChild(option);
                });
            }
            document.getElementById('setting-group-avatar-preview').src = group.avatar;
            document.getElementById('setting-group-name').value = group.name;
            document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;
            document.getElementById('setting-group-my-nickname').value = group.me.nickname;
            document.getElementById('setting-group-my-persona').value = group.me.persona;
            themeSelect.value = group.theme || 'white_pink';
            document.getElementById('setting-group-max-memory').value = group.maxMemory;
            renderGroupMembersInSettings(group);
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'), groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'), groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.checked = group.useCustomBubbleCss || false;
            groupCustomCssTextarea.value = group.customBubbleCss || '';
            groupCustomCssTextarea.disabled = !useGroupCustomCssCheckbox.checked;
            const theme = colorThemes[group.theme || 'white_pink'];
            updateBubbleCssPreview(groupPreviewBox, group.customBubbleCss, !group.useCustomBubbleCss, theme);
        }

        function renderGroupMembersInSettings(group) {
            groupMembersListContainer.innerHTML = '';
            group.members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'group-member';
                memberDiv.dataset.id = member.id;
                memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;
                groupMembersListContainer.appendChild(memberDiv);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-member-btn';
            addBtn.innerHTML = `<div class="add-icon">+</div><span>Ï∂îÍ∞Ä</span>`;
            groupMembersListContainer.appendChild(addBtn);
        }

        function renderGroupRecipientSelectionList(actionText) {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            groupRecipientSelectionTitle.textContent = actionText;
            groupRecipientSelectionList.innerHTML = '';
            group.members.forEach(member => {
                const li = document.createElement('li');
                li.className = 'group-recipient-select-item';
                li.innerHTML = `
                        <input type="checkbox" id="recipient-select-${member.id}" value="${member.id}">
                        <label for="recipient-select-${member.id}">
                            <img src="${member.avatar}" alt="${member.groupNickname}">
                            <span>${member.groupNickname}</span>
                        </label>`;
                groupRecipientSelectionList.appendChild(li);
            });
        }

        function saveGroupSettingsFromSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const oldName = group.name;
            const newName = document.getElementById('setting-group-name').value;
            if (oldName !== newName) {
                group.name = newName;
                sendRenameNotification(group, newName);
            }
            group.avatar = document.getElementById('setting-group-avatar-preview').src;
            group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;
            group.me.nickname = document.getElementById('setting-group-my-nickname').value;
            group.me.persona = document.getElementById('setting-group-my-persona').value;
            group.theme = document.getElementById('setting-group-theme-color').value;
            group.maxMemory = document.getElementById('setting-group-max-memory').value;
            group.useCustomBubbleCss = document.getElementById('setting-group-use-custom-css').checked;
            group.customBubbleCss = document.getElementById('setting-group-custom-bubble-css').value;
            updateCustomBubbleStyle(currentChatId, group.customBubbleCss, group.useCustomBubbleCss);
            saveData();
            showToast('Í∑∏Î£πÏ±ÑÌåÖ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
            chatRoomTitle.textContent = group.name;
            renderChatList();
            renderMessages(false, true);
        }

        function openGroupMemberEditModal(memberId) {
            const group = db.groups.find(g => g.id === currentChatId);
            const member = group.members.find(m => m.id === memberId);
            if (!member) return;
            document.getElementById('edit-group-member-title').textContent = `${member.groupNickname} Ìé∏Ïßë`;
            document.getElementById('editing-member-id').value = member.id;
            document.getElementById('edit-member-avatar-preview').src = member.avatar;
            document.getElementById('edit-member-group-nickname').value = member.groupNickname;
            document.getElementById('edit-member-real-name').value = member.realName;
            document.getElementById('edit-member-persona').value = member.persona;
            editGroupMemberModal.classList.add('visible');
        }

        function renderInviteSelectionList() {
            inviteMemberSelectionList.innerHTML = '';
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));
            const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));
            if (availableChars.length === 0) {
                inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">Ï¥àÎåÄÌï† Ïàò ÏûàÎäî ÏÉà Î©§Î≤ÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</li>';
                confirmInviteBtn.disabled = true;
                return;
            }
            confirmInviteBtn.disabled = false;
            availableChars.forEach(char => {
                const li = document.createElement('li');
                li.className = 'invite-member-select-item';
                li.innerHTML = `<input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label>`;
                inviteMemberSelectionList.appendChild(li);
            });
        }

        function sendInviteNotification(group, newMemberRealName) {
            const messageContent = `[${group.me.nickname}ÎãòÏù¥ ${newMemberRealName}ÎãòÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌñàÏäµÎãàÎã§]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, parts: [{ type: 'text', text: messageContent }], timestamp: Date.now(), senderId: 'user_me' };
            group.history.push(message);
        }

        function sendRenameNotification(group, newName) {
            const myName = group.me.nickname;
            const messageContent = `[${myName}ÎãòÏù¥ Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ‚Äò${newName}‚Äô(Ïúº)Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, parts: [{ type: 'text', text: messageContent }], timestamp: Date.now() };
            group.history.push(message);
        }

        init();
    });
	
</script>

</body>


</html>
