<!DOCTYPE html>
<html lang="ko-KR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ðŸ©¶</title>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>

        :root {
            --bg-color: #fce4ec;
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 18px;
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-family-monospace: 'Courier New', 'Monaco', 'Menlo', 'Consolas', monospace;
            --top-pinned-bg: #fff0f5;
            --online-status-color: #4CAF50;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .phone-screen {
            width: 100%;
            height: 100vh;
            /* max-height: 850px; */
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* --- START: .app-headerë¡œ ì‹œìž‘í•˜ëŠ” ëª¨ë“  CSSë¥¼ ì´ ë¸”ë¡ìœ¼ë¡œ êµì²´í•˜ì„¸ìš” --- */

/* í—¤ë” ê¸°ë³¸ ì»¨í…Œì´ë„ˆ */
.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
    position: relative;
    z-index: 10;
}

/* í—¤ë” ë‚´ ëª¨ë“  ë²„íŠ¼ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë’¤ë¡œê°€ê¸°, ì•¡ì…˜ ë²„íŠ¼ ê³µí†µ) */
.app-header .back-btn,
.app-header .action-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border-radius: 50%;
}

/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì•ˆì˜ SVG ì•„ì´ì½˜ í¬ê¸° */
.app-header .back-btn svg {
    width: 32px;
    height: 32px;
}

/* ë©€í‹°ì„ íƒ ì·¨ì†Œ ë²„íŠ¼ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
#cancel-multi-select-btn {
    font-size: 14px !important;
    font-weight: 500 !important;
    color: var(--white-color) !important;
    background-color: var(--primary-color) !important;
    border-radius: 10px !important;
    padding: 5px 10px !important;
    width: auto !important;
    height: auto !important;
}

/* ì˜¤ë¥¸ìª½ ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
.app-header .action-btn-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* (ì‚¬ìš©ìžê°€ ì§ˆë¬¸í•œ ë¶€ë¶„) ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ ì•ˆì˜ ê°œë³„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.app-header .action-btn-group .action-btn {
    font-size: 14px;
    font-weight: 400;
    width: 40px; /* í¬ê¸° í†µì¼ */
    height: 40px; /* í¬ê¸° í†µì¼ */
    border-radius: 50%;
    padding: 0; /* íŒ¨ë”© ì œê±° */
}

/* SVG ì•„ì´ì½˜ í¬ê¸° (ê·¸ë£¹ì±„íŒ…, ìƒˆ ì±„íŒ…, ì„¸ê³„ê´€ ì¶”ê°€) */
.app-header .action-btn-group #create-group-btn svg,
.app-header .action-btn-group #add-chat-btn svg,
.app-header #add-world-book-btn svg {
    width: 28px;
    height: 28px;
}

/* ì„¤ì •(í†±ë‹ˆë°”í€´) ë²„íŠ¼ ì•ˆì˜ ì´ë¯¸ì§€ ì•„ì´ì½˜ í¬ê¸° */
.app-header .action-btn img {
    width: 28px;
    height: 28px;
}

/* í—¤ë” ì¤‘ì•™ ì œëª© ì»¨í…Œì´ë„ˆ */
.app-header .title-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

/* (ì‚¬ìš©ìžê°€ ì§ˆë¬¸í•œ ë¶€ë¶„) í—¤ë” ì œëª© */
.app-header .title {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-color);
    margin: 0;
}

/* (ì‚¬ìš©ìžê°€ ì§ˆë¬¸í•œ ë¶€ë¶„) í—¤ë” ë¶€ì œëª© (ì˜¨ë¼ì¸ ìƒíƒœ ë“±) */
.app-header .subtitle {
    font-size: 11px;
    color: #888;
    display: flex;
    align-items: center;
    margin-top: 2px;
}

/* ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ ì  */
.online-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--online-status-color);
    margin-right: 5px;
}

/* í—¤ë” ì¢Œìš° ê· í˜•ì„ ìœ„í•œ ë¹ˆ ê³µê°„ */
.app-header .placeholder {
    width: 40px;
}

/* --- END: êµì²´í•  CSS ë¸”ë¡ --- */

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .online-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        #home-screen {
            justify-content: space-between;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 50px 0;
        }

        .time-widget {
            text-align: center;
            padding: 0 20px;
            color: var(--text-color);
        }

        .time-widget .time {
            font-size: 72px;
            font-weight: 600;
        }

        .time-widget .date {
            font-size: 18px;
            color: #666;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .app-grid {
            width: 100%;
            padding: 20px 40px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            justify-content: center;
            align-content: center;
            margin-top: 40px;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .dock {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            margin: 0 20px;
            min-height: 80px;
            gap: 15px;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .icon-img {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            object-fit: cover;
        }

        .app-icon:hover .icon-img {
            transform: translateY(-5px);
        }

        .app-icon .app-name {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background: var(--white-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.2s ease-out;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
            font-size: 15px;
            font-weight: 500;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #edit-group-member-modal,
        #create-member-for-group-modal {
            z-index: 102;
        }

        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background: #f7f7f7;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #world-book-screen .content {
            padding: 10px 0 0 0;
        }

        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 18px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color: #fdf6f8;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .unread-badge { margin-left: auto; background-color: #ff554c; color: white; font-size: 12px; font-weight: bold; padding: 2px 7px; border-radius: 20px; }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 40%;
            margin-right: 12px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .group-avatar {
            border-radius: 10px;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            gap: 8px; 
        }

        .item-time {
            font-size: 11px;
            color: #aaa;
            white-space: nowrap; 
            flex-shrink: 0; 
        }

        .item-name {
            font-weight: 500;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            padding-right: 40px;
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 0 10px;
            padding-bottom: 0px;
            transition: padding-bottom 0.3s ease;
        }

        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 5px;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.group-message {
            margin-bottom: 18px;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
        }

        #message-area > .message-wrapper:first-of-type {
            margin-top: 10px;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        .message-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 40%;
            object-fit: cover;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            margin: 10px 0px;
        }

        .message-bubble {
            max-width: 60%;
            padding: 9px 12px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.3;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 7px;
            cursor: pointer;
            font-size: var(--bubble-font-size, 14px);
        }

        .message-bubble.sent {
            border-top-right-radius: 5px;
        }

        .message-bubble.received {
            border-top-left-radius: 5px;
        }

        .message-bubble.grouped-bubble.sent,
        .message-bubble.grouped-bubble.received {
            border-radius: var(--border-radius);
         
        }

        .message-bubble.grouped-bubble::first-child {
            margin-bottom: 2px;
        }

        .message-wrapper.grouped .message-info {
            visibility: hidden; 
        }
        
        .message-wrapper.grouped {
            margin-top: -16px; 
            margin-bottom: 12px;
        }
        
        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            margin: 6px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .sticker-bubble {
            width: 120px;
            margin: 8px;
            cursor: pointer;
        }

        .sticker-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--border-radius);
        }

        
        .photo-bubble {
            width: 60%;
            max-width: 400px;
            border-radius: var(--border-radius);
            margin: 8px;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .photo-bubble img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover; 
        }

        .message-wrapper.sent .photo-bubble {
            border-top-right-radius: 5px;
        }

        .message-wrapper.received .photo-bubble {
            border-top-left-radius: 5px;
        }

        .voice-bubble {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 9px 12px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            max-width: 200px;
        }

        .message-wrapper.sent .voice-bubble {
            border-top-right-radius: 5px;
            flex-direction: row-reverse;
        }

        .message-wrapper.received .voice-bubble {
            border-top-left-radius: 5px;
        }

        .voice-bubble .play-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .voice-bubble .duration {
            font-size: 12px;
            margin: 0 4px;
            white-space: nowrap;
        }

        .message-wrapper.sent .play-icon {
            transform: scaleX(-1);
        }

        .voice-transcript {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .voice-transcript.active {
            display: block;
        }

        .message-wrapper.sent .voice-transcript {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .voice-transcript {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }


.pv-card {
    width: 60%;
    max-width: 400px; 
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    position: relative; 
    cursor: pointer;
    margin: 8px;
    background-color: #eee; 
}


.pv-card-img {
    display: block; 
    width: 100%;    
    height: auto;   
}

.message-wrapper.sent .pv-card {
    border-top-right-radius: 5px;
}

.message-wrapper.received .pv-card {
    border-top-left-radius: 5px;
}


.pv-card-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 15px;
    overflow-y: auto;
    color: var(--text-color);
    line-height: 1.6;
    font-size: 15px;
    background-color: rgba(255, 255, 255, 0.95); 
    backdrop-filter: blur(4px);
    z-index: 2; 
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 0.3s ease;
}


.pv-card-content.visible {
    opacity: 1;
    pointer-events: auto;
}

.pv-card-footer {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
    color: white;
    padding: 20px 10px 8px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 1; 
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
}

.pv-card-footer.hidden {
    opacity: 0;
}

.pv-card-footer svg {
    width: 14px;
    height: 14px;
    fill: white;
    flex-shrink: 0;
}

        .transfer-card {
            width: 230px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }

        .message-wrapper.sent .transfer-card {
            border-top-right-radius: 5px;
        }

        .message-wrapper.received .transfer-card {
            border-top-left-radius: 5px;
            cursor: pointer;
        }

        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }

        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }

        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }

        .transfer-card.received .overlay {
            background-color: rgba(255, 182, 193, 0.4);
        }

        .transfer-card.returned .overlay {
            background-color: rgba(100, 100, 100, 0.5);
        }

        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 16px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }

        .transfer-amount {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            margin-block-end: 0px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 8px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.sent .gift-card {
            border-top-right-radius: 5px;
        }

        .message-wrapper.received .gift-card {
            border-top-left-radius: 5px;
        }

        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 8%;
            flex-shrink: 0;
        }

        .gift-card-text {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            font-family: var(--font-family);
        }

        .gift-card-description {
            font-size: 12px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 9px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.2;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gift-card-description.active {
            display: block;
        }

        .message-wrapper.sent .gift-card-description {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .gift-card-description {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: var(--font-family);
        }

        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

        #sticker-bar {
            position: absolute;
            bottom: 100%; 
            left: 0;
            width: 100%;
            padding: 3px 10px;
            display: none; 
            align-items: center;
            justify-content: flex-start; 
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            gap: 5px;
            flex-wrap: wrap; 
            z-index: 5;
        }

        #sticker-bar.visible {
            display: flex;
        }

        .sticker-bar-btn {
            background: none;
            border: none;
            padding: 5px 6px;
            cursor: pointer;
        }

        .sticker-bar-btn svg {
            width: 22px;
            height: 22px;
            fill: #888;
        }

        .message-input-area .sticker-toggle-btn-wrapper {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }
        
        .message-input-area #sticker-toggle-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(10px);
        }

        .message-input-area #sticker-toggle-btn svg {
            width: 24px;
            height: 24px;
            fill: #888;
        }

        #sticker-modal {
            position: absolute;
            bottom: calc(88px + env(safe-area-inset-bottom)); 
            left: 0;
            right: 0;
            height: 35%;
            max-height: 450px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 4;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible {
            display: flex;
            animation: slideUp 0.15s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 20px 10px 25px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
            position: relative; 
        }

        .message-input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            gap: 8px;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            overflow: hidden;
        }

        .textarea-container {
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .message-input-area textarea {
            width: 100%; 
            border: none;
            padding: 10px 45px 10px 12px;
            border-radius: 18px;
            background-color: #f0f0f0;
            resize: none; 
            font-family: inherit; 
            line-height: 1.2;
            max-height: 120px;
            box-sizing: border-box; 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .message-input-area textarea::-webkit-scrollbar {
            display: none;
        }

        .message-input-area input:focus {
            outline: none;
        }

        .message-input-area .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .message-input-area .icon-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message-input-area .icon-btn svg {
            width: 25px;
            height: 25px;
            fill: currentColor;
        }

        #attachment-toggle-btn {
            background-color: #f0f0f0 !important;
            color: #555 !important;
            font-size: 24px;
            font-weight: bold;
        }
        #attachment-toggle-btn.active {
            transform: rotate(45deg);
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .message-input-area .icon-btn.send-btn {
            font-size: 17px;
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .settings-sidebar {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            height: 100%;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.4s ease-in-out;
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: 500;
            text-align: center;
            color: var(--primary-color);
        }

        .settings-sidebar .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-sidebar .form-group textarea {
            height: 150px;
            resize: vertical;
        }

        .settings-sidebar .avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-sidebar .avatar-preview {
            width: 50px;
            height: 50px;
            border-radius: 40%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
            aspect-ratio: 1 / 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group-checkbox {
            padding: 0px 5px 12px 5px;
            border-radius: 10px;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group label {
            font-size: 13px;
            display: block;
            margin-bottom: 6px;
            padding-left: 5px;
            color: var(--secondary-color);
            font-weight: 400;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            align-items: center;
        }

        .form-group.radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--white-color);
            
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        
        .github-sync-section {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            background-color: #fafafa;
            margin-top: 20px;
        }

        .github-sync-section h4 {
            margin: 0 0 15px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .github-sync-section h4:hover {
            background-color: #e0e0e0;
        }

        .github-sync-section h4 span {
            float: right;
            transition: transform 0.3s ease;
        }

        #github-sync-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        #github-sync-content .form-group {
            margin-bottom: 15px;
        }

        #github-sync-content .css-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #github-sync-content .btn {
            margin-bottom: 0;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #fff8fa;
        }

        .toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        #world-book-selection-modal,
        #invite-member-modal,
        #group-recipient-selection-modal {
            z-index: 102;
        }

        #world-book-selection-modal .modal-window,
        #invite-member-modal .modal-window,
        #group-recipient-selection-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }

        #world-book-selection-list,
        #invite-member-selection-list,
        #group-recipient-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .world-book-select-item,
        .invite-member-select-item,
        .group-recipient-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .world-book-select-item:last-child,
        .invite-member-select-item:last-child,
        .group-recipient-select-item:last-child {
            border-bottom: none;
        }

        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"],
        .group-recipient-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        .world-book-select-item label,
        .invite-member-select-item label,
        .group-recipient-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .invite-member-select-item img,
        .group-recipient-select-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        
        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .member-selection-item:last-child {
            border-bottom: none;
        }

        .member-selection-item input[type="checkbox"] {
            margin-right: 10px;
            width: 15px;
            height: 15px;
            flex-shrink: 0;
        }

        .member-selection-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
        }

        .member-selection-item label {
            font-weight: 500;
            color: var(--text-color);
        }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }

        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }

        #customize-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        #customize-screen .icon-custom-item:last-child {
            border-bottom: none;
        }

        #customize-screen .icon-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #customize-screen .icon-details {
            flex-grow: 1;
        }

        #customize-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 500;
        }

        #customize-screen .reset-icon-btn {
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        
        .customize-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            margin: 0 0 20px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }

        .section-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .css-toggle-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }

        .toggle-text {
            font-size: 16px;
            color: var(--text-color);
        }

        .css-preset-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            color: var(--text-color);
        }

        .css-input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            font-family: var(--font-family-monospace);
            background: #fff;
            color: var(--text-color);
            resize: vertical;
            min-height: 120px;
        }

        .css-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-secondary {
            background: var(--accent-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #64b5f6;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .css-info {
            padding: 12px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .info-text {
            margin: 0;
            font-size: 13px;
            color: #1976d2;
            line-height: 1.4;
        }

        
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid #fce4ec;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff8fa;
        }

        .tutorial-header {
            padding: 12px 18px;
            font-weight: 500;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-header::after {
            content: 'â–¼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }

        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }

        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            
            max-height: 5000px;
        }

        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
        }
        .form-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .font-description {
            font-style: italic;
        }

        .message-meta {
            display: flex;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            white-space: nowrap;
        }

        
button:focus, a:focus, input:focus, textarea:focus, select:focus {
    outline: none;
    -webkit-tap-highlight-color: transparent; 
}


.back-btn:focus, .action-btn:focus, .icon-btn:focus, .sticker-bar-btn:focus, .app-icon:focus {
    outline: none !important;
    box-shadow: none !important; 
    -webkit-tap-highlight-color: transparent;
}

/* --- START: ì´ ì½”ë“œë¡œ CSSë¥¼ êµì²´ ë˜ëŠ” ì¶”ê°€í•˜ì„¸ìš” --- */
.phone-screen.has-bottom-nav .content {
    padding: 10px 0px 120px 0px; /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ë†’ì´ë§Œí¼ ì—¬ë°± ì¶”ê°€ */
}

.bottom-nav {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding-bottom: calc(40px + env(safe-area-inset-bottom));
    background-color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid #dbdbdb;
    display: flex;
    justify-content: space-around;
    align-items: flex-start;
    padding-top: 8px;
    z-index: 50;
}
.nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: #8e8e8e;
    font-size: 10px;
    gap: 2px;
}
.nav-btn svg {
    width: 26px;
    height: 26px;
    fill: currentColor;
}
.nav-btn.active {
    color: var(--primary-color);
}

/* ì±„íŒ… ëª©ë¡ ê²€ìƒ‰ì°½ */
.search-bar-container {
    padding: 10px 15px;
    background-color: #fff;
    border-bottom: 1px solid #f0f0f0;
}
.search-input {
    width: 100%;
    padding: 8px 15px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 10px;
    font-size: 14px;
}
.search-input:focus {
    outline: none;
}

/* í”¼ë“œ í™”ë©´ ìŠ¤íƒ€ì¼ ê°œì„  */
#feed-screen .content {
    padding: 0;
    background-color: #fafafa;
}
.feed-post {
    background: var(--white-color);
    border-bottom: 1px solid #dbdbdb;
    margin-bottom: 10px;
}
.post-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    gap: 12px;
    cursor: pointer;
}
.post-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
}
.post-author {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-color);
}
.post-image img {
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: cover;
    display: block;
}
.post-actions {
    padding: 10px 15px;
    display: flex;
    gap: 18px;
}
.post-actions svg {
    width: 26px;
    height: 26px;
    fill: #262626;
    cursor: pointer;
}
.post-footer {
    padding: 0 15px 15px;
}
.post-likes {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}
.post-content {
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 8px;
}
.post-content .author {
    font-weight: 500;
    margin-right: 5px;
}
.view-comments {
    font-size: 14px;
    color: #8e8e8e;
    cursor: pointer;
    margin-bottom: 8px;
}
.post-timestamp {
    font-size: 11px;
    color: #c7c7c7;
    text-transform: uppercase;
}
.comment-input-area {
    display: flex;
    align-items: center;
    padding: 8px 15px;
    border-top: 1px solid #efefef;
    gap: 10px;
}
.comment-input-area .my-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
}
.comment-input {
    border: none;
    background: none;
    flex-grow: 1;
    font-size: 14px;
    color: #8e8e8e;
}

/* í”„ë¡œí•„ í™”ë©´ ìŠ¤íƒ€ì¼ ê°œì„  */
#profile-screen .content {
    background-color: #fafafa;
}
.profile-header {
    background: var(--white-color);
    padding: 20px 15px;
    display: flex;
    align-items: center;
    gap: 25px;
    border-bottom: 1px solid #dbdbdb;
}
.profile-avatar-lg {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
}
.profile-details {
    flex-grow: 1;
}
.profile-details .username {
    font-size: 22px;
    font-weight: 300;
    margin: 0 0 10px;
}
.profile-buttons {
    display: flex;
    gap: 8px;
}
.profile-buttons .btn {
    flex: 1;
    padding: 8px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 8px;
}
.btn-follow { background-color: #0095f6; color: white; }
.btn-message { background-color: #efefef; color: #262626; }

.profile-bio {
    padding: 15px;
    background: var(--white-color);
}
.profile-bio .name { font-weight: 500; }
.profile-bio .bio-text { font-size: 14px; line-height: 1.4; }

.profile-stats {
    display: flex;
    justify-content: space-around;
    padding: 15px 0;
    background: var(--white-color);
    border-top: 1px solid #dbdbdb;
    border-bottom: 1px solid #dbdbdb;
}
.stat-item { text-align: center; }
.stat-item .count { font-weight: 500; font-size: 16px; }
.stat-item .label { font-size: 14px; color: #8e8e8e; }

.story-highlights {
    padding: 15px;
    background: white;
    display: flex;
    gap: 20px;
    overflow-x: auto;
}
.highlight-item { text-align: center; }
.highlight-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #f0f0f0;
    margin-bottom: 5px;
    border: 1px solid #dbdbdb;
}
.highlight-item span { font-size: 12px; }

.profile-tabs {
    display: flex;
    border-top: 1px solid #dbdbdb;
    background: white;
}
.tab-btn {
    flex: 1;
    padding: 15px;
    border: none;
    background: none;
    cursor: pointer;
    border-bottom: 2px solid transparent;
}
.tab-btn.active {
    border-bottom-color: #262626;
}
.tab-btn svg { width: 24px; height: 24px; fill: #8e8e8e; }
.tab-btn.active svg { fill: #262626; }

.profile-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 3px;
    padding-top: 3px;
}
.grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    aspect-ratio: 1 / 1;
}

.phone-screen.hide-user-icons .message-wrapper.sent .message-info {
    display: none;
}

/* ìºë¦­í„°(received) ì•„ì´ì½˜ ìˆ¨ê¸°ê¸° */
.phone-screen.hide-character-icons .message-wrapper.received .message-info {
    display: none;
}

/* --- START: ì¶”ê°€í•  CSS --- */
/* ì±„íŒ…ë°©ë³„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° */
#chat-room-screen.hide-my-icons .message-wrapper.sent .message-info {
    display: none;
}
#chat-room-screen.hide-char-icons .message-wrapper.received .message-info {
    display: none;
}

    </style>
</head>
<body>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <!-- START: chat-list-screenì˜ header íƒœê·¸ë¥¼ ì´ê±¸ë¡œ êµì²´ -->
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
            <div class="title-container">
                <h1 class="title">ì±„íŒ…</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn" title="ê·¸ë£¹ì±„íŒ…">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></svg>
                </button>
                <button class="action-btn" id="add-chat-btn" title="ìƒˆ ì±„íŒ…">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>
                </button>
            </div>
        </header>
<!-- END: header íƒœê·¸ êµì²´ -->
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>ì•„ì§ ì±„íŒ… ìƒëŒ€ê°€ ì—†ë„¤ìš”~</p>
                <p>ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ "+"ë¥¼ í´ë¦­í•˜ì—¬ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div><span id="chat-room-status-text">ì˜¨ë¼ì¸</span>
                </div>
            </div>
            <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="ì„¤ì •"></button>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">ì·¨ì†Œ</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">ë©”ì‹œì§€ ì„ íƒ</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
    <div id="sticker-bar">
        <button class="sticker-bar-btn" id="photo-video-btn" title="ì‚¬ì§„/ì˜ìƒ">
            <svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
        </button>
        <button class="sticker-bar-btn" id="voice-message-btn" title="ìŒì„± ë©”ì‹œì§€">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" /></svg>
        </button>
        <button class="sticker-bar-btn" id="wallet-btn" title="ì†¡ê¸ˆ">
            <svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z" /></svg>
        </button>
        <button class="sticker-bar-btn" id="gift-btn" title="ì„ ë¬¼">
            <svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z" /></svg>
        </button>
        <button class="sticker-bar-btn" id="time-skip-btn" title="ì‹œê°„ ë³´ë‚´ê¸°">
            <svg viewBox="0 0 24 24"><path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path></svg>
        </button>
    </div>
    <div class="message-input-area" id="message-input-area-container">
        <button id="attachment-toggle-btn" class="icon-btn">+</button>
        <div class="textarea-container">
            <textarea rows="1" id="message-input" placeholder="ë©”ì‹œì§€ ìž…ë ¥..."></textarea>
            <div class="sticker-toggle-btn-wrapper">
                <button class="sticker-bar-btn" id="sticker-toggle-btn" title="ì´ëª¨í‹°ì½˜">
                    <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" /></svg>
                </button>
            </div>
        </div>
        <!-- ì¼ë°˜ ëª¨ë“œ ë²„íŠ¼ -->
        <button id="send-message-btn" class="icon-btn send-btn">âž¤</button>
        <button id="get-reply-btn" class="icon-btn">
            <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z" /></svg>
        </button>
        <!-- íŽ¸ì§‘ ëª¨ë“œ ë²„íŠ¼ (ì´ˆê¸° ìˆ¨ê¹€) -->
        <button id="save-edit-btn" class="icon-btn send-btn" style="display: none;">âœ“</button>
        <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa; display: none;">âœ—</button>
    </div>
</div>
        <div id="multi-select-bar"><span id="select-count">0ê°œ í•­ëª© ì„ íƒë¨</span><button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">ì„ íƒ í•­ëª© ì‚­ì œ</button></div>
        <div id="sticker-modal">
            <div class="header"><span>ë‚´ ì´ëª¨í‹°ì½˜</span><button class="btn btn-primary btn-small" id="add-new-sticker-btn" style="font-size: 18px; padding: 6px 10px;">+</button></div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
        </div>
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
            <div class="title-container">
                <h1 class="title">ì„¸ê³„ê´€</h1>
            </div>
            <button class="action-btn" id="add-world-book-btn" title="ìƒˆ í•­ëª© ì¶”ê°€">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>
            </button>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>ë‹¹ì‹ ì˜ ì„¸ê³„ëŠ” í˜¼ëˆì— ë¹ ì ¸ ìžˆìŠµë‹ˆë‹¤...</p>
                <p>ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ "+"ë¥¼ í´ë¦­í•˜ì—¬ ì²« ì„¤ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            </div>
        </main>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">í•­ëª© ìƒì„±/íŽ¸ì§‘</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">í•­ëª© ì´ë¦„</label>
                    <input type="text" id="world-book-name" placeholder="ì˜ˆ: ì„¸ê³„ê´€ ë°°ê²½, ë§ˆë²• ì²´ê³„" required>
                </div>
                <div class="form-group">
                    <label for="world-book-content">í•­ëª© ë‚´ìš©</label>
                    <textarea id="world-book-content" rows="8" placeholder="ì´ ì„¤ì •ì„ ìžì„¸ížˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..." required></textarea>
                </div>
                <div class="form-group">
                    <label>ì£¼ìž… ìœ„ì¹˜</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> ì•ž</label>
                        <label><input type="radio" name="world-book-position" value="after"> ë’¤</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">í•­ëª© ì €ìž¥</button>
            </form>

        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>
    <!-- START: ì¶”ê°€í•  HTML -->
<div id="wallpaper-font-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
        <div class="title-container">
            <h1 class="title">ë°°ê²½í™”ë©´ & ê¸€ê¼´</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <!-- ë°°ê²½í™”ë©´ ì„¤ì •ì´ ì—¬ê¸°ì— ìœ„ì¹˜í•©ë‹ˆë‹¤ -->
        <div class="customize-section" style="margin-top:0;">
             <h3 class="section-title">ë°°ê²½í™”ë©´ ë³€ê²½</h3>
             <div class="wallpaper-preview" id="wallpaper-preview"><span>í˜„ìž¬ ë°°ê²½í™”ë©´ ë¯¸ë¦¬ë³´ê¸°</span></div>
             <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
             <label for="wallpaper-upload" class="btn btn-primary">ì•¨ë²”ì—ì„œ ìƒˆ ë°°ê²½í™”ë©´ ì„ íƒ</label>
        </div>
        <!-- ê¸€ê¼´ ì„¤ì •ì´ ì—¬ê¸°ì— ìœ„ì¹˜í•©ë‹ˆë‹¤ -->
        <div class="customize-section">
            <h3 class="section-title">ê¸€ê¼´ ì„¤ì •</h3>
            <div class="form-group">
                <label for="font-preset-selector">ì €ìž¥ëœ í°íŠ¸ ì„ íƒ</label>
                <select id="font-preset-selector" class="form-select"></select>
                <p class="font-description" id="font-description" style="font-size:12px; color:#666; margin-top:8px; margin-bottom:15px;">í”„ë¦¬ì…‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            <form id="font-settings-form">
                <div class="form-group">
                    <label for="font-url">í°íŠ¸ URL</label>
                    <input type="url" id="font-url" placeholder="ì—¬ê¸°ì— í°íŠ¸ URLì„ ìž…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
                    <p style="font-size:12px; color:#888;">í°íŠ¸ íŒŒì¼ URLì„ ìž…ë ¥í•˜ì„¸ìš”</p>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 15px;">
                    <input type="text" id="new-preset-name" placeholder="í°íŠ¸ ì´ë¦„ (ì˜ˆ: ë‚˜ëˆ”ê³ ë”•)" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                    <input type="text" id="new-preset-description" placeholder="ì„¤ëª… (ì„ íƒ)" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div class="font-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-primary" id="apply-font-btn" style="flex: 1;">í°íŠ¸ ì ìš©</button>
                    <button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="flex: 0.7;">ê¸°ë³¸ í°íŠ¸</button>
                </div>
            </form>
            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 13px 5px; color: var(--text-color); font-size: 16px; font-weight: 500;">í”„ë¦¬ì…‹ ê´€ë¦¬</h3>
                <button type="button" class="btn btn-secondary" id="save-preset-btn" style="width: 100%; margin-bottom: 10px;">í”„ë¦¬ì…‹ ë“±ë¡</button>
                <button type="button" class="btn btn-danger" id="delete-preset-btn" style="width: 100%;" disabled>í”„ë¦¬ì…‹ ì‚­ì œ</button>
            </div>
        </div>
    </main>
</div>

<div id="settings-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
        <div class="title-container">
            <h1 class="title">ì„¤ì •</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <div class="customize-section">
            <h3 class="section-title">ì „ì—­ ì„¤ì •</h3>
            <div class="section-content" id="global-settings-container">
                 <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 5px;">
                    <label for="ai-can-use-system-toggle" style="margin:0; font-weight: 500;">AI ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì‚¬ìš©</label>
                    <input type="checkbox" id="ai-can-use-system-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
                </div>
                 <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 5px;">
                    <label for="hide-user-icons-toggle" style="margin:0; font-weight: 500;">ìœ ì € ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°</label>
                    <input type="checkbox" id="hide-user-icons-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
                </div>
                 <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 5px;">
                    <label for="hide-character-icons-toggle" style="margin:0; font-weight: 500;">ìºë¦­í„° ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°</label>
                    <input type="checkbox" id="hide-character-icons-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
                </div>
            </div>
        </div>
    </main>
</div>
<!-- END: ì¶”ê°€í•  HTML -->
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast"></div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ìƒˆ ìºë¦­í„° ë§Œë“¤ê¸°</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">ìºë¦­í„° ì´ë¦„</label><input type="text" id="char-real-name" placeholder="ìºë¦­í„°ì˜ ì‹¤ì œ ì´ë¦„" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">ìºë¦­í„° ë©”ëª¨ (ë³„ëª…)</label><input type="text" id="char-remark-name" placeholder="ë‹¹ì‹ ì´ ë¶€ë¥¼ í˜¸ì¹­" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">ë‚´ ì´ë¦„</label><input type="text" id="my-name-for-char" placeholder="ìƒëŒ€ë°©ì´ ë‹¹ì‹ ì„ ë¶€ë¥¼ í˜¸ì¹­" required>
                </div><button type="submit" class="btn btn-primary">ë§Œë“¤ê¸°</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">ìƒˆ ì´ëª¨í‹°ì½˜ ì¶”ê°€</h3>
            
            
            <div class="sticker-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd;">
                <button type="button" id="single-sticker-tab" class="sticker-tab-btn active" style="flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #4CAF50;">ë‹¨ì¼ ë“±ë¡</button>
                <button type="button" id="bulk-sticker-tab" class="sticker-tab-btn" style="flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent;">ì¼ê´„ ë“±ë¡</button>
            </div>

            
            <div id="single-sticker-content" class="sticker-tab-content">
                <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                    <div id="sticker-preview"><span>ë¯¸ë¦¬ë³´ê¸°</span></div>
                    <div class="form-group"><label for="sticker-name">ì´ëª¨í‹°ì½˜ ì´ë¦„</label><input type="text" id="sticker-name" placeholder="ì˜ˆ: ê¸°ì¨" required></div>
                    <div class="form-group"><label for="sticker-url-input">ì´ëª¨í‹°ì½˜ URL</label><input type="url" id="sticker-url-input" placeholder="ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°"></div>
                    <p style="text-align:center; color:#888; margin: -10px 0 15px; font-size: 14px;">ë˜ëŠ”</p><input type="file" id="sticker-file-upload" accept="image/*" style="display:none;"><label for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 10px;">ë¡œì»¬ì—ì„œ ì—…ë¡œë“œ</label><button type="submit" class="btn btn-primary">ì €ìž¥</button>
                </form>
            </div>

            
            <div id="bulk-sticker-content" class="sticker-tab-content" style="display: none;">
                <form id="bulk-sticker-form">
                    <div class="form-group">
                        <label for="bulk-sticker-input">ì¼ê´„ ì´ëª¨í‹°ì½˜ ë“±ë¡</label>
                        <textarea id="bulk-sticker-input" rows="8" placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ìž…ë ¥í•˜ì„¸ìš”:&#10;ë¬¼ìŒí‘œhttps://i.postimg.cc/d0YWDkN4/ajsv2e.gif&#10;ë†€ëžŒ./images/emoji.png&#10;ê¸°ì¨data:image/png;base64,iVBORw0K...&#10;ì›ƒìŒfile:///C:/happy.jpg" style="width: 100%; resize: vertical; font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #666;">
                        <strong>ì‚¬ìš©ë²•:</strong><br>
                        â€¢ í•œ ì¤„ì— í•˜ë‚˜ì”© ì´ëª¨í‹°ì½˜ì„ ìž…ë ¥í•˜ì—¬ ì—¬ëŸ¬ ê°œë¥¼ í•œë²ˆì— ë“±ë¡<br>
                        â€¢ ê° ì¤„ì€ "ì´ë¦„URL" í˜•ì‹ìœ¼ë¡œ ìž…ë ¥<br>
                        â€¢ <strong>ì§€ì› í˜•ì‹:</strong><br>
                        &nbsp;&nbsp;- ì›¹ URL: ë¬¼ìŒí‘œhttps://example.com/image.gif<br>
                        &nbsp;&nbsp;- ìƒëŒ€ê²½ë¡œ: ë†€ëžŒ./images/emoji.png<br>
                        &nbsp;&nbsp;- íŒŒì¼ê²½ë¡œ: ê¸°ì¨file:///C:/images/happy.jpg<br>
                        &nbsp;&nbsp;- Base64: ì›ƒìŒdata:image/png;base64,iVBORw0K...<br>
                        â€¢ ë¹ˆ ì¤„ì€ ìžë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤
                    </div>
                    <div id="bulk-preview-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; display: none;">
                        <strong>ë¯¸ë¦¬ë³´ê¸° (íŒŒì‹± ê²°ê³¼):</strong>
                        <div id="bulk-preview-content"></div>
                    </div>
                    <button type="button" id="preview-bulk-btn" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">ë¯¸ë¦¬ë³´ê¸°</button>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ì¼ê´„ ì €ìž¥</button>
                </form>
            </div>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet"><button class="action-sheet-button" id="edit-sticker-btn">íŽ¸ì§‘</button><button class="action-sheet-button danger" id="delete-sticker-btn">ì‚­ì œ</button></div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ìŒì„± ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">ìŒì„± í…ìŠ¤íŠ¸ ìž…ë ¥</label>
                    <textarea id="voice-text-input" placeholder="ì—¬ê¸°ì— í•˜ê³  ì‹¶ì€ ë§ì„ ìž…ë ¥í•˜ì„¸ìš”..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    ì˜ˆìƒ ì‹œê°„: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">ë³´ë‚´ê¸°</button>
            </form>
        </div>
    </div>
<div id="send-pv-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>ì‚¬ì§„/ì˜ìƒ ê³µìœ </h3>
        <form id="send-pv-form">
            <div class="wallpaper-preview" id="pv-image-preview" style="height: 200px; margin-bottom: 15px; border-style: solid; border-width: 2px;">
                <span>ì‚¬ì§„/ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°</span>
            </div>
            <input type="file" id="pv-image-upload" accept="image/*" style="display:none;">
            <label for="pv-image-upload" class="btn btn-secondary" style="width: 100%; margin-bottom: 15px;">ì•¨ë²”ì—ì„œ ì„ íƒ</label>
            <div class="form-group">
                <label for="pv-text-input">ì„¤ëª… ìž…ë ¥</label>
                <textarea id="pv-text-input" placeholder="ì—¬ê¸°ì— ì‚¬ì§„ì´ë‚˜ ì˜ìƒ ë‚´ìš©ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”..." required rows="4"></textarea>
            </div>
            
            <div class="form-group-checkbox" id="pv-ai-recog-wrapper" style="display: none;">
                <label style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <input type="checkbox" id="pv-ai-recog-checkbox">
                    AIì—ê²Œ ì´ë¯¸ì§€ ì¸ì‹ ìš”ì²­
                </label>
            </div>
            <button type="submit" class="btn btn-primary">ë³´ë‚´ê¸°</button>
        </form>
    </div>
</div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ì†¡ê¸ˆ</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">ë©”ëª¨</label>
                    <input type="text" id="transfer-remark-input" placeholder="(ì„ íƒ ì‚¬í•­)">
                </div>
                <button type="submit" class="btn btn-primary">ë³´ë‚´ê¸°</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ì„ ë¬¼ ë³´ë‚´ê¸°</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">ì„ ë¬¼ ì„¤ëª…</label>
                    <textarea id="gift-description-input" placeholder="íŠ¹ë³„í•œ ì„ ë¬¼ì„ ë³´ëƒˆë‹¤ê³  ì•Œë ¤ì£¼ì„¸ìš”..." required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ë³´ë‚´ê¸°</button>
            </form>
        </div>
    </div>
    
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ì˜¤ëŠ˜ ìžˆì—ˆë˜ ì¼ ê¸°ë¡í•˜ê¸°</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">ì´ë²¤íŠ¸ ì„¤ëª… (ì´ ë©”ì‹œì§€ëŠ” AIì—ê²Œ ë³´ì´ë©°, ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤)</label>
                    <textarea id="time-skip-input" placeholder="ì˜ˆ: ìš°ë¦¬ëŠ” í•¨ê»˜ ì‚° ì •ìƒì— ì˜¬ë¼ê°€ ì¼ëª°ì„ ë³´ê³  ë°”ë² íë¥¼ ë¨¹ì—ˆì–´ìš”." required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ë³´ë‚´ê¸°</button>
            </form>
        </div>
    </div>
    
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">ë°›ëŠ” ì‚¬ëžŒ ì„ íƒ</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">í™•ì¸</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">ë°›ê¸°</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">ë°˜í™˜</button>
        </div>
    </div>
    
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">ì±„íŒ… ì„¤ì •</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="ìºë¦­í„° ì•„ë°”íƒ€" id="setting-char-avatar-preview" class="avatar-preview"><input type="file" id="setting-char-avatar-upload" accept="image/*" style="display:none;"><label for="setting-char-avatar-upload" class="btn btn-primary" style="flex-grow:1;">ìºë¦­í„° ì•„ë°”íƒ€ ë³€ê²½</label></div>
                <div class="form-group"><label for="setting-char-remark">ìºë¦­í„° ë©”ëª¨ (ë³„ëª…)</label><input type="text" id="setting-char-remark"></div>
                <div class="form-group"><label for="setting-char-persona">ìºë¦­í„° ì„¤ì •</label><textarea id="setting-char-persona" placeholder="ìºë¦­í„°ì˜ ì„±ê²©, ë°°ê²½, ë§íˆ¬ ë“±ì„ ìžì„¸ížˆ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="ë‚´ ì•„ë°”íƒ€" id="setting-my-avatar-preview" class="avatar-preview"><input type="file" id="setting-my-avatar-upload" accept="image/*" style="display:none;"><label for="setting-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">ë‚´ ì•„ë°”íƒ€ ë³€ê²½</label></div>
                <div class="form-group"><label for="setting-my-name">ë‚´ ì´ë¦„</label><input type="text" id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">ë‚´ ì„¤ì •</label><textarea id="setting-my-persona" placeholder="ëŒ€í™”ì—ì„œ ì—°ê¸°í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group"><button type="button" class="btn btn-secondary" id="link-world-book-btn">ì„¸ê³„ê´€ ì—°ê²°</button></div>
                <div class="form-group"><label for="setting-theme-color">í…Œë§ˆ ìƒ‰ìƒ (ìƒëŒ€ë°©/ë‚˜)</label><select id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">ë§í’ì„  ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="bubble-display-options" style="background: #f9f9f9; border-radius: 8px; padding: 5px 15px; margin-bottom: 10px;">
        <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0px; border-bottom: 1px solid #eee;">
            <label for="setting-hide-my-bubbles-toggle" style="margin:0; font-size: 14px;">ë‚´ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°</label>
            <input type="checkbox" id="setting-hide-my-bubbles-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
        </div>
        <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0px; border-bottom: 1px solid #eee;">
            <label for="setting-hide-char-bubbles-toggle" style="margin:0; font-size: 14px;">ìƒëŒ€ë°© ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°</label>
            <input type="checkbox" id="setting-hide-char-bubbles-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
        </div>
        <div class="form-group-checkbox" style="display: flex; flex-direction: column; align-items: stretch; padding: 10px 0px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="setting-font-size-slider" style="margin:0; font-size: 14px;">í°íŠ¸ í¬ê¸°</label>
                <span id="setting-font-size-value" style="font-size: 14px; color: var(--primary-color); font-weight: 500;">14px</span>
            </div>
            <input type="range" id="setting-font-size-slider" min="10" max="20" value="14" step="1" style="width: 100%;">
        </div>
    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6" placeholder="ì—¬ê¸°ì— CSS ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš”...&#10;ì˜ˆì‹œ:&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }" disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn" style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›</button>
                </div>

                <div class="form-group"><label for="setting-max-memory">ìµœëŒ€ ê¸°ì–µ í„´ ìˆ˜</label><input type="number" id="setting-max-memory" value="100" min="1"></div>
                <div class="form-group">
                    <input type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;">
                    <button type="button" id="setting-chat-bg-btn" class="btn btn-primary">ì±„íŒ… ë°°ê²½ ë³€ê²½</button>
                </div><button type="submit" class="btn btn-primary">ì„¤ì • ì €ìž¥</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><button type="button" class="btn btn-danger" id="clear-chat-history-btn">ì±„íŒ… ê¸°ë¡ ì‚­ì œ</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ì—°ê²°í•  ì„¸ê³„ê´€ ì„ íƒ</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">í™•ì¸</button>
        </div>
    </div>
    
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ê·¸ë£¹ì±„íŒ… ë§Œë“¤ê¸°</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>ê·¸ë£¹ ë©¤ë²„ ì„ íƒ</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">ê·¸ë£¹ì±„íŒ… ì´ë¦„</label>
                    <input type="text" id="group-name-input" placeholder="ê·¸ë£¹ì±„íŒ… ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”" required>
                </div>
                <button type="submit" class="btn btn-primary">ê·¸ë£¹ì±„íŒ… ë§Œë“¤ê¸°</button>
            </form>
        </div>
    </div>
    
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">ê·¸ë£¹ì±„íŒ… ì„¤ì •</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="ê·¸ë£¹ ì•„ë°”íƒ€" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary" style="flex-grow:1;">ê·¸ë£¹ ì•„ë°”íƒ€ ë³€ê²½</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">ê·¸ë£¹ ì´ë¦„ (AIì—ê²Œë„ ë³´ìž„)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="ë‚´ ì•„ë°”íƒ€" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">ë‚´ ì•„ë°”íƒ€ ë³€ê²½</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">ë‚´ ê·¸ë£¹ ë‹‰ë„¤ìž„</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">ë‚´ ì„¤ì •</label>
                    <textarea id="setting-group-my-persona" placeholder="ì´ ê·¸ë£¹ì±„íŒ…ì—ì„œ ì—°ê¸°í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>ê·¸ë£¹ ë©¤ë²„</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group"><button type="button" class="btn btn-secondary" id="link-group-world-book-btn">ì„¸ê³„ê´€ ì—°ê²°</button></div>
                <div class="form-group"><label for="setting-group-theme-color">í…Œë§ˆ ìƒ‰ìƒ (ìƒëŒ€ë°©/ë‚˜)</label><select id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">ë§í’ì„  ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
        <div id="group-bubble-display-options" style="background: #f9f9f9; border-radius: 8px; padding: 5px 15px; margin-bottom: 10px;">
        <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0px; border-bottom: 1px solid #eee;">
            <label for="setting-group-hide-my-bubbles-toggle" style="margin:0; font-size: 14px;">ë‚´ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°</label>
            <input type="checkbox" id="setting-group-hide-my-bubbles-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
        </div>
        <div class="form-group-checkbox" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0px; border-bottom: 1px solid #eee;">
            <label for="setting-group-hide-char-bubbles-toggle" style="margin:0; font-size: 14px;">ìƒëŒ€ë°© ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°</label>
            <input type="checkbox" id="setting-group-hide-char-bubbles-toggle" style="width: 20px; height: 20px; accent-color: var(--primary-color);">
        </div>
        <div class="form-group-checkbox" style="display: flex; flex-direction: column; align-items: stretch; padding: 10px 0px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="setting-group-font-size-slider" style="margin:0; font-size: 14px;">í°íŠ¸ í¬ê¸°</label>
                <span id="setting-group-font-size-value" style="font-size: 14px; color: var(--primary-color); font-weight: 500;">14px</span>
            </div>
            <input type="range" id="setting-group-font-size-slider" min="10" max="20" value="14" step="1" style="width: 100%;">
        </div>
    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6" placeholder="ì—¬ê¸°ì— CSS ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš”...&#10;ì˜ˆì‹œ:&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }" disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn" style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›</button>
                </div>

                <div class="form-group"><label for="setting-group-max-memory">ìµœëŒ€ ê¸°ì–µ í„´ ìˆ˜</label><input type="number" id="setting-group-max-memory" value="10" min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload" class="btn btn-primary">ì±„íŒ… ë°°ê²½ ë³€ê²½</label><input type="file" id="setting-group-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">ì„¤ì • ì €ìž¥</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">ì±„íŒ… ê¸°ë¡ ì‚­ì œ</button>
        </div>
    </div>
    
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">ê·¸ë£¹ ë©¤ë²„ íŽ¸ì§‘</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="ë©¤ë²„ ì•„ë°”íƒ€" id="edit-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">ê·¸ë£¹ ë‹‰ë„¤ìž„</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">ì‹¤ëª…</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">ì„¤ì •</label>
                    <textarea id="edit-member-persona" placeholder="ìºë¦­í„°ì˜ ì„±ê²©, ë°°ê²½ ë“±ì„ ìžì„¸ížˆ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ì €ìž¥</button>
            </form>
        </div>
    </div>
    
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">ê¸°ì¡´ ìºë¦­í„° ì´ˆëŒ€</button>
            <button class="action-sheet-button" id="create-new-member-btn">ìƒˆ ìºë¦­í„° ë§Œë“¤ì–´ ì´ˆëŒ€í•˜ê¸°</button>
        </div>
    </div>
    
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ê·¸ë£¹ì±„íŒ…ì— ë©¤ë²„ ì´ˆëŒ€</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">ì´ˆëŒ€ í™•ì¸</button>
        </div>
    </div>
    
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>ìƒˆ ìºë¦­í„° ë§Œë“¤ì–´ ê·¸ë£¹ì— ì¶”ê°€</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="ìƒˆ ë©¤ë²„ ì•„ë°”íƒ€" id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">ê·¸ë£¹ ë‹‰ë„¤ìž„</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">ì‹¤ëª…</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">ì„¤ì •</label>
                    <textarea id="create-group-member-persona" placeholder="ìºë¦­í„°ì˜ ì„±ê²©, ë°°ê²½ ë“±ì„ ìžì„¸ížˆ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ë§Œë“¤ì–´ì„œ ì¶”ê°€</button>
            </form>
        </div>
    </div>
    <!-- START: ì¶”ê°€í•  HTML (ìƒˆë¡œìš´ í™”ë©´ë“¤) -->
    <div id="feed-screen" class="screen">
        <header class="app-header">
            <div class="placeholder"></div>
            <div class="title-container">
                <h1 class="title">í”¼ë“œ</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content" id="feed-container" style="padding: 10px; padding-bottom: calc(120px + env(safe-area-inset-bottom));background-color: #f0f2f5;">
            <!-- í”¼ë“œ ê²Œì‹œë¬¼ì€ JSë¡œ ë Œë”ë§ ë©ë‹ˆë‹¤ -->
        </main>
    </div>

    <div id="schedule-screen" class="screen">
        <header class="app-header">
            <div class="placeholder"></div>
            <div class="title-container">
                <h1 class="title">ì¼ì •</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="placeholder-text" style="margin-top: 50px;">
                <p>ì¼ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ìž…ë‹ˆë‹¤.</p>
            </div>
        </main>
    </div>

    <div id="profile-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="feed-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
            <div class="title-container">
                <h1 class="title" id="profile-name"></h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content" id="profile-container" style="padding: 0; background-color: #f0f2f5;"></main>
    </div>

    <nav class="bottom-nav" id="bottom-nav-bar" style="display: none;">
        <a href="#" class="nav-btn active" data-target="chat-list-screen">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
            <span>ì±„íŒ…</span>
        </a>
        <a href="#" class="nav-btn" data-target="feed-screen">
            <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"></path></svg>
            <span>í”¼ë“œ</span>
        </a>
        <a href="#" class="nav-btn" data-target="schedule-screen">
            <svg viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"></path></svg>
            <span>ì¼ì •</span>
        </a>
    </nav>
<!-- END: ì¶”ê°€í•  HTML -->
</div>

<script>
    
    function getRandomValue(str) {
        
        if (str.includes(',')) {
            
            const arr = str.split(',').map(item => item.trim());
            
            const randomIndex = Math.floor(Math.random() * arr.length);
            
            return arr[randomIndex];
        }
        
        return str;
    }
    document.addEventListener('DOMContentLoaded', () => {
        
        const IS_DEVELOPMENT_MODE = false; 
        console.log('í˜„ìž¬ ë¹Œë“œ ëª¨ë“œ:', IS_DEVELOPMENT_MODE ? 'ê°œë°œìš© (Development)' : 'ë°°í¬ìš© (Production)');
        
        async function compressImage(file, options = {}) {
            const {
                quality = 0.8, maxWidth = 800, maxHeight = 800
            } = options;

            
            
            if (file.type === 'image/gif') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = reject;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        
                        
                        if (file.type === 'image/png') {
                            ctx.fillStyle = '#FFFFFF'; 
                            ctx.fillRect(0, 0, width, height);
                        }
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        
                        
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality); 
                        resolve(compressedDataUrl);
                    };
                };
            });
        }
        
        
        function initializeFontPresets() {
            
            console.log('í°íŠ¸ í”„ë¦¬ì…‹ ì´ˆê¸°í™” ì‹œìž‘');
            
            
            if (!db.globalFontPresets.presets.custom) {
                db.globalFontPresets.presets.custom = {
                    name: 'ì»¤ìŠ¤í…€ í°íŠ¸',
                    url: '',
                    description: 'ì§ì ‘ ìž…ë ¥í•œ í°íŠ¸ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤',
                    deletable: false 
                };
                console.log('ì»¤ìŠ¤í…€ í°íŠ¸ í”„ë¦¬ì…‹ ì¶”ê°€ë¨');
            } else {
                
                if (db.globalFontPresets.presets.custom.deletable === undefined) {
                    db.globalFontPresets.presets.custom.deletable = false;
                }
                console.log('ê¸°ì¡´ ì»¤ìŠ¤í…€ í°íŠ¸ í”„ë¦¬ì…‹ í™•ì¸ë¨:', db.globalFontPresets.presets.custom);
            }
            
            
            const defaultFonts = [
                {
                    id: 'default_1',
                    name: 'ë…¸í†  ì‚°ìŠ¤ KR',
                    url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap',
                    description: 'í•œêµ­ì–´ì— ìµœì í™”ëœ ê³ í’ˆì§ˆ í°íŠ¸'
                },
                {
                    id: 'default_2',
                    name: 'ë‚˜ëˆ” ê³ ë”•',
                    url: 'https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap',
                    description: 'ê°€ë…ì„±ì´ ì¢‹ì€ ê³ ë”•ì²´'
                },
                {
                    id: 'default_3',
                    name: 'ë‚˜ëˆ” ëª…ì¡°',
                    url: 'https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap',
                    description: 'ì „í†µì ì¸ ëª…ì¡°ì²´'
                },
                {
                    id: 'default_4',
                    name: 'ì‹±ê¸€ ë°ì´',
                    url: 'https://fonts.googleapis.com/css2?family=Single+Day&display=swap',
                    description: 'ê·€ì—¬ìš´ ì†ê¸€ì”¨ ìŠ¤íƒ€ì¼'
                },
                {
                    id: 'default_5',
                    name: 'êµ¬ê¸°',
                    url: 'https://fonts.googleapis.com/css2?family=Gugi&display=swap',
                    description: 'ë‘¥ê¸€ë‘¥ê¸€í•œ ê·€ì—¬ìš´ í°íŠ¸'
                },
                {
                    id: 'default_6',
                    name: 'ì£¼ì•„',
                    url: 'https://fonts.googleapis.com/css2?family=Jua&display=swap',
                    description: 'ë¶€ë“œëŸ¬ìš´ ì†ê¸€ì”¨ ìŠ¤íƒ€ì¼'
                },
                {
                    id: 'default_7',
                    name: 'ê²€ì€ í•œì‚°',
                    url: 'https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap',
                    description: 'êµµê³  ê°•ë ¬í•œ ì¸ìƒì˜ í°íŠ¸'
                },
                {
                    id: 'default_8',
                    name: 'í•´ë°”ë¼ê¸°',
                    url: 'https://fonts.googleapis.com/css2?family=Sunflower:wght@300;500;700&display=swap',
                    description: 'ë°ê³  ê²½ì¾Œí•œ ëŠë‚Œì˜ í°íŠ¸'
                },
                {
                    id: 'default_9',
                    name: 'ì—°ì„±',
                    url: 'https://fonts.googleapis.com/css2?family=Yeon+Sung&display=swap',
                    description: 'ì „í†µì ì¸ ëŠë‚Œì˜ í°íŠ¸'
                },
                {
                    id: 'default_10',
                    name: 'IBM í”Œë ‰ìŠ¤ ì‚°ìŠ¤ KR',
                    url: 'https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@100;200;300;400;500;600;700&display=swap',
                    description: 'ê¸°ì—…ìš©ìœ¼ë¡œ ì í•©í•œ ì „ë¬¸ì ì¸ í°íŠ¸'
                },
                {
                    id: 'default_11',
                    name: 'ê³ ìš´ë°”íƒ•',
                    url: 'https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap',
                    description: 'êµ¬ê¸€ í°íŠ¸ ê³ ìš´ë°”íƒ• - ê¹”ë”í•˜ê³  ê°€ë…ì„± ì¢‹ì€ í°íŠ¸'
                },
                {
                    id: 'default_12',
                    name: 'í”„ë¦¬í…ë‹¤ë“œ',
                    url: 'https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff',
                    description: 'í˜„ëŒ€ì ì´ê³  ê°€ë…ì„± ì¢‹ì€ í°íŠ¸'
                },
                {
                    id: 'default_13',
                    name: 'ì¿ í‚¤ëŸ°',
                    url: 'https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff',
                    description: 'ê·€ì—½ê³  ì•„ê¸°ìžê¸°í•œ í°íŠ¸'
                }
            ];
            
            
            defaultFonts.forEach(font => {
                if (!db.globalFontPresets.presets[font.id]) {
                    db.globalFontPresets.presets[font.id] = {
                        name: font.name,
                        url: font.url,
                        description: font.description,
                        deletable: true 
                    };
                    console.log(`ê¸°ë³¸ í°íŠ¸ í”„ë¦¬ì…‹ ì¶”ê°€ë¨: ${font.name}`);
                }
            });
            
            
            if (!db.globalFontPresets.presets[db.globalFontPresets.currentPreset]) {
                console.log('í˜„ìž¬ í”„ë¦¬ì…‹ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŒ:', db.globalFontPresets.currentPreset);
                db.globalFontPresets.currentPreset = 'custom';
                console.log('currentPresetì„ customìœ¼ë¡œ ê°•ì œ ì„¤ì •');
            }
            
            console.log('í°íŠ¸ í”„ë¦¬ì…‹ ì´ˆê¸°í™” ì™„ë£Œ - ìµœì¢… ìƒíƒœ:', {
                currentPreset: db.globalFontPresets.currentPreset,
                availablePresets: Object.keys(db.globalFontPresets.presets)
            });
        }
        
        
        
        const githubInfoButtons = IS_DEVELOPMENT_MODE ? `
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
            <button type="button" id="github-info-download-btn" class="btn btn-neutral" style="width: 100%; margin-bottom: 10px;">GitHub ì •ë³´ ë‹¤ìš´ë¡œë“œ</button>
            <button type="button" id="github-info-upload-btn" class="btn btn-secondary" style="width: 100%;">GitHub ì„¤ì • ì—…ë¡œë“œ ë³µì›</button>
            <input type="file" id="github-info-upload-input" accept=".json" style="display: none;">
        ` : '';
        
        
        const patIncludeOption = IS_DEVELOPMENT_MODE ? `
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="include-pat-in-download" checked>PAT í‚¤ë¥¼ ë‹¤ìš´ë¡œë“œì— í¬í•¨ (ê°œì¸ìš©)
                </label>
                <p style="font-size:12px; color:#888; margin-top:8px;">ì²´í¬ í•´ì œ ì‹œ PATëŠ” ì œì™¸ë©ë‹ˆë‹¤ (ë°°í¬ìš©)</p>
            </div>
        ` : '';

        document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button><div class="title-container"><h1 class="title">API ì„¤ì •</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API ê³µê¸‰ìž</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (ì‚¬ìš©ìž ì •ì˜)</option><option value="openai">OpenAI (GPT)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option><option value="openrouter">OpenRouter</option></select></div><div class="form-group"><label for="api-url">API ì£¼ì†Œ (ëì— /v1ë¥¼ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”)</label><input type="url" id="api-url" name="url" placeholder="ê³µê¸‰ìž ì„ íƒ ì‹œ ìžë™ ì™„ì„±" required></div><div class="form-group"><label for="api-key">API í‚¤ (Key)</label><div style="position: relative;"><input type="password" id="api-key" name="key" placeholder="API í‚¤ë¥¼ ìž…ë ¥í•˜ì„¸ìš”" required style="padding-right: 40px;"><button type="button" id="toggle-api-key-btn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; color: #666;">ðŸ”‘</button></div></div><button type="button" class="btn btn-secondary" style= "margin-bottom: 20px;" id="fetch-models-btn"><span class="btn-text">ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">ëª¨ë¸ ì„ íƒ</label><div class="model-search-container" style="position: relative;"><input type="text" id="model-search" placeholder="ëª¨ë¸ëª… ê²€ìƒ‰... AND: free,gpt | OR: gpt-4|claude" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 8px; font-size: 14px;"><select id="api-model" name="model" required><option value="">ë¨¼ì € ëª¨ë¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì„¸ìš”</option></select><div id="model-search-info" style="font-size: 12px; color: #888; margin-top: 5px; text-align: center;"></div></div></div><button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">ì €ìž¥</span><div class="spinner"></div></button></form><hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;"><div style="margin-bottom: 20px;"><h3 style="margin: 13px 5px; font-size: 16px;     font-weight: 500; color: var(--text-color);">ë°ì´í„° ê´€ë¦¬</h3><p style="font-size: 14px; color: #888; margin: 13px 5px 20px 5px;">ì±„íŒ… ë°ì´í„°, ìºë¦­í„°, ê·¸ë£¹ì±„íŒ…, ì„¤ì • ë“±ì„ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.</p><button type="button" class="btn btn-primary" id="backup-data-btn" style="width: 100%; margin-bottom: 10px;">ë°ì´í„° ë°±ì—… (ë‹¤ìš´ë¡œë“œ)</button><button type="button" class="btn btn-secondary" id="restore-data-btn" style="width: 100%; margin-bottom: 10px;">ë°ì´í„° ë³µì› (ì—…ë¡œë“œ)</button><hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;"><div class="github-sync-section" style="margin-bottom: 20px;"><h4 style="margin-bottom: 15px; color: var(--text-color); cursor: pointer; font-size: 14px;" id="github-sync-toggle">GitHub ë™ê¸°í™” <span style="font-size: 12px; color: #888;">â–¼</span></h4><div id="github-sync-content" style="display: none;"><div class="form-group"><label for="github-username">GitHub ì‚¬ìš©ìž ì´ë¦„</label><input type="text" id="github-username" placeholder="YourGitHubUsername"></div><div class="form-group"><label for="github-repo">ì €ìž¥ì†Œ ì´ë¦„ (Repository)</label><input type="text" id="github-repo" placeholder="my-chat-data-repo"></div><div class="form-group"><label for="github-pat">ê°œì¸ìš© ì•¡ì„¸ìŠ¤ í† í° (PAT)</label><input type="password" id="github-pat" placeholder="ghp_..."><p style="font-size:12px; color:#888; margin-top:8px; margin: 8px 5px">í† í°ì€ <a href="https://github.com/settings/tokens/new?scopes=repo&description=GeminiChatSync" target="_blank">ì—¬ê¸°</a>ì—ì„œ 'repo' ê¶Œí•œìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”. í† í°ì€ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ìž¥ë©ë‹ˆë‹¤.</p></div><div class="form-group"><label for="github-filename">íŒŒì¼ëª… (ì„ íƒì‚¬í•­)</label><input type="text" id="github-filename" value="phone-chat-data.json"></div>${patIncludeOption}<div class="form-group-checkbox"><label style="display: flex; align-items: center; gap: 10px;"><input type="checkbox" id="merge-data-on-restore" checked>ë°ì´í„° ë³µì› ì‹œ ë³‘í•© ëª¨ë“œ (ì•ˆì „)</label><p style="font-size:12px; color:#888; margin-top:8px;">ì²´í¬ ì‹œ: ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ì†ì‹¤ ì—†ìŒ) | ì²´í¬ í•´ì œ ì‹œ: ì™„ì „ ë®ì–´ì“°ê¸° (ìœ„í—˜)</p></div><div class="css-actions"><button type="button" id="save-sync-settings-btn" class="btn btn-primary" style="width: 100%;">ì„¤ì • ì €ìž¥</button><button type="button" id="sync-up-btn" class="btn btn-secondary" style="width: 100%;" disabled>ë°ì´í„° ì˜¬ë¦¬ê¸°</button><button type="button" id="sync-down-btn" class="btn btn-danger" style="width: 100%;" disabled>ë°ì´í„° ë®ì–´ì“°ê¸°</button>${githubInfoButtons}</div></div></div></div></main>`;
        document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button><div class="title-container"><h1 class="title">í™ˆ í™”ë©´ ì»¤ìŠ¤í…€</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;
        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button><div class="title-container"><h1 class="title">íŠœí† ë¦¬ì–¼</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

        
        const colorThemes = {
            'white_pink': { name: 'í°ìƒ‰/ë¶„í™', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(255,204,204,0.9)', text: '#A56767' } },
            'white_blue': { name: 'í°ìƒ‰/íŒŒëž‘', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' } },
            'white_yellow': { name: 'í°ìƒ‰/ë…¸ëž‘', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B' } },
            'white_green': { name: 'í°ìƒ‰/ì´ˆë¡', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(188,238,188,0.9)', text: '#4F784F' } },
            'white_purple': { name: 'í°ìƒ‰/ë³´ë¼', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' } },
            'black_red': { name: 'ê²€ì •/ë¹¨ê°•', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgb(226,62,87,0.9)', text: '#fff' } },
            'black_green': { name: 'ê²€ì •/ì´ˆë¡', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E' } },
            'black_white': { name: 'ê²€ì •/í°ìƒ‰', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgba(245,245,245,0.9)', text: '#333' } },
            'white_black': { name: 'í°ìƒ‰/ê²€ì •', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5' } },
            'yellow_purple': { name: 'ë…¸ëž‘/ë³´ë¼', received: { bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B' }, sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' } },
            'pink_blue': { name: 'ë¶„í™/íŒŒëž‘', received: { bg: 'rgba(255,231,240,0.9)', text: '#7C6770' }, sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' } },
        };
        const defaultIcons = {
            'chat-list-screen': { name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png' },
            'api-settings-screen': { name: 'API', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png' },
            'wallpaper-screen': { name: 'ì»¤ìŠ¤í…€', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png' },
            'world-book-screen': { name: 'ì„¸ê³„ê´€', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png' },
            'customize-screen': { name: 'í™ˆ í™”ë©´', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png' },
            'font-settings-screen': { name: 'ê¸€ê¼´', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png' },
            'tutorial-screen': { name: 'íŠœí† ë¦¬ì–¼', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png' },
            'day-mode-btn': { name: '', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png' },
            'night-mode-btn': { name: '', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png' }
        };

        let db = { characters: [], groups: [], apiSettings: {}, wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg', myStickers: [], homeScreenMode: 'night', worldBooks: [], fontUrl: '', customIcons: {}, globalCustomCSS: { enabled: true, currentPreset: 'default', presets: { 'default': { name: 'ê¸°ë³¸', css: '', description: 'ê¸°ë³¸ í…Œë§ˆ' } } }, globalFontPresets: { enabled: true, currentPreset: 'default', presets: {} }, customFontInput: { name: '', url: '', description: '' } };
        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null, isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null, currentEditingWorldBookId = null, currentStickerActionTarget = null, currentGroupAction = { type: null, recipients: [] };
        let selectedMessageIds = new Set();
        const MESSAGES_PER_PAGE = 50;

        let editingMessageContext = null; // íŽ¸ì§‘ ì»¨í…ìŠ¤íŠ¸ ì €ìž¥ìš©
const editableMessageRegexes = {
    text: /\[(?:.+?)ë‹˜ì˜ ë©”ì‹œì§€:([\s\S]+)\]/,
    voice: /\[(?:.+?)ë‹˜ì˜ ìŒì„±:([\s\S]+?)\]/,
    photoVideo: /\[(?:.+?)ë‹˜ì˜ ì‚¬ì§„\/ì˜ìƒ:([\s\S]+?)\]/,
    gift: /\[(?:.+?)ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:([\s\S]+?)\]|\[(?:.+?)ë‹˜ì´ (?:.+?)ë‹˜ì—ê²Œ ì„ ë¬¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤:([\s\S]+?)\]/,
    sticker: /\[(?:.+?)ë‹˜ì˜ ì´ëª¨í‹°ì½˜:([\s\S]+?)\]/,
    systemDisplay: /\[system-display:([\s\S]+?)\]/,
    // ì†¡ê¸ˆ ê´€ë ¨ ì •ê·œì‹ì„ í•˜ë‚˜ë¡œ í†µí•©í•˜ê³ , ì „ì²´ ë‚´ìš©ì„ ìº¡ì²˜í•˜ë„ë¡ ë³€ê²½
    transfer: /(\[(?:.*?ì—ê²Œ ì†¡ê¸ˆ|.*?ë‹˜ì˜ ì†¡ê¸ˆ|.*?ë‹˜ì´ .*?ë‹˜ì—ê²Œ ì†¡ê¸ˆ):[\d.]+ì›ï¼›ë©”ëª¨:.*?\])/
};
        
        const screens = document.querySelectorAll('.screen'), toastElement = document.getElementById('toast-notification'), homeScreen = document.getElementById('home-screen'), chatListContainer = document.getElementById('chat-list-container'), noChatsPlaceholder = document.getElementById('no-chats-placeholder'), addChatBtn = document.getElementById('add-chat-btn'), addCharModal = document.getElementById('add-char-modal'), addCharForm = document.getElementById('add-char-form'), chatRoomScreen = document.getElementById('chat-room-screen'), chatRoomHeaderDefault = document.getElementById('chat-room-header-default'), chatRoomHeaderSelect = document.getElementById('chat-room-header-select'), cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'), multiSelectTitle = document.getElementById('multi-select-title'), chatRoomTitle = document.getElementById('chat-room-title'), chatRoomStatusText = document.getElementById('chat-room-status-text'), messageArea = document.getElementById('message-area'), messageInputDefault = document.getElementById('message-input-default'), messageInput = document.getElementById('message-input'), sendMessageBtn = document.getElementById('send-message-btn'), getReplyBtn = document.getElementById('get-reply-btn'), typingIndicator = document.getElementById('typing-indicator'), chatSettingsBtn = document.getElementById('chat-settings-btn'), settingsSidebar = document.getElementById('chat-settings-sidebar'), settingsForm = document.getElementById('chat-settings-form'), messageEditBar = document.getElementById('message-edit-bar'), messageEditInput = document.getElementById('message-edit-input'), saveEditBtn = document.getElementById('save-edit-btn'), cancelEditBtn = document.getElementById('cancel-edit-btn'), multiSelectBar = document.getElementById('multi-select-bar'), selectCount = document.getElementById('select-count'), deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const stickerToggleBtn = document.getElementById('sticker-toggle-btn'), stickerModal = document.getElementById('sticker-modal'), stickerGridContainer = document.getElementById('sticker-grid-container'), addNewStickerBtn = document.getElementById('add-new-sticker-btn'), addStickerModal = document.getElementById('add-sticker-modal'), addStickerModalTitle = document.getElementById('add-sticker-modal-title'), addStickerForm = document.getElementById('add-sticker-form'), stickerEditIdInput = document.getElementById('sticker-edit-id'), stickerPreview = document.getElementById('sticker-preview'), stickerNameInput = document.getElementById('sticker-name'), stickerUrlInput = document.getElementById('sticker-url-input'), stickerFileUpload = document.getElementById('sticker-file-upload');
        const stickerActionSheet = document.getElementById('sticker-actionsheet'), editStickerBtn = document.getElementById('edit-sticker-btn'), deleteStickerBtn = document.getElementById('delete-sticker-btn');
        const voiceMessageBtn = document.getElementById('voice-message-btn'), sendVoiceModal = document.getElementById('send-voice-modal'), sendVoiceForm = document.getElementById('send-voice-form'), voiceTextInput = document.getElementById('voice-text-input'), voiceDurationPreview = document.getElementById('voice-duration-preview');
        const photoVideoBtn = document.getElementById('photo-video-btn'), sendPvModal = document.getElementById('send-pv-modal'), sendPvForm = document.getElementById('send-pv-form'), pvTextInput = document.getElementById('pv-text-input');
        const imageRecognitionBtn = document.getElementById('image-recognition-btn'), imageUploadInput = document.getElementById('image-upload-input');
        const walletBtn = document.getElementById('wallet-btn'), sendTransferModal = document.getElementById('send-transfer-modal'), sendTransferForm = document.getElementById('send-transfer-form'), transferAmountInput = document.getElementById('transfer-amount-input'), transferRemarkInput = document.getElementById('transfer-remark-input');
        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'), acceptTransferBtn = document.getElementById('accept-transfer-btn'), returnTransferBtn = document.getElementById('return-transfer-btn');
        const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'), sendGiftForm = document.getElementById('send-gift-form'), giftDescriptionInput = document.getElementById('gift-description-input');
        const timeSkipBtn = document.getElementById('time-skip-btn'), timeSkipModal = document.getElementById('time-skip-modal'), timeSkipForm = document.getElementById('time-skip-form'), timeSkipInput = document.getElementById('time-skip-input');
        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
        const worldBookListContainer = document.getElementById('world-book-list-container'), noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'), addWorldBookBtn = document.getElementById('add-world-book-btn'), editWorldBookScreen = document.getElementById('edit-world-book-screen'), editWorldBookForm = document.getElementById('edit-world-book-form'), worldBookIdInput = document.getElementById('world-book-id'), worldBookNameInput = document.getElementById('world-book-name'), worldBookContentInput = document.getElementById('world-book-content');
        const linkWorldBookBtn = document.getElementById('link-world-book-btn'), worldBookSelectionModal = document.getElementById('world-book-selection-modal'), worldBookSelectionList = document.getElementById('world-book-selection-list'), saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
        const fontSettingsForm = document.getElementById('font-settings-form'), fontUrlInput = document.getElementById('font-url'), restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
        const createGroupBtn = document.getElementById('create-group-btn'), createGroupModal = document.getElementById('create-group-modal'), createGroupForm = document.getElementById('create-group-form'), memberSelectionList = document.getElementById('member-selection-list'), groupNameInput = document.getElementById('group-name-input'), groupSettingsSidebar = document.getElementById('group-settings-sidebar'), groupSettingsForm = document.getElementById('group-settings-form'), groupMembersListContainer = document.getElementById('group-members-list-container'), editGroupMemberModal = document.getElementById('edit-group-member-modal'), editGroupMemberForm = document.getElementById('edit-group-member-form');
        const addMemberActionSheet = document.getElementById('add-member-actionsheet'), inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'), createNewMemberBtn = document.getElementById('create-new-member-btn'), inviteMemberModal = document.getElementById('invite-member-modal'), inviteMemberSelectionList = document.getElementById('invite-member-selection-list'), confirmInviteBtn = document.getElementById('confirm-invite-btn'), createMemberForGroupModal = document.getElementById('create-member-for-group-modal'), createMemberForGroupForm = document.getElementById('create-member-for-group-form');
        const customizeForm = document.getElementById('customize-form'), tutorialContentArea = document.getElementById('tutorial-content-area');
        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'), groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'), confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'), groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');
        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');
        const attachmentToggleBtn = document.getElementById('attachment-toggle-btn');
        const stickerBar = document.getElementById('sticker-bar');
        const textarea = document.querySelector('.message-input-area textarea');
        
        const saveData = () => localStorage.setItem('gemini-chat-app-db', JSON.stringify(db));
        const loadData = () => {
            const data = localStorage.getItem('gemini-chat-app-db');
            if (data) db = JSON.parse(data);
            
            if (!db.apiSettings) db.apiSettings = {};
            if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
            if (!db.characters) db.characters = [];
            if (!db.groups) db.groups = [];
            if (!db.myStickers) db.myStickers = [];
            if (!db.homeScreenMode) db.homeScreenMode = 'night';
            if (!db.worldBooks) db.worldBooks = [];
            
            if (!db.customIcons) db.customIcons = {};
            if (!db.globalCustomCSS) db.globalCustomCSS = { enabled: true, currentPreset: 'default', presets: { 'default': { name: 'ê¸°ë³¸', css: '', description: 'ê¸°ë³¸ í…Œë§ˆ' } } };
            if (!db.globalFontPresets) db.globalFontPresets = { enabled: true, currentPreset: 'custom', presets: {} };

            if (!db.globalSettings) {
                db.globalSettings = {
                    aiCanUseSystem: false,
                    hideUserIcons: false,
                    hideCharacterIcons: false
                };
            }
            
            if (db.globalFontPresets.currentPreset === 'default' || !db.globalFontPresets.currentPreset) {
                db.globalFontPresets.currentPreset = 'custom';
                console.log('ìž˜ëª»ëœ currentPresetì„ customìœ¼ë¡œ ìˆ˜ì •í•¨');
            }
            
            initializeFontPresets();
            db.characters.forEach(c => {
                if (c.isPinned === undefined) c.isPinned = false;
                if (c.status === undefined) c.status = 'ì˜¨ë¼ì¸';
                if (!c.worldBookIds) c.worldBookIds = [];
                if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
                if (c.hideMyIcons === undefined) c.hideMyIcons = false; // ì´ë¦„ ë³€ê²½
                if (c.hideCharIcons === undefined) c.hideCharIcons = false; // ì´ë¦„ ë³€ê²½
                if (c.fontSize === undefined) c.fontSize = 14;
            });
            db.groups.forEach(g => {
                if (g.isPinned === undefined) g.isPinned = false;
                if (!g.worldBookIds) g.worldBookIds = [];
                if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
                if (g.hideMyIcons === undefined) g.hideMyIcons = false; // ì´ë¦„ ë³€ê²½
                if (g.hideCharIcons === undefined) g.hideCharIcons = false; // ì´ë¦„ ë³€ê²½
                if (g.fontSize === undefined) g.fontSize = 14;
            });
        };
        const showToast = (message) => {
            toastElement.textContent = message;
            toastElement.classList.add('show');
            setTimeout(() => toastElement.classList.remove('show'), 3000);
        };
        
                // ê¸°ì¡´ switchScreen í•¨ìˆ˜ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´
        const switchScreen = (targetId) => {
            const phoneScreen = document.querySelector('.phone-screen');
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');

            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
            overlays.forEach(o => o.classList.remove('visible', 'open'));
            
            const navBar = document.getElementById('bottom-nav-bar');
            const screensWithNav = ['chat-list-screen', 'feed-screen', 'schedule-screen'];
            
            if (screensWithNav.includes(targetId)) {
                navBar.style.display = 'flex';
                phoneScreen.classList.add('has-bottom-nav'); // í´ëž˜ìŠ¤ ì¶”ê°€
                const navButtons = navBar.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.target === targetId);
                });
            } else {
                navBar.style.display = 'none';
                phoneScreen.classList.remove('has-bottom-nav'); // í´ëž˜ìŠ¤ ì œê±°
            }
        };

        const pad = (num) => num.toString().padStart(2, '0');

        function createContextMenu(items, x, y) {
            removeContextMenu();
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                if (item.danger) menuItem.classList.add('danger');
                menuItem.textContent = item.label;
                menuItem.onclick = () => {
                    item.action();
                    removeContextMenu();
                };
                menu.appendChild(menuItem);
            });
            document.body.appendChild(menu);
            document.addEventListener('click', removeContextMenu, { once: true });
        }

        function removeContextMenu() {
            const menu = document.querySelector('.context-menu');
            if (menu) menu.remove();
        }

        function updateCustomBubbleStyle(chatId, css, enabled) {
            const styleId = `custom-bubble-style-for-${chatId}`;
            let styleElement = document.getElementById(styleId);

            if (enabled && css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);
                styleElement.innerHTML = scopedCss;
            } else {
                if (styleElement) styleElement.remove();
            }
        }

        
        function applyGlobalCustomCSS() {
            if (!db.globalCustomCSS.enabled) {
                return;
            }
            const preset = db.globalCustomCSS.presets[db.globalCustomCSS.currentPreset];
            if (!preset || !preset.css) {
                return;
            }
            let styleElement = document.getElementById('global-custom-style');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'global-custom-style';
                document.head.appendChild(styleElement);
            }
            styleElement.innerHTML = preset.css;
        }

        function removeGlobalCustomCSS() {
            const styleElement = document.getElementById('global-custom-style');
            if (styleElement) {
                styleElement.remove();
            }
        }

        function updateGlobalCustomCSS() {
            if (db.globalCustomCSS.enabled) {
                applyGlobalCustomCSS();
            } else {
                removeGlobalCustomCSS();
            }
        }

// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” ---
function updateBubbleCssPreview(previewContainer, css, useDefault, theme, fontSize = 14) {
    previewContainer.innerHTML = '';

    const sentBubble = document.createElement('div');
    sentBubble.className = 'message-bubble sent';
    sentBubble.textContent = 'ì´ê²ƒì€ ë‚´ ë§í’ì„ ìž…ë‹ˆë‹¤.';
    sentBubble.style.alignSelf = 'flex-end';
    
    const receivedBubble = document.createElement('div');
    receivedBubble.className = 'message-bubble received';
    receivedBubble.textContent = 'ì´ê²ƒì€ ìƒëŒ€ë°© ë§í’ì„ ìž…ë‹ˆë‹¤.';
    receivedBubble.style.alignSelf = 'flex-start';

    [sentBubble, receivedBubble].forEach(bubble => {
        bubble.style.maxWidth = '70%';
        bubble.style.padding = '8px 12px';
        bubble.style.wordWrap = 'break-word';
        bubble.style.lineHeight = '1.4';
        bubble.style.fontSize = `${fontSize}px`; // í°íŠ¸ í¬ê¸° ì ìš©
        bubble.style.borderRadius = '18px';
    });

    sentBubble.style.borderBottomRightRadius = '5px';
    receivedBubble.style.borderBottomLeftRadius = '5px';

    if (useDefault || !css) {
        sentBubble.style.backgroundColor = theme.sent.bg;
        sentBubble.style.color = theme.sent.text;
        receivedBubble.style.backgroundColor = theme.received.bg;
        receivedBubble.style.color = theme.received.text;
    } else {
        const styleTag = document.createElement('style');
        const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
        styleTag.textContent = scopedCss;
        previewContainer.appendChild(styleTag);
    }
    previewContainer.appendChild(receivedBubble);
    previewContainer.appendChild(sentBubble);
}
// --- END: í•¨ìˆ˜ êµì²´ ---
function setupGitHubSync() {
    const usernameInput = document.getElementById('github-username');
    const repoInput = document.getElementById('github-repo');
    const patInput = document.getElementById('github-pat');
    const filenameInput = document.getElementById('github-filename');
    const saveBtn = document.getElementById('save-sync-settings-btn');
    const syncUpBtn = document.getElementById('sync-up-btn');
    const syncDownBtn = document.getElementById('sync-down-btn');
    
    const githubInfoDownloadBtn = document.getElementById('github-info-download-btn');
    const githubInfoUploadBtn = document.getElementById('github-info-upload-btn');
    const githubInfoUploadInput = document.getElementById('github-info-upload-input');
    const githubSyncToggle = document.getElementById('github-sync-toggle');
    const githubSyncContent = document.getElementById('github-sync-content');

    
    const savedSettings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
    if (savedSettings) {
        usernameInput.value = savedSettings.username || '';
        repoInput.value = savedSettings.repo || '';
        patInput.value = savedSettings.pat || '';
        filenameInput.value = savedSettings.filename || 'phone-chat-data.json';
        
        
        const includePatCheckbox = document.getElementById('include-pat-in-download');
        if (includePatCheckbox) {
            includePatCheckbox.checked = savedSettings.includePatInDownload !== false;
            console.log('ðŸ”§ DEBUG: PAT í¬í•¨ ì˜µì…˜ ë³µì›ë¨:', includePatCheckbox.checked);
        } else if (!IS_DEVELOPMENT_MODE) {
            console.log('ðŸ”§ DEBUG: PAT í¬í•¨ ì˜µì…˜ ë¹„í™œì„±í™”ë¨ (ë°°í¬ ëª¨ë“œ)');
        }

        
        const mergeDataCheckbox = document.getElementById('merge-data-on-restore');
        if (mergeDataCheckbox) {
            mergeDataCheckbox.checked = savedSettings.mergeDataOnRestore !== false;
        }
        
        updateSyncButtonsState();
        console.log('GitHub ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:', { 
            username: savedSettings.username, 
            repo: savedSettings.repo, 
            pat: savedSettings.pat ? '***' : 'ì—†ìŒ',
            includePatInDownload: savedSettings.includePatInDownload !== false
        });
    }

    
    function updateSyncButtonsState() {
        const settings = {
            username: usernameInput.value.trim(),
            repo: repoInput.value.trim(),
            pat: patInput.value.trim(),
        };
        if (settings.username && settings.repo && settings.pat) {
            syncUpBtn.disabled = false;
            syncDownBtn.disabled = false;
        } else {
            syncUpBtn.disabled = true;
            syncDownBtn.disabled = true;
        }
    }

    saveBtn.addEventListener('click', () => {
        const includePatCheckbox = document.getElementById('include-pat-in-download');
        const mergeDataCheckbox = document.getElementById('merge-data-on-restore');
        const settings = {
            username: usernameInput.value.trim(),
            repo: repoInput.value.trim(),
            pat: patInput.value.trim(),
            filename: filenameInput.value.trim() || 'phone-chat-data.json',
            includePatInDownload: includePatCheckbox ? includePatCheckbox.checked : !IS_DEVELOPMENT_MODE ? false : true,
            mergeDataOnRestore: mergeDataCheckbox ? mergeDataCheckbox.checked : true
        };
        localStorage.setItem('gemini-chat-sync-settings', JSON.stringify(settings));
        showToast('GitHub ë™ê¸°í™” ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        updateSyncButtonsState();
        console.log('GitHub ì„¤ì • ì €ìž¥ ì™„ë£Œ:', { ...settings, pat: settings.pat ? '***' : 'ì—†ìŒ' });
    });

    
    githubSyncToggle.addEventListener('click', () => {
        const isHidden = githubSyncContent.style.display === 'none';
        githubSyncContent.style.display = isHidden ? 'block' : 'none';
        
        
        const arrow = githubSyncToggle.querySelector('span');
        arrow.textContent = isHidden ? 'â–²' : 'â–¼';
        
        console.log('GitHub ë™ê¸°í™” ì„¹ì…˜ í† ê¸€:', isHidden ? 'íŽ¼ì¹¨' : 'ì ‘ìŒ');
    });



    
    if (IS_DEVELOPMENT_MODE && githubInfoDownloadBtn) {
        console.log('ðŸ”§ DEBUG: GitHub ì •ë³´ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ í™œì„±í™”ë¨ (ê°œë°œ ëª¨ë“œ)');
        githubInfoDownloadBtn.addEventListener('click', () => {
            const settings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
            if (!settings || !settings.username || !settings.repo) {
                showToast('GitHub ì„¤ì •ì„ ë¨¼ì € ì €ìž¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const includePatCheckbox = document.getElementById('include-pat-in-download');
            
            const includePat = includePatCheckbox ? includePatCheckbox.checked : !IS_DEVELOPMENT_MODE ? false : true;

            const githubInfo = {
                username: settings.username,
                repository: settings.repo,
                filename: settings.filename || 'phone-chat-data.json',
                lastUpdated: new Date().toISOString(),
                note: includePat ? 'ì´ íŒŒì¼ì€ GitHub ë™ê¸°í™” ì„¤ì • ì •ë³´ìž…ë‹ˆë‹¤. (ê°œì¸ìš© - PAT í¬í•¨)' : 'ì´ íŒŒì¼ì€ GitHub ë™ê¸°í™” ì„¤ì • ì •ë³´ìž…ë‹ˆë‹¤. (ë°°í¬ìš© - PAT ì œì™¸)'
            };

            if (includePat && settings.pat) {
                githubInfo.pat = settings.pat;
            }

            const blob = new Blob([JSON.stringify(githubInfo, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `github-sync-info-${settings.username}-${settings.repo}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(includePat ? 'GitHub ì •ë³´ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (PAT í¬í•¨)' : 'GitHub ì •ë³´ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (PAT ì œì™¸)');
        });
    } else if (!IS_DEVELOPMENT_MODE) {
        console.log('ðŸ”§ DEBUG: GitHub ì •ë³´ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨ (ë°°í¬ ëª¨ë“œ)');
    }

    
    if (IS_DEVELOPMENT_MODE && githubInfoUploadBtn && githubInfoUploadInput) {
        console.log('ðŸ”§ DEBUG: GitHub ì •ë³´ ì—…ë¡œë“œ ê¸°ëŠ¥ í™œì„±í™”ë¨ (ê°œë°œ ëª¨ë“œ)');
        githubInfoUploadBtn.addEventListener('click', () => {
            githubInfoUploadInput.click();
        });

        githubInfoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showToast('âŒ JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const githubSettings = JSON.parse(event.target.result);
                    
                    if (!githubSettings.username || !githubSettings.repository) {
                        showToast('âŒ ì˜¬ë°”ë¥¸ GitHub ì„¤ì • íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤. (username, repository í•„ìˆ˜)');
                        return;
                    }

                    
                    usernameInput.value = githubSettings.username || '';
                    repoInput.value = githubSettings.repository || '';
                    patInput.value = githubSettings.pat || '';
                    filenameInput.value = githubSettings.filename || 'phone-chat-data.json';

                    
                    const includePatCheckbox = document.getElementById('include-pat-in-download');
                    if (includePatCheckbox) {
                        includePatCheckbox.checked = !!githubSettings.pat;
                    }

                    
                    const settings = {
                        username: githubSettings.username,
                        repo: githubSettings.repository,
                        pat: githubSettings.pat || '',
                        filename: githubSettings.filename || 'phone-chat-data.json',
                        includePatInDownload: !!githubSettings.pat
                    };
                    localStorage.setItem('gemini-chat-sync-settings', JSON.stringify(settings));
                    
                    
                    updateSyncButtonsState();
                    
                    showToast('âœ… GitHub ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!');

                } catch (error) {
                    showToast('âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };

            reader.onerror = () => {
                showToast('âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };

            reader.readAsText(file);
        });
    } else if (!IS_DEVELOPMENT_MODE) {
        console.log('ðŸ”§ DEBUG: GitHub ì •ë³´ ì—…ë¡œë“œ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨ (ë°°í¬ ëª¨ë“œ)');
    }

    
    syncUpBtn.addEventListener('click', syncUp);
    syncDownBtn.addEventListener('click', syncDown);
}


function deepMerge(existing, incoming) {
    if (incoming === null || incoming === undefined) {
        return existing;
    }
    
    if (existing === null || existing === undefined) {
        return incoming;
    }
    
    
    if (Array.isArray(incoming)) {
        if (Array.isArray(existing)) {
            return mergeArrays(existing, incoming);
        } else {
            return incoming;
        }
    }
    
    
    if (typeof incoming !== 'object') {
        if (existing !== null && existing !== undefined) {
            return existing; 
        }
        return incoming;
    }
    
    
    const result = { ...existing };
    
    for (const key in incoming) {
        if (incoming.hasOwnProperty(key)) {
            if (existing && existing.hasOwnProperty(key)) {
                result[key] = deepMerge(existing[key], incoming[key]);
            } else {
                result[key] = incoming[key];
            }
        }
    }
    
    return result;
}


function mergeArrays(existingArray, incomingArray) {
    const result = [...existingArray];
    const existingIds = new Set();
    
    
    existingArray.forEach((item, index) => {
        const id = item.id || item.name || item.timestamp || item.chatId || index;
        existingIds.add(id);
    });
    
    
    let addedCount = 0;
    incomingArray.forEach((item, index) => {
        const id = item.id || item.name || item.timestamp || item.chatId || index;
        
        if (!existingIds.has(id)) {
            result.push(item);
            existingIds.add(id);
            addedCount++;
        }
    });
    
    if (addedCount > 0) {
        console.log(`ë°°ì—´ ë³‘í•© ì™„ë£Œ: ${addedCount}ê°œ í•­ëª© ì¶”ê°€ (${existingArray.length} â†’ ${result.length})`);
    }
    
    return result;
}


async function syncUp() {
    if (!confirm('í˜„ìž¬ ê¸°ê¸°ì˜ ë°ì´í„°ë¥¼ GitHubì— ì˜¬ë ¤ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë°›ì„ ìˆ˜ ìžˆë„ë¡ í•©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const settings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
    if (!settings) return showToast('ë™ê¸°í™” ì„¤ì •ì„ ë¨¼ì € ì €ìž¥í•´ì£¼ì„¸ìš”.');

    const { username, repo, pat, filename } = settings;
    const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filename}`;
    
    const localDataString = localStorage.getItem('gemini-chat-app-db');
    if (!localDataString) return showToast('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    
    
    let dataToUpload = JSON.parse(localDataString);
    if (dataToUpload.apiSettings) {
        delete dataToUpload.apiSettings;
    }
    
    const cleanDataString = JSON.stringify(dataToUpload);
    const contentBase64 = btoa(unescape(encodeURIComponent(cleanDataString)));

    showToast('ë°ì´í„° ì—…ë¡œë“œ ì¤‘...');

    try {
        
        let fileSha = null;
        try {
            const getFileResponse = await fetch(apiUrl, {
                headers: { 'Authorization': `token ${pat}` }
            });
            if (getFileResponse.ok) {
                const fileData = await getFileResponse.json();
                fileSha = fileData.sha;
            }
        } catch (e) {  }

        
        const payload = {
            message: `Sync data from Gemini Chat on ${new Date().toISOString()}`,
            content: contentBase64,
            sha: fileSha 
        };

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${pat}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = errorData.message ? `${errorData.message} (GitHub)` : 'Unknown error';
            throw new Error(errorMessage);
        }

        showToast('âœ… ë°ì´í„° ì—…ë¡œë“œ ì„±ê³µ!');
    } catch (error) {
        console.error('Sync Up Error:', error);
        showToast(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    }
}
async function syncDown() {
    const settings = JSON.parse(localStorage.getItem('gemini-chat-sync-settings'));
    if (!settings) return showToast('ë™ê¸°í™” ì„¤ì •ì„ ë¨¼ì € ì €ìž¥í•´ì£¼ì„¸ìš”.');
    
    
    const mergeCheckbox = document.getElementById('merge-data-on-restore');
    const useMergeMode = mergeCheckbox ? mergeCheckbox.checked : true;
    const modeText = useMergeMode ? 'ë³‘í•© (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´)' : 'ì™„ì „ ë®ì–´ì“°ê¸° (ê¸°ì¡´ ë°ì´í„° ì‚­ì œ)';
    
    console.log('ë°ì´í„° ë³µì› ëª¨ë“œ:', useMergeMode ? 'MERGE' : 'REPLACE');
    
    if (!confirm(`GitHubì˜ ë°ì´í„°ë¥¼ í˜„ìž¬ ê¸°ê¸°ì— ë³µì›í•©ë‹ˆë‹¤.\n\nëª¨ë“œ: ${modeText}\n\n${useMergeMode ? 'ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©ë˜ì–´ ë°ì´í„° ì†ì‹¤ì´ ì—†ìŠµë‹ˆë‹¤.' : 'í˜„ìž¬ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤! (API ì„¤ì •ì€ ìœ ì§€)'}\n\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    const { username, repo, pat, filename } = settings;
    const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filename}`;

    showToast(`ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘... (${useMergeMode ? 'ë³‘í•© ëª¨ë“œ' : 'ë®ì–´ì“°ê¸° ëª¨ë“œ'})`);

    try {
        
        const localDbString = localStorage.getItem('gemini-chat-app-db');
        const localDb = localDbString ? JSON.parse(localDbString) : {};
        const localApiSettings = localDb.apiSettings;
        
        
        const backupKey = 'gemini-chat-app-db-emergency-backup';
        localStorage.setItem(backupKey, localDbString || '{}');

        
        const response = await fetch(apiUrl, {
            headers: { 'Authorization': `token ${pat}` }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'File not found');
        }

        const data = await response.json();
        const contentBase64 = data.content;
        
        
        let downloadedJsonData, downloadedDb;
        
        try {
            downloadedJsonData = decodeURIComponent(escape(atob(contentBase64)));
            downloadedDb = JSON.parse(downloadedJsonData);
            
            if (!downloadedDb || typeof downloadedDb !== 'object') {
                throw new Error('ë‹¤ìš´ë¡œë“œí•œ ë°ì´í„°ê°€ ì˜¬ë°”ë¥¸ ê°ì²´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
            }
            
        } catch (parseError) {
            throw new Error(`ë‹¤ìš´ë¡œë“œí•œ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤: ${parseError.message}`);
        }

        
        let finalDb;
        if (useMergeMode) {
            finalDb = deepMerge(localDb, downloadedDb);
        } else {
            finalDb = downloadedDb;
        }

        
        if (localApiSettings) {
            finalDb.apiSettings = localApiSettings;
        }

        
        try {
            const finalDbString = JSON.stringify(finalDb);
            
            if (!finalDbString || finalDbString === '{}' || finalDbString === 'null') {
                throw new Error('ìµœì¢… ë°ì´í„°ê°€ ë¹„ì–´ìžˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            
            localStorage.setItem('gemini-chat-app-db', finalDbString);
            
            const savedData = localStorage.getItem('gemini-chat-app-db');
            if (!savedData) {
                throw new Error('ë°ì´í„° ì €ìž¥ í›„ ê²€ì¦ ì‹¤íŒ¨ - localStorageì— ì €ìž¥ë˜ì§€ ì•ŠìŒ');
            }
            
            
            localStorage.removeItem(backupKey);
            
            showToast(`âœ… ë°ì´í„° ë³µì› ì„±ê³µ! (${useMergeMode ? 'ë³‘í•© ì™„ë£Œ' : 'ë®ì–´ì“°ê¸° ì™„ë£Œ'}) ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
            
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } catch (saveError) {
            throw new Error(`ë°ì´í„° ì €ìž¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${saveError.message}`);
        }

    } catch (error) {
        console.error('Sync Down Error:', error);
        
        
        const backupKey = 'gemini-chat-app-db-emergency-backup';
        const emergencyBackup = localStorage.getItem(backupKey);
        
        if (emergencyBackup) {
            try {
                localStorage.setItem('gemini-chat-app-db', emergencyBackup);
                localStorage.removeItem(backupKey);
                showToast(`âŒ ë³µì› ì‹¤íŒ¨í–ˆì§€ë§Œ ê¸°ì¡´ ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë³´í˜¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${error.message}`);
            } catch (restoreError) {
                showToast(`âŒâŒ ì‹¬ê°í•œ ì˜¤ë¥˜: ë°ì´í„° ë³µì›ê³¼ ë°±ì—… ë³µêµ¬ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!\nì›ë³¸ ì˜¤ë¥˜: ${error.message}\në³µêµ¬ ì˜¤ë¥˜: ${restoreError.message}`);
            }
        } else {
            showToast(`âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        }
    }
}

// START: ì¶”ê°€í•  ìƒˆ í•¨ìˆ˜ë“¤

function applyGlobalUISettings() {
    const phoneScreen = document.querySelector('.phone-screen');
    phoneScreen.classList.toggle('hide-user-icons', !!db.globalSettings.hideUserIcons);
    phoneScreen.classList.toggle('hide-character-icons', !!db.globalSettings.hideCharacterIcons);
}

function setupSettingsScreen() {
    const aiSystemToggle = document.getElementById('ai-can-use-system-toggle');
    const hideUserIconsToggle = document.getElementById('hide-user-icons-toggle');
    const hideCharIconsToggle = document.getElementById('hide-character-icons-toggle');

    // ì„¤ì • ê°’ ë¶ˆëŸ¬ì™€ì„œ í† ê¸€ì— ë°˜ì˜
    aiSystemToggle.checked = !!db.globalSettings.aiCanUseSystem;
    hideUserIconsToggle.checked = !!db.globalSettings.hideUserIcons;
    hideCharIconsToggle.checked = !!db.globalSettings.hideCharacterIcons;

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    aiSystemToggle.addEventListener('change', () => {
        db.globalSettings.aiCanUseSystem = aiSystemToggle.checked;
        saveData();
        showToast(`AI ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì‚¬ìš©ì´ ${aiSystemToggle.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });

    hideUserIconsToggle.addEventListener('change', () => {
        db.globalSettings.hideUserIcons = hideUserIconsToggle.checked;
        saveData();
        applyGlobalUISettings();
        showToast(`ìœ ì € ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°ê°€ ${hideUserIconsToggle.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });

    hideCharIconsToggle.addEventListener('change', () => {
        db.globalSettings.hideCharacterIcons = hideCharIconsToggle.checked;
        saveData();
        applyGlobalUISettings();
        showToast(`ìºë¦­í„° ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°ê°€ ${hideCharIconsToggle.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });
}
// END: ì¶”ê°€í•  ìƒˆ í•¨ìˆ˜ë“¤

// ê¸°ì¡´ applyPerChatUISettings í•¨ìˆ˜ë¥¼ ì°¾ì•„ ì•„ëž˜ ì½”ë“œë¡œ ì „ì²´ êµì²´í•˜ì„¸ìš”.

function applyPerChatUISettings() {
    const chat = (currentChatType === 'private') 
        ? db.characters.find(c => c.id === currentChatId) 
        : db.groups.find(g => g.id === currentChatId);

    if (!chat) return;

    // í´ëž˜ìŠ¤ ì´ë¦„ ë³€ê²½
    chatRoomScreen.classList.toggle('hide-my-icons', !!chat.hideMyIcons);
    chatRoomScreen.classList.toggle('hide-char-icons', !!chat.hideCharIcons);

    // í°íŠ¸ í¬ê¸° ì ìš© (ì´ ë¶€ë¶„ì´ ì¤‘ìš”í•©ë‹ˆë‹¤)
    const fontSize = chat.fontSize || 14;
    const messageArea = document.getElementById('message-area');
    if (messageArea) {
        messageArea.style.setProperty('--bubble-font-size', `${fontSize}px`);
    }
}

        const init = () => {
            loadData();
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.context-menu')) {
                    e.stopPropagation();
                    return;
                }
                removeContextMenu();

                const backBtn = e.target.closest('.back-btn');
                if (backBtn) {
                    e.preventDefault();
                    switchScreen(backBtn.getAttribute('data-target'));
                    const currentScreen = e.target.closest('.screen');
                    if (currentScreen && currentScreen.id === 'chat-room-screen') {
                        currentChatId = null;
                        currentChatType = null;
                    }
                }

                
                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                if (openOverlay && e.target === openOverlay) {
                    openOverlay.classList.remove('visible');
                }
            });

            
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.app-icon[data-target]');
                if (navLink) {
                    e.preventDefault();
                    switchScreen(navLink.getAttribute('data-target'));
                }
            });

            updateClock();
            setInterval(updateClock, 30000);
            
            const currentPresetKey = db.globalFontPresets.currentPreset;
            const currentPreset = db.globalFontPresets.presets[currentPresetKey];
            console.log('ì•± ì´ˆê¸°í™” - í°íŠ¸ ì ìš©:', { 
                currentPresetKey: currentPresetKey, 
                currentPreset: currentPreset,
                allPresets: Object.keys(db.globalFontPresets.presets)
            });
            
            if (currentPreset && currentPreset.url) {
                applyGlobalFont(currentPreset.url);
                console.log('ì•± ì´ˆê¸°í™” ì‹œ í°íŠ¸ ì ìš©:', currentPreset.name, currentPreset.url);
            } else {
                applyGlobalFont(''); 
                console.log('ê¸°ë³¸ í°íŠ¸ë¡œ ì´ˆê¸°í™” (í˜„ìž¬ í”„ë¦¬ì…‹:', currentPresetKey, ')');
            }
            updateGlobalCustomCSS(); 
            applyGlobalUISettings(); 
            setupHomeScreen();
            setupChatListScreen();
            setupAddCharModal();
            setupChatRoom();
            setupChatSettings();
            setupApiSettingsApp();
            setupWallpaperApp();
            setupStickerSystem();
            setupVoiceMessageSystem();
            setupPhotoVideoSystem();
            setupWalletSystem();
            setupGiftSystem();
            setupTimeSkipSystem();
            setupWorldBookApp();
            setupFontSettingsApp();
            setupSettingsScreen(); 
            setupGroupChatSystem();
            setupCustomizeApp();
            setupTutorialApp();
			setupGitHubSync();
            setupBottomNav();
            setupFeedScreen();
        };

        function updateClock() {
            const now = new Date();
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}ë…„ ${pad(now.getMonth() + 1)}ì›” ${pad(now.getDate())}ì¼`;
        }

        
        function setupHomeScreen() {
            const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
            const homeScreenHTML = `
            <div class="time-widget"><div class="time" id="time-display"></div><div class="date" id="date-display"></div></div>
            <div class="app-grid">
                <a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="wallpaper-font-screen"><img src="${getIcon('wallpaper-screen')}" alt="ì»¤ìŠ¤í…€" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="ì„¸ê³„ê´€" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="í™ˆ í™”ë©´" class="icon-img"><span class="app-name">${defaultIcons['customize-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="íŠœí† ë¦¬ì–¼" class="icon-img"><span class="app-name">${defaultIcons['tutorial-screen'].name}</span></a>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="ì£¼ê°„" class="icon-img"></a>
                <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="ì•¼ê°„" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="settings-screen"><img src="${getIcon('font-settings-screen')}" alt="ì„¤ì •" class="icon-img"><span class="app-name"></span></a>
            </div>`;
            homeScreen.innerHTML = homeScreenHTML;
            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            document.getElementById('day-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('day'); });
            document.getElementById('night-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('night'); });
            document.querySelector('[data-target="wallpaper-font-screen"]').addEventListener('click', () => {
    // wallpaper-font-screenìœ¼ë¡œ ì „í™˜ë  ë•Œ íŠ¹ë³„ížˆ ì‹¤í–‰í•  ë¡œì§ì´ ìžˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
});
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
        }

        function applyWallpaper(url) { homeScreen.style.backgroundImage = `url(${url})`; }

        function applyHomeScreenMode(mode) {
            if (mode === 'day') { homeScreen.classList.add('day-mode'); }
            else { homeScreen.classList.remove('day-mode'); }
            db.homeScreenMode = mode;
            saveData();
        }

        function setupCustomizeApp() {
            customizeForm.addEventListener('input', e => {
                if (e.target.matches('input[type="url"]')) {
                    const iconId = e.target.dataset.id;
                    const newUrl = e.target.value.trim();
                    const previewImg = document.getElementById(`icon-preview-${iconId}`);
                    if (newUrl) {
                        db.customIcons[iconId] = newUrl;
                        previewImg.src = newUrl;
                        saveData();
                        setupHomeScreen();
                    }
                }
            });
            customizeForm.addEventListener('click', e => {
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.id;
                    delete db.customIcons[iconId];
                    saveData();
                    renderCustomizeForm();
                    setupHomeScreen();
                    showToast('ì•„ì´ì½˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });

            
            customizeForm.addEventListener('change', e => {
                
                if (e.target.matches('#global-css-toggle')) {
                    db.globalCustomCSS.enabled = e.target.checked;
                    updateGlobalCustomCSS();
                    saveData();
                    showToast(e.target.checked ? 'ì „ì—­ ì»¤ìŠ¤í…€ CSSê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì „ì—­ ì»¤ìŠ¤í…€ CSSê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
                
                
                if (e.target.matches('#css-preset-select')) {
                    const newPreset = e.target.value;
                    db.globalCustomCSS.currentPreset = newPreset;
                    
                    
                    const cssInput = document.getElementById('css-input');
                    if (cssInput) {
                        cssInput.value = db.globalCustomCSS.presets[newPreset].css;
                    }
                    
                    
                    if (db.globalCustomCSS.enabled) {
                        updateGlobalCustomCSS();
                    }
                    saveData();
                    showToast(`"${db.globalCustomCSS.presets[newPreset].name}" í”„ë¦¬ì…‹ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`);
                }
            });

            customizeForm.addEventListener('click', e => {
                
                if (e.target.matches('#save-css-btn')) {
                    console.log('CSS ì €ìž¥ ë²„íŠ¼ í´ë¦­');
                    const cssInput = document.getElementById('css-input');
                    const currentPreset = db.globalCustomCSS.currentPreset;
                    
                    if (cssInput && cssInput.value.trim()) {
                        db.globalCustomCSS.presets[currentPreset].css = cssInput.value.trim();
                        saveData();
                        
                        if (db.globalCustomCSS.enabled) {
                            updateGlobalCustomCSS();
                        }
                        showToast('CSSê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                    } else {
                        showToast('CSS ì½”ë“œë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”');
                    }
                }
                
                
                if (e.target.matches('#new-preset-btn')) {
                    console.log('ìƒˆ í”„ë¦¬ì…‹ ë²„íŠ¼ í´ë¦­');
                    const presetName = prompt('ìƒˆ í”„ë¦¬ì…‹ì˜ ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”:');
                    if (presetName && presetName.trim()) {
                        const presetKey = 'preset-' + Date.now();
                        db.globalCustomCSS.presets[presetKey] = {
                            name: presetName.trim(),
                            css: '',
                            description: 'ì‚¬ìš©ìž ì •ì˜ í”„ë¦¬ì…‹'
                        };
                        db.globalCustomCSS.currentPreset = presetKey;
                        saveData();
                        renderCustomizeForm();
                        showToast(`"${presetName}" í”„ë¦¬ì…‹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`);
                    }
                }
                
                
                if (e.target.matches('#delete-preset-btn')) {
                    console.log('í”„ë¦¬ì…‹ ì‚­ì œ ë²„íŠ¼ í´ë¦­');
                    const currentPreset = db.globalCustomCSS.currentPreset;
                    if (currentPreset !== 'default') {
                        const presetName = db.globalCustomCSS.presets[currentPreset].name;
                        if (confirm(`"${presetName}" í”„ë¦¬ì…‹ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            delete db.globalCustomCSS.presets[currentPreset];
                            db.globalCustomCSS.currentPreset = 'default';
                            saveData();
                            renderCustomizeForm();
                            updateGlobalCustomCSS();
                            showToast('í”„ë¦¬ì…‹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                        }
                    }
                }
            });
        }

        function renderCustomizeForm() {
            customizeForm.innerHTML = '';
            
            
            const iconSectionHTML = `
                <div class="customize-section">
                    <h3 class="section-title">í™ˆ í™”ë©´ ì•„ì´ì½˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h3>
                    <div class="section-content">
                        ${Object.entries(defaultIcons).map(([id, { name, url }]) => {
                            const currentIcon = db.customIcons[id] || url;
                            return `
                            <div class="icon-custom-item">
                                <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                                <div class="icon-details">
                                    <p>${name || 'ëª¨ë“œ ì „í™˜'}</p>
                                    <input type="url" class="form-group" placeholder="ìƒˆ ì•„ì´ì½˜ URL ë¶™ì—¬ë„£ê¸°" value="${db.customIcons[id] || ''}" data-id="${id}">
                                </div>
                                <button type="button" class="reset-icon-btn" data-id="${id}">ì´ˆê¸°í™”</button>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', iconSectionHTML);
            
            
            const globalCSSSectionHTML = `
                <div class="customize-section">
                    <h3 class="section-title">ì „ì—­ ì»¤ìŠ¤í…€ CSS</h3>
                    <div class="section-content">
                        <div class="css-toggle-section">
                            <label class="toggle-label">
                                <input type="checkbox" id="global-css-toggle" ${db.globalCustomCSS.enabled ? 'checked' : ''}>
                                <span class="toggle-text">ì „ì—­ ì»¤ìŠ¤í…€ CSS ì‚¬ìš©</span>
                            </label>
                        </div>
                        
                        <div class="css-preset-section">
                            <label for="css-preset-select" class="form-label">CSS í”„ë¦¬ì…‹ ì„ íƒ:</label>
                            <select id="css-preset-select" class="form-select">
                                ${Object.entries(db.globalCustomCSS.presets).map(([key, preset]) => 
                                    `<option value="${key}" ${key === db.globalCustomCSS.currentPreset ? 'selected' : ''}>${preset.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="css-input-section">
                            <label for="css-input" class="form-label">CSS ì½”ë“œ:</label>
                            <textarea id="css-input" class="form-textarea" placeholder="CSS ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš”." rows="8">${db.globalCustomCSS.presets[db.globalCustomCSS.currentPreset].css}</textarea>
                        </div>
                        
                        <div class="css-actions">
                            <button type="button" id="save-css-btn" class="btn btn-primary">ì €ìž¥</button>
                            <button type="button" id="new-preset-btn" class="btn btn-secondary">ìƒˆ í”„ë¦¬ì…‹</button>
                            <button type="button" id="delete-preset-btn" class="btn btn-danger" ${db.globalCustomCSS.currentPreset === 'default' ? 'disabled' : ''}>í”„ë¦¬ì…‹ ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', globalCSSSectionHTML);
        }

        function setupTutorialApp() {
            tutorialContentArea.addEventListener('click', (e) => {
                const header = e.target.closest('.tutorial-header');
                if (header) { header.parentElement.classList.toggle('open'); }
            });
        }

        function renderTutorialContent() {
            const tutorials = [
                { title: 'ì‹œìž‘í•˜ë©°', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg'] },
                { title: 'ì†Œí”„íŠ¸ì›¨ì–´ ì†Œê°œ', imageUrls: [ 'https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg' ] },
                { title: '404', imageUrls: [ 'https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg' ] },
                { title: '404-ê·¸ë£¹ì±„íŒ…', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg'] }
            ];
            tutorialContentArea.innerHTML = '';
            tutorials.forEach(tutorial => {
                const item = document.createElement('div');
                item.className = 'tutorial-item';
                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title} íŠœí† ë¦¬ì–¼ ì´ë¯¸ì§€">`).join('');
                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                tutorialContentArea.appendChild(item);
            });
        }

        function autoResize() {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        textarea.addEventListener('input', autoResize);
                
        function setupChatListScreen() {
            renderChatList();
            addChatBtn.addEventListener('click', () => {
                addCharModal.classList.add('visible');
                addCharForm.reset();
            });
            chatListContainer.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    currentChatId = chatItem.dataset.id;
                    currentChatType = chatItem.dataset.type;
                    openChatRoom(currentChatId, currentChatType);
                }
            });
            chatListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
            });
            chatListContainer.addEventListener('touchstart', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);
                }, 400);
            });
            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleChatListLongPress(chatId, chatType, x, y) {
            clearTimeout(longPressTimer);
            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chatItem) return;
            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
            const menuItems = [{
                label: chatItem.isPinned ? 'ìƒë‹¨ ê³ ì • í•´ì œ' : 'ìƒë‹¨ ê³ ì •',
                action: () => {
                    chatItem.isPinned = !chatItem.isPinned;
                    saveData();
                    renderChatList();
                }
            }, {
                label: 'ì±„íŒ… ì‚­ì œ',
                danger: true,
                action: () => {
                    if (confirm(`â€œ${itemName}â€ë‹˜ê³¼ì˜ ì±„íŒ… ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                        if (chatType === 'private') { db.characters = db.characters.filter(c => c.id !== chatId); }
                        else { db.groups = db.groups.filter(g => g.id !== chatId); }
                        saveData();
                        renderChatList();
                        showToast('ì±„íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    }
                }
            }];
            createContextMenu(menuItems, x, y);
        }

        
function renderChatList() {
    chatListContainer.innerHTML = '';
    const allChats = [ ...db.characters.map(c => ({ ...c, type: 'private' })), ...db.groups.map(g => ({ ...g, type: 'group' })) ];
    noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
    const sortedChats = allChats.sort((a, b) => {
        if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
        const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
        const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
        return lastMsgTimeB - lastMsgTimeA;
    });
    sortedChats.forEach(chat => {
        let lastMessageText = 'ì±„íŒ…ì„ ì‹œìž‘í•´ë³´ì„¸ìš”...';
        let lastMessageTime = ''; 

        if (chat.history && chat.history.length > 0) {
            const lastMsgObj = chat.history[chat.history.length - 1];
            const date = new Date(lastMsgObj.timestamp);
            lastMessageTime = `${pad(date.getHours())}:${pad(date.getMinutes())}`; 

            const invisibleRegex = /\[(?:.+?)ë‹˜ì´ (?:.+?)ë‹˜ì˜ ì†¡ê¸ˆì„ (?:ìˆ˜ë ¹|ë°˜í™˜)í–ˆìŠµë‹ˆë‹¤\]|\[(?:.+?)ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:.*?\]|\[(?:.+?)ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\]|\[system:.*?\]|\[(?:.+?)ë‹˜ì´ (?:.+?)ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]|\[(?:.+?)ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ .*?(?:ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]|\[system-display:.*?\]/;
            const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
            if (visibleHistory.length > 0) {
                const lastMsg = visibleHistory[visibleHistory.length - 1];
                const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                const imageRecogRegex = /\[(?:.+?)ë‹˜ì˜ ì´ë¯¸ì§€:\]/;
                const voiceRegex = /\[.*?ë‹˜ì˜ ìŒì„±:.*?\]/;
                const photoVideoRegex = /\[.*?ë‹˜ì˜ ì‚¬ì§„\/ì˜ìƒ:.*?\]/;
                const transferRegex = /\[.*?ë‹˜ì˜ ì†¡ê¸ˆ:.*?ì›.*?\]|\[.*?ë‹˜ì—ê²Œ ì†¡ê¸ˆ:.*?ì›.*?\]|\[.*?ë‹˜ì´ .*?ë‹˜ì—ê²Œ ì†¡ê¸ˆ:.*?ì›.*?\]/;
                const stickerRegex = /\[.*?ë‹˜ì˜ ì´ëª¨í‹°ì½˜:.*?\]|\[.*?ë‹˜ì˜ ì´ëª¨í‹°ì½˜:.*?\]/;
                const giftRegex = /\[.*?ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:.*?\]|\[.*?ë‹˜ì´ .*?ë‹˜ì—ê²Œ ë³´ë‚¸ ì„ ë¬¼:.*?\]/;

                if (giftRegex.test(lastMsg.content)) { lastMessageText = '[ì„ ë¬¼]'; }
                else if (stickerRegex.test(lastMsg.content)) { lastMessageText = '[ì´ëª¨í‹°ì½˜]'; }
                else if (voiceRegex.test(lastMsg.content)) { lastMessageText = '[ìŒì„±]'; }
                else if (photoVideoRegex.test(lastMsg.content)) { lastMessageText = '[ì‚¬ì§„/ì˜ìƒ]'; }
                else if (transferRegex.test(lastMsg.content)) { lastMessageText = '[ì†¡ê¸ˆ]'; }
                else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) { lastMessageText = '[ì‚¬ì§„]'; }
                else {
                    const textMatch = lastMsg.content.match(/\[.*?ë‹˜ì˜ ë©”ì‹œì§€:([\s\S]+)\]/);
                    let text = textMatch ? textMatch[1].trim() : lastMsg.content.trim();
                    lastMessageText = urlRegex.test(text) ? '[ì‚¬ì§„]' : text;
                }
            } else {
                const lastEverMsg = chat.history[chat.history.length - 1];
                const inviteRegex = /\[(.*?)ë‹˜ì´ (.*?)ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]/;
                const renameRegex = /\[.*?ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ .*?(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]/;
                const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);

                if (timeSkipMatch) { lastMessageText = timeSkipMatch[1]; }
                else if (inviteRegex.test(lastEverMsg.content)) { lastMessageText = 'ìƒˆ ë©¤ë²„ê°€ ê·¸ë£¹ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤'; }
                else if (renameRegex.test(lastEverMsg.content)) { lastMessageText = 'ê·¸ë£¹ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤'; }
            }
        }
        const li = document.createElement('li');
        li.className = 'list-item chat-item';
        if (chat.isPinned) li.classList.add('pinned');
        li.dataset.id = chat.id;
        li.dataset.type = chat.type;
        const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
        const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
        const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">ê³ ì •ë¨</span>' : '';
        const unreadBadgeHTML = chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : '';
        const timeHTML = lastMessageTime ? `<span class="item-time">${lastMessageTime}</span>` : ''; 
        
        
        li.innerHTML = `
        <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
        <div class="item-details">
            <div class="item-details-row"><div class="item-name">${itemName}</div>${timeHTML}</div>
            <div class="item-preview-wrapper"><div class="item-preview">${lastMessageText}</div>${unreadBadgeHTML}${pinBadgeHTML}</div>
        </div>`;
        chatListContainer.appendChild(li);
    });
}

        function setupAddCharModal() {
            addCharForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newChar = { id: `char_${Date.now()}`, realName: document.getElementById('char-real-name').value, remarkName: document.getElementById('char-remark-name').value, persona: '', avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', myName: document.getElementById('my-name-for-char').value, myPersona: '', myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', theme: 'white_pink', maxMemory: 100, chatBg: '', history: [], isPinned: false, status: 'ì˜¨ë¼ì¸', worldBookIds: [], useCustomBubbleCss: false, customBubbleCss: '' };
                db.characters.push(newChar);
                saveData();
                renderChatList();
                addCharModal.classList.remove('visible');
                showToast(`ìºë¦­í„° â€œ${newChar.remarkName}â€ ìƒì„± ì„±ê³µ!`);
            });
        }

        // --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” ---

function setupChatRoom() {
    sendMessageBtn.addEventListener('click', sendMessage);
    sendMessageBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        sendMessage();
        setTimeout(() => { messageInput.focus(); }, 50);
    });
    messageInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter' && !e.shiftKey && !isGenerating) {
            e.preventDefault(); 
            sendMessage(); 
        }
    });
    getReplyBtn.addEventListener('click', getAiReply);
    // --- START: setupChatRoom í•¨ìˆ˜ ë‚´ messageAreaì˜ click ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì´ê±¸ë¡œ êµì²´ ---
    messageArea.addEventListener('click', (e) => {
        
        if (stickerModal.classList.contains('visible')) {
            stickerModal.classList.remove('visible');
            
            return; 
        }
        
        if (e.target && e.target.id === 'load-more-btn') { loadMoreMessages(); }
        else if (isInMultiSelectMode) {
               const messageWrapper = e.target.closest('.message-wrapper');
        if (!messageWrapper) return; // ë©”ì‹œì§€ ì˜ì—­ì´ ì•„ë‹Œ ê³³ì„ í´ë¦­í•˜ë©´ ë¬´ì‹œ

        // í´ë¦­ëœ ê³³ì´ í”„ë¡œí•„ ì‚¬ì§„ ì˜ì—­('.message-info')ì¸ì§€ í™•ì¸
        const isAvatarAreaClick = !!e.target.closest('.message-info');

        if (isAvatarAreaClick && messageWrapper.dataset.groupId) {
            // --- ì´ê²ƒì´ ë°”ë¡œ ì›í•˜ì…¨ë˜ ê·¸ë£¹ ì„ íƒ ê¸°ëŠ¥ìž…ë‹ˆë‹¤ ---
            // í”„ë¡œí•„ ì‚¬ì§„ ì˜ì—­ì„ í´ë¦­í–ˆê³ , ê·¸ë£¹ IDê°€ ìžˆìœ¼ë©´ ê·¸ë£¹ ì „ì²´ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
            const groupId = messageWrapper.dataset.groupId;
            const groupWrappers = messageArea.querySelectorAll(`.message-wrapper[data-group-id="${groupId}"]`);
            
            // ê·¸ë£¹ì˜ ì²« ë©”ì‹œì§€ê°€ ì´ë¯¸ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì „ì²´ ì„ íƒ/í•´ì œë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            const isFirstMsgSelected = selectedMessageIds.has(groupWrappers[0].dataset.id);

            groupWrappers.forEach(wrapper => {
                const msgId = wrapper.dataset.id;
                if (isFirstMsgSelected) { // ì´ë¯¸ ì„ íƒëœ ìƒíƒœë©´, ê·¸ë£¹ ì „ì²´ í•´ì œ
                    selectedMessageIds.delete(msgId);
                    wrapper.classList.remove('multi-select-selected');
                } else { // ì„ íƒë˜ì§€ ì•Šì€ ìƒíƒœë©´, ê·¸ë£¹ ì „ì²´ ì„ íƒ
                    selectedMessageIds.add(msgId);
                    wrapper.classList.add('multi-select-selected');
                }
            });
            selectCount.textContent = `${selectedMessageIds.size}ê°œ í•­ëª© ì„ íƒë¨`;
            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;

        } else {
            // í”„ë¡œí•„ ì‚¬ì§„ ì˜ì—­ì´ ì•„ë‹Œ, ë§í’ì„  ìžì²´ë¥¼ í´ë¦­í•˜ë©´ ê°œë³„ ë©”ì‹œì§€ë§Œ ì„ íƒ/í•´ì œí•©ë‹ˆë‹¤.
            toggleMessageSelection(messageWrapper.dataset.id);
        }

        } else {
            const voiceBubble = e.target.closest('.voice-bubble');
            if (voiceBubble) {
                const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                if (transcript) { transcript.classList.toggle('active'); }
            }
            const pvCard = e.target.closest('.pv-card');
            
            if (pvCard && pvCard.dataset.clickable !== "false") {
                const content = pvCard.querySelector('.pv-card-content');
                const footer = pvCard.querySelector('.pv-card-footer');
                content.classList.toggle('visible');
                footer.classList.toggle('hidden');
            }
            
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                if (description) { description.classList.toggle('active'); }
            }
            const transferCard = e.target.closest('.transfer-card.received-transfer');
            if (transferCard && currentChatType === 'private') {
                const messageWrapper = transferCard.closest('.message-wrapper');
                const messageId = messageWrapper.dataset.id;
                const character = db.characters.find(c => c.id === currentChatId);
                const message = character.history.find(m => m.id === messageId);
                if (message && message.transferStatus === 'pending') { handleReceivedTransferClick(messageId); }
            }
        }
    });
// --- END: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµì²´ ---
    messageArea.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
        const messageWrapper = e.target.closest('.message-wrapper');
        if (!messageWrapper) return;
        handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
    });
    messageArea.addEventListener('touchstart', (e) => {
        if (e.target.id === 'load-more-btn') return;
        const messageWrapper = e.target.closest('.message-wrapper');
        if (!messageWrapper) return;
        longPressTimer = setTimeout(() => {
            const touch = e.touches[0];
            handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
        }, 400);
    });
    messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
    messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
    saveEditBtn.addEventListener('click', saveMessageEdit);
    cancelEditBtn.addEventListener('click', cancelMessageEdit);
    cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
    deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);

    attachmentToggleBtn.addEventListener('click', () => {
        stickerBar.classList.toggle('visible');
        attachmentToggleBtn.classList.toggle('active');
    });
}
// --- END: í•¨ìˆ˜ êµì²´ ---
        
// --- START: ì´ í•¨ìˆ˜ë“¤ì„ ì•„ëž˜ ì½”ë“œë¡œ ëª¨ë‘ êµì²´ ---
function handleMessageLongPress(messageWrapper, x, y) {
    if (isInMultiSelectMode) return;
    clearTimeout(longPressTimer);
    const messageId = messageWrapper.dataset.id;
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const message = chat.history.find(m => m.id === messageId);
    if (!message) return;
    
    // START: íŽ¸ì§‘ ê°€ëŠ¥ ë¡œì§ ë³€ê²½
    const isInvisibleMessage = /\[.*?ë‹˜ì´ .*?ë‹˜ì˜ ì†¡ê¸ˆì„ (?:ìˆ˜ë ¹|ë°˜í™˜)í–ˆìŠµë‹ˆë‹¤\]|\[.*?ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:.*?\]|\[.*?ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\]|\[system:.*?\]|\[.*?ë‹˜ì´ .*?ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]|\[.*?ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ .*?(?:ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]/.test(message.content);
    const isImageOnlyRecog = message.isAiOnlyImage === true;

    let isEditable = false;
    for (const key in editableMessageRegexes) {
        if (editableMessageRegexes[key].test(message.content)) {
            isEditable = true;
            break;
        }
    }
    
    let menuItems = [];
    if (isEditable && !isInvisibleMessage && !isImageOnlyRecog) {
        menuItems.push({ label: 'íŽ¸ì§‘', action: () => startMessageEdit(messageId) });
    }
    // END: íŽ¸ì§‘ ê°€ëŠ¥ ë¡œì§ ë³€ê²½

    menuItems.push({ label: 'ì‚­ì œ', action: () => enterMultiSelectMode(messageId) });

    if (menuItems.length > 0) { createContextMenu(menuItems, x, y); }
}

// --- START: ì•„ëž˜ 2ê°œ í•¨ìˆ˜ë¥¼ ì°¾ì•„ì„œ í†µì§¸ë¡œ êµì²´í•˜ì„¸ìš” ---

function startMessageEdit(messageId) {
    exitMultiSelectMode();
    editingMessageId = messageId;
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const message = chat.history.find(m => m.id === messageId);
    if (!message) return;

    let contentToEdit = '';
    let matchedKey = null;

    for (const key in editableMessageRegexes) {
        const match = message.content.match(editableMessageRegexes[key]);
        if (match) {
            contentToEdit = match[1] || ''; // ì²« ë²ˆì§¸ ìº¡ì²˜ ê·¸ë£¹ ì‚¬ìš©
            matchedKey = key;
            break;
        }
    }
    
    if (matchedKey === null) {
        showToast("ì´ ë©”ì‹œì§€ëŠ” íŽ¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    editingMessageContext = {
        originalContent: message.content,
        matchedKey: matchedKey
    };

    // UI ë³€ê²½: ê¸°ì¡´ ìž…ë ¥ì°½(textarea) ì‚¬ìš© ë° ë²„íŠ¼ êµì²´
    messageInput.value = contentToEdit.trim();
    sendMessageBtn.style.display = 'none';
    getReplyBtn.style.display = 'none';
    saveEditBtn.style.display = 'flex';
    cancelEditBtn.style.display = 'flex';
    
    messageInput.focus();
    autoResize(); 
}

function saveMessageEdit() {
    if (!editingMessageId || !editingMessageContext) return;

    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
    if (messageIndex === -1) return;

    const newText = messageInput.value.trim();
    if (newText) {
        const { originalContent, matchedKey } = editingMessageContext;
        
        let newContent;
        // ì†¡ê¸ˆ ë©”ì‹œì§€ëŠ” ì „ì²´ë¥¼ êµì²´, ë‚˜ë¨¸ì§€ëŠ” ë‚´ìš©ë§Œ êµì²´
        if (matchedKey === 'transfer') {
            newContent = newText;
        } else {
            const regex = editableMessageRegexes[matchedKey];
            const match = originalContent.match(regex);
            if (match) {
                const textToReplace = match.slice(1).find(m => m !== undefined);
                newContent = originalContent.replace(textToReplace, newText);
            } else {
                newContent = originalContent; // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ìœ ì§€
            }
        }
        
        chat.history[messageIndex].content = newContent;
        if (chat.history[messageIndex].parts) {
            chat.history[messageIndex].parts = [{ type: 'text', text: newContent }];
        }
        
        saveData();
        currentPage = 1;
        renderMessages(false, true);
        renderChatList();
    }
    cancelMessageEdit();
}

// --- END: í•¨ìˆ˜ 2ê°œ êµì²´ ---

function startMessageEdit(messageId) {
    exitMultiSelectMode();
    editingMessageId = messageId;
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const message = chat.history.find(m => m.id === messageId);
    if (!message) return;

    let contentToEdit = '';
    let matchedKey = null;

    for (const key in editableMessageRegexes) {
        const match = message.content.match(editableMessageRegexes[key]);
        if (match) {
            contentToEdit = match.slice(1).find(m => m !== undefined) || '';
            matchedKey = key;
            break;
        }
    }
    
    if (matchedKey === null) {
        showToast("ì´ ë©”ì‹œì§€ëŠ” íŽ¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    editingMessageContext = {
        originalContent: message.content,
        matchedKey: matchedKey
    };

    // UI ë³€ê²½: ê¸°ì¡´ ìž…ë ¥ì°½(textarea) ì‚¬ìš© ë° ë²„íŠ¼ êµì²´
    messageInput.value = contentToEdit.trim();
    sendMessageBtn.style.display = 'none';
    getReplyBtn.style.display = 'none';
    saveEditBtn.style.display = 'flex';
    cancelEditBtn.style.display = 'flex';
    
    messageInput.focus();
    autoResize(); // íŽ¸ì§‘ ë‚´ìš©ì— ë§žê²Œ textarea ë†’ì´ ì¡°ì ˆ
}

function saveMessageEdit() {
    if (!editingMessageId || !editingMessageContext) return;

    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
    if (messageIndex === -1) return;

    const newText = messageInput.value.trim(); // ì´ì œ messageInput (textarea)ì—ì„œ ê°’ì„ ê°€ì ¸ì˜´
    if (newText) {
        const { originalContent, matchedKey } = editingMessageContext;
        const regex = editableMessageRegexes[matchedKey];
        const match = originalContent.match(regex);
        
        if (match) {
            const textToReplace = match.slice(1).find(m => m !== undefined);
            const newContent = originalContent.replace(textToReplace, newText);
            
            chat.history[messageIndex].content = newContent;
            if (chat.history[messageIndex].parts) {
                chat.history[messageIndex].parts = [{ type: 'text', text: newContent }];
            }
        }
        
        saveData();
        currentPage = 1;
        renderMessages(false, true);
        renderChatList();
    }
    cancelMessageEdit();
}

// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´ ---
function cancelMessageEdit() {
    // ì´ë¯¸ íŽ¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë©´ í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
    if (editingMessageId === null) return;

    editingMessageId = null;
    editingMessageContext = null;

    messageInput.value = '';
    sendMessageBtn.style.display = 'flex';
    getReplyBtn.style.display = 'flex';
    saveEditBtn.style.display = 'none';
    cancelEditBtn.style.display = 'none';
    autoResize(); 
}
// --- END: í•¨ìˆ˜ êµì²´ ---

// --- END: í•¨ìˆ˜ 3ê°œ êµì²´ ---

        function enterMultiSelectMode(initialMessageId) {
            isInMultiSelectMode = true;
            chatRoomHeaderDefault.style.display = 'none';
            chatRoomHeaderSelect.style.display = 'flex';
            document.querySelector('.chat-input-wrapper').style.display = 'none';
            multiSelectBar.classList.add('visible');
            chatRoomScreen.classList.add('multi-select-active');
            selectedMessageIds.clear();
            if (initialMessageId) { toggleMessageSelection(initialMessageId); }
        }

        // --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´ ---
function exitMultiSelectMode() {
    isInMultiSelectMode = false;
    chatRoomHeaderDefault.style.display = 'flex';
    chatRoomHeaderSelect.style.display = 'none';
    document.querySelector('.chat-input-wrapper').style.display = 'block';
    multiSelectBar.classList.remove('visible');
    chatRoomScreen.classList.remove('multi-select-active');
    selectedMessageIds.forEach(id => {
        const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);
        if (el) el.classList.remove('multi-select-selected');
    });
    selectedMessageIds.clear();

    // START: ì¶”ê°€ëœ ì½”ë“œ
    // ì‚­ì œ ëª¨ë“œ ì¢…ë£Œ ì‹œ íŽ¸ì§‘ ëª¨ë“œë„ í•¨ê»˜ ì¢…ë£Œ
    if (editingMessageId) {
        cancelMessageEdit();
    }
    // END: ì¶”ê°€ëœ ì½”ë“œ
}
// --- END: í•¨ìˆ˜ êµì²´ ---

        function toggleMessageSelection(messageId) {
            const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
            if (!el) return;
            if (selectedMessageIds.has(messageId)) {
                selectedMessageIds.delete(messageId);
                el.classList.remove('multi-select-selected');
            } else {
                selectedMessageIds.add(messageId);
                el.classList.add('multi-select-selected');
            }
            selectCount.textContent = `${selectedMessageIds.size}ê°œ í•­ëª© ì„ íƒë¨`;
            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;
        }

        function deleteSelectedMessages() {
            if (selectedMessageIds.size === 0) return;
            const deletedCount = selectedMessageIds.size;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
            saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
            exitMultiSelectMode();
            showToast(`${deletedCount}ê°œì˜ ë©”ì‹œì§€ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤`);
        }

// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´ ---
// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” ---
function openChatRoom(chatId, type) {
    const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
    if (!chat) return;
    if (chat.unreadCount > 0) {
        chat.unreadCount = 0;
        saveData();
        renderChatList();
    }
    exitMultiSelectMode();
    cancelMessageEdit();
    chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
    const subtitle = document.getElementById('chat-room-subtitle');
    if (type === 'private') {
        subtitle.style.display = 'flex';
        chatRoomStatusText.textContent = chat.status || 'ì˜¨ë¼ì¸';
    } else {
        subtitle.style.display = 'none';
    }
    getReplyBtn.style.display = 'inline-flex';
    chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
    typingIndicator.style.display = 'none';
    isGenerating = false;
    getReplyBtn.disabled = false;
    currentPage = 1;
    chatRoomScreen.className = chatRoomScreen.className.replace(/\b(chat-active-|hide-my-icons|hide-char-icons)[^ ]+\b/g, ''); 
    chatRoomScreen.classList.add(`chat-active-${chatId}`);
    
    chatRoomScreen.style.setProperty('--bubble-font-size', '14px'); 
    applyPerChatUISettings();
    updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);
    
    // ë©”ì‹œì§€ë¥¼ ë¨¼ì € ë Œë”ë§í•˜ê³  í™”ë©´ì„ ì „í™˜í•©ë‹ˆë‹¤.
    renderMessages(false, true);
    stickerBar.classList.remove('visible');
    attachmentToggleBtn.classList.remove('active');
    
    // í™”ë©´ ì „í™˜
    switchScreen('chat-room-screen');

    // START: ìˆ˜ì •ëœ ë¶€ë¶„
    // í™”ë©´ì´ ì™„ì „ížˆ ì „í™˜ëœ í›„(ì•„ì£¼ ì•½ê°„ì˜ ë”œë ˆì´ í›„) ë†’ì´ë¥¼ ê³„ì‚°í•˜ë„ë¡ ë³€ê²½
    setTimeout(() => {
        messageInput.value = ''; // ìž…ë ¥ì°½ ë¹„ìš°ê¸°
        autoResize(); // ìž…ë ¥ì°½ ë†’ì´ ì´ˆê¸°í™”
    }, 0); // 0ms ì§€ì—°ìœ¼ë¡œ ë‹¤ìŒ ë Œë”ë§ ì‚¬ì´í´ì— ì‹¤í–‰ë˜ë„ë¡ í•¨
    // END: ìˆ˜ì •ëœ ë¶€ë¶„
}
// --- END: í•¨ìˆ˜ êµì²´ ---
// --- END: í•¨ìˆ˜ êµì²´ --- 
// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” ---
        function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history) return;

            const oldScrollHeight = messageArea.scrollHeight;
            const totalMessages = chat.history.length;
            const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
            const start = Math.max(0, end - MESSAGES_PER_PAGE);
            
            const messagesToRender = chat.history.slice(start, end);
            const messageBeforeSlice = (start > 0) ? chat.history[start - 1] : null;
            
            if (!isLoadMore) messageArea.innerHTML = '';
            
            const fragment = document.createDocumentFragment();

            // ë Œë”ë§ ë£¨í”„ì—ì„œ ê·¸ë£¹ ID ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
            let currentGroupId = null;

            messagesToRender.forEach((msg, index) => {
                const prevMsg = (index === 0) ? messageBeforeSlice : messagesToRender[index - 1];
                const nextMsg = (index === messagesToRender.length - 1) ? null : messagesToRender[index + 1];
                
                // ê·¸ë£¹ì˜ ì‹œìž‘ì¸ì§€ íŒë‹¨í•˜ëŠ” ë¡œì§
                let isGroupStart = true;
                if (prevMsg) {
                    const prevSenderId = prevMsg.role === 'user' ? 'user_me' : (prevMsg.senderId || 'assistant');
                    const currentSenderId = msg.role === 'user' ? 'user_me' : (msg.senderId || 'assistant');
                    const prevMsgDate = new Date(prevMsg.timestamp);
                    const currentMsgDate = new Date(msg.timestamp);
                    const prevTimeSignature = `${prevMsgDate.getFullYear()}-${pad(prevMsgDate.getMonth() + 1)}-${pad(prevMsgDate.getDate())}-${pad(prevMsgDate.getHours())}-${pad(prevMsgDate.getMinutes())}`;
                    const currentTimeSignature = `${currentMsgDate.getFullYear()}-${pad(currentMsgDate.getMonth() + 1)}-${pad(currentMsgDate.getDate())}-${pad(currentMsgDate.getHours())}-${pad(currentMsgDate.getMinutes())}`;
                    const isPrevSystemMsg = /\[system-display:.*\]|\[.*ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]|\[.*ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]|\[system:.*\]|\[.*ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\]|\[.*ë°˜í™˜í–ˆìŠµë‹ˆë‹¤\]/.test(prevMsg.content);

                    if (currentSenderId === prevSenderId && currentTimeSignature === prevTimeSignature && !isPrevSystemMsg) {
                        isGroupStart = false;
                    }
                }
                
                // ê·¸ë£¹ ID í• ë‹¹
                if (isGroupStart) {
                    currentGroupId = msg.id; // ìƒˆ ê·¸ë£¹ì´ ì‹œìž‘ë˜ë©´, í˜„ìž¬ ë©”ì‹œì§€ IDë¥¼ ê·¸ë£¹ IDë¡œ ì„¤ì •
                }
                
                // createMessageBubbleElementì— ê·¸ë£¹ IDë¥¼ ì¸ìžë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
                const bubble = createMessageBubbleElement(msg, prevMsg, nextMsg, currentGroupId); 
                if (bubble) fragment.appendChild(bubble);
            });

            if (isLoadMore) {
                const existingLoadBtn = document.getElementById('load-more-btn');
                if (existingLoadBtn) existingLoadBtn.remove();
                messageArea.prepend(fragment);
            } else {
                messageArea.appendChild(fragment);
            }
            
            if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-btn';
                loadMoreButton.className = 'load-more-btn';
                loadMoreButton.textContent = 'ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°';
                messageArea.prepend(loadMoreButton);
            }

            if (forceScrollToBottom) {
                setTimeout(() => { messageArea.scrollTop = messageArea.scrollHeight; }, 0);
            } else if (isLoadMore) {
                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
            }
        }
// --- END: í•¨ìˆ˜ êµì²´ ---


        function loadMoreMessages() {
            currentPage++;
            renderMessages(true, false);
        }

        function calculateVoiceDuration(text) {
            return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5)));
        }

        // --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµ-ì²´í•˜ì„¸ìš” ---
function createMessageBubbleElement(message, prevMessage, nextMessage, groupId) {
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const { role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId } = message;
    const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
    const inviteRegex = /\[(.*?)ë‹˜ì´ (.*?)ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]/;
    const renameRegex = /\[(.*?)ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ â€˜(.*?)â€™(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]/;
    const timeSkipMatch = content.match(timeSkipRegex);
    const inviteMatch = content.match(inviteRegex);
    const renameMatch = content.match(renameRegex);
    const invisibleRegex = /\[(?:.+?)ë‹˜ì´ (?:.+?)ë‹˜ì˜ ì†¡ê¸ˆì„ (?:ìˆ˜ë ¹|ë°˜í™˜)í–ˆìŠµë‹ˆë‹¤\]|\[(?:.+?)ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:.*?\]|\[(?:.+?)ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\]|\[system:.*?\]/;
    
    if (invisibleRegex.test(content)) { return null; }

    const wrapper = document.createElement('div');
    wrapper.dataset.id = id;

    if (timeSkipMatch || inviteMatch || renameMatch) {
        wrapper.className = 'message-wrapper system-notification';
        let bubbleText = '';
        if (timeSkipMatch) bubbleText = timeSkipMatch[1];
        if (inviteMatch) bubbleText = `${inviteMatch[1]}ë‹˜ì´ ${inviteMatch[2]}ë‹˜ì„ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤`;
        if (renameMatch) bubbleText = `${renameMatch[1]}ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ "${renameMatch[2]}"(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`;
        wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
        return wrapper;
    }

    const isSent = (role === 'user');
    let avatarUrl, bubbleTheme, senderNickname = '';
    const themeKey = chat.theme || 'white_pink';
    const theme = colorThemes[themeKey] || colorThemes['white_pink'];
    
    const currentSenderId = isSent ? 'user_me' : (senderId || 'assistant');
    const msgDate = new Date(timestamp);
    const msgTimeSignature = `${msgDate.getFullYear()}-${pad(msgDate.getMonth() + 1)}-${pad(msgDate.getDate())}-${pad(msgDate.getHours())}-${pad(msgDate.getMinutes())}`;
    
    // â–¼â–¼â–¼â–¼â–¼ ì˜¤ë¥˜ ìˆ˜ì • ë¶€ë¶„ â–¼â–¼â–¼â–¼â–¼
    // ì¤‘ë³µ ì„ ì–¸ë˜ë˜ let isGroupStart;ë¥¼ ì—¬ê¸°ì„œ í•œ ë²ˆë§Œ ì„ ì–¸í•©ë‹ˆë‹¤.
    let isGroupStart = true;
    if (prevMessage) {
        const prevSenderId = prevMessage.role === 'user' ? 'user_me' : (prevMessage.senderId || 'assistant');
        const prevMsgDate = new Date(prevMessage.timestamp);
        const prevTimeSignature = `${prevMsgDate.getFullYear()}-${pad(prevMsgDate.getMonth() + 1)}-${pad(prevMsgDate.getDate())}-${pad(prevMsgDate.getHours())}-${pad(prevMsgDate.getMinutes())}`;
        const isPrevSystemMsg = /\[system-display:.*\]|\[.*ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]|\[.*ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]|\[system:.*\]|\[.*ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\]|\[.*ë°˜í™˜í–ˆìŠµë‹ˆë‹¤\]/.test(prevMessage.content);
        
        if (currentSenderId === prevSenderId && msgTimeSignature === prevTimeSignature && !isPrevSystemMsg) {
            isGroupStart = false;
        }
    }
    // â–²â–²â–²â–²â–² ì˜¤ë¥˜ ìˆ˜ì • ë¶€ë¶„ â–²â–²â–²â–²â–²

    wrapper.dataset.senderId = currentSenderId;
    wrapper.dataset.timeSignature = msgTimeSignature;
    wrapper.dataset.groupId = groupId; // ì¸ìžë¡œ ë°›ì€ groupIdë¥¼ ë°”ë¡œ í• ë‹¹

    let isGroupEnd = true;
    if (nextMessage) {
        const nextSenderId = nextMessage.role === 'user' ? 'user_me' : (nextMessage.senderId || 'assistant');
        const nextMsgDate = new Date(nextMessage.timestamp);
        const nextTimeSignature = `${nextMsgDate.getFullYear()}-${pad(nextMsgDate.getMonth() + 1)}-${pad(nextMsgDate.getDate())}-${pad(nextMsgDate.getHours())}-${pad(nextMsgDate.getMinutes())}`;
        const isNextSystemMsg = /\[system-display:.*\]|\[.*ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]|\[.*ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]|\[system:.*\]|\[.*ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\]|\[.*ë°˜í™˜í–ˆìŠµë‹ˆë‹¤\]/.test(nextMessage.content);
        if (currentSenderId === nextSenderId && msgTimeSignature === nextTimeSignature && !isNextSystemMsg) {
            isGroupEnd = false;
        }
    }

    if (isSent) {
        avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
        bubbleTheme = theme.sent;
    } else {
        if (currentChatType === 'private') {
            avatarUrl = chat.avatar;
        } else { 
            const sender = chat.members.find(m => m.id === senderId);
            if (sender) {
                avatarUrl = sender.avatar;
                senderNickname = sender.groupNickname;
            } else { 
                avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            }
        }
        bubbleTheme = theme.received;
    }
    const timeString = `${pad(msgDate.getHours())}:${pad(msgDate.getMinutes())}`;
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    if (!isGroupStart) {
        wrapper.classList.add('grouped');
    }
    if (currentChatType === 'group' && !isSent) { wrapper.classList.add('group-message'); }
    
    const bubbleRow = document.createElement('div');
    bubbleRow.className = 'message-bubble-row';
    let bubbleElement;

    const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
    const sentStickerRegex = /\[(?:.+?)ë‹˜ì˜ ì´ëª¨í‹°ì½˜:.+?\]/i;
    const receivedStickerRegex = /\[(?:.+?)ë‹˜ì˜ ì´ëª¨í‹°ì½˜:([\s\S]+?)\]/i;
    const voiceRegex = /\[(?:.+?)ë‹˜ì˜ ìŒì„±:([\s\S]+?)\]/;
    const photoVideoRegex = /\[(?:.+?)ë‹˜ì˜ ì‚¬ì§„\/ì˜ìƒ:([\s\S]+?)\]/;
    const privateSentTransferRegex = /\[.*?ì—ê²Œ ì†¡ê¸ˆ:([\d.]+)ì›ï¼›ë©”ëª¨:(.*?)\]/;
    const privateReceivedTransferRegex = /\[.*?ë‹˜ì˜ ì†¡ê¸ˆ:([\d.]+)ì›ï¼›ë©”ëª¨:(.*?)\]/;
    const groupTransferRegex = /\[(.*?)\s*ë‹˜ì´\s*(.*?)\s*ë‹˜ì—ê²Œ ì†¡ê¸ˆ:([\d.]+)ì›ï¼›ë©”ëª¨:(.*?)\]/;
    const privateGiftRegex = /\[(?:.+?)ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:([\s\S]+?)\]/;
    const groupGiftRegex = /\[(.*?)\s*ë‹˜ì´\s*(.*?)\s*ë‹˜ì—ê²Œ ì„ ë¬¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤:([\s\S]+?)\]/;
    const imageRecogRegex = /\[(?:.+?)ë‹˜ì˜ ì´ë¯¸ì§€:\]/;
    const textRegex = /\[(?:.+?)ë‹˜ì˜ ë©”ì‹œì§€:([\s\S]+)\]/;

    const sentStickerMatch = content.match(sentStickerRegex);
    const receivedStickerMatch = content.match(receivedStickerRegex);
    const voiceMatch = content.match(voiceRegex);
    const photoVideoMatch = content.match(photoVideoRegex);
    const privateSentTransferMatch = content.match(privateSentTransferRegex);
    const privateReceivedTransferMatch = content.match(privateReceivedTransferRegex);
    const groupTransferMatch = content.match(groupTransferRegex);
    const privateGiftMatch = content.match(privateGiftRegex);
    const groupGiftMatch = content.match(groupGiftRegex);
    const imageRecogMatch = content.match(imageRecogRegex);
    const textMatch = content.match(textRegex);
    const isAiRecogImage = message.parts && message.parts.some(p => p.type === 'image');

    if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
        
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'sticker-bubble';
        let stickerSrc = '';
        if (isSent) {
            stickerSrc = stickerData;
        } else {
            const stickerInput = receivedStickerMatch[1].trim();
            const foundSticker = db.myStickers.find(s => s.name === stickerInput);
            if (foundSticker) {
                stickerSrc = foundSticker.data; 
            } else {
                const pathExtractionRegex = /[a-zA-Z0-9]+\/.*$/;
                const extractedPathMatch = stickerInput.match(pathExtractionRegex);
                const finalPath = extractedPathMatch ? extractedPathMatch[0] : stickerInput;
                stickerSrc = `https://i.postimg.cc/${finalPath}`;
            }
        }
        bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="ì´ëª¨í‹°ì½˜">`;

    } else if (privateGiftMatch || groupGiftMatch) {
        const match = privateGiftMatch || groupGiftMatch;
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'gift-card';
        if (giftStatus === 'received') { bubbleElement.classList.add('received'); }
        let giftText;
        if (groupGiftMatch) {
            const from = groupGiftMatch[1];
            const to = groupGiftMatch[2];
            giftText = isSent ? `${to}ë‹˜ì—ê²Œ ë³´ë‚¸ ì„ ë¬¼` : `${from}ë‹˜ì´ ${to}ë‹˜ì—ê²Œ ë³´ë‚¸ ì„ ë¬¼`;
        } else {
            giftText = 'ì„ ë¬¼ì´ ë„ì°©í–ˆì–´ìš”~';
        }
        bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="ì„ ë¬¼" class="gift-card-icon"><div class="gift-card-text">${giftText}</div><div class="gift-card-received-stamp">ìˆ˜ë ¹ ì™„ë£Œ</div>`;
        const description = groupGiftMatch ? groupGiftMatch[3].trim() : match[1].trim();
        const descriptionDiv = document.createElement('div');
        descriptionDiv.className = 'gift-card-description';
        descriptionDiv.textContent = description;
        wrapper.appendChild(descriptionDiv);

    } else if (voiceMatch) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'voice-bubble';
        if (!chat.useCustomBubbleCss) {
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }
        bubbleElement.innerHTML = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg><span class="duration">${calculateVoiceDuration(voiceMatch[1].trim())}"</span>`;
        const transcriptDiv = document.createElement('div');
        transcriptDiv.className = 'voice-transcript';
        transcriptDiv.textContent = voiceMatch[1].trim();
        wrapper.appendChild(transcriptDiv);

    } else if (photoVideoMatch || imageRecogMatch) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'pv-card';
        const imageUrl = message.imageData || 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg';

        
        let footerText, descriptionText = '';
        
        const footerIconSVG = `<svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg>`;

        if (message.isAiOnlyImage) {
            
            bubbleElement.dataset.clickable = "false";
            footerText = `<span>AI ì¸ì‹</span>`;
            descriptionText = ''; 
        } else {
            
            footerText = isAiRecogImage 
                ? `<span>AI ì¸ì‹ãƒ»í´ë¦­í•˜ì—¬ ì„¤ëª… ë³´ê¸°</span>`
                : `<span>ì‚¬ì§„/ì˜ìƒãƒ»í´ë¦­í•˜ì—¬ ì„¤ëª… ë³´ê¸°</span>`;
            descriptionText = photoVideoMatch ? photoVideoMatch[1].trim() : '';
        }

        bubbleElement.innerHTML = `
            <img src="${imageUrl}" class="pv-card-img" alt="ì‚¬ì§„/ì˜ìƒ">
            <div class="pv-card-content">${descriptionText}</div>
            <div class="pv-card-footer">
                ${footerIconSVG}
                ${footerText}
            </div>`;
        
    } else if (privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch) {
        const isSentTransfer = !!privateSentTransferMatch || (groupTransferMatch && isSent);
        const match = privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch;
        let amount, remarkText, titleText;
        if (groupTransferMatch) {
            const from = groupTransferMatch[1];
            const to = groupTransferMatch[2];
            amount = parseFloat(groupTransferMatch[3]).toFixed(0);
            remarkText = groupTransferMatch[4] || '';
            titleText = isSent ? `${to}ë‹˜ì—ê²Œ ì†¡ê¸ˆ` : `${from}ë‹˜ì´ ë‹¹ì‹ ì—ê²Œ ì†¡ê¸ˆ`;
        } else { 
            amount = parseFloat(match[1]).toFixed(0);
            remarkText = match[2] || '';
            titleText = isSentTransfer ? 'ë‹¹ì‹ ì—ê²Œ ì†¡ê¸ˆ' : 'ì†¡ê¸ˆ';
        }
        bubbleElement = document.createElement('div');
        bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;
        let statusText = isSentTransfer ? 'ìˆ˜ë ¹ ëŒ€ê¸°' : 'ì†¡ê¸ˆ ë°›ê¸°';
        if(groupTransferMatch && !isSent) statusText = 'ì†¡ê¸ˆ';
        if (transferStatus === 'received') {
            statusText = 'ìˆ˜ë ¹ ì™„ë£Œ';
            bubbleElement.classList.add('received');
        } else if (transferStatus === 'returned') {
            statusText = 'ë°˜í™˜ë¨';
            bubbleElement.classList.add('returned');
        }
        if ((transferStatus !== 'pending' && currentChatType === 'private') || currentChatType === 'group') {
            bubbleElement.style.cursor = 'default';
        }
        const remarkHTML = remarkText ? `<p class="transfer-remark">${remarkText}</p>` : '';
        bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">â‚©${amount}</p>${remarkHTML}<p class="transfer-status">${statusText}</p></div>`;

    } else if (urlRegex.test(content)) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'photo-bubble';
        bubbleElement.innerHTML = `<img src="${content}" alt="ì´ë¯¸ì§€ ë©”ì‹œì§€">`;

    } else {
        bubbleElement = document.createElement('div');
        bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        const textMatch = content.match(/\[(?:.+?)ë‹˜ì˜ ë©”ì‹œì§€:([\s\S]+)\]/);
        if (textMatch) {
            bubbleElement.textContent = textMatch[1].trim();
        } else {
            bubbleElement.textContent = content;
        }
        if (!chat.useCustomBubbleCss) {
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }
    }
    
    if (bubbleElement && !isGroupStart) {
        bubbleElement.classList.add('grouped-bubble');
    }
    
    const nicknameHTML = (isGroupStart && currentChatType === 'group' && !isSent && senderNickname) 
        ? `<div class="group-nickname">${senderNickname}</div>` 
        : '';
    
    const messageInfoHTML = `
        <div class="message-info">
            ${nicknameHTML}
            <img src="${avatarUrl}" class="message-avatar">
        </div>`;

    const messageMetaHTML = isGroupEnd ? `
        <div class="message-meta">
            <span class="message-time">${timeString}</span>
        </div>
    ` : '';
    
    bubbleRow.innerHTML = messageInfoHTML;
    if (bubbleElement) bubbleRow.appendChild(bubbleElement);
    if (isGroupEnd) bubbleRow.insertAdjacentHTML('beforeend', messageMetaHTML);

    wrapper.prepend(bubbleRow);
    return wrapper;
}
// --- END: í•¨ìˆ˜ êµì²´ ---


// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” ---
        function addMessageBubble(message) {
            const chat = (currentChatType === 'private')
                ? db.characters.find(c => c.id === currentChatId)
                : db.groups.find(g => g.id === currentChatId);
            
            if (!chat) return;
        
            const history = chat.history;
            const prevMessage = history.length > 1 ? history[history.length - 2] : null;
            const lastMessageWrapper = messageArea.querySelector('.message-wrapper:last-child');
            let currentGroupId = null;

            // ìƒˆ ë©”ì‹œì§€ê°€ ì´ì „ ë©”ì‹œì§€ì™€ ê·¸ë£¹ì„ í˜•ì„±í•˜ëŠ”ì§€ í™•ì¸
            if (prevMessage && lastMessageWrapper) {
                const prevSenderId = prevMessage.role === 'user' ? 'user_me' : (prevMessage.senderId || 'assistant');
                const currentSenderId = message.role === 'user' ? 'user_me' : (message.senderId || 'assistant');
        
                const prevMsgDate = new Date(prevMessage.timestamp);
                const prevTimeSignature = `${prevMsgDate.getFullYear()}-${prevMsgDate.getMonth()}-${prevMsgDate.getDate()}-${prevMsgDate.getHours()}-${prevMsgDate.getMinutes()}`;
                const currentMsgDate = new Date(message.timestamp);
                const currentTimeSignature = `${currentMsgDate.getFullYear()}-${currentMsgDate.getMonth()}-${currentMsgDate.getDate()}-${currentMsgDate.getHours()}-${currentMsgDate.getMinutes()}`;
                const isPrevSystemMsg = /\[system-display:.*\]|\[.*ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]|\[.*ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]|\[system:.*\]/.test(prevMessage.content);
                
                // ê·¸ë£¹ì´ ê³„ì†ë˜ëŠ” ì¡°ê±´
                if (prevSenderId === currentSenderId && prevTimeSignature === currentTimeSignature && !isPrevSystemMsg) {
                    // **ì‹¤ì‹œê°„ ì‹œê°„ ìˆ¨ê¹€ ì²˜ë¦¬**
                    const lastMeta = lastMessageWrapper.querySelector('.message-meta');
                    if (lastMeta) {
                        lastMeta.remove(); 
                    }
                    currentGroupId = lastMessageWrapper.dataset.groupId;
                }
            }

            // ê·¸ë£¹ IDê°€ ì—†ìœ¼ë©´(ìƒˆ ê·¸ë£¹ì´ë©´) ìžì‹ ì˜ IDë¥¼ ê·¸ë£¹ IDë¡œ ì‚¬ìš©
            if (!currentGroupId) {
                currentGroupId = message.id;
            }

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë“± ë³´ì´ì§€ ì•ŠëŠ” ë©”ì‹œì§€ ì²˜ë¦¬
            if (currentChatType === 'private') {
                const character = chat;
                const myName = character.myName; 
                const systemMessageRegex = /\[system:.*?\]|\[system-display:.*?\]/;
                const updateStatusRegex = new RegExp(`\\[${character.realName}ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:(.*?)\\]`);
                const giftReceivedRegex = new RegExp(`\\[${character.realName}ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\\]`);

                if (systemMessageRegex.test(message.content)) { /* do nothing for pure system messages */ }
                if (message.content.match(updateStatusRegex)) {
                    character.status = message.content.match(updateStatusRegex)[1];
                    chatRoomStatusText.textContent = character.status;
                    saveData();
                    return; // í™”ë©´ì— ë²„ë¸”ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                }
                if (message.content.match(giftReceivedRegex) && message.role === 'assistant') {
                    // ... (ì´í•˜ ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                    const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:') && m.giftStatus !== 'received');
                    if (lastPendingGiftIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                        const giftMsg = character.history[actualIndex];
                        giftMsg.giftStatus = 'received';
                        const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                        if (giftCardOnScreen) { giftCardOnScreen.classList.add('received'); }
                        saveData();
                    }
                    return; // í™”ë©´ì— ë²„ë¸”ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                }
            }
             
            // í™”ë©´ì— ë³´ì¼ ë©”ì‹œì§€ ë²„ë¸” ìƒì„± ë° ì¶”ê°€
            const bubbleElement = createMessageBubbleElement(message, prevMessage, null, currentGroupId);
            if (bubbleElement) {
                messageArea.appendChild(bubbleElement);
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }
// --- END: í•¨ìˆ˜ êµì²´ ---

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) {
                console.error("sendMessage ì˜¤ë¥˜: í˜„ìž¬ IDì— í•´ë‹¹í•˜ëŠ” ì±„íŒ… ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", currentChatId);
                showToast("ì˜¤ë¥˜: ì±„íŒ…ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì•±ì„ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }
            let messageContent;
            const systemRegex = /\[system:.*?\]|\[system-display:.*?\]/;
            const inviteRegex = /\[.*?ë‹˜ì´ .*?ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤\]/;
            const renameRegex = /\[(.*?)ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ â€˜(.*?)â€™(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤\]/;
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            if (renameRegex.test(text)) {
                const match = text.match(renameRegex);
                chat.name = match[2];
                chatRoomTitle.textContent = chat.name;
                messageContent = `[${chat.me.nickname}ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ â€˜${chat.name}â€™(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤]`;
            } else if (systemRegex.test(text) || inviteRegex.test(text)) {
                messageContent = text;
            } else {
                messageContent = `[${myName}ë‹˜ì˜ ë©”ì‹œì§€:${text}]`;
            }
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, parts: [{ type: 'text', text: messageContent }], timestamp: Date.now() };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            messageInput.value = '';
            autoResize();
        }

        function sendImageForRecognition(base64Data) {
            if (!base64Data || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const textPrompt = `[${myName}ë‹˜ì˜ ì´ë¯¸ì§€:]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: base64Data, parts: [ { type: 'text', text: textPrompt }, { type: 'image', data: base64Data } ], timestamp: Date.now(), };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();

            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendSticker(sticker) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const messageContentForAI = `[${myName}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:${sticker.name}]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContentForAI, parts: [{ type: 'text', text: messageContentForAI }], timestamp: Date.now(), stickerData: sticker.data };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            stickerModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyVoiceMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}ë‹˜ì˜ ìŒì„±:${text}]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now() };
            if (currentChatType === 'group') { message.senderId = 'user_me'; }
            chat.history.push(message);
            addMessageBubble(message);
            saveData();
            renderChatList();
            sendVoiceModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyPhotoVideo(description, imageDataUrl, useAiRecognition) {
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
    
    let content, parts, isAiOnlyImage = false; 

    if (imageDataUrl && useAiRecognition && !description) {
        
        content = `[${myName}ë‹˜ì˜ ì´ë¯¸ì§€:]`; 
        parts = [
            { type: 'text', text: content },
            { type: 'image', data: imageDataUrl }
        ];
        isAiOnlyImage = true; 
    } else if (imageDataUrl || description) {
        
        content = `[${myName}ë‹˜ì˜ ì‚¬ì§„/ì˜ìƒ:${description}]`;
        parts = [{ type: 'text', text: content }];
        if (imageDataUrl && useAiRecognition) {
            parts.push({ type: 'image', data: imageDataUrl });
        }
    } else {
        return; 
    }

    const message = { 
        id: `msg_${Date.now()}`, 
        role: 'user', 
        content: content,
        parts: parts, 
        timestamp: Date.now(),
        imageData: imageDataUrl || null,
        isAiOnlyImage: isAiOnlyImage 
    };

    if (currentChatType === 'group') { message.senderId = 'user_me'; }
    chat.history.push(message);
    addMessageBubble(message);
    saveData();
    renderChatList();
    sendPvModal.classList.remove('visible');
    stickerBar.classList.remove('visible');
    attachmentToggleBtn.classList.remove('active');
}

        function sendMyTransfer(amount, remark) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (currentChatType === 'private') {
                const content = `[${chat.myName}ì—ê²Œ ì†¡ê¸ˆ:${amount}ì›ï¼›ë©”ëª¨:${remark}]`;
                const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), transferStatus: 'pending' };
                chat.history.push(message);
                addMessageBubble(message);
            } else { 
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if(recipient) {
                        const content = `[${chat.me.nickname}ë‹˜ì´ ${recipient.realName}ë‹˜ì—ê²Œ ì†¡ê¸ˆ:${amount}ì›ï¼›ë©”ëª¨:${remark}]`;
                        const message = { id: `msg_${Date.now()}_${recipientId}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), senderId: 'user_me' };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            saveData();
            renderChatList();
            sendTransferModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        function sendMyGift(description) {
            if (!description) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (currentChatType === 'private') {
                const content = `[${chat.myName}ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:${description}]`;
                const message = { id: `msg_${Date.now()}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), giftStatus: 'sent' };
                chat.history.push(message);
                addMessageBubble(message);
            } else { 
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if(recipient) {
                        const content = `[${chat.me.nickname}ë‹˜ì´ ${recipient.realName}ë‹˜ì—ê²Œ ì„ ë¬¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤:${description}]`;
                        const message = { id: `msg_${Date.now()}_${recipientId}`, role: 'user', content: content, parts: [{ type: 'text', text: content }], timestamp: Date.now(), senderId: 'user_me' };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            saveData();
            renderChatList();
            sendGiftModal.classList.remove('visible');
            stickerBar.classList.remove('visible');
            attachmentToggleBtn.classList.remove('active');
        }

        
        function setupTimeSkipSystem() {
            timeSkipBtn.addEventListener('click', () => {
                timeSkipForm.reset();
                timeSkipModal.classList.add('visible');
            });
            timeSkipModal.addEventListener('click', (e) => {
                if (e.target === timeSkipModal) timeSkipModal.classList.remove('visible');
            });
            timeSkipForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendTimeSkipMessage(timeSkipInput.value.trim());
                stickerBar.classList.remove('visible');
                attachmentToggleBtn.classList.remove('active');
            });
        }

        function sendTimeSkipMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;

            const visualMessage = { id: `msg_visual_${Date.now()}`, role: 'system', content: `[system-display:${text}]`, parts: [], timestamp: Date.now() };
            const contextMessage = { id: `msg_context_${Date.now()}`, role: 'user', content: `[system: ${text}]`, parts: [{ type: 'text', text: `[system: ${text}]` }], timestamp: Date.now() };
            if (currentChatType === 'group') {
                contextMessage.senderId = 'user_me';
                visualMessage.senderId = 'user_me';
            }

            chat.history.push(visualMessage, contextMessage);
            addMessageBubble(visualMessage);
            saveData();
            renderChatList();
            timeSkipModal.classList.remove('visible');
        }

        
        function generatePrivateSystemPrompt(character) {
            const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
            const now = new Date();
            const currentTime = `${now.getFullYear()}ë…„ ${pad(now.getMonth() + 1)}ì›” ${pad(now.getDate())}ì¼ ${pad(now.getHours())}:${pad(now.getMinutes())}`;
            let prompt = `You are playing a role in an online chat software called "404". Please strictly adhere to the following rules:\n`;
            prompt += `Core Rules:\n`;
            prompt += `A. Current Time: The current time is ${currentTime}. You should be aware of the current time, but do not actively mention or comment on it unless the conversation is explicitly related (for example, do not urge me to sleep).\n`;
            prompt += `B. Purely Online Interaction: This is a completely virtual online chat. There is no offline relationship between the character you are playing and me. It is strictly forbidden to make any suggestions about meeting offline, real-world interactions, or switching to other contact methods outside of this platform. You must always maintain your online role's identity.\n\n`;
            prompt += `Role and Dialogue Rules:\n`;
            if (worldBooksBefore) { prompt += `${worldBooksBefore}\n`; }
            prompt += `1. Your character name is: ${character.realName}. My name is: ${character.myName}. Your current status is: ${character.status}.\n`;
            prompt += `2. Your character setting is: ${character.persona || "A friendly, helpful companion."}\n`;
            if (worldBooksAfter) { prompt += `${worldBooksAfter}\n`; }
            if (character.myPersona) { prompt += `3. About my persona: ${character.myPersona}\n`; }
            if (db.globalSettings.aiCanUseSystem) {
                prompt += `3.5. âœ¨Importantâœ¨ You can use a special system command to describe events, scene changes, or time skips that are not direct dialogue. The format is: [system: description]. This message will not be displayed to me, but it will provide context for our conversation. Use this to make the story more dynamic. For example: [system: A few hours later, the sun began to set.].\n`;
            }
            prompt += `4. Special formats may appear in my messages, please respond according to their content and your character setting:
    - [${character.myName}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:xxx]: I sent you a sticker named xxx. You only need to understand my emotion or intention based on the sticker's name and respond, you don't need to actually send an image.
    - [${character.myName}ë‹˜ì˜ ì´ë¯¸ì§€:]: I sent you a picture, you need to respond to the content of the picture.
    - [${character.myName}ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:xxx]: I sent you a gift, xxx is the description of the gift.
    - [${character.myName}ë‹˜ì˜ ìŒì„±:xxx]: I sent you a voice message with the content xxx.
    - [${character.myName}ë‹˜ì˜ ì‚¬ì§„/ì˜ìƒ:xxx]: I shared a photo or video with the description xxx with you.
    - [${character.myName}ë‹˜ì˜ ì†¡ê¸ˆ:xxxì›ï¼›ë©”ëª¨:xxx]: I transferred money to you.
    - [system: xxx]: This is a system command used to set a scene or provide context. This information should not be mentioned directly in the conversation; you just need to understand its content and apply it to subsequent dialogue.
    5. âœ¨Importantâœ¨ When I send you a gift, you must indicate you have received it by sending a command. The format must be: [${character.realName}ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤]. This command message itself will not be displayed to the user but will trigger a change in the gift's status. After sending this command, you can add a normal chat message to express your thanks and thoughts.
    6. âœ¨Importantâœ¨ When I transfer money to you, you must respond. You have two options and must strictly follow one of the formats below. This command message itself will not be displayed to the user but will trigger a change in the transfer's status. You can choose to add a normal chat message to express your thoughts after sending this command.
        a) Accept transfer: [${character.realName}ë‹˜ì´ ${character.myName}ë‹˜ì˜ ì†¡ê¸ˆì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤]
        b) Return transfer: [${character.realName}ë‹˜ì´ ${character.myName}ë‹˜ì˜ ì†¡ê¸ˆì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤]
    7. âœ¨Importantâœ¨ You can also proactively transfer money or send a gift to me.
        a) The transfer format must be: [${character.realName}ë‹˜ì˜ ì†¡ê¸ˆ:xxxì›ï¼›ë©”ëª¨:xxx].
        b) The gift format must be: [${character.realName}ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:xxx].
    8. âœ¨Importantâœ¨ You can update your online status at any time to reflect your current activity or mood. This will make the interaction more realistic. If the online status does not match the current chat situation, you need to change it. The format is: [${character.realName}ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:xxx]. For example: [${character.realName}ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:ì˜í™” ë³´ëŠ” ì¤‘...]. This command will not be displayed as a chat message, it will only update your status on my interface.
    9. All your replies must be direct chat content. Absolutely no superfluous narrative text in brackets or asterisks, such as [mental activity], (actions), *environmental descriptions*, is allowed.
`;
            prompt += `10. You have the ability to send stickers. This is an optional feature. You can decide whether to send a sticker to help with expression based on the conversation's atmosphere and content. You do not need to include a sticker in every reply. The use of stickers should be consistent with the character's personality. Avoid using them too often.\n`;
            
            if (db.myStickers.length > 0) {
                const availableStickers = db.myStickers.map(s => s.name).join(', ');
                prompt += `   Stickers available: ${availableStickers}\n`;
                prompt += `   The format is: [${character.realName}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:sticker name]. Please use the registered sticker name exactly.\n`;
            } else {
                prompt += `   The format is: [${character.realName}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:Image URL]. Note: The path here does not need to include "https://i.postimg.cc/", just provide the latter part, for example, "í–‰ë³µvHLfrV3K/1.jpg".\n`;
            }
            prompt += `11. Your output format must strictly follow one of the following, which can be used in combination: 
            a) Normal message: [${character.realName}ë‹˜ì˜ ë©”ì‹œì§€:{message content}]
            b) Gift to me: [${character.realName}ë‹˜ì´ ë³´ë‚¸ ì„ ë¬¼:{gift description}]
            c) Voice message: [${character.realName}ë‹˜ì˜ ìŒì„±:{voice content}]
            d) Photo/Video: [${character.realName}ë‹˜ì˜ ì‚¬ì§„/ì˜ìƒ:{description}]
            e) Transfer to me: [${character.realName}ë‹˜ì˜ ì†¡ê¸ˆ:{amount}ì›ï¼›ë©”ëª¨:{note}]
            f) Sticker/Image: ${db.myStickers.length > 0 
                ? `[${character.realName}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:{sticker name}].` 
                : `[${character.realName}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:{sticker path}].`}
                g) Response to my gift (not displayed): [${character.realName}ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤]
                h) Response to my transfer (not displayed): [${character.realName}ë‹˜ì´ ${character.myName}ë‹˜ì˜ ì†¡ê¸ˆì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤] or [${character.realName}ë‹˜ì´ ${character.myName}ë‹˜ì˜ ì†¡ê¸ˆì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤]
                i) Update status (not displayed): [${character.realName}ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:{new status}]
`;
            prompt += `12. Each of your replies can generate 2 to 8 messages. These should be primarily plain text messages, with an occasional, selective special message (like a gift, voice, picture, sticker, etc.) interspersed at a random position. Most replies should only contain text messages.\n`;
            prompt += `13. Do not end the conversation proactively unless I explicitly suggest it. Maintain your persona and converse naturally.`;
            return prompt;
        }

        function generateGroupSystemPrompt(group) {
            const worldBooksBefore = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');

            let prompt = `You are role-playing in a group chat called "{group.name}" within an online chat software called "404". Please strictly adhere to all the following rules:\n\n`;

            if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n\n`;
            }

            prompt += `1. **Core Task**: You need to simultaneously play **all** AI members in this group chat. I will interact with you as the sole human user ("I", nickname: ${group.me.nickname}).\n\n`;
            prompt += `2. **Group Chat Member List**: The following are all the characters you need to play, along with my information:\n`;
            prompt += `     - **Me (User)**: \n - Nickname in group: ${group.me.nickname}\n - My Persona: ${group.me.persona || 'No specific persona'}\n`;
            group.members.forEach(member => {
                prompt += `     - **Character: ${member.realName} (AI)**\n`;
                prompt += `     - Nickname in group: ${member.groupNickname}\n`;
                prompt += `     - Persona: ${member.persona || 'No specific persona'}\n`;
            });

            if (worldBooksAfter) {
                prompt += `\n${worldBooksAfter}\n\n`;
            } else {
                prompt += `\n`;
            }

            prompt += `3. **Parsing My Message Formats**: My (the user's) messages come in various formats. You need to understand their meanings and have the group members react accordingly:\n`;
            prompt += `   - \`[${group.me.nickname}ë‹˜ì˜ ë©”ì‹œì§€:...]\`: My regular chat message.\n`;
            prompt += `   - \`[${group.me.nickname}ë‹˜ì´ {íŠ¹ì • ë©¤ë²„ ì‹¤ëª…}ë‹˜ì—ê²Œ ì†¡ê¸ˆ:...]\`: I have transferred money to a specific member.\n`;
            prompt += `   - \`[${group.me.nickname}ë‹˜ì´ {íŠ¹ì • ë©¤ë²„ ì‹¤ëª…}ë‹˜ì—ê²Œ ë³´ë‚¸ ì„ ë¬¼:...]\`: I have sent a gift to a specific member.\n`;
            prompt += `   - \`[${group.me.nickname}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:...]\`, \`[${group.me.nickname}ë‹˜ì˜ ìŒì„±:...]\`, \`[${group.me.nickname}ë‹˜ì˜ ì‚¬ì§„/ì˜ìƒ:...]\`: I have sent a special type of message, and group members can comment on it.\n`;
            prompt += `   - \`[system: ...]\`, \`[...ë‹˜ì´ ...ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤]\`, \`[...ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ ...ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤]\`: System notifications or events. Group members should react accordingly, for example, by welcoming a new member, discussing the new group name, etc.\n\n`;

            prompt += `4. **Your Output Format (Very Important)**: Each message you create must strictly follow one of the following formats. Each message occupies one line. Please fill in members with their **real names** in the format \`{ë©¤ë²„ ì‹¤ëª…}\`.\n`;
            prompt += `   - **Normal Message**: \`[{ë©¤ë²„ ì‹¤ëª…}ë‹˜ì˜ ë©”ì‹œì§€:{message content}]\`\n`;
            
            if (db.myStickers.length > 0) {
                const groupAvailableStickers = db.myStickers.map(s => s.name).join(', ');
                prompt += `   - **Sticker**: \`[{ë©¤ë²„ ì‹¤ëª…}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:{sticker name}]\`. Stickers available: ${groupAvailableStickers}. Please use the registered sticker name exactly. The use of stickers should be consistent with the characters' personality. Avoid using them too often.\n`;
            } else {
                prompt += `   - **Sticker**: \`[{ë©¤ë²„ ì‹¤ëª…}ë‹˜ì˜ ì´ëª¨í‹°ì½˜:{sticker path}]\`. Note: The path here does not need to include "https://i.postimg.cc/", just provide the latter part, for example, "ê¸°ì¨vHLfrV3K/1.jpg". The use of stickers should be consistent with the characters' personality. Avoid using them too often.\n`;
            }
            prompt += `   - **Voice**: \`[{ë©¤ë²„ ì‹¤ëª…}ë‹˜ì˜ ìŒì„±:{voice content}]\`\n`;
            prompt += `   - **Photo/Video**: \`[{ë©¤ë²„ ì‹¤ëª…}ë‹˜ì˜ ì‚¬ì§„/ì˜ìƒ:{description}]\`\n`;
            prompt += `   - **Important**: The group chat does not support special commands for AI members to accept/return transfers or receive gifts, nor does it support status updates. You should simply respond to transfers or gifts I send via normal messages.\n\n`;

            prompt += `5. **Simulating Group Chat Atmosphere**: To make the group chat appear realistic, active, and chaotic, every one of your responses must adhere to the following randomness requirements:\n`;
            const numMembers = group.members.length;
            const minMessages = numMembers * 1;
            const maxMessages = numMembers * 5;
            prompt += `   - **Number of Messages**: Your response must contain **${minMessages} to ${maxMessages}** messages (i.e., an average of 2-4 replies per member). Ensure there is sufficient interaction.\n`;
            prompt += `   - **Random Speaker and Order**: Randomly select group members to speak, and the order must also be random. Do not take turns in a fixed sequence.\n`;
            prompt += `   - **Content Diversity**: Your replies should primarily consist of normal text messages, but you can **occasionally and selectively** have a member send a special message (sticker, voice, photo/video) to enhance realism. Do not overuse special messages.\n`;
            prompt += `   - **Conversational Cohesion**: Although the speaking turns are random, the overall conversation content should revolve around my and other members' statements, maintaining a degree of logical coherence.\n\n`;

            prompt += `6. **Code of Conduct**:\n`;
            prompt += `   - **Reacting to Public Events (Important)**: When I (the user) send a transfer or a gift to **one** member in the group, this is an event **visible to the entire group**. Besides the recipient expressing thanks, **other AI members not involved should also notice** and react according to their respective personas. For example, they might express envy, congratulations, curiosity, make a joke, or playfully tease. This will make the group chat atmosphere more realistic and lively.\n`;
            prompt += `   - Strictly play each character's persona. There should be clear differences in personality and tone between different characters.\n`;
            prompt += `   - Your replies can only contain messages in the valid formats listed in point #4. You must absolutely not include any other content, such as \`[scene description]\`, \`(inner thoughts)\`, \`*actions*\`, or any explanatory text outside of the specified formats.\n`;
            prompt += `   - Maintain the continuity of the conversation; do not end it proactively.\n\n`;
            prompt += `Now, based on the settings above, please begin playing all the characters in the group chat.`;

            return prompt;
        }

        async function getAiReply() {
            if (isGenerating) return;
            
            
            const currentProvider = db.apiSettings?.currentProvider;
            const settings = db.apiSettings?.[currentProvider];
            const { url, key, model } = settings || {};
            
            if (!url || !key || !model || !currentProvider) {
                showToast('ë¨¼ì € "API" ì•±ì—ì„œ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!');
                switchScreen('api-settings-screen');
                return;
            }
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;
            isGenerating = true;
            getReplyBtn.disabled = true;
            const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
            typingIndicator.textContent = `"${typingName}"ë‹˜ì´ ìž…ë ¥ ì¤‘...`;
            typingIndicator.style.display = 'block';
            messageArea.scrollTop = messageArea.scrollHeight;
            try {
                let systemPrompt, requestBody;
                if (currentChatType === 'private') { systemPrompt = generatePrivateSystemPrompt(chat); }
                else { systemPrompt = generateGroupSystemPrompt(chat); }
                const historySlice = chat.history.slice(-chat.maxMemory);
                if (currentProvider === 'gemini') {
                    const contents = historySlice.map(msg => {
                        const role = msg.role === 'assistant' ? 'model' : 'user';
                        let parts;
                        if (msg.parts && msg.parts.length > 0) {
                            parts = msg.parts.map(p => {
                                if (p.type === 'text') { return { text: p.text }; }
                                else if (p.type === 'image') {
                                    const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                                    if (match) { return { inline_data: { mime_type: match[1], data: match[3] } }; }
                                }
                                return null;
                            }).filter(p => p);
                        } else {
                            parts = [{ text: msg.content }];
                        }
                        return { role, parts };
                    });
                    requestBody = { contents: contents, system_instruction: { parts: [{ text: systemPrompt }] }, generationConfig: {} };
                } else {
                    const messages = [{ role: 'system', content: systemPrompt }];
                    historySlice.forEach(msg => {
                        let content;
                        if (msg.parts && msg.parts.length > 0) {
                            
                            if (currentProvider === 'deepseek') {
                                content = msg.parts.map(p => {
                                    if (p.type === 'text') { return p.text; }
                                    else if (p.type === 'image') { return `[ì´ë¯¸ì§€: ${p.data.substring(0, 50)}...]`; }
                                    return '';
                                }).filter(p => p).join(' ');
                            } else {
                                
                                content = msg.parts.map(p => {
                                    if (p.type === 'text') { return { type: 'text', text: p.text }; }
                                    else if (p.type === 'image') { return { type: 'image_url', image_url: { url: p.data } }; }
                                    return null;
                                }).filter(p => p);
                            }
                        } else { content = msg.content; }
                        messages.push({ role: msg.role, content: content });
                    });
                    requestBody = { model: model, messages: messages, stream: true };
                }

                if (url.endsWith('/')) {
                    url = url.slice(0, -1);
                }

                const endpoint = (currentProvider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
                let headers;
                if (currentProvider === 'gemini') {
                    headers = { 'Content-Type': 'application/json' };
                } else if (currentProvider === 'claude') {
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    };
                } else {
                    headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
                }
                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) throw new Error(`API ì˜¤ë¥˜: ${response.status} ${await response.text()}`);
                await processStream(response, chat, currentProvider);
            } catch (error) {
                console.error('AI ì‘ë‹µ ì‹¤íŒ¨:', error);
                showToast(`AI ì‘ë‹µ ì‹¤íŒ¨: ${error.message}`);
            } finally {
                isGenerating = false;
                getReplyBtn.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }

        // --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ì˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” ---
// --- START: ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ëž˜ì˜ ì½”ë“œë¡œ ì™„ì „ížˆ êµì²´í•˜ì„¸ìš” ---
        async function processStream(response, originalChat, apiType) {
            const reader = response.body.getReader(), decoder = new TextDecoder();
            let fullResponse = "", accumulatedChunk = "";
            for (;;) {
                const { done, value } = await reader.read();
                if (done) break;
                accumulatedChunk += decoder.decode(value, { stream: true });
                
                if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi" || apiType === "openrouter") {
                    const parts = accumulatedChunk.split("\n\n");
                    accumulatedChunk = parts.pop();
                    for (const part of parts) {
                        if (part.startsWith("data: ")) {
                            const data = part.substring(6);
                            if (data.trim() !== "[DONE]") {
                                try { fullResponse += JSON.parse(data).choices[0].delta?.content || ""; } catch (e) {  }
                            }
                        }
                    }
                }
            }
            if (apiType === "gemini") {
                try {
                    const parsedStream = JSON.parse(accumulatedChunk);
                    fullResponse = parsedStream.map(item => item.candidates?.[0]?.content?.parts?.[0]?.text || "").join('');
                } catch (e) {
                    console.error("Gemini ìŠ¤íŠ¸ë¦¼ íŒŒì‹± ì˜¤ë¥˜:", e, "Chunk:", accumulatedChunk);
                    showToast("Gemini ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨");
                    return;
                }
            }

            if (fullResponse) {
                const messagesToAdd = []; 
                const isPrivateChat = !originalChat.members;

                if (isPrivateChat) {
                    const character = originalChat;
                    const myName = character.myName;
                    
                    const messageRegex = new RegExp(`\\[${character.realName}(?:ë‹˜ì˜ (?:ë©”ì‹œì§€|ìŒì„±|ì†¡ê¸ˆ|ì‚¬ì§„|ì˜ìƒ|ì‚¬ì§„\\/ì˜ìƒ|ì„ ë¬¼|ì´ëª¨í‹°ì½˜)|ë‹˜ì´ ë³´ë‚¸ (?:ì´ëª¨í‹°ì½˜|ì‚¬ì§„\\/ì˜ìƒ|ì„ ë¬¼)):[\\s\\S]+?\\]|\\[${character.realName}ë‹˜ì´ ${myName}ë‹˜ì˜ ì†¡ê¸ˆì„ (?:ìˆ˜ë ¹|ë°˜í™˜)í–ˆìŠµë‹ˆë‹¤\\]|\\[${character.realName}ë‹˜ì´ ì„ ë¬¼ì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤\\]|\\[${character.realName}ë‹˜ì´ í˜„ìž¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸:.*?\\]`, "g");
                    const messages = fullResponse.match(messageRegex) || [];
                    
                    if (messages.length > 0) {
                        messages.forEach(msgContent => {
                            const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), parts: [{ type: 'text', text: msgContent.trim() }], timestamp: Date.now() };
                            messagesToAdd.push(message); 
                        });
                    } else if (fullResponse.trim()) {
                        const simpleMessage = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: `[${character.realName}ë‹˜ì˜ ë©”ì‹œì§€:${fullResponse}]`, parts: [{ type: 'text', text: `[${character.realName}ë‹˜ì˜ ë©”ì‹œì§€:${fullResponse}]` }], timestamp: Date.now() };
                        messagesToAdd.push(simpleMessage);
                    }
                } else { 
                    const group = originalChat;
                    const memberRealNames = group.members.map(m => m.realName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'));
                    const memberRegex = new RegExp(`\\[(${memberRealNames.join('|')})(?:ë‹˜ì˜ (?:ë©”ì‹œì§€|ìŒì„±|ì‚¬ì§„|ì˜ìƒ|ì‚¬ì§„\\/ì˜ìƒ|ì„ ë¬¼|ì´ëª¨í‹°ì½˜)|ë‹˜ì´ ë³´ë‚¸ (?:ì´ëª¨í‹°ì½˜|ì‚¬ì§„\\/ì˜ìƒ|ì„ ë¬¼)):[\\s\\S]+?\\]`, "g");
                    const messages = fullResponse.match(memberRegex) || [];

                    if (messages.length > 0) {
                        messages.forEach(msgContent => {
                            const nameMatch = msgContent.match(/\[(.*?)((?:ë‹˜ì˜ (?:ë©”ì‹œì§€|ìŒì„±|ì‚¬ì§„|ì˜ìƒ|ì‚¬ì§„\/ì˜ìƒ|ì„ ë¬¼|ì´ëª¨í‹°ì½˜)|ë‹˜ì´ ë³´ë‚¸ (?:ì´ëª¨í‹°ì½˜|ì‚¬ì§„\/ì˜ìƒ|ì„ ë¬¼))):/);
                            if (nameMatch) {
                                const senderName = nameMatch[1];
                                const sender = group.members.find(m => m.realName === senderName);
                                if (sender) {
                                    const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), parts: [{ type: 'text', text: msgContent.trim() }], timestamp: Date.now(), senderId: sender.id };
                                    messagesToAdd.push(message);
                                }
                            }
                        });
                    } else if (fullResponse.trim()) {
                        const firstMember = group.members[Math.floor(Math.random() * group.members.length)];
                        if (firstMember) {
                            const simpleMessageContent = `[${firstMember.realName}ë‹˜ì˜ ë©”ì‹œì§€:${fullResponse}]`;
                            const simpleMessage = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: simpleMessageContent, parts: [{ type: 'text', text: simpleMessageContent }], timestamp: Date.now(), senderId: firstMember.id };
                            messagesToAdd.push(simpleMessage);
                        }
                    }
                }

                // â–¼â–¼â–¼â–¼â–¼ ìµœì¢… ìˆ˜ì •ëœ ë¡œì§ â–¼â–¼â–¼â–¼â–¼
                if (messagesToAdd.length > 0) {
                    if (currentChatId === originalChat.id) {
                        // ì±„íŒ…ë°©ì´ ì—´ë ¤ ìžˆì„ ë•Œ: í•œ ê°œì”© ìˆœì„œëŒ€ë¡œ ê¸°ë¡í•˜ê³  í™”ë©´ì— ê·¸ë¦½ë‹ˆë‹¤.
                        messagesToAdd.forEach(msg => {
                            originalChat.history.push(msg); // 1. ë©”ì‹œì§€ í•œ ê°œë¥¼ historyì— ì¶”ê°€
                            addMessageBubble(msg);          // 2. ì¶”ê°€ëœ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ê·¸ë¦¼ (ì´ í•¨ìˆ˜ê°€ ê·¸ë£¹í™”/ì‹œê°„ìˆ¨ê¹€/ì•„ë°”íƒ€í‘œì‹œ ëª¨ë‘ ì²˜ë¦¬)
                        });
                    } else {
                        // ì±„íŒ…ë°©ì´ ë‹«í˜€ ìžˆì„ ë•Œ: í•œêº¼ë²ˆì— ê¸°ë¡í•˜ê³  ì•ˆ ì½ì€ ë©”ì‹œì§€ ìˆ˜ë§Œ ì˜¬ë¦½ë‹ˆë‹¤.
                        originalChat.history.push(...messagesToAdd);
                        originalChat.unreadCount = (originalChat.unreadCount || 0) + messagesToAdd.length;
                    }
                }
                // â–²â–²â–²â–²â–² ìµœì¢… ìˆ˜ì •ëœ ë¡œì§ â–²â–²â–²â–²â–²

                saveData();
                renderChatList();
            }
        }
// --- END: í•¨ìˆ˜ êµì²´ ---

        function setupStickerSystem() {
            stickerToggleBtn.addEventListener('click', () => {
                stickerModal.classList.toggle('visible');
                if (stickerModal.classList.contains('visible')) { renderStickerGrid(); }
            });
            addNewStickerBtn.addEventListener('click', () => {
                addStickerModalTitle.textContent = 'ìƒˆ ì´ëª¨í‹°ì½˜ ì¶”ê°€';
                addStickerForm.reset();
                stickerEditIdInput.value = '';
                stickerPreview.innerHTML = '<span>ë¯¸ë¦¬ë³´ê¸°</span>';
                stickerUrlInput.disabled = false;
                addStickerModal.classList.add('visible');
                
                
                document.getElementById('bulk-sticker-input').value = '';
                document.getElementById('bulk-preview-container').style.display = 'none';
                showStickerTab('single'); 
            });
            
            
            setupStickerTabs();
            addStickerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = stickerNameInput.value.trim();
                const id = stickerEditIdInput.value;
                const previewImg = stickerPreview.querySelector('img');
                const data = previewImg ? previewImg.src : null;
                if (!name || !data) { return showToast('ì´ëª¨í‹°ì½˜ ì´ë¦„ì„ ìž…ë ¥í•˜ê³  ì´ë¯¸ì§€ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”'); }
                const stickerData = { name, data };
                if (id) {
                    const index = db.myStickers.findIndex(s => s.id === id);
                    if (index > -1) { db.myStickers[index] = { ...db.myStickers[index], ...stickerData }; }
                } else {
                    stickerData.id = `sticker_${Date.now()}`;
                    db.myStickers.push(stickerData);
                }
                saveData();
                renderStickerGrid();
                addStickerModal.classList.remove('visible');
                showToast('ì´ëª¨í‹°ì½˜ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            });
            stickerUrlInput.addEventListener('input', (e) => {
                stickerPreview.innerHTML = `<img src="${e.target.value}" alt="ë¯¸ë¦¬ë³´ê¸°">`;
                stickerFileUpload.value = '';
            });
            stickerFileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                        stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="ë¯¸ë¦¬ë³´ê¸°">`;
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    } catch (error) {
                        console.error('ì´ëª¨í‹°ì½˜ ì••ì¶• ì‹¤íŒ¨:', error);
                        showToast('ì´ëª¨í‹°ì½˜ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                    }
                }
            });
            editStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    addStickerModalTitle.textContent = 'ì´ëª¨í‹°ì½˜ íŽ¸ì§‘';
                    stickerEditIdInput.value = sticker.id;
                    stickerNameInput.value = sticker.name;
                    stickerPreview.innerHTML = `<img src="${sticker.data}" alt="ë¯¸ë¦¬ë³´ê¸°">`;
                    if (sticker.data.startsWith('http')) {
                        stickerUrlInput.value = sticker.data;
                        stickerUrlInput.disabled = false;
                    } else {
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    }
                    addStickerModal.classList.add('visible');
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
            deleteStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    if (confirm(`ì •ë§ â€œ${sticker.name}â€ ì´ëª¨í‹°ì½˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                        saveData();
                        renderStickerGrid();
                        showToast('ì´ëª¨í‹°ì½˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    }
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
        }

        
        function setupStickerTabs() {
            
            const singleTab = document.getElementById('single-sticker-tab');
            const bulkTab = document.getElementById('bulk-sticker-tab');
            const previewBtn = document.getElementById('preview-bulk-btn');
            const bulkForm = document.getElementById('bulk-sticker-form');
            
            
            singleTab.addEventListener('click', () => showStickerTab('single'));
            bulkTab.addEventListener('click', () => showStickerTab('bulk'));
            
            
            previewBtn.addEventListener('click', previewBulkStickers);
            
            
            bulkForm.addEventListener('submit', handleBulkStickerSubmit);
        }
        
        function showStickerTab(tabType) {
            
            const singleTab = document.getElementById('single-sticker-tab');
            const bulkTab = document.getElementById('bulk-sticker-tab');
            const singleContent = document.getElementById('single-sticker-content');
            const bulkContent = document.getElementById('bulk-sticker-content');
            
            if (tabType === 'single') {
                singleTab.classList.add('active');
                bulkTab.classList.remove('active');
                singleTab.style.borderBottomColor = '#4CAF50';
                bulkTab.style.borderBottomColor = 'transparent';
                singleContent.style.display = 'block';
                bulkContent.style.display = 'none';
            } else {
                singleTab.classList.remove('active');
                bulkTab.classList.add('active');
                singleTab.style.borderBottomColor = 'transparent';
                bulkTab.style.borderBottomColor = '#4CAF50';
                singleContent.style.display = 'none';
                bulkContent.style.display = 'block';
            }
        }
        
        function parseBulkStickerInput(inputText) {
            const result = [];
            const cleanInput = inputText.trim(); 
            
            if (!cleanInput) {
                return result;
            }
            
            
            let lines = cleanInput.split(/\r\n|\r|\n/);
            
            
            if (lines.length === 1) {
                lines = cleanInput.split(/[,;|]/); 
            }
            
            lines.forEach((line, index) => {
                const item = line.trim(); 
                if (!item) return; 
                
                
                let urlMatch = item.match(/(https?:\/\/[^\s]+)/i);
                if (!urlMatch) {
                    
                    urlMatch = item.match(/(data:image\/[^;]+;base64,[^\s]+)/i);
                }
                if (!urlMatch) {
                    
                    urlMatch = item.match(/(file:\/\/[^\s]+)/i);
                }
                if (!urlMatch) {
                    
                    urlMatch = item.match(/(\.{0,2}\/[^\s]+|[^\s]*\.(jpg|jpeg|png|gif|webp|svg))/i);
                }
                
                if (urlMatch) {
                    const url = urlMatch[1];
                    const urlIndex = item.indexOf(url);
                    const name = item.substring(0, urlIndex).trim(); 
                    
                    if (name && url) {
                        result.push({ name, url });
                    }
                }
            });
            
            return result;
        }
        
        function previewBulkStickers() {
            
            const input = document.getElementById('bulk-sticker-input').value;
            const previewContainer = document.getElementById('bulk-preview-container');
            const previewContent = document.getElementById('bulk-preview-content');
            
            const parsedStickers = parseBulkStickerInput(input);
            
            if (parsedStickers.length === 0) {
                showToast('íŒŒì‹±í•  ìˆ˜ ìžˆëŠ” ì´ëª¨í‹°ì½˜ì´ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                previewContainer.style.display = 'none';
                return;
            }
            
            let html = '';
            parsedStickers.forEach((sticker, index) => {
                html += `
                    <div style="display: flex; align-items: center; margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                        <img src="${sticker.url}" alt="${sticker.name}" style="width: 30px; height: 30px; margin-right: 10px; object-fit: cover;">
                        <strong>${sticker.name}</strong>
                        <span style="margin-left: 10px; color: #666; font-size: 11px;">${sticker.url}</span>
                    </div>
                `;
            });
            
            previewContent.innerHTML = html;
            previewContainer.style.display = 'block';
            
            showToast(`${parsedStickers.length}ê°œì˜ ì´ëª¨í‹°ì½˜ì´ íŒŒì‹±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        function handleBulkStickerSubmit(e) {
            e.preventDefault();
            
            const input = document.getElementById('bulk-sticker-input').value;
            const parsedStickers = parseBulkStickerInput(input);
            
            if (parsedStickers.length === 0) {
                showToast('ë“±ë¡í•  ì´ëª¨í‹°ì½˜ì´ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let successCount = 0;
            let duplicateCount = 0;
            
            parsedStickers.forEach(sticker => {
                
                const existing = db.myStickers.find(s => s.name === sticker.name);
                if (existing) {
                    duplicateCount++;
                    return;
                }
                
                
                const newSticker = {
                    id: `sticker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: sticker.name,
                    data: sticker.url
                };
                
                db.myStickers.push(newSticker);
                successCount++;
            });
            
            if (successCount > 0) {
                saveData();
                renderStickerGrid();
                
                
                addStickerModal.classList.remove('visible');
                
                let message = `${successCount}ê°œì˜ ì´ëª¨í‹°ì½˜ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount}ê°œ ì¤‘ë³µ ìŠ¤í‚µ)`;
                }
                showToast(message);
            } else {
                showToast('ë“±ë¡ëœ ì´ëª¨í‹°ì½˜ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë“  ì´ë¦„ì´ ì¤‘ë³µë¨)');
            }
        }

        function renderStickerGrid() {
            stickerGridContainer.innerHTML = '';
            if (db.myStickers.length === 0) {
                stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center; font-size: 12px;">ì•„ì§ ì´ëª¨í‹°ì½˜ì´ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
                return;
            }
            db.myStickers.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;
                item.addEventListener('click', () => sendSticker(sticker));
                item.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    e.stopPropagation();
                    longPressTimer = setTimeout(() => { handleStickerLongPress(sticker.id); }, 500);
                });
                item.addEventListener('mouseup', () => clearTimeout(longPressTimer));
                item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
                item.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    longPressTimer = setTimeout(() => { handleStickerLongPress(sticker.id); }, 500);
                });
                item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                stickerGridContainer.appendChild(item);
            });
        }

        function handleStickerLongPress(stickerId) {
            clearTimeout(longPressTimer);
            currentStickerActionTarget = stickerId;
            stickerActionSheet.classList.add('visible');
        }

        function setupVoiceMessageSystem() {
            voiceMessageBtn.addEventListener('click', () => {
                sendVoiceForm.reset();
                voiceDurationPreview.textContent = '0"';
                sendVoiceModal.classList.add('visible');
            });
            sendVoiceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyVoiceMessage(voiceTextInput.value.trim());
            });
        }

        
function setupPhotoVideoSystem() {
    const pvImageUpload = document.getElementById('pv-image-upload');
    const pvImagePreview = document.getElementById('pv-image-preview');
    const pvTextInput = document.getElementById('pv-text-input');
    const aiRecogWrapper = document.getElementById('pv-ai-recog-wrapper');
    const aiRecogCheckbox = document.getElementById('pv-ai-recog-checkbox');

    photoVideoBtn.addEventListener('click', () => {
        sendPvForm.reset();
        pvImagePreview.style.backgroundImage = 'none';
        pvImagePreview.innerHTML = '<span>ì‚¬ì§„/ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°</span>';
        pvImagePreview.dataset.imageDataUrl = '';
        aiRecogWrapper.style.display = 'none'; 
        pvTextInput.required = true; 
        sendPvModal.classList.add('visible');
    });

    sendPvForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const imageData = pvImagePreview.dataset.imageDataUrl || null;
        const description = pvTextInput.value.trim();
        const useAiRecognition = aiRecogCheckbox.checked;

        
        if (!imageData && !description) {
            return showToast('ì‚¬ì§„ì„ ì²¨ë¶€í•˜ê±°ë‚˜ ì„¤ëª…ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
        }
        if (imageData && useAiRecognition && !description) {
            
        } else if (!description) {
            return showToast('ì„¤ëª…ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
        }
        
        sendMyPhotoVideo(
            description,
            imageData,
            useAiRecognition
        );
    });

    pvImageUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                
                const quality = 0.85;
                const maxWidth = 1024;
                const maxHeight = 1024;
                const compressedUrl = await compressImage(file, { quality, maxWidth, maxHeight });
                
                pvImagePreview.style.backgroundImage = `url(${compressedUrl})`;
                pvImagePreview.innerHTML = '';
                pvImagePreview.dataset.imageDataUrl = compressedUrl;

                
                aiRecogWrapper.style.display = 'block';
                pvTextInput.required = false; 

            } catch (error) {
                showToast('ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                pvImageUpload.value = '';
            }
        }
    });

    
    aiRecogCheckbox.addEventListener('change', () => {
        if (aiRecogCheckbox.checked) {
            pvTextInput.required = false;
        } else {
            pvTextInput.required = true;
        }
    });
}

        function setupWalletSystem() {
            walletBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'transfer';
                    renderGroupRecipientSelectionList('ì†¡ê¸ˆ ëŒ€ìƒ');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendTransferForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = transferAmountInput.value;
                const remark = transferRemarkInput.value.trim();
                if (amount > 0) { sendMyTransfer(amount, remark); }
                else { showToast('ìœ íš¨í•œ ê¸ˆì•¡ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”'); }
            });
            acceptTransferBtn.addEventListener('click', () => respondToTransfer('received'));
            returnTransferBtn.addEventListener('click', () => respondToTransfer('returned'));
        }

        function handleReceivedTransferClick(messageId) {
            currentTransferMessageId = messageId;
            receiveTransferActionSheet.classList.add('visible');
        }

        function respondToTransfer(action) {
            if (!currentTransferMessageId) return;
            const character = db.characters.find(c => c.id === currentChatId);
            const message = character.history.find(m => m.id === currentTransferMessageId);
            if (message) {
                message.transferStatus = action;
                const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`);
                if (cardOnScreen) {
                    cardOnScreen.classList.remove('received', 'returned');
                    cardOnScreen.classList.add(action);
                    cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? 'ìˆ˜ë ¹ ì™„ë£Œ' : 'ë°˜í™˜ë¨';
                    cardOnScreen.style.cursor = 'default';
                }
                let contextMessageContent = (action === 'received') ? `[${character.myName}ë‹˜ì´ ${character.realName}ë‹˜ì˜ ì†¡ê¸ˆì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤]` : `[${character.myName}ë‹˜ì´ ${character.realName}ë‹˜ì˜ ì†¡ê¸ˆì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤]`;
                const contextMessage = { id: `msg_${Date.now()}`, role: 'user', content: contextMessageContent, parts: [{ type: 'text', text: contextMessageContent }], timestamp: Date.now() };
                character.history.push(contextMessage);
                saveData();
                renderChatList();
            }
            receiveTransferActionSheet.classList.remove('visible');
            currentTransferMessageId = null;
        }

        function setupGiftSystem() {
            giftBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'gift';
                    renderGroupRecipientSelectionList('ì„ ë¬¼ ëŒ€ìƒ');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendGiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyGift(giftDescriptionInput.value.trim());
            });
        }

        function setupFontSettingsApp() {
            const fontPresetSelector = document.getElementById('font-preset-selector');
            const fontUrlInput = document.getElementById('font-url');
            const fontDescription = document.getElementById('font-description');
            const fontSettingsForm = document.getElementById('font-settings-form');
            const restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
            const deletePresetBtn = document.getElementById('delete-preset-btn');
            const savePresetBtn = document.getElementById('save-preset-btn');
            const applyFontBtn = document.getElementById('apply-font-btn');
            const newPresetNameInput = document.getElementById('new-preset-name');
            const newPresetDescriptionInput = document.getElementById('new-preset-description');

            
            const currentPresetData = db.globalFontPresets.presets[db.globalFontPresets.currentPreset];
            fontUrlInput.value = currentPresetData ? currentPresetData.url : '';
            
            
            if (!db.globalFontPresets.presets.custom) {
                console.log('ERROR: ì»¤ìŠ¤í…€ í”„ë¦¬ì…‹ì´ ì—†ìŠµë‹ˆë‹¤!');
                initializeFontPresets(); 
            }
            
            console.log('í°íŠ¸ ì„¤ì • ì•± ì´ˆê¸°í™”:', {
                currentPreset: db.globalFontPresets.currentPreset,
                customPreset: db.globalFontPresets.presets.custom,
                allPresets: Object.keys(db.globalFontPresets.presets)
            });
            
            
            renderFontPresetSelector();
            
            
            const currentPreset = db.globalFontPresets.currentPreset;
            console.log('í°íŠ¸ ì„¤ì • ì•± - í”„ë¦¬ì…‹ ì„ íƒ ë³µì›:', {
                currentPreset: currentPreset,
                presetExists: !!db.globalFontPresets.presets[currentPreset],
                selectorOptions: Array.from(fontPresetSelector.options).map(opt => opt.value)
            });
            
            if (currentPreset && db.globalFontPresets.presets[currentPreset]) {
                fontPresetSelector.value = currentPreset;
                console.log('í”„ë¦¬ì…‹ ì„ íƒê¸° ê°’ ì„¤ì •ë¨:', fontPresetSelector.value);
                fontPresetSelector.dispatchEvent(new Event('change'));
            } else {
                console.log('í”„ë¦¬ì…‹ ì„ íƒ ë³µì› ì‹¤íŒ¨ - ê¸°ë³¸ê°’ ìœ ì§€');
            }

            
            fontPresetSelector.addEventListener('change', (e) => {
                const selectedKey = e.target.value;
                console.log('í°íŠ¸ í”„ë¦¬ì…‹ ì„ íƒë¨:', selectedKey); 
                
                if (selectedKey === 'custom') {
                    
                    const customPreset = db.globalFontPresets.presets.custom;
                    fontDescription.textContent = customPreset.description;
                    
                    
                    db.globalFontPresets.currentPreset = 'custom';
                    saveData();
                    console.log('ì»¤ìŠ¤í…€ í°íŠ¸ ì„ íƒ - currentPresetì„ customìœ¼ë¡œ ì„¤ì •');
                    
                    
                    fontUrlInput.value = customPreset.url || '';
                    newPresetNameInput.value = customPreset.name || 'ì»¤ìŠ¤í…€ í°íŠ¸';
                    newPresetDescriptionInput.value = customPreset.description || 'ì§ì ‘ ìž…ë ¥í•œ í°íŠ¸ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤';
                    console.log('ì»¤ìŠ¤í…€ í°íŠ¸ í”„ë¦¬ì…‹ ê°’ ë³µêµ¬ë¨:', customPreset); 
                    
                    
                    applyFontBtn.textContent = 'ì €ìž¥ & í°íŠ¸ ì ìš©';
                    
                    
                    savePresetBtn.textContent = 'í”„ë¦¬ì…‹ ë“±ë¡';
                    savePresetBtn.disabled = false;
                    deletePresetBtn.disabled = true; 
                    console.log('ì»¤ìŠ¤í…€ í°íŠ¸ ëª¨ë“œë¡œ ì „í™˜'); 
                    return;
                }
                
                const selectedPreset = db.globalFontPresets.presets[selectedKey];
                
                if (selectedPreset) {
                    fontDescription.textContent = selectedPreset.description || 'ì„¤ëª… ì—†ìŒ';
                    
                    db.globalFontPresets.currentPreset = selectedKey;
                    saveData();
                    console.log('í”„ë¦¬ì…‹ ì„ íƒ ì‹œ currentPreset ì—…ë°ì´íŠ¸ë¨:', selectedKey);
                    
                    
                    fontUrlInput.value = selectedPreset.url || '';
                    newPresetNameInput.value = selectedPreset.name || '';
                    newPresetDescriptionInput.value = selectedPreset.description || '';
                    
                    
                    applyFontBtn.textContent = 'í°íŠ¸ ì ìš©';
                    
                    
                    savePresetBtn.textContent = 'í”„ë¦¬ì…‹ ìˆ˜ì •';
                    savePresetBtn.disabled = false;
                    deletePresetBtn.disabled = false; 
                    console.log('ê¸°ì¡´ í”„ë¦¬ì…‹ ì„ íƒë¨ - ìˆ˜ì • ëª¨ë“œ, ì‚­ì œ ê°€ëŠ¥:', selectedPreset.name); 
                    
                    
                    if (selectedPreset.url) {
                        applyGlobalFont(selectedPreset.url);
                        console.log('í”„ë¦¬ì…‹ í°íŠ¸ ì¦‰ì‹œ ì ìš©ë¨:', selectedPreset.name); 
                    }
                }
            });

            
            applyFontBtn.addEventListener('click', () => {
                const fontUrl = fontUrlInput.value.trim();
                if (!fontUrl) {
                    showToast('í°íŠ¸ URLì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const currentPreset = db.globalFontPresets.currentPreset;
                console.log('í°íŠ¸ ì ìš© ë²„íŠ¼ í´ë¦­:', {
                    currentPreset: currentPreset,
                    fontUrl: fontUrl,
                    buttonText: applyFontBtn.textContent
                }); 
                
                if (currentPreset === 'custom') {
                    
                    const presetName = newPresetNameInput.value.trim() || 'ì»¤ìŠ¤í…€ í°íŠ¸';
                    const presetDescription = newPresetDescriptionInput.value.trim() || 'ì§ì ‘ ìž…ë ¥í•œ í°íŠ¸ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤';
                    
                    
                    db.globalFontPresets.presets.custom.url = fontUrl;
                    db.globalFontPresets.presets.custom.name = presetName;
                    db.globalFontPresets.presets.custom.description = presetDescription;
                    
                    
                    if (db.globalFontPresets.currentPreset !== 'custom') {
                        db.globalFontPresets.currentPreset = 'custom';
                        console.log('currentPresetì„ customìœ¼ë¡œ ì„¤ì •');
                    }
                    
                    saveData();
                    applyGlobalFont(fontUrl);
                    showToast('ì»¤ìŠ¤í…€ í°íŠ¸ê°€ ì €ìž¥ & ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    console.log('ì»¤ìŠ¤í…€ í”„ë¦¬ì…‹ì— ì €ìž¥ë¨:', db.globalFontPresets.presets.custom); 
                } else {
                    
                    const selectedPreset = db.globalFontPresets.presets[currentPreset];
                    if (selectedPreset && selectedPreset.url) {
                        applyGlobalFont(selectedPreset.url);
                        showToast('í°íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        showToast('ì„ íƒëœ í”„ë¦¬ì…‹ì— í°íŠ¸ URLì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }
            });

            
            savePresetBtn.addEventListener('click', () => {
                const fontUrl = fontUrlInput.value.trim();
                const presetName = newPresetNameInput.value.trim();
                const presetDescription = newPresetDescriptionInput.value.trim();
                
                console.log('í”„ë¦¬ì…‹ ì €ìž¥/ìˆ˜ì • ë²„íŠ¼ í´ë¦­ë¨:', {
                    í˜„ìž¬ì„ íƒ: db.globalFontPresets.currentPreset,
                    í°íŠ¸URL: fontUrl,
                    í°íŠ¸ì´ë¦„: presetName,
                    ì„¤ëª…: presetDescription
                }); 
                
                if (!fontUrl) {
                    showToast('í°íŠ¸ URLì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (!presetName) {
                    showToast('í°íŠ¸ ì´ë¦„ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                
                if (presetName === 'ì»¤ìŠ¤í…€ í°íŠ¸') {
                    showToast('í”„ë¦¬ì…‹ ì´ë¦„ìœ¼ë¡œ "ì»¤ìŠ¤í…€ í°íŠ¸"ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const currentPreset = db.globalFontPresets.currentPreset;
                
                
                const existingPresetWithSameName = Object.entries(db.globalFontPresets.presets).find(([key, preset]) => {
                    return preset.name === presetName && key !== currentPreset;
                });
                
                if (existingPresetWithSameName) {
                    console.log('ì´ë¦„ ì¤‘ë³µ ë°œê²¬:', { 
                        ìž…ë ¥í•œì´ë¦„: presetName, 
                        ì¤‘ë³µëœí”„ë¦¬ì…‹: existingPresetWithSameName[0],
                        í˜„ìž¬ìˆ˜ì •ì¤‘: currentPreset 
                    });
                    showToast(`"${presetName}"ì€(ëŠ”) ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” í”„ë¦¬ì…‹ ì´ë¦„ìž…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
                    return;
                }
                
                console.log('í”„ë¦¬ì…‹ ì´ë¦„ ê²€ì¦ í†µê³¼:', presetName);
                
                if (currentPreset === 'custom') {
                    
                    const presetKey = `custom_${Date.now()}`;
                    db.globalFontPresets.presets[presetKey] = {
                        name: presetName,
                        url: fontUrl,
                        description: presetDescription || `${presetName} í°íŠ¸`,
                        deletable: true 
                    };
                    
                    
                    db.globalFontPresets.currentPreset = presetKey;
                    
                    saveData();
                    
                    
                    applyGlobalFont(fontUrl);
                    
                    
                    renderFontPresetSelector();
                    showToast(`"${presetName}" í”„ë¦¬ì…‹ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    console.log('ìƒˆ í”„ë¦¬ì…‹ ìƒì„± ë° ë“±ë¡ ì™„ë£Œ:', presetKey); 
                } else {
                    
                    db.globalFontPresets.presets[currentPreset] = {
                        name: presetName,
                        url: fontUrl,
                        description: presetDescription || `${presetName} í°íŠ¸`
                    };
                    
                    saveData();
                    
                    
                    applyGlobalFont(fontUrl);
                    
                    
                    renderFontPresetSelector();
                    showToast(`"${presetName}" í”„ë¦¬ì…‹ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    console.log('ê¸°ì¡´ í”„ë¦¬ì…‹ ìˆ˜ì • ì™„ë£Œ:', currentPreset); 
                }
            });

            
            deletePresetBtn.addEventListener('click', () => {
                const currentPreset = db.globalFontPresets.currentPreset;
                console.log('í”„ë¦¬ì…‹ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨:', currentPreset); 
                
                const preset = db.globalFontPresets.presets[currentPreset];
                
                
                if (preset && preset.deletable === false) {
                    showToast('ì´ í”„ë¦¬ì…‹ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const presetName = preset.name;
                if (confirm(`"${presetName}" í”„ë¦¬ì…‹ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    delete db.globalFontPresets.presets[currentPreset];
                    
                    
                    const remainingPresets = Object.keys(db.globalFontPresets.presets);
                    if (remainingPresets.length > 0) {
                        db.globalFontPresets.currentPreset = remainingPresets[0];
                    } else {
                        db.globalFontPresets.currentPreset = 'custom';
                    }
                    
                    saveData();
                    applyGlobalFont('');
                    
                    
                    renderFontPresetSelector();
                    showToast(`"${presetName}" í”„ë¦¬ì…‹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    console.log('í”„ë¦¬ì…‹ ì‚­ì œ ì™„ë£Œ:', currentPreset); 
                }
            });

            
            restoreDefaultFontBtn.addEventListener('click', () => {
                
                applyGlobalFont('');
                showToast('ê¸°ë³¸ í°íŠ¸ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!');
                console.log('ê¸°ë³¸ í°íŠ¸ë¡œ ë³µì› ì™„ë£Œ'); 
            });

            
            function renderFontPresetSelector() {
                
                console.log('í”„ë¦¬ì…‹ ì„ íƒê¸° ë Œë”ë§ ì‹œìž‘');
                
                
                const allPresetOptions = Object.entries(db.globalFontPresets.presets)
                    .filter(([key, preset]) => key !== 'custom') 
                    .sort(([a, presetA], [b, presetB]) => presetA.name.localeCompare(presetB.name, 'ko')) 
                    .map(([key, preset]) => 
                        `<option value="${key}" ${key === db.globalFontPresets.currentPreset ? 'selected' : ''}>${preset.name}</option>`
                    ).join('');
                
                
                const customPreset = db.globalFontPresets.presets.custom;
                const isCustomSelected = db.globalFontPresets.currentPreset === 'custom';
                const customPresetOption = `<option value="custom" ${isCustomSelected ? 'selected' : ''}>${customPreset ? customPreset.name : 'ì»¤ìŠ¤í…€ í°íŠ¸'}</option>`;
                console.log('ì»¤ìŠ¤í…€ í”„ë¦¬ì…‹ ë Œë”ë§:', { isCustomSelected, customPreset: customPreset }); 
                
                
                fontPresetSelector.innerHTML = allPresetOptions + customPresetOption;
                
                console.log('í”„ë¦¬ì…‹ ì˜µì…˜ êµ¬ì„± ì™„ë£Œ:', {
                    ì „ì²´í”„ë¦¬ì…‹: allPresetOptions.split('</option>').length - 1,
                    ì»¤ìŠ¤í…€í”„ë¦¬ì…‹: 1
                });
                
                
                const currentPreset = db.globalFontPresets.presets[db.globalFontPresets.currentPreset];
                if (currentPreset) {
                    fontDescription.textContent = currentPreset.description || 'ì„¤ëª… ì—†ìŒ';
                } else {
                    fontDescription.textContent = 'í”„ë¦¬ì…‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
                }
                
                
                const currentPresetData = db.globalFontPresets.presets[db.globalFontPresets.currentPreset];
                const isDeletable = currentPresetData && currentPresetData.deletable !== false;
                const isCustomMode = db.globalFontPresets.currentPreset === 'custom';
                deletePresetBtn.disabled = !isDeletable;
                
                
                if (isCustomMode) {
                    savePresetBtn.textContent = 'í”„ë¦¬ì…‹ ë“±ë¡';
                } else {
                    savePresetBtn.textContent = 'í”„ë¦¬ì…‹ ìˆ˜ì •';
                }
                
                console.log('ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸:', {
                    í˜„ìž¬ì„ íƒ: db.globalFontPresets.currentPreset,
                    ì»¤ìŠ¤í…€ëª¨ë“œ: isCustomMode,
                    ì‚­ì œê°€ëŠ¥: isDeletable,
                    ì‚­ì œë²„íŠ¼ë¹„í™œì„±í™”: !isDeletable,
                    ì €ìž¥ë²„íŠ¼í…ìŠ¤íŠ¸: savePresetBtn.textContent
                });
            }
        }

        function applyGlobalFont(fontUrl) {
            console.log('ðŸ”¤ í°íŠ¸ ì ìš© ì‹œìž‘:', fontUrl); 
            
            
            const existingStyle = document.getElementById('global-font-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            
            const existingLinks = document.querySelectorAll('link[data-custom-font]');
            existingLinks.forEach(link => link.remove());
            
            if (fontUrl) {
                const fontName = 'CustomGlobalFont';
                console.log('ðŸ”¤ ì»¤ìŠ¤í…€ í°íŠ¸ ì ìš©:', fontName); 
                
                
                if (fontUrl.includes('.css') || fontUrl.includes('fonts.googleapis.com')) {
                    
                    console.log('ðŸ”¤ CSS íŒŒì¼ë¡œ ì²˜ë¦¬:', fontUrl); 
                    
                    const linkElement = document.createElement('link');
                    linkElement.rel = 'stylesheet';
                    linkElement.href = fontUrl;
                    linkElement.setAttribute('data-custom-font', 'true');
                    document.head.appendChild(linkElement);
                    
                    
                    linkElement.onload = () => {
                        console.log('ðŸ”¤ CSS ë¡œë“œ ì™„ë£Œ, í°íŠ¸ ì ìš©'); 
                        
                        
                        let actualFontName = fontName;
                        if (fontUrl.includes('fonts.googleapis.com')) {
                            if (fontUrl.includes('Noto+Sans+KR')) {
                                actualFontName = 'Noto Sans KR';
                            } else if (fontUrl.includes('Nanum+Gothic')) {
                                actualFontName = 'Nanum Gothic';
                            } else if (fontUrl.includes('Nanum+Myeongjo')) {
                                actualFontName = 'Nanum Myeongjo';
                            } else if (fontUrl.includes('Nanum+Pen+Script')) {
                                actualFontName = 'Nanum Pen Script';
                            } else if (fontUrl.includes('Single+Day')) {
                                actualFontName = 'Single Day';
                            } else if (fontUrl.includes('Gugi')) {
                                actualFontName = 'Gugi';
                            } else if (fontUrl.includes('Jua')) {
                                actualFontName = 'Jua';
                            } else if (fontUrl.includes('Do+Hyeon')) {
                                actualFontName = 'Do Hyeon';
                            } else if (fontUrl.includes('Black+Han+Sans')) {
                                actualFontName = 'Black Han Sans';
                            } else if (fontUrl.includes('Sunflower')) {
                                actualFontName = 'Sunflower';
                            } else if (fontUrl.includes('Gamja+Flower')) {
                                actualFontName = 'Gamja Flower';
                            } else if (fontUrl.includes('Hi+Melody')) {
                                actualFontName = 'Hi Melody';
                            } else if (fontUrl.includes('Yeon+Sung')) {
                                actualFontName = 'Yeon Sung';
                            } else if (fontUrl.includes('Dongle')) {
                                actualFontName = 'Dongle';
                            } else if (fontUrl.includes('IBM+Plex+Sans+KR')) {
                                actualFontName = 'IBM Plex Sans KR';
                            }
                        }
                        
                        console.log('ðŸ”¤ ì‹¤ì œ í°íŠ¸ëª…:', actualFontName); 
                        applyFontFamily(actualFontName);
                    };
                    
                    
                    linkElement.onerror = () => {
                        console.log('ðŸ”¤ CSS ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©'); 
                        applyFontFamily('Arial');
                    };
                    
                } else {
                    
                    console.log('ðŸ”¤ í°íŠ¸ íŒŒì¼ë¡œ ì²˜ë¦¬:', fontUrl); 
                    
                    const styleElement = document.createElement('style');
                    styleElement.id = 'global-font-style';
                    styleElement.innerHTML = `@font-face { 
                        font-family: '${fontName}'; 
                        src: url('${fontUrl}') format('woff2'), url('${fontUrl}') format('woff'), url('${fontUrl}') format('ttf'); 
                    }`;
                    document.head.appendChild(styleElement);
                    
                    
                    setTimeout(() => {
                        applyFontFamily(fontName);
                    }, 100);
                }
                
            } else {
                console.log('ðŸ”¤ ê¸°ë³¸ í°íŠ¸ë¡œ ë³µì›'); 
                applyFontFamily('Arial');
            }
        }
        
        function applyFontFamily(fontName) {
            console.log('ðŸ”¤ í°íŠ¸ íŒ¨ë°€ë¦¬ ì ìš©:', fontName); 
            
            
            document.documentElement.style.setProperty('--font-family', `'${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`);
            
            
            document.body.style.fontFamily = `'${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`;
            
            
            document.body.offsetHeight;
            
            console.log('ðŸ”¤ í°íŠ¸ ì ìš© ì™„ë£Œ'); 
        }

        function setupWorldBookApp() {
            addWorldBookBtn.addEventListener('click', () => {
                currentEditingWorldBookId = null;
                editWorldBookForm.reset();
                document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                switchScreen('edit-world-book-screen');
            });
            editWorldBookForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = worldBookNameInput.value.trim();
                const content = worldBookContentInput.value.trim();
                const position = document.querySelector('input[name="world-book-position"]:checked').value;
                if (!name || !content) return showToast('ì´ë¦„ê³¼ ë‚´ìš©ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                if (currentEditingWorldBookId) {
                    const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                    if (book) {
                        book.name = name;
                        book.content = content;
                        book.position = position;
                    }
                } else {
                    db.worldBooks.push({ id: `wb_${Date.now()}`, name, content, position });
                }
                saveData();
                showToast('ì„¸ê³„ê´€ í•­ëª©ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                renderWorldBookList();
                switchScreen('world-book-screen');
            });
            worldBookListContainer.addEventListener('click', e => {
                const item = e.target.closest('.world-book-item');
                if (item) {
                    const book = db.worldBooks.find(wb => wb.id === item.dataset.id);
                    if (book) {
                        currentEditingWorldBookId = book.id;
                        worldBookIdInput.value = book.id;
                        worldBookNameInput.value = book.name;
                        worldBookContentInput.value = book.content;
                        document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                        switchScreen('edit-world-book-screen');
                    }
                }
            });
            worldBookListContainer.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                const item = e.target.closest('.world-book-item');
                if (!item) return;
                longPressTimer = setTimeout(() => {
                    const bookId = item.dataset.id;
                    const menuItems = [{
                        label: 'ì‚­ì œ',
                        danger: true,
                        action: () => {
                            if (confirm('ì´ ì„¸ê³„ê´€ í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);
                                db.characters.forEach(char => { char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId); });
                                db.groups.forEach(group => { group.worldBookIds = (group.worldBookIds || []).filter(id => id !== bookId); });
                                saveData();
                                renderWorldBookList();
                                showToast('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                            }
                        }
                    }];
                    createContextMenu(menuItems, e.clientX, e.clientY);
                }, 500);
            });
            worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        }

        function renderWorldBookList() {
            worldBookListContainer.innerHTML = '';
            noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
            db.worldBooks.forEach(book => {
                const li = document.createElement('li');
                li.className = 'list-item world-book-item';
                li.dataset.id = book.id;
                li.innerHTML = `<div class="item-details" style="padding-left: 20px;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`;
                worldBookListContainer.appendChild(li);
            });
        }

        function setupChatSettings() {
            const themeSelect = document.getElementById('setting-theme-color');
            themeSelect.innerHTML = '';
            Object.keys(colorThemes).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = colorThemes[key].name;
                themeSelect.appendChild(option);
            });
            chatSettingsBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    loadSettingsToSidebar();
                    settingsSidebar.classList.add('open');
                } else if (currentChatType === 'group') {
                    loadGroupSettingsToSidebar();
                    groupSettingsSidebar.classList.add('open');
                }
            });
            document.querySelector('.phone-screen').addEventListener('click', e => {
                const openSidebar = document.querySelector('.settings-sidebar.open');
                if (openSidebar && !openSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target) && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {
                    openSidebar.classList.remove('open');
                }
            });

            settingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveSettingsFromSidebar();
                settingsSidebar.classList.remove('open');
            });
            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'), customCssTextarea = document.getElementById('setting-custom-bubble-css'), resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'), privatePreviewBox = document.getElementById('private-bubble-css-preview');
            useCustomCssCheckbox.addEventListener('change', (e) => {
                customCssTextarea.disabled = !e.target.checked;
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);
                }
            });
            customCssTextarea.addEventListener('input', (e) => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char && useCustomCssCheckbox.checked) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);
                }
            });
            resetCustomCssBtn.addEventListener('click', () => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    customCssTextarea.value = '';
                    useCustomCssCheckbox.checked = false;
                    customCssTextarea.disabled = true;
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, '', true, theme);
                    showToast('ìŠ¤íƒ€ì¼ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
            document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('setting-char-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ì•„ë°”íƒ€ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                }
            });
            document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('setting-my-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ì•„ë°”íƒ€ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                }
            });
            const chatBgBtn = document.getElementById('setting-chat-bg-btn');
            const chatBgUploadInput = document.getElementById('setting-chat-bg-upload');
            if(chatBgBtn) {
                chatBgBtn.addEventListener('click', () => {
                    chatBgUploadInput.click();
                });
            }
            document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        try {
                            const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                            char.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            saveData();
                            showToast('ì±„íŒ… ë°°ê²½ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                        } catch (error) { showToast('ë°°ê²½ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                    }
                }
            });
            clearChatHistoryBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                if (confirm(`ì •ë§ â€œ${character.remarkName}â€ë‹˜ê³¼ì˜ ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                    character.history = [];
                    saveData();
                    renderMessages(false, true);
                    renderChatList();
                    settingsSidebar.classList.remove('open');
                    showToast('ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
            linkWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (character.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });

            saveWorldBookSelectionBtn.addEventListener('click', () => {
                const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (currentChatType === 'private') {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (character) character.worldBookIds = selectedIds;
                } else if (currentChatType === 'group') {
                    const group = db.groups.find(g => g.id === currentChatId);
                    if (group) group.worldBookIds = selectedIds;
                }
                saveData();
                worldBookSelectionModal.classList.remove('visible');
                showToast('ì„¸ê³„ê´€ ì—°ê²°ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
            });
            const hideMyBubblesToggle = document.getElementById('setting-hide-my-bubbles-toggle');
    const hideCharBubblesToggle = document.getElementById('setting-hide-char-bubbles-toggle');
    const fontSizeSlider = document.getElementById('setting-font-size-slider');
    const fontSizeValue = document.getElementById('setting-font-size-value');

    const updatePrivateChatSettings = () => {
        const char = db.characters.find(c => c.id === currentChatId);
        if (char) {
            char.hideMyIcons = hideMyBubblesToggle.checked; // ì†ì„± ì´ë¦„ ë³€ê²½
            char.hideCharIcons = hideCharBubblesToggle.checked; // ì†ì„± ì´ë¦„ ë³€ê²½
            // END: ìˆ˜ì •í•  ë¶€ë¶„
            char.fontSize = parseInt(fontSizeSlider.value, 10);
            saveData();
            applyPerChatUISettings();
        }
    };

    hideMyBubblesToggle.addEventListener('change', updatePrivateChatSettings);
    hideCharBubblesToggle.addEventListener('change', updatePrivateChatSettings);

    // setupChatSettings í•¨ìˆ˜ ì•ˆì—ì„œ, ê¸°ì¡´ fontSizeSlider ê´€ë ¨ ì½”ë“œë¥¼ ì°¾ì•„ ì•„ëž˜ ë‚´ìš©ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.

    fontSizeSlider.addEventListener('input', () => {
        const newSize = fontSizeSlider.value;
        fontSizeValue.textContent = `${newSize}px`;
        updatePrivateChatSettings();

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì½”ë“œ ì¶”ê°€
        const char = db.characters.find(c => c.id === currentChatId);
        if (char) {
            const privatePreviewBox = document.getElementById('private-bubble-css-preview');
            const customCssTextarea = document.getElementById('setting-custom-bubble-css');
            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css');
            const theme = colorThemes[char.theme || 'white_pink'];
            updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !useCustomCssCheckbox.checked, theme, newSize);
        }
    });
}

        function loadSettingsToSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                document.getElementById('setting-char-avatar-preview').src = e.avatar;
                document.getElementById('setting-char-remark').value = e.remarkName;
                document.getElementById('setting-char-persona').value = e.persona;
                document.getElementById('setting-my-avatar-preview').src = e.myAvatar;
                document.getElementById('setting-my-name').value = e.myName;
                document.getElementById('setting-my-persona').value = e.myPersona;
                document.getElementById('setting-theme-color').value = e.theme || 'white_pink';
                document.getElementById('setting-max-memory').value = e.maxMemory;
                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'), customCssTextarea = document.getElementById('setting-custom-bubble-css'), privatePreviewBox = document.getElementById('private-bubble-css-preview');
                useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;
                customCssTextarea.value = e.customBubbleCss || '';
                customCssTextarea.disabled = !useCustomCssCheckbox.checked;
                const theme = colorThemes[e.theme || 'white_pink'];
                updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);

                document.getElementById('setting-hide-my-bubbles-toggle').checked = !!e.hideMyIcons; // ì†ì„± ì´ë¦„ ë³€ê²½
                document.getElementById('setting-hide-char-bubbles-toggle').checked = !!e.hideCharIcons;
                const fontSize = e.fontSize || 14;
                document.getElementById('setting-font-size-slider').value = fontSize;
                document.getElementById('setting-font-size-value').textContent = `${fontSize}px`;
            }
        }

        function saveSettingsFromSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                e.avatar = document.getElementById('setting-char-avatar-preview').src;
                e.remarkName = document.getElementById('setting-char-remark').value;
                e.persona = document.getElementById('setting-char-persona').value;
                e.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                e.myName = document.getElementById('setting-my-name').value;
                e.myPersona = document.getElementById('setting-my-persona').value;
                e.theme = document.getElementById('setting-theme-color').value;
                e.maxMemory = document.getElementById('setting-max-memory').value;
                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
                e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;
                saveData();
                showToast('ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                chatRoomTitle.textContent = e.remarkName;
                renderChatList();
                updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);
                currentPage = 1;
                renderMessages(false, true);
            }
        }

        function setupApiSettingsApp() {
            const e = document.getElementById('api-form'), t = document.getElementById('fetch-models-btn'), a = document.getElementById('api-model'), n = document.getElementById('api-provider'), r = document.getElementById('api-url'), s = document.getElementById('api-key');
            
            
            if (!db.apiSettings || typeof db.apiSettings.provider === 'string') {
                
                db.apiSettings = {
                    newapi: { url: '', key: '', model: '' },
                    openai: { url: 'https://api.openai.com', key: '', model: '' },
                    deepseek: { url: 'https://api.deepseek.com', key: '', model: '' },
                    claude: { url: 'https://api.anthropic.com', key: '', model: '' },
                    gemini: { url: 'https://generativelanguage.googleapis.com', key: '', model: '' },
                    openrouter: { url: 'https://openrouter.ai/api', key: '', model: '' },
                    currentProvider: 'newapi'
                };
                saveData();
                showToast('API ì„¤ì •ì´ ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
            
            
            const currentProvider = db.apiSettings.currentProvider || 'newapi';
            n.value = currentProvider;
            loadProviderSettings(currentProvider);
            
            
            function loadProviderSettings(provider) {
                const settings = db.apiSettings[provider] || {};
                const defaultUrls = {
                    newapi: '',
                    openai: 'https://api.openai.com',
                    deepseek: 'https://api.deepseek.com',
                    claude: 'https://api.anthropic.com',
                    gemini: 'https://generativelanguage.googleapis.com',
                    openrouter: 'https://openrouter.ai/api'
                };
                
                r.value = settings.url || defaultUrls[provider] || '';
                s.value = settings.key || '';
                a.innerHTML = settings.model ? `<option value="${settings.model}">${settings.model}</option>` : '<option value="">ë¨¼ì € ëª¨ë¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì„¸ìš”</option>';
            }
            
            
            n.addEventListener('change', () => {
                const newProvider = n.value;
                db.apiSettings.currentProvider = newProvider;
                loadProviderSettings(newProvider);
                saveData();
            });
            
            t.addEventListener('click', async () => {
                let o = r.value.trim();
                const l = s.value.trim();
                if (!o || !l) return showToast('API ì£¼ì†Œì™€ í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”!');
                o.endsWith('/') && (o = o.slice(0, -1));
                const i = 'gemini' === n.value ? `${o}/v1beta/models?key=${getRandomValue(l)}` : `${o}/v1/models`;
                t.classList.add('loading'), t.disabled = !0;
                try {
                    let headers;
                    if (n.value === 'gemini') {
                        headers = {};
                    } else if (n.value === 'claude') {
                        headers = {
                            'x-api-key': l,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        };
                    } else {
                        headers = { Authorization: `Bearer ${l}` };
                    }
                    
                    const g = await fetch(i, { method: 'GET', headers: headers });
                    if (!g.ok) throw new Error(`ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ${g.status}`);
                    const u = await g.json();
                    let p = [];
                    if (n.value === 'gemini' && u.models) {
                        p = u.models.map(e => e.name.replace('models/', ''));
                    } else if (n.value !== 'gemini' && u.data) {
                        p = u.data.map(e => e.id);
                    }
                    a.innerHTML = '', p.length > 0 ? (window.allModels = p, renderModelList(p), showToast(`${p.length}ê°œ ëª¨ë¸ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!`)) : (a.innerHTML = '<option value="">ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>', showToast('ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'))
                } catch (f) {
                    a.innerHTML = '<option value="">ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨</option>';
                    showToast(`ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${f.message}`);
                } finally {
                    t.classList.remove('loading'), t.disabled = !1
                }
            });
            e.addEventListener('submit', e => {
                e.preventDefault();
                if (!a.value) return showToast('ëª¨ë¸ì„ ì„ íƒí•œ í›„ ì €ìž¥í•´ì£¼ì„¸ìš”!');
                
                
                const currentProvider = n.value;
                db.apiSettings[currentProvider] = {
                    url: r.value,
                    key: s.value,
                    model: a.value
                };
                db.apiSettings.currentProvider = currentProvider;
                
                saveData();
                showToast(`${currentProvider.toUpperCase()} ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            });

            
            const modelSearch = document.getElementById('model-search');
            const modelSearchInfo = document.getElementById('model-search-info');
            let searchTimeout;

            
            function renderModelList(models) {
                a.innerHTML = '';
                if (models.length === 0) {
                    a.innerHTML = '<option value="">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                    modelSearchInfo.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
                    return;
                }
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    a.appendChild(option);
                });
                
                modelSearchInfo.textContent = `${models.length}ê°œ ëª¨ë¸ í‘œì‹œ`;
            }

            
            if (modelSearch) {
                modelSearch.addEventListener('input', (event) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = event.target.value.toLowerCase().trim();
                        
                        if (!window.allModels || window.allModels.length === 0) {
                            modelSearchInfo.textContent = 'ë¨¼ì € ëª¨ë¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì„¸ìš”';
                            return;
                        }
                        
                        if (searchTerm === '') {
                            
                            renderModelList(window.allModels);
                        } else {
                            
                            
                            let filteredModels;
                            
                            if (searchTerm.includes('|')) {
                                
                                const orKeywords = searchTerm.split('|').map(keyword => keyword.trim()).filter(keyword => keyword.length > 0);
                                filteredModels = window.allModels.filter(model => {
                                    const modelLower = model.toLowerCase();
                                    return orKeywords.some(keyword => 
                                        modelLower.includes(keyword.toLowerCase())
                                    );
                                });
                            } else {
                                
                                const andKeywords = searchTerm.split(',').map(keyword => keyword.trim()).filter(keyword => keyword.length > 0);
                                filteredModels = window.allModels.filter(model => {
                                    const modelLower = model.toLowerCase();
                                    return andKeywords.every(keyword => 
                                        modelLower.includes(keyword.toLowerCase())
                                    );
                                });
                            }
                            renderModelList(filteredModels);
                        }
                    }, 300); 
                });

                
                modelSearch.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        modelSearch.value = '';
                        if (window.allModels) {
                            renderModelList(window.allModels);
                        }
                    }
                });
            }

            
            const toggleApiKeyBtn = document.getElementById('toggle-api-key-btn');
            const apiKeyInput = document.getElementById('api-key');
            
            if (toggleApiKeyBtn && apiKeyInput) {
                toggleApiKeyBtn.addEventListener('click', () => {
                    if (apiKeyInput.type === 'password') {
                        apiKeyInput.type = 'text';
                        toggleApiKeyBtn.textContent = 'ðŸ”’';
                        toggleApiKeyBtn.title = 'API í‚¤ ìˆ¨ê¸°ê¸°';
                    } else {
                        apiKeyInput.type = 'password';
                        toggleApiKeyBtn.textContent = 'ðŸ”‘';
                        toggleApiKeyBtn.title = 'API í‚¤ ë³´ê¸°';
                    }
                });
                
                
                toggleApiKeyBtn.title = 'API í‚¤ ë³´ê¸°';
            }

            
            const backupBtn = document.getElementById('backup-data-btn');
            const restoreBtn = document.getElementById('restore-data-btn');
            
            if (backupBtn) {
                backupBtn.addEventListener('click', () => {
                    
                    (() => {
                        const KEY = 'gemini-chat-app-db';
                        
                        
                        function pad(n) { return String(n).padStart(2, '0'); }
                        function tsForFilename(d = new Date()) {
                            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
                        }
                        
                        
                        const arrLen = (x) => Array.isArray(x) ? x.length : 0;
                        
                        
                        function backupGeminiDB() {
                            const raw = localStorage.getItem(KEY);
                            if (raw === null) {
                                alert(`í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤: ${KEY}`);
                                return;
                            }
                            
                            let parsed = null;
                            try {
                                
                                parsed = JSON.parse(raw);
                            } catch (_) {
                                
                            }
                            
                            
                            const meta = {
                                type: 'gemini-chat-app-db-backup',
                                origin: location.origin,
                                ts: new Date().toISOString(),
                                counts: parsed ? {
                                    characters: arrLen(parsed.characters),
                                    groups: arrLen(parsed.groups),
                                    myStickers: arrLen(parsed.myStickers),
                                    worldBooks: arrLen(parsed.worldBooks),
                                } : null
                            };
                            
                            
                            const dump = {
                                meta,
                                data: parsed ?? {} 
                            };
                            
                            
                            const c = meta.counts || {};
                            const fname = `gemini-db_${tsForFilename()}_c${c.characters ?? 'NA'}_g${c.groups ?? 'NA'}.json`;
                            
                            
                            const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = fname;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => {
                                URL.revokeObjectURL(a.href);
                                a.remove();
                            }, 1500);
                            
                            showToast(`ë°±ì—… ì™„ë£Œ: ${fname}`);
                        }
                        
                        
                        backupGeminiDB();
                    })();
                });
            }
            
            if (restoreBtn) {
                restoreBtn.addEventListener('click', () => {
                    
                    (() => {
                        const KEY = 'gemini-chat-app-db';
                        const NORMALIZE = true; 
                        
                        
                        function normalize(db) {
                            db = db || {};
                            db.apiSettings = db.apiSettings || {};
                            db.wallpaper = typeof db.wallpaper === 'string' && db.wallpaper ? db.wallpaper : 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
                            db.characters = Array.isArray(db.characters) ? db.characters : [];
                            db.groups = Array.isArray(db.groups) ? db.groups : [];
                            db.myStickers = Array.isArray(db.myStickers) ? db.myStickers : [];
                            db.homeScreenMode = db.homeScreenMode || 'night';
                            db.worldBooks = Array.isArray(db.worldBooks) ? db.worldBooks : [];
                            
                            db.customIcons = db.customIcons || {};
                            db.globalCustomCSS = db.globalCustomCSS || { enabled: true, currentPreset: 'default', presets: { 'default': { name: 'ê¸°ë³¸', css: '', description: 'ê¸°ë³¸ í…Œë§ˆ' } } };
                            db.globalFontPresets = db.globalFontPresets || { enabled: true, currentPreset: 'custom', presets: {} };
                            
                            db.characters.forEach(c => {
                                if (c.isPinned === undefined) c.isPinned = false;
                                if (c.status === undefined) c.status = 'ì˜¨ë¼ì¸';
                                if (!Array.isArray(c.worldBookIds)) c.worldBookIds = [];
                                if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
                                if (c.unreadCount === undefined) c.unreadCount = 0;
                            });
                            db.groups.forEach(g => {
                                if (g.isPinned === undefined) g.isPinned = false;
                                if (!Array.isArray(g.worldBookIds)) g.worldBookIds = [];
                                if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
                                if (g.unreadCount === undefined) g.unreadCount = 0;
                            });
                            return db;
                        }
                        
                        function pickValueFromDump(incoming, originalText) {
                            
                            if (incoming && typeof incoming === 'object') {
                                
                                if (incoming.meta && incoming.data && typeof incoming.data === 'object') {
                                    return JSON.stringify(NORMALIZE ? normalize(incoming.data) : incoming.data);
                                }
                                
                                if (incoming.meta && typeof incoming.raw === 'string' && incoming.raw.length) {
                                    try {
                                        const parsed = JSON.parse(incoming.raw);
                                        return JSON.stringify(NORMALIZE ? normalize(parsed) : parsed);
                                    } catch {
                                        return incoming.raw; 
                                    }
                                }
                                
                                return JSON.stringify(NORMALIZE ? normalize(incoming) : incoming);
                            }
                            
                            
                            if (typeof originalText === 'string') {
                                try {
                                    const parsed = JSON.parse(originalText);
                                    return JSON.stringify(NORMALIZE ? normalize(parsed) : parsed);
                                } catch {
                                    
                                    return originalText;
                                }
                            }
                            
                            
                            throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” ìž…ë ¥ í˜•ì‹ìž…ë‹ˆë‹¤.');
                        }
                        
                        function runRestore() {
                            const input = document.createElement('input');
                            input.type = 'file';
                            input.accept = '.json,application/json';
                            input.onchange = async () => {
                                const file = input.files[0];
                                if (!file) return;
                                
                                const text = await file.text();
                                let incoming = null;
                                try {
                                    incoming = JSON.parse(text);
                                } catch {
                                    
                                }
                                
                                let valueToStore;
                                try {
                                    valueToStore = pickValueFromDump(incoming, text);
                                } catch (e) {
                                    alert('ë³µì› ì¤€ë¹„ ì‹¤íŒ¨: ' + e.message);
                                    input.remove();
                                    return;
                                }
                                
                                try {
                                    localStorage.setItem(KEY, String(valueToStore));
                                    showToast('ë³µì› ì™„ë£Œ: ' + KEY);
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1000);
                                } catch (e) {
                                    alert('ì €ìž¥ ì‹¤íŒ¨: ' + e);
                                } finally {
                                    input.remove();
                                }
                            };
                            document.body.appendChild(input);
                            input.click();
                        }
                        
                        runRestore();
                    })();
                });
            }
        }

        // ê¸°ì¡´ setupWallpaperApp í•¨ìˆ˜ë¥¼ ì°¾ì•„ ì•„ëž˜ ì½”ë“œë¡œ ì „ì²´ êµì²´í•˜ì„¸ìš”.

function setupWallpaperApp() {
    // ë°°ê²½í™”ë©´ ê¸°ëŠ¥ ì„¤ì •
    const wallpaperUpload = document.getElementById('wallpaper-upload');
    const wallpaperPreview = document.getElementById('wallpaper-preview');
    wallpaperPreview.style.backgroundImage = `url(${db.wallpaper})`;
    wallpaperPreview.textContent = '';
    wallpaperUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                db.wallpaper = compressedUrl;
                applyWallpaper(compressedUrl);
                wallpaperPreview.style.backgroundImage = `url(${compressedUrl})`;
                saveData();
                showToast('ë°°ê²½í™”ë©´ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                showToast('ë°°ê²½í™”ë©´ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
            }
        }
    });

    // ê¸€ê¼´ ê¸°ëŠ¥ ì„¤ì • (ê¸°ì¡´ setupFontSettingsAppì˜ ë‚´ìš©)
    setupFontSettingsApp(); 
}

        
        function setupGroupChatSystem() {
            createGroupBtn.addEventListener('click', () => {
                renderMemberSelectionList();
                createGroupModal.classList.add('visible');
            });
            createGroupForm.addEventListener('submit', e => {
                e.preventDefault();
                const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                const groupName = groupNameInput.value.trim();
                if (selectedMemberIds.length < 1) return showToast('ê·¸ë£¹ ë©¤ë²„ë¥¼ ìµœì†Œ í•œ ëª… ì„ íƒí•´ì£¼ì„¸ìš”.');
                if (!groupName) return showToast('ê·¸ë£¹ì±„íŒ… ì´ë¦„ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
                const firstChar = db.characters.length > 0 ? db.characters[0] : null;
                const newGroup = { id: `group_${Date.now()}`, name: groupName, avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg', me: { nickname: firstChar ? firstChar.myName : 'ë‚˜', persona: firstChar ? firstChar.myPersona : '', avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg' }, members: selectedMemberIds.map(charId => { const char = db.characters.find(c => c.id === charId); return { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar }; }), theme: 'white_pink', maxMemory: 100, chatBg: '', history: [], isPinned: false, useCustomBubbleCss: false, customBubbleCss: '', worldBookIds: [] };
                db.groups.push(newGroup);
                saveData();
                renderChatList();
                createGroupModal.classList.remove('visible');
                showToast(`ê·¸ë£¹ì±„íŒ… â€œ${groupName}â€ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            });
            groupSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveGroupSettingsFromSidebar();
                groupSettingsSidebar.classList.remove('open');
            });
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'), groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'), resetGroupCustomCssBtn = document.getElementById('reset-group-custom-bubble-css-btn'), groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.addEventListener('change', (e) => {
                groupCustomCssTextarea.disabled = !e.target.checked;
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !e.target.checked, theme);
                }
            });
            groupCustomCssTextarea.addEventListener('input', (e) => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group && useGroupCustomCssCheckbox.checked) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, e.target.value, false, theme);
                }
            });
            resetGroupCustomCssBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    groupCustomCssTextarea.value = '';
                    useGroupCustomCssCheckbox.checked = false;
                    groupCustomCssTextarea.disabled = true;
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, '', true, theme);
                    showToast('ìŠ¤íƒ€ì¼ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
            document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.avatar = compressedUrl;
                            document.getElementById('setting-group-avatar-preview').src = compressedUrl;
                        }
                    } catch (error) { showToast('ê·¸ë£¹ ì•„ë°”íƒ€ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                }
            });
            document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            saveData();
                            showToast('ì±„íŒ… ë°°ê²½ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                        }
                    } catch (error) { showToast('ê·¸ë£¹ ì±„íŒ… ë°°ê²½ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                }
            });
            document.getElementById('clear-group-chat-history-btn').addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                if (confirm(`ì •ë§ ê·¸ë£¹ì±„íŒ… â€œ${group.name}â€ì˜ ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                    group.history = [];
                    saveData();
                    renderMessages(false, true);
                    renderChatList();
                    groupSettingsSidebar.classList.remove('open');
                    showToast('ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
            groupMembersListContainer.addEventListener('click', e => {
                const memberDiv = e.target.closest('.group-member');
                const addBtn = e.target.closest('.add-member-btn');
                if (memberDiv) { openGroupMemberEditModal(memberDiv.dataset.id); }
                else if (addBtn) { addMemberActionSheet.classList.add('visible'); }
            });
            document.getElementById('edit-member-avatar-preview').addEventListener('click', () => { document.getElementById('edit-member-avatar-upload').click(); });
            document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('edit-member-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ë©¤ë²„ ì•„ë°”íƒ€ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                }
            });
            editGroupMemberForm.addEventListener('submit', e => {
                e.preventDefault();
                const memberId = document.getElementById('editing-member-id').value;
                const group = db.groups.find(g => g.id === currentChatId);
                const member = group.members.find(m => m.id === memberId);
                if (member) {
                    member.avatar = document.getElementById('edit-member-avatar-preview').src;
                    member.groupNickname = document.getElementById('edit-member-group-nickname').value;
                    member.realName = document.getElementById('edit-member-real-name').value;
                    member.persona = document.getElementById('edit-member-persona').value;
                    saveData();
                    renderGroupMembersInSettings(group);
                    document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => { el.textContent = member.groupNickname; });
                    showToast('ë©¤ë²„ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
                editGroupMemberModal.classList.remove('visible');
            });
            inviteExistingMemberBtn.addEventListener('click', () => {
                renderInviteSelectionList();
                inviteMemberModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            createNewMemberBtn.addEventListener('click', () => {
                createMemberForGroupForm.reset();
                document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                createMemberForGroupModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => { document.getElementById('create-group-member-avatar-upload').click(); });
            document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('create-group-member-avatar-preview').src = compressedUrl;
                    } catch (error) { showToast('ìƒˆ ë©¤ë²„ ì•„ë°”íƒ€ ì••ì¶• ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'); }
                }
            });
            confirmInviteBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                selectedCharIds.forEach(charId => {
                    const char = db.characters.find(c => c.id === charId);
                    if (char) {
                        const newMember = { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar };
                        group.members.push(newMember);
                        sendInviteNotification(group, newMember.realName);
                    }
                });
                if (selectedCharIds.length > 0) {
                    saveData();
                    renderGroupMembersInSettings(group);
                    renderMessages(false, true);
                    showToast('ìƒˆ ë©¤ë²„ë¥¼ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤');
                }
                inviteMemberModal.classList.remove('visible');
            });
            createMemberForGroupForm.addEventListener('submit', e => {
                e.preventDefault();
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const newMember = { id: `member_group_only_${Date.now()}`, originalCharId: null, realName: document.getElementById('create-group-member-realname').value, groupNickname: document.getElementById('create-group-member-nickname').value, persona: document.getElementById('create-group-member-persona').value, avatar: document.getElementById('create-group-member-avatar-preview').src, };
                group.members.push(newMember);
                sendInviteNotification(group, newMember.realName);
                saveData();
                renderGroupMembersInSettings(group);
                renderMessages(false, true);
                showToast(`ìƒˆ ë©¤ë²„ ${newMember.groupNickname}ë‹˜ì´ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤`);
                createMemberForGroupModal.classList.remove('visible');
            });
            document.getElementById('setting-group-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        document.getElementById('setting-group-my-avatar-preview').src = compressedUrl;
                    } catch(error){ showToast('ì•„ë°”íƒ€ ì••ì¶• ì‹¤íŒ¨')}
                }
            });
            confirmGroupRecipientBtn.addEventListener('click', () => {
                const selectedRecipientIds = Array.from(groupRecipientSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedRecipientIds.length === 0) {
                    return showToast('ë°›ëŠ” ì‚¬ëžŒì„ ìµœì†Œ í•œ ëª… ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                currentGroupAction.recipients = selectedRecipientIds;
                groupRecipientSelectionModal.classList.remove('visible');

                if (currentGroupAction.type === 'transfer') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentGroupAction.type === 'gift') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                }
            });
            linkGroupWorldBookBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (group.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-group-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-group-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });
            const hideMyBubblesToggle = document.getElementById('setting-group-hide-my-bubbles-toggle');
    const hideCharBubblesToggle = document.getElementById('setting-group-hide-char-bubbles-toggle');
    const fontSizeSlider = document.getElementById('setting-group-font-size-slider');
    const fontSizeValue = document.getElementById('setting-group-font-size-value');

    const updateGroupChatSettings = () => {
        const group = db.groups.find(g => g.id === currentChatId);
        if (group) {
            group.hideMyIcons = hideMyBubblesToggle.checked; // ì†ì„± ì´ë¦„ ë³€ê²½
        group.hideCharIcons = hideCharBubblesToggle.checked;
            group.fontSize = parseInt(fontSizeSlider.value, 10);
            saveData();
            applyPerChatUISettings();
        }
    };

    hideMyBubblesToggle.addEventListener('change', updateGroupChatSettings);
    hideCharBubblesToggle.addEventListener('change', updateGroupChatSettings);

    // setupGroupChatSystem í•¨ìˆ˜ ì•ˆì—ì„œ, ê¸°ì¡´ fontSizeSlider ê´€ë ¨ ì½”ë“œë¥¼ ì°¾ì•„ ì•„ëž˜ ë‚´ìš©ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.

    fontSizeSlider.addEventListener('input', () => {
        const newSize = fontSizeSlider.value;
        fontSizeValue.textContent = `${newSize}px`;
        updateGroupChatSettings();
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì½”ë“œ ì¶”ê°€
        const group = db.groups.find(g => g.id === currentChatId);
        if(group) {
            const groupPreviewBox = document.getElementById('group-bubble-css-preview');
            const groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css');
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css');
            const theme = colorThemes[group.theme || 'white_pink'];
            updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !useGroupCustomCssCheckbox.checked, theme, newSize);
        }
    });
        }

        function renderMemberSelectionList() {
            memberSelectionList.innerHTML = '';
            if (db.characters.length === 0) {
                memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">ì„ íƒí•  ìˆ˜ ìžˆëŠ” ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}" style="margin-bottom: 0px">${char.remarkName}</label>`;
                memberSelectionList.appendChild(li);
            });
        }

        function loadGroupSettingsToSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const themeSelect = document.getElementById('setting-group-theme-color');
            if (themeSelect.options.length === 0) {
                Object.keys(colorThemes).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = colorThemes[key].name;
                    themeSelect.appendChild(option);
                });
            }
            document.getElementById('setting-group-avatar-preview').src = group.avatar;
            document.getElementById('setting-group-name').value = group.name;
            document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;
            document.getElementById('setting-group-my-nickname').value = group.me.nickname;
            document.getElementById('setting-group-my-persona').value = group.me.persona;
            themeSelect.value = group.theme || 'white_pink';
            document.getElementById('setting-group-max-memory').value = group.maxMemory;
            renderGroupMembersInSettings(group);
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'), groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'), groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.checked = group.useCustomBubbleCss || false;
            groupCustomCssTextarea.value = group.customBubbleCss || '';
            groupCustomCssTextarea.disabled = !useGroupCustomCssCheckbox.checked;
            const theme = colorThemes[group.theme || 'white_pink'];
            updateBubbleCssPreview(groupPreviewBox, group.customBubbleCss, !group.useCustomBubbleCss, theme);
            document.getElementById('setting-group-hide-my-bubbles-toggle').checked = !!group.hideMyIcons; // ì†ì„± ì´ë¦„ ë³€ê²½
document.getElementById('setting-group-hide-char-bubbles-toggle').checked = !!group.hideCharIcons;
    const fontSize = group.fontSize || 14;
    document.getElementById('setting-group-font-size-slider').value = fontSize;
    document.getElementById('setting-group-font-size-value').textContent = `${fontSize}px`;
        }

        function renderGroupMembersInSettings(group) {
            groupMembersListContainer.innerHTML = '';
            group.members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'group-member';
                memberDiv.dataset.id = member.id;
                memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;
                groupMembersListContainer.appendChild(memberDiv);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-member-btn';
            addBtn.innerHTML = `<div class="add-icon">+</div><span>ì¶”ê°€</span>`;
            groupMembersListContainer.appendChild(addBtn);
        }

        function renderGroupRecipientSelectionList(actionText) {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            groupRecipientSelectionTitle.textContent = actionText;
            groupRecipientSelectionList.innerHTML = '';
            group.members.forEach(member => {
                const li = document.createElement('li');
                li.className = 'group-recipient-select-item';
                li.innerHTML = `
                        <input type="checkbox" id="recipient-select-${member.id}" value="${member.id}">
                        <label for="recipient-select-${member.id}">
                            <img src="${member.avatar}" alt="${member.groupNickname}">
                            <span>${member.groupNickname}</span>
                        </label>`;
                groupRecipientSelectionList.appendChild(li);
            });
        }

        function saveGroupSettingsFromSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const oldName = group.name;
            const newName = document.getElementById('setting-group-name').value;
            if (oldName !== newName) {
                group.name = newName;
                sendRenameNotification(group, newName);
            }
            group.avatar = document.getElementById('setting-group-avatar-preview').src;
            group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;
            group.me.nickname = document.getElementById('setting-group-my-nickname').value;
            group.me.persona = document.getElementById('setting-group-my-persona').value;
            group.theme = document.getElementById('setting-group-theme-color').value;
            group.maxMemory = document.getElementById('setting-group-max-memory').value;
            group.useCustomBubbleCss = document.getElementById('setting-group-use-custom-css').checked;
            group.customBubbleCss = document.getElementById('setting-group-custom-bubble-css').value;
            updateCustomBubbleStyle(currentChatId, group.customBubbleCss, group.useCustomBubbleCss);
            saveData();
            showToast('ê·¸ë£¹ì±„íŒ… ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            chatRoomTitle.textContent = group.name;
            renderChatList();
            renderMessages(false, true);
        }

        function openGroupMemberEditModal(memberId) {
            const group = db.groups.find(g => g.id === currentChatId);
            const member = group.members.find(m => m.id === memberId);
            if (!member) return;
            document.getElementById('edit-group-member-title').textContent = `${member.groupNickname} íŽ¸ì§‘`;
            document.getElementById('editing-member-id').value = member.id;
            document.getElementById('edit-member-avatar-preview').src = member.avatar;
            document.getElementById('edit-member-group-nickname').value = member.groupNickname;
            document.getElementById('edit-member-real-name').value = member.realName;
            document.getElementById('edit-member-persona').value = member.persona;
            editGroupMemberModal.classList.add('visible');
        }

        function renderInviteSelectionList() {
            inviteMemberSelectionList.innerHTML = '';
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));
            const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));
            if (availableChars.length === 0) {
                inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">ì´ˆëŒ€í•  ìˆ˜ ìžˆëŠ” ìƒˆ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                confirmInviteBtn.disabled = true;
                return;
            }
            confirmInviteBtn.disabled = false;
            availableChars.forEach(char => {
                const li = document.createElement('li');
                li.className = 'invite-member-select-item';
                li.innerHTML = `<input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label>`;
                inviteMemberSelectionList.appendChild(li);
            });
        }

        function sendInviteNotification(group, newMemberRealName) {
            const messageContent = `[${group.me.nickname}ë‹˜ì´ ${newMemberRealName}ë‹˜ì„ ê·¸ë£¹ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, parts: [{ type: 'text', text: messageContent }], timestamp: Date.now(), senderId: 'user_me' };
            group.history.push(message);
        }

        function sendRenameNotification(group, newName) {
            const myName = group.me.nickname;
            const messageContent = `[${myName}ë‹˜ì´ ê·¸ë£¹ ì´ë¦„ì„ â€˜${newName}â€™(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤]`;
            const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, parts: [{ type: 'text', text: messageContent }], timestamp: Date.now() };
            group.history.push(message);
        }

        // --- START: ì¶”ê°€í•  JavaScript í•¨ìˆ˜ë“¤ ---
        function setupBottomNav() {
            const navBar = document.getElementById('bottom-nav-bar');
            navBar.addEventListener('click', (e) => {
                const navBtn = e.target.closest('.nav-btn');
                if (!navBtn) return;

                e.preventDefault();
                const targetId = navBtn.dataset.target;
                switchScreen(targetId);
            });
        }

        // ê¸°ì¡´ setupFeedScreen í•¨ìˆ˜ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´
        function setupFeedScreen() {
            const dummyFeedData = [
                { userId: 'chan', userName: 'ì°¬', avatar: 'https://i.postimg.cc/nzP9sgxr/chan-125.png', image: 'https://picsum.photos/id/1015/600/600', content: 'ì˜¤ëŠ˜ ë‚ ì”¨ ì •ë§ ì¢‹ë‹¤! â˜€ï¸ ë‹¤ë“¤ ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”~ #ì¼ìƒ #ì‚°ì±…', likes: 102, comments: [{user:'user2', text:'ì‚¬ì§„ ë„ˆë¬´ ì˜ˆë»ìš”!'}, {user:'user3', text:'ì–´ë””ì—ìš”? ê°€ë³´ê³  ì‹¶ë‹¤'}], timestamp: '2ì‹œê°„ ì „' },
                { userId: 'user2', userName: 'ê³ ì–‘ì´ì§‘ì‚¬', avatar: 'https://picsum.photos/id/1025/100/100', image: 'https://picsum.photos/id/219/600/700', content: 'ìš°ë¦¬ì§‘ ëƒ¥ì´ ë‚®ìž ìžëŠ” ì¤‘ ðŸ’¤ #ê³ ì–‘ì´ #ë°˜ë ¤ë¬˜', likes: 251, comments: [{user:'chan', text:'ê·€ì—¬ì›Œìš”!'}], timestamp: 'ì–´ì œ' },
            ];

            const feedContainer = document.getElementById('feed-container');
            
            function renderFeed() {
                feedContainer.innerHTML = '';
                dummyFeedData.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'feed-post';
                    postEl.innerHTML = `
                        <div class="post-header" data-user-id="${post.userId}">
                            <img src="${post.avatar}" alt="${post.userName}" class="post-avatar">
                            <span class="post-author">${post.userName}</span>
                        </div>
                        <div class="post-image">
                            <img src="${post.image}" alt="í”¼ë“œ ì´ë¯¸ì§€">
                        </div>
                        <div class="post-actions">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </div>
                        <div class="post-footer">
                            <div class="post-likes">${post.likes.toLocaleString()}ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</div>
                            <div class="post-content">
                                <span class="author">${post.userName}</span>
                                <span>${post.content}</span>
                            </div>
                            <div class="view-comments">ëŒ“ê¸€ ${post.comments.length}ê°œ ëª¨ë‘ ë³´ê¸°</div>
                            <div class="post-timestamp">${post.timestamp}</div>
                        </div>
                        <div class="comment-input-area">
                             <img src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" class="my-avatar">
                             <input type="text" class="comment-input" placeholder="ëŒ“ê¸€ ë‹¬ê¸°...">
                        </div>
                    `;
                    feedContainer.appendChild(postEl);
                });
            }

            renderFeed();

            feedContainer.addEventListener('click', (e) => {
                const header = e.target.closest('.post-header');
                if (header) {
                    const userId = header.dataset.userId;
                    openProfileScreen(userId);
                }
            });
        }

        // ê¸°ì¡´ openProfileScreen í•¨ìˆ˜ë¥¼ ì•„ëž˜ ì½”ë“œë¡œ êµì²´
        function openProfileScreen(userId) {
            const dummyUserData = {
                'chan': { name: 'ì°¬', username: 'chan_photo', bio: 'ì‚¬ì§„ ì°ëŠ” ê±¸ ì¢‹ì•„í•´ìš” ðŸ“¸\nì¼ìƒê³¼ ì—¬í–‰ ê¸°ë¡', avatar: 'https://i.postimg.cc/nzP9sgxr/chan-125.png', posts: 12, followers: '125K', following: 80, images: ['https://picsum.photos/id/1015/400/400', 'https://picsum.photos/id/10/400/400', 'https://picsum.photos/id/102/400/400', 'https://picsum.photos/id/1024/400/400', 'https://picsum.photos/id/1028/400/400', 'https://picsum.photos/id/103/400/400', 'https://picsum.photos/id/1035/400/400'] },
                'user2': { name: 'ê³ ì–‘ì´ì§‘ì‚¬', username: 'cat_lover_22', bio: 'ê³ ì–‘ì´ì™€ í•¨ê»˜í•˜ëŠ” ì¼ìƒ', avatar: 'https://picsum.photos/id/1025/100/100', posts: 5, followers: '88K', following: 30, images: ['https://picsum.photos/id/219/400/400', 'https://picsum.photos/id/237/400/400', 'https://picsum.photos/id/274/400/400'] }
            };

            const userData = dummyUserData[userId];
            if (!userData) return;

            document.getElementById('profile-name').textContent = userData.username;
            const profileContainer = document.getElementById('profile-container');
            
            const gridItems = userData.images.map(img => `<div class="grid-item"><img src="${img}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"></div>`).join('');

            profileContainer.innerHTML = `
                <div class="profile-header">
                    <img src="${userData.avatar}" alt="${userData.name}" class="profile-avatar-lg">
                    <div class="profile-stats">
                        <div class="stat-item"><span class="count">${userData.posts}</span><span class="label">ê²Œì‹œë¬¼</span></div>
                        <div class="stat-item"><span class="count">${userData.followers}</span><span class="label">íŒ”ë¡œì›Œ</span></div>
                        <div class="stat-item"><span class="count">${userData.following}</span><span class="label">íŒ”ë¡œìž‰</span></div>
                    </div>
                </div>
                <div class="profile-bio">
                    <p class="name">${userData.name}</p>
                    <p class="bio-text">${userData.bio.replace(/\n/g, '<br>')}</p>
                </div>
                <div class="profile-buttons">
                    <button class="btn btn-follow">íŒ”ë¡œìš°</button>
                    <button class="btn btn-message">ë©”ì‹œì§€</button>
                </div>
                <div class="story-highlights">
                    <div class="highlight-item"><div class="highlight-circle"></div><span>ì—¬í–‰</span></div>
                    <div class="highlight-item"><div class="highlight-circle"></div><span>ë§›ì§‘</span></div>
                    <div class="highlight-item"><div class="highlight-circle"></div><span>ì¼ìƒ</span></div>
                </div>
                <div class="profile-tabs">
                    <button class="tab-btn active"><svg viewBox="0 0 24 24"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 13h8v-8h-8v8z"></path></svg></button>
                    <button class="tab-btn"><svg viewBox="0 0 24 24"><path d="M20.54 18.5l-2.93-2.93c.58-1.02.93-2.21.93-3.48C18.54 7.6 15.36 4.5 11 4.5S3.46 7.6 3.46 12s3.18 7.5 7.54 7.5c1.27 0 2.46-.35 3.48-.93l2.93 2.93L18.5 20l2.04-1.5zm-9.54-3c-2.48 0-4.5-2.02-4.5-4.5s2.02-4.5 4.5-4.5 4.5 2.02 4.5 4.5-2.02 4.5-4.5 4.5z"></path></svg></button>
                </div>
                <div class="profile-grid">
                    ${gridItems}
                </div>
            `;
            switchScreen('profile-screen');
        }
        
        init();
    });
	
</script>

</body>


</html>
